---
description: Streaming-und Anwendungsthreads
ms.assetid: 954f7abd-fe06-430a-b6f7-d60852826bc9
title: Streaming-und Anwendungsthreads
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 432e613ff0322377c042e796d84ef7affdda99c2
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/08/2021
ms.locfileid: "104530245"
---
# <a name="the-streaming-and-application-threads"></a><span data-ttu-id="f910e-103">Streaming-und Anwendungsthreads</span><span class="sxs-lookup"><span data-stu-id="f910e-103">The Streaming and Application Threads</span></span>

<span data-ttu-id="f910e-104">Alle DirectShow-Anwendungen enthalten mindestens zwei wichtige Threads: den Anwendungs Thread und einen oder mehrere streamingthreads.</span><span class="sxs-lookup"><span data-stu-id="f910e-104">Any DirectShow application contains at least two important threads: the application thread, and one or more streaming threads.</span></span> <span data-ttu-id="f910e-105">Die Beispiele werden über die streamingthreads geliefert, und Zustandsänderungen werden im Anwendungs Thread ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="f910e-105">Samples are delivered on the streaming threads, and state changes happen on the application thread.</span></span> <span data-ttu-id="f910e-106">Der hauptstreamingthread wird von einem Quell-oder Parserfilter erstellt.</span><span class="sxs-lookup"><span data-stu-id="f910e-106">The main streaming thread is created by a source or parser filter.</span></span> <span data-ttu-id="f910e-107">Andere Filter erstellen möglicherweise Arbeitsthreads, die Beispiele bereitstellen. Diese werden auch als streamingthreads angesehen.</span><span class="sxs-lookup"><span data-stu-id="f910e-107">Other filters might create worker threads that deliver samples, and these are considered streaming threads as well.</span></span>

<span data-ttu-id="f910e-108">Einige Methoden werden im Anwendungs Thread aufgerufen, während andere in einem streamingthread aufgerufen werden.</span><span class="sxs-lookup"><span data-stu-id="f910e-108">Some methods are called on the application thread, while others are called on a streaming thread.</span></span> <span data-ttu-id="f910e-109">Beispiel:</span><span class="sxs-lookup"><span data-stu-id="f910e-109">For example:</span></span>

-   <span data-ttu-id="f910e-110">Streaming Thread (s): [**IMemInputPin:: Receive**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-receive), [**IMemInputPin:: receivemultiple**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-receivemultiple), [**IPin:: EndOfStream**](/windows/desktop/api/Strmif/nf-strmif-ipin-endofstream), [**imemzuzucator:: GetBuffer**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-getbuffer).</span><span class="sxs-lookup"><span data-stu-id="f910e-110">Streaming thread(s): [**IMemInputPin::Receive**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-receive), [**IMemInputPin::ReceiveMultiple**](/windows/desktop/api/Strmif/nf-strmif-imeminputpin-receivemultiple), [**IPin::EndOfStream**](/windows/desktop/api/Strmif/nf-strmif-ipin-endofstream), [**IMemAllocator::GetBuffer**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-getbuffer).</span></span>
-   <span data-ttu-id="f910e-111">Anwendungs Thread: [**imediafilter::P ause**](/windows/desktop/api/Strmif/nf-strmif-imediafilter-pause), [**imediafilter:: Run**](/windows/desktop/api/Strmif/nf-strmif-imediafilter-run), [**imediafilter::**](/windows/desktop/api/Strmif/nf-strmif-imediafilter-stop)End, [**imediaseeking:: setpositions**](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-setpositions), [**IPin:: beginflush**](/windows/desktop/api/Strmif/nf-strmif-ipin-beginflush), [**IPin:: endflush**](/windows/desktop/api/Strmif/nf-strmif-ipin-endflush).</span><span class="sxs-lookup"><span data-stu-id="f910e-111">Application thread: [**IMediaFilter::Pause**](/windows/desktop/api/Strmif/nf-strmif-imediafilter-pause), [**IMediaFilter::Run**](/windows/desktop/api/Strmif/nf-strmif-imediafilter-run), [**IMediaFilter::Stop**](/windows/desktop/api/Strmif/nf-strmif-imediafilter-stop), [**IMediaSeeking::SetPositions**](/windows/desktop/api/Strmif/nf-strmif-imediaseeking-setpositions), [**IPin::BeginFlush**](/windows/desktop/api/Strmif/nf-strmif-ipin-beginflush), [**IPin::EndFlush**](/windows/desktop/api/Strmif/nf-strmif-ipin-endflush).</span></span>
-   <span data-ttu-id="f910e-112">Beides: [**IPin:: newsegment**](/windows/desktop/api/Strmif/nf-strmif-ipin-newsegment).</span><span class="sxs-lookup"><span data-stu-id="f910e-112">Either: [**IPin::NewSegment**](/windows/desktop/api/Strmif/nf-strmif-ipin-newsegment).</span></span>

<span data-ttu-id="f910e-113">Ein separater streamingthread ermöglicht das Übertragen von Daten durch das Diagramm, während der Anwendungs Thread auf Benutzereingaben wartet.</span><span class="sxs-lookup"><span data-stu-id="f910e-113">Having a separate streaming thread allows data to flow through the graph while the application thread waits for user input.</span></span> <span data-ttu-id="f910e-114">Die Gefahr mehrerer Threads besteht jedoch darin, dass ein Filter Ressourcen erstellen kann, wenn er angehalten wird (im Anwendungs Thread), diese innerhalb einer Streamingmethode verwenden und diese bei Beendigung (auch im Anwendungs Thread) zerstören.</span><span class="sxs-lookup"><span data-stu-id="f910e-114">The danger of multiple threads, however, is that a filter may create resources when it pauses (on the application thread), use them inside a streaming method, and destroy them when it stops (also on the application thread).</span></span> <span data-ttu-id="f910e-115">Wenn Sie nicht vorsichtig sind, versucht der streamingingthread möglicherweise, die Ressourcen zu verwenden, nachdem Sie zerstört wurden.</span><span class="sxs-lookup"><span data-stu-id="f910e-115">If you are not careful, the streaming thread might try to use the resources after they are destroyed.</span></span> <span data-ttu-id="f910e-116">Die Lösung besteht darin, Ressourcen mithilfe kritischer Abschnitte zu schützen und Streamingmethoden mit Zustandsänderungen zu synchronisieren.</span><span class="sxs-lookup"><span data-stu-id="f910e-116">The solution is to protect resources using critical sections, and synchronize streaming methods with state changes.</span></span>

<span data-ttu-id="f910e-117">Ein Filter benötigt einen kritischen Abschnitt, um den Filter Zustand zu schützen.</span><span class="sxs-lookup"><span data-stu-id="f910e-117">A filter needs one critical section to protect the filter state.</span></span> <span data-ttu-id="f910e-118">Die [**cbasefilter**](cbasefilter.md) -Klasse verfügt über eine Member-Variable für diesen kritischen Abschnitt [**cbasefilter:: m \_ Plock**](cbasefilter-m-plock.md).</span><span class="sxs-lookup"><span data-stu-id="f910e-118">The [**CBaseFilter**](cbasefilter.md) class has a member variable for this critical section, [**CBaseFilter::m\_pLock**](cbasefilter-m-plock.md).</span></span> <span data-ttu-id="f910e-119">Dieser kritische Abschnitt wird als Filter Sperre bezeichnet.</span><span class="sxs-lookup"><span data-stu-id="f910e-119">This critical section is called the filter lock.</span></span> <span data-ttu-id="f910e-120">Außerdem benötigt jede Eingabe-PIN einen kritischen Abschnitt, um die Ressourcen zu schützen, die vom Streaminginhalt verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="f910e-120">Also, each input pin needs a critical section to protect resources used by the streaming thread.</span></span> <span data-ttu-id="f910e-121">Diese kritischen Abschnitte heißen streamingsperren. Sie müssen Sie in der abgeleiteten Pin-Klasse deklarieren.</span><span class="sxs-lookup"><span data-stu-id="f910e-121">These critical sections are called streaming locks; you must declare them in your derived pin class.</span></span> <span data-ttu-id="f910e-122">Es ist am einfachsten, die [**ccritsec**](ccritsec.md) -Klasse zu verwenden, die ein kritisches Windows- **\_ Abschnitts** Objekt umschließt und mithilfe der [**cautolock**](cautolock.md) -Klasse gesperrt werden kann.</span><span class="sxs-lookup"><span data-stu-id="f910e-122">It is easiest to use the [**CCritSec**](ccritsec.md) class, which wraps a Windows **CRITICAL\_SECTION** object and can be locked using the [**CAutoLock**](cautolock.md) class.</span></span> <span data-ttu-id="f910e-123">Die **ccritsec** -Klasse bietet auch einige nützliche Debuggingfunktionen.</span><span class="sxs-lookup"><span data-stu-id="f910e-123">The **CCritSec** class also provides some useful debugging functions.</span></span> <span data-ttu-id="f910e-124">Weitere Informationen finden Sie im [Abschnitt zum Debuggen von kritischen Abschnitten](critical-section-debugging-functions.md).</span><span class="sxs-lookup"><span data-stu-id="f910e-124">For more information, see [Critical Section Debugging Functions](critical-section-debugging-functions.md).</span></span>

<span data-ttu-id="f910e-125">Wenn ein Filter beendet oder geleert wird, muss er den Anwendungs Thread mit dem streamingthread synchronisieren.</span><span class="sxs-lookup"><span data-stu-id="f910e-125">When a filter stops or flushes, it must synchronize the application thread with the streaming thread.</span></span> <span data-ttu-id="f910e-126">Um Deadlocks zu vermeiden, muss zunächst der streamingingthread blockiert werden. Dies kann aus verschiedenen Gründen blockiert werden:</span><span class="sxs-lookup"><span data-stu-id="f910e-126">To avoid deadlocking, it must first unblock the streaming thread, which might be blocked for several reasons:</span></span>

-   <span data-ttu-id="f910e-127">Er wartet darauf, ein Beispiel innerhalb der [**imemzucator:: GetBuffer**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-getbuffer) -Methode zu erhalten, da alle Beispiele der Zuweiser verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="f910e-127">It is waiting to get a sample inside the [**IMemAllocator::GetBuffer**](/windows/desktop/api/Strmif/nf-strmif-imemallocator-getbuffer) method, because all of the allocator's samples are in use.</span></span>
-   <span data-ttu-id="f910e-128">Er wartet darauf, dass ein anderer Filter von einer Streamingmethode (z. b. **Receive**) zurückgegeben wird.</span><span class="sxs-lookup"><span data-stu-id="f910e-128">It is waiting for another filter to return from a streaming method, such as **Receive**.</span></span>
-   <span data-ttu-id="f910e-129">Er wartet innerhalb einer seiner eigenen Streamingmethoden, damit eine Ressource verfügbar wird.</span><span class="sxs-lookup"><span data-stu-id="f910e-129">It is waiting inside one of its own streaming methods, for some resource to become available.</span></span>
-   <span data-ttu-id="f910e-130">Es handelt sich um einen rendererfilter, der auf die Präsentationszeit des nächsten Beispiels wartet.</span><span class="sxs-lookup"><span data-stu-id="f910e-130">It is a renderer filter waiting for the presentation time of the next sample</span></span>
-   <span data-ttu-id="f910e-131">Es handelt sich um einen rendererfilter, der in der **Receive** -Methode wartet</span><span class="sxs-lookup"><span data-stu-id="f910e-131">It is a renderer filter waiting inside the **Receive** method while paused.</span></span>

<span data-ttu-id="f910e-132">Wenn der Filter beendet oder geleert wird, muss er daher folgende Aktionen ausführen:</span><span class="sxs-lookup"><span data-stu-id="f910e-132">Therefore, when the filter stops or flushes, it must do the following:</span></span>

-   <span data-ttu-id="f910e-133">Geben Sie ein beliebiges Beispiel aus irgendeinem Grund frei.</span><span class="sxs-lookup"><span data-stu-id="f910e-133">Release any sample it is holding for any reason.</span></span> <span data-ttu-id="f910e-134">Dadurch wird die Blockierung der **GetBuffer** -Methode aufgehoben.</span><span class="sxs-lookup"><span data-stu-id="f910e-134">Doing so unblocks the **GetBuffer** method.</span></span>
-   <span data-ttu-id="f910e-135">Gibt so schnell wie möglich von jeder Streamingmethode zurück.</span><span class="sxs-lookup"><span data-stu-id="f910e-135">Return from any streaming method as quickly as possible.</span></span> <span data-ttu-id="f910e-136">Wenn eine Streamingmethode auf eine Ressource wartet, muss Sie nicht mehr sofort warten.</span><span class="sxs-lookup"><span data-stu-id="f910e-136">If a streaming method is waiting for a resource, it must stop waiting immediately.</span></span>
-   <span data-ttu-id="f910e-137">Beginnen Sie mit dem ablehnen von Beispielen in **Receive**, damit der streamingingthread nicht auf Weitere Ressourcen zugreift.</span><span class="sxs-lookup"><span data-stu-id="f910e-137">Start rejecting samples in **Receive**, so that the streaming thread does not access any more resources.</span></span> <span data-ttu-id="f910e-138">(Die [**cbaseingeputpin**](cbaseinputpin.md) -Klasse verarbeitet dies automatisch.)</span><span class="sxs-lookup"><span data-stu-id="f910e-138">(The [**CBaseInputPin**](cbaseinputpin.md) class handles this automatically.)</span></span>
-   <span data-ttu-id="f910e-139">Die Methode zum **Abbrechen** muss alle Zuweisungen des Filters Decommit aufheben.</span><span class="sxs-lookup"><span data-stu-id="f910e-139">The **Stop** method must decommit all of the filter's allocators.</span></span> <span data-ttu-id="f910e-140">(Die **cbaseingeputpin** -Klasse verarbeitet dies automatisch.)</span><span class="sxs-lookup"><span data-stu-id="f910e-140">(The **CBaseInputPin** class handles this automatically.)</span></span>

<span data-ttu-id="f910e-141">Das leeren und beenden beider vorkommen erfolgt im Anwendungs Thread.</span><span class="sxs-lookup"><span data-stu-id="f910e-141">Flushing and stopping both happen on the application thread.</span></span> <span data-ttu-id="f910e-142">Ein Filter wird als Reaktion auf die [**IMediaControl:: Stopp**](/windows/desktop/api/Control/nf-control-imediacontrol-stop) -Methode angehalten.</span><span class="sxs-lookup"><span data-stu-id="f910e-142">A filter stops in response to the [**IMediaControl::Stop**](/windows/desktop/api/Control/nf-control-imediacontrol-stop) method.</span></span> <span data-ttu-id="f910e-143">Der Filter Graph-Manager gibt den Befehl zum Abbrechen in der upstreamreihenfolge aus, beginnend mit den renderatoren und rückwärts zu den Quell filtern.</span><span class="sxs-lookup"><span data-stu-id="f910e-143">The Filter Graph Manager issues the stop command in upstream order, starting from the renderers and working backward to the source filters.</span></span> <span data-ttu-id="f910e-144">Der Befehl zum Abbrechen erfolgt vollständig innerhalb der **cbasefilter:: stopmethode** des Filters.</span><span class="sxs-lookup"><span data-stu-id="f910e-144">The stop command happens completely inside the filter's **CBaseFilter::Stop** method.</span></span> <span data-ttu-id="f910e-145">Wenn die Methode zurückgegeben wird, sollte der Filter den Status "beendet" aufweisen.</span><span class="sxs-lookup"><span data-stu-id="f910e-145">When the method returns, the filter should be in a stopped state.</span></span>

<span data-ttu-id="f910e-146">Das leeren erfolgt in der Regel aufgrund eines Seek-Befehls.</span><span class="sxs-lookup"><span data-stu-id="f910e-146">Flushing typically occurs because of a seek command.</span></span> <span data-ttu-id="f910e-147">Ein Flush-Befehl beginnt mit dem Quell-oder Parserfilter und verläuft nach unten.</span><span class="sxs-lookup"><span data-stu-id="f910e-147">A flush command starts from the source or parser filter, and travels downstream.</span></span> <span data-ttu-id="f910e-148">Das leeren erfolgt in zwei Phasen: die [**IPin:: beginflush**](/windows/desktop/api/Strmif/nf-strmif-ipin-beginflush) -Methode informiert einen Filter, alle ausstehenden und eingehenden Daten zu verwerfen. die [**IPin:: endflush**](/windows/desktop/api/Strmif/nf-strmif-ipin-endflush) -Methode signalisiert dem Filter, Daten erneut zu akzeptieren.</span><span class="sxs-lookup"><span data-stu-id="f910e-148">Flushing happens in two stages: The [**IPin::BeginFlush**](/windows/desktop/api/Strmif/nf-strmif-ipin-beginflush) method informs a filter to discard all pending and incoming data; the [**IPin::EndFlush**](/windows/desktop/api/Strmif/nf-strmif-ipin-endflush) method signals the filter to accept data again.</span></span> <span data-ttu-id="f910e-149">Das Leeren von erfordert zwei Stufen, da sich der **beginflush** -Rückruf im Anwendungs Thread befindet, in dem der streamingthread weiterhin Daten bereitstellt.</span><span class="sxs-lookup"><span data-stu-id="f910e-149">Flushing requires two stages because the **BeginFlush** call is on the application thread, during which the streaming thread continues to deliver data.</span></span> <span data-ttu-id="f910e-150">Daher können nach dem **beginflush** -Aufrufvorgang einige Beispiele eintreffen.</span><span class="sxs-lookup"><span data-stu-id="f910e-150">Therefore, some samples may arrive after the **BeginFlush** call.</span></span> <span data-ttu-id="f910e-151">Der Filter sollte diese verwerfen.</span><span class="sxs-lookup"><span data-stu-id="f910e-151">The filter should discard these.</span></span> <span data-ttu-id="f910e-152">Alle Beispiele, die nach dem **endflush** -Rückruf eintreffen, sind garantiert neu und sollten übermittelt werden.</span><span class="sxs-lookup"><span data-stu-id="f910e-152">Any samples that arrive after the **EndFlush** call are guaranteed to be new, and should be delivered.</span></span>

<span data-ttu-id="f910e-153">Die folgenden Abschnitte enthalten Codebeispiele, die zeigen, wie die wichtigsten Filter **Methoden wie anhalten,** **empfangen** usw. implementiert werden, um Deadlocks und Racebedingungen zu vermeiden.</span><span class="sxs-lookup"><span data-stu-id="f910e-153">The sections that follow contain code samples showing how to implement the most important filter methods, such as **Pause**, **Receive**, and so forth, in ways that avoid deadlocks and race conditions.</span></span> <span data-ttu-id="f910e-154">Jeder Filter hat jedoch unterschiedliche Anforderungen, sodass Sie diese Beispiele an Ihren speziellen Filter anpassen müssen.</span><span class="sxs-lookup"><span data-stu-id="f910e-154">Every filter has different requirements, however, so you will need to adapt these examples to your particular filter.</span></span>

> [!Note]  
> <span data-ttu-id="f910e-155">Mit den [**ctransformfilter**](ctransformfilter.md) -und [**ctransinplacefilter**](ctransinplacefilter.md) -Basisklassen werden viele der in diesem Artikel beschriebenen Probleme behandelt.</span><span class="sxs-lookup"><span data-stu-id="f910e-155">The [**CTransformFilter**](ctransformfilter.md) and [**CTransInPlaceFilter**](ctransinplacefilter.md) base classes handle many of the issues described in this article.</span></span> <span data-ttu-id="f910e-156">Wenn Sie einen Transformations Filter schreiben und der Filter nicht auf Ereignisse innerhalb einer Streamingmethode wartet oder Beispiele außerhalb des **Empfangs** enthalten, sollten diese Basisklassen ausreichen.</span><span class="sxs-lookup"><span data-stu-id="f910e-156">If you are writing a transform filter, and your filter does not wait on events inside a streaming method, or hold onto samples outside of **Receive**, then these base classes should be sufficient.</span></span>

 

 

 



