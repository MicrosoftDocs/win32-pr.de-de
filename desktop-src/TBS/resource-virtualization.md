---
title: Ressourcenvirtualisierung
description: Ressourcenvirtualisierung
ms.assetid: ead0e99a-94da-4e80-bb68-d8f4b199173d
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f340b1a1bddfb3fd591452e028c80403b9c7e02f
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 09/16/2019
ms.locfileid: "103711819"
---
# <a name="resource-virtualization"></a><span data-ttu-id="c4bae-103">Ressourcenvirtualisierung</span><span class="sxs-lookup"><span data-stu-id="c4bae-103">Resource Virtualization</span></span>

<span data-ttu-id="c4bae-104">Die primäre Funktion des TSB ist die effiziente Freigabe bestimmter eingeschränkter TPM-Ressourcen: Schlüssel, Autorisierung und Transport Sitzungen.</span><span class="sxs-lookup"><span data-stu-id="c4bae-104">The primary function of the TBS is to efficiently share certain limited TPM resources: keys, authorization, and transport sessions.</span></span>

<span data-ttu-id="c4bae-105">Wenn eine Instanz einer dieser Ressourcen erstellt wird, erstellt die TSB eine virtuelle Instanz der Ressource und gibt ein Handle für diese virtuelle Instanz im ergebnisbefehlsstream zurück (anstelle der eigentlichen handle-Instanz, die vom TPM zurückgegeben wird).</span><span class="sxs-lookup"><span data-stu-id="c4bae-105">When an instance of one of these resources is created, the TBS creates a virtual instance of the resource, and returns a handle to this virtual instance in the result command stream (rather than the actual handle instance returned by the TPM).</span></span> <span data-ttu-id="c4bae-106">Die TSB verwaltet eine Zuordnung zwischen dem virtuellen Handle und dem eigentlichen handle intern.</span><span class="sxs-lookup"><span data-stu-id="c4bae-106">The TBS maintains a mapping between the virtual handle and the actual handle internally.</span></span> <span data-ttu-id="c4bae-107">Wenn das TPM nicht mehr über genügend Speicherplatz verfügt, um mehr Ressourcen eines bestimmten Typs zu speichern, werden vorhandene Instanzen der Ressource selektiv gespeichert und entfernt, bis das TPM die neue Ressource aufnehmen kann.</span><span class="sxs-lookup"><span data-stu-id="c4bae-107">If the TPM runs out of space to hold more resources of a given type, existing instances of the resource are selectively saved and evicted until the TPM can hold the new resource.</span></span> <span data-ttu-id="c4bae-108">Wenn die alten Ressourcen erneut benötigt werden, lädt die TSB die gespeicherten Kontexte (speichern und auslagern anderer Ressourcen bei Bedarf), bevor der Befehl übermittelt wird.</span><span class="sxs-lookup"><span data-stu-id="c4bae-108">When the old resources are required again, the TBS loads the saved contexts (saving and evicting other resources if necessary) before submitting the command.</span></span>

<span data-ttu-id="c4bae-109">Die gesamte Virtualisierung in den TSB wird im Auftrag eines bestimmten Kontexts ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="c4bae-109">All virtualization in the TBS is performed on behalf of a specific context.</span></span> <span data-ttu-id="c4bae-110">Jeder Kontext darf nur auf virtuelle Ressourcen zugreifen, die speziell in seinem Namen erstellt wurden, sowie auf die physischen Ressourcen auf dem TPM, die diesen virtuellen Ressourcen entsprechen.</span><span class="sxs-lookup"><span data-stu-id="c4bae-110">Each context is only allowed to access virtual resources created specifically on its behalf, as well as the physical resources on the TPM that corresponds to those virtual resources.</span></span> <span data-ttu-id="c4bae-111">Standardmäßig ist die Gesamtzahl aller virtualisierten Ressourcen auf 500 beschränkt.</span><span class="sxs-lookup"><span data-stu-id="c4bae-111">By default, the total number of all virtualized resources is limited to 500.</span></span> <span data-ttu-id="c4bae-112">Diese Nummer kann geändert werden, indem Sie einen **DWORD** -Registrierungs Wert mit dem Namen " **maxresources** " unter **HKEY \_ local \_ Machine** \\ **Software** \\ **Microsoft** \\ **TPM** erstellen oder ändern.</span><span class="sxs-lookup"><span data-stu-id="c4bae-112">This number can be altered by creating or modifying a **DWORD** registry value named **MaxResources** under **HKEY\_LOCAL\_MACHINE**\\**Software**\\**Microsoft**\\**Tpm**.</span></span> <span data-ttu-id="c4bae-113">Die Ressourcennutzung in Echtzeit-TSB kann mithilfe des Leistungs Monitor Tools zum Nachverfolgen der Anzahl von TSB-Ressourcen beobachtet werden.</span><span class="sxs-lookup"><span data-stu-id="c4bae-113">Real-time TBS resource usage can be observed by using the Performance Monitor tool to track the number of TBS resources.</span></span> <span data-ttu-id="c4bae-114">Diese Einschränkung wurde in Windows 8 und Windows Server 2012 als veraltet eingestuft.</span><span class="sxs-lookup"><span data-stu-id="c4bae-114">This restriction became obsolete with Windows 8 and Windows Server 2012.</span></span>

<span data-ttu-id="c4bae-115">Eingeschränkte TPM-Ressourcen, die nicht von den TSB (z. b. Indikatoren und NV-Speicher) virtualisiert werden, müssen gemeinsam zwischen Software Stapeln gemeinsam genutzt werden.</span><span class="sxs-lookup"><span data-stu-id="c4bae-115">Limited TPM resources that are not virtualized by the TBS (such as counters and NV store) must be cooperatively shared among software stacks.</span></span>

> [!Note]  
> <span data-ttu-id="c4bae-116">Diese handle-Virtualisierung bewirkt, dass Befehle, die Schlüssel Handles in der Berechnung von HMAC-Autorisierungs Parametern enthalten, fehlschlagen.</span><span class="sxs-lookup"><span data-stu-id="c4bae-116">This handle virtualization causes commands that include key handles in the calculation of HMAC authorization parameters to fail.</span></span> <span data-ttu-id="c4bae-117">Infolgedessen können viele in TPM, Version 1,2, veraltete Befehle nicht von der Anwendungssoftware in der TSB-Umgebung verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="c4bae-117">As a result, many commands deprecated in TPM version 1.2 cannot be used by application software in the TBS environment.</span></span>

 

## <a name="resource-limits"></a><span data-ttu-id="c4bae-118">Ressourceneinschränkungen</span><span class="sxs-lookup"><span data-stu-id="c4bae-118">Resource Limits</span></span>

<span data-ttu-id="c4bae-119">Das TPM ermöglicht es Aufrufern, ihre Funktionen abzufragen, um zu bestimmen, wie viel Speicherplatz für bestimmte Ressourcentypen verfügbar ist.</span><span class="sxs-lookup"><span data-stu-id="c4bae-119">The TPM enables callers to query its capabilities to determine how much space is available for certain types of resources.</span></span> <span data-ttu-id="c4bae-120">Einige dieser Ressourcen Limits, wie z. b. der verfügbare Speicherplatz für Schlüssel, Autorisierungs Sitzungen und Transport Sitzungen, werden durch die Virtualisierung effektiv durch die TSB erweitert.</span><span class="sxs-lookup"><span data-stu-id="c4bae-120">Some of these resource limits, such as the amount of space available for keys, authorization sessions, and transport sessions, are effectively extended by the TBS through virtualization.</span></span> <span data-ttu-id="c4bae-121">TSB-Einschränkungen, die von der **maxresources** -Registrierungs Einstellung gesteuert werden, sind in der Regel weitaus größer als die tatsächlichen Einschränkungen der zugrunde liegenden TPM-Hardware.</span><span class="sxs-lookup"><span data-stu-id="c4bae-121">TBS limitations, which are controlled by the **MaxResources** registry setting, are usually far larger than the actual limitations of the underlying TPM hardware.</span></span> <span data-ttu-id="c4bae-122">Es wird kein Mechanismus zum Abfragen von TSB-Einschränkungen getrennt von den TPM-Hardware Limits bereitgestellt.</span><span class="sxs-lookup"><span data-stu-id="c4bae-122">No mechanism is supplied for querying TBS limitations separately from the TPM hardware limits.</span></span> <span data-ttu-id="c4bae-123">Diese TSB-Einschränkung wurde mit Windows 8 und Windows Server 2012 als veraltet eingestuft.</span><span class="sxs-lookup"><span data-stu-id="c4bae-123">This TBS limitation became obsolete with Windows 8 and Windows Server 2012.</span></span>

## <a name="keys"></a><span data-ttu-id="c4bae-124">Schlüssel</span><span class="sxs-lookup"><span data-stu-id="c4bae-124">Keys</span></span>

<span data-ttu-id="c4bae-125">Die TSB virtualisiert Schlüssel Handles, sodass Schlüssel transparent aus dem TPM entladen werden können, wenn Sie nicht verwendet werden und bei Bedarf wieder auf das TPM geladen werden.</span><span class="sxs-lookup"><span data-stu-id="c4bae-125">The TBS virtualizes key handles so that keys can be transparently unloaded from the TPM when they are not being used and loaded back onto the TPM when they are needed.</span></span> <span data-ttu-id="c4bae-126">Wenn ein Schlüssel erstellt wird, ordnet die TSB ein virtuelles handle dem geladenen Schlüssel zu.</span><span class="sxs-lookup"><span data-stu-id="c4bae-126">When a key is created, the TBS associates a virtual handle with the loaded key.</span></span> <span data-ttu-id="c4bae-127">Das gleiche virtuelle Handle wird für die Lebensdauer der Ressource verwendet.</span><span class="sxs-lookup"><span data-stu-id="c4bae-127">The same virtual handle is used for the lifetime of the resource.</span></span> <span data-ttu-id="c4bae-128">Virtuelle Schlüssel Handles sind nur in dem Kontext gültig, in dem Sie erstellt wurden, und die zugeordneten Ressourcen werden über die Lebensdauer des Kontexts hinaus nicht beibehalten.</span><span class="sxs-lookup"><span data-stu-id="c4bae-128">Virtual key handles are only valid in the context that created them, and the associated resources are not preserved beyond the life of the context.</span></span>

-   <span data-ttu-id="c4bae-129">Erstellen von Schlüsseln mit TPM \_ LoadKey2</span><span class="sxs-lookup"><span data-stu-id="c4bae-129">Creating Keys with TPM\_LoadKey2</span></span>

    <span data-ttu-id="c4bae-130">Wenn ein Schlüssel mit dem TPM-LoadKey2, dem TPM2-Befehl "", dem \_ \_ Befehl "TPM2 Load" oder dem \_ TPM2 \_ loadexternal-Befehl erstellt wird, ersetzt die TSB das Handle im Rückgabe Byte-Stream durch ein virtuelles Schlüssel handle seiner Wahl.</span><span class="sxs-lookup"><span data-stu-id="c4bae-130">If a key is created by using the TPM\_LoadKey2, TPM2\_CreatePrimary, TPM2\_Load, or TPM2\_LoadExternal command, the TBS replaces the handle in the return byte stream with a virtual key handle of its choosing.</span></span> <span data-ttu-id="c4bae-131">Folglich stellt die TSB sicher, dass jedes virtuelle handle eindeutig ist.</span><span class="sxs-lookup"><span data-stu-id="c4bae-131">As a result, the TBS ensures that each virtual handle is unique.</span></span> <span data-ttu-id="c4bae-132">Wenn die TSB eine Kollision erkennt (ein äußerst unwahrscheinliches Ereignis), entlädt die TSB den Schlüssel vom TPM und informiert die aufrufende Software.</span><span class="sxs-lookup"><span data-stu-id="c4bae-132">If the TBS detects a collision (an extremely unlikely event), the TBS unloads the key from the TPM and informs the calling software.</span></span> <span data-ttu-id="c4bae-133">Die Software kann den Vorgang dann erneut übermitteln.</span><span class="sxs-lookup"><span data-stu-id="c4bae-133">The software can then resubmit the operation.</span></span> <span data-ttu-id="c4bae-134">Dieser Vorgang kann wiederholt werden, bis die TSB ein eindeutiges Schlüssel handle erhält.</span><span class="sxs-lookup"><span data-stu-id="c4bae-134">This process can be repeated until the TBS gets a unique key handle.</span></span>

-   <span data-ttu-id="c4bae-135">Löschen von Schlüsseln</span><span class="sxs-lookup"><span data-stu-id="c4bae-135">Clearing Keys</span></span>

    <span data-ttu-id="c4bae-136">Der TSB macht das virtuelle Schlüssel Handle für ungültig, wenn es eine TPM- \_ flushspecific-oder TPM2 \_ flushcontext-Nachricht für dieses virtuelle Handle aus dem Client Kontext empfängt.</span><span class="sxs-lookup"><span data-stu-id="c4bae-136">The TBS invalidates the virtual key handle when it receives a TPM\_FlushSpecific or TPM2\_FlushContext message for that virtual handle from the client context.</span></span> <span data-ttu-id="c4bae-137">Wenn der Schlüssel im TPM physisch vorhanden ist, wenn die Leerungs Nachricht empfangen wird, leert die TSB den Schlüssel zu diesem Zeitpunkt aus dem TPM.</span><span class="sxs-lookup"><span data-stu-id="c4bae-137">If the key is physically present on the TPM when the flush message is received, the TBS flushes the key from the TPM at that time.</span></span>

-   <span data-ttu-id="c4bae-138">Temporäres Entfernen von Schlüsseln</span><span class="sxs-lookup"><span data-stu-id="c4bae-138">Temporarily Removing Keys</span></span>

    <span data-ttu-id="c4bae-139">Wenn Sie einen Schlüssel aus dem TPM entfernen, um Platz für ein neues Element zu schaffen, führt die TSB einen TPM \_ savecontext-oder TPM2 \_ contextsave-Befehl für den Schlüssel aus, bevor Sie ihn entfernen.</span><span class="sxs-lookup"><span data-stu-id="c4bae-139">When evicting a key from the TPM to make room for a new item, the TBS executes a TPM\_SaveContext or TPM2\_ContextSave command on the key before evicting it.</span></span>

-   <span data-ttu-id="c4bae-140">Wiederherstellen von Schlüsseln</span><span class="sxs-lookup"><span data-stu-id="c4bae-140">Restoring Keys</span></span>

    <span data-ttu-id="c4bae-141">Wenn ein Befehl, der auf einen geladenen Schlüssel verweist, an den TSB übermittelt wird, wird sichergestellt, dass der Schlüssel physisch auf dem TPM vorhanden ist.</span><span class="sxs-lookup"><span data-stu-id="c4bae-141">When a command that references a loaded key is submitted to the TBS, it ensures that the key is physically present on the TPM.</span></span> <span data-ttu-id="c4bae-142">Wenn der Schlüssel nicht vorhanden ist, stellt der TSB ihn mit einem TPM- \_ loadcontext oder TPM2 \_ contextload wieder her.</span><span class="sxs-lookup"><span data-stu-id="c4bae-142">If the key is not present, the TBS restores it with a call to TPM\_LoadContext or TPM2\_ContextLoad.</span></span> <span data-ttu-id="c4bae-143">Wenn ein Schlüssel nicht auf dem TPM wieder hergestellt werden kann, gibt TSB ein \_ \_ ungültiges \_ keyHandle als TPM-Ergebnis zurück.</span><span class="sxs-lookup"><span data-stu-id="c4bae-143">If a key cannot be restored to the TPM, the TBS returns TPM\_E\_INVALID\_KEYHANDLE as the TPM result.</span></span>

<span data-ttu-id="c4bae-144">Die TSB ersetzt jedes virtuelle handle, das einem Schlüssel in einem Befehlsdaten Strom zugeordnet ist, durch das physische Handle des Schlüssels, der auf dem TPM geladen wurde.</span><span class="sxs-lookup"><span data-stu-id="c4bae-144">The TBS replaces each virtual handle associated with a key in a command stream with the physical handle of the key loaded on the TPM.</span></span> <span data-ttu-id="c4bae-145">Wenn ein Befehl mit einem virtuellen handle übermittelt wird, das von den TSB nicht im Kontext des Aufrufers erkannt wird, formatiert TSB einen fehlerstream für den Aufrufer mit einem \_ \_ ungültigen keyHandle von TPM E \_ .</span><span class="sxs-lookup"><span data-stu-id="c4bae-145">If a command is submitted with a virtual handle that is not recognized by the TBS in the context of the caller, the TBS formats an error stream for the caller with TPM\_E\_INVALID\_KEYHANDLE.</span></span>

## <a name="authorization-sessions"></a><span data-ttu-id="c4bae-146">Autorisierungs Sitzungen</span><span class="sxs-lookup"><span data-stu-id="c4bae-146">Authorization Sessions</span></span>

<span data-ttu-id="c4bae-147">Autorisierungs Sitzungen werden durch Aufrufen von TPM \_ OIAP, TPM \_ OSAP oder TPM \_ DSAP erstellt.</span><span class="sxs-lookup"><span data-stu-id="c4bae-147">Authorization sessions are created by calling TPM\_OIAP, TPM\_OSAP, or TPM\_DSAP.</span></span> <span data-ttu-id="c4bae-148">In jedem Fall enthält der Rückgabe Byte Datenstrom das physische TPM-Handle der neu erstellten Autorisierungs Sitzung.</span><span class="sxs-lookup"><span data-stu-id="c4bae-148">In each case, the return byte stream contains the physical TPM handle of the newly created authorization session.</span></span> <span data-ttu-id="c4bae-149">Die TSB ersetzt dies durch ein virtuelles handle.</span><span class="sxs-lookup"><span data-stu-id="c4bae-149">The TBS replaces this with a virtual handle.</span></span> <span data-ttu-id="c4bae-150">Beim anschließenden Verweis auf die Autorisierungs Sitzung ersetzt die TSB das virtuelle Handle im Befehlsdaten Strom durch das physische Handle der Autorisierungs Sitzung.</span><span class="sxs-lookup"><span data-stu-id="c4bae-150">When the authorization session is subsequently referenced, the TBS replaces the virtual handle in the command stream with the physical handle of the authorization session.</span></span> <span data-ttu-id="c4bae-151">Die TSB stellt sicher, dass die Lebensdauer der virtuellen Autorisierungs Sitzung mit der der physischen Autorisierungs Sitzung übereinstimmt.</span><span class="sxs-lookup"><span data-stu-id="c4bae-151">The TBS ensures that the lifetime of the virtual authorization session matches that of the physical authorization session.</span></span> <span data-ttu-id="c4bae-152">Wenn ein Client versucht, ein abgelaufenes virtuelles Handle zu verwenden, formatiert TSB einen Fehler Datenstrom mit dem Fehler TPM \_ invalidauthhandle.</span><span class="sxs-lookup"><span data-stu-id="c4bae-152">If a client attempts to use an expired virtual handle, the TBS formats an error stream with error TPM\_INVALIDAUTHHANDLE.</span></span>

<span data-ttu-id="c4bae-153">Sitzungs Slots sind begrenzt, und die TSB kann aus externen Slots bestehen, in denen Sie Autorisierungs Sitzungs Kontexte speichern können.</span><span class="sxs-lookup"><span data-stu-id="c4bae-153">Session slots are limited, and the TBS may run out of external slots in which to save authorization session contexts.</span></span> <span data-ttu-id="c4bae-154">In diesem Fall wählt die TSB eine Autorisierungs Sitzung aus, die für ungültig erklärt werden soll, damit der neue Kontext erfolgreich gespeichert werden kann.</span><span class="sxs-lookup"><span data-stu-id="c4bae-154">If this happens, the TBS chooses an authorization session to invalidate so that the new context can be successfully saved.</span></span> <span data-ttu-id="c4bae-155">Eine Anwendung, die versucht, den alten Kontext zu verwenden, muss die Autorisierungs Sitzung neu erstellen.</span><span class="sxs-lookup"><span data-stu-id="c4bae-155">An application that attempts to use the old context will need to re-create the authorization session.</span></span>

<span data-ttu-id="c4bae-156">Der TSB macht die virtuelle Autorisierungs Sitzung ungültig, wenn einer der folgenden Fälle eintritt:</span><span class="sxs-lookup"><span data-stu-id="c4bae-156">The TBS invalidates the virtual authorization session when any of the following cases occur:</span></span>

-   <span data-ttu-id="c4bae-157">Das Flag für die Fortsetzung der Verwendung, das der Autorisierungs Sitzung im zurückgegebenen Befehlsdaten Strom vom TPM zugeordnet ist, ist **false**.</span><span class="sxs-lookup"><span data-stu-id="c4bae-157">The continue-use flag associated with the authorization session in the returned command stream from the TPM is **FALSE**.</span></span>
-   <span data-ttu-id="c4bae-158">Ein Befehl, der eine Autorisierungs Sitzung verwendet, schlägt fehl.</span><span class="sxs-lookup"><span data-stu-id="c4bae-158">A command that uses an authorization session fails.</span></span>
-   <span data-ttu-id="c4bae-159">Ein Befehl wird ausgeführt, der die mit dem Befehl verknüpfte Autorisierungs Sitzung (z. b. TPM-Aufforderungs Schlüssel) für ungültig erklärt \_ .</span><span class="sxs-lookup"><span data-stu-id="c4bae-159">A command is executed that invalidates the authorization session associated with the command (such as TPM\_CreateWrapKey).</span></span>
-   <span data-ttu-id="c4bae-160">Ein Schlüssel, der einer OSAP-oder DSAP-Sitzung zugeordnet ist, wird durch einen Aufrufen von TPM \_ flushspecific oder TPM2 flushcontext aus dem TPM entfernt \_ (ohne Rücksicht darauf, ob dieser Befehl aus dem TSB oder mit einer höheren Software stammt).</span><span class="sxs-lookup"><span data-stu-id="c4bae-160">A key associated with an OSAP or DSAP session is evicted from the TPM with a call to TPM\_FlushSpecific or TPM2\_FlushContext (without regard to whether this command originated with the TBS or with higher-level software).</span></span>

    <span data-ttu-id="c4bae-161">Die TSB synchronisiert die Autorisierungs Sitzungen nach erfolgreicher Ausführung bestimmter nicht deterministischer Befehle automatisch erneut, um sicherzustellen, dass der TSB-Status mit dem TPM-Status konsistent bleibt.</span><span class="sxs-lookup"><span data-stu-id="c4bae-161">The TBS will automatically resynchronize the authorization sessions after successful execution of certain nondeterministic commands to ensure that the TBS state remains consistent with the TPM state.</span></span> <span data-ttu-id="c4bae-162">Die folgenden Befehle sind betroffen:</span><span class="sxs-lookup"><span data-stu-id="c4bae-162">The affected commands are:</span></span>

    -   <span data-ttu-id="c4bae-163">TPM Ord-Delegat \_ \_ \_ Verwalten</span><span class="sxs-lookup"><span data-stu-id="c4bae-163">TPM\_ORD\_Delegate\_Manage</span></span>
    -   <span data-ttu-id="c4bae-164">TPM Ord-Delegat " \_ \_ \_ kreatebesitzdelegation"</span><span class="sxs-lookup"><span data-stu-id="c4bae-164">TPM\_ORD\_Delegate\_CreateOwnerDelegation</span></span>
    -   <span data-ttu-id="c4bae-165">TPM \_ Ord Delegat \_ \_ loadbesitzdelegierung</span><span class="sxs-lookup"><span data-stu-id="c4bae-165">TPM\_ORD\_Delegate\_LoadOwnerDelegation</span></span>

<span data-ttu-id="c4bae-166">In jedem der folgenden Fälle wird die Autorisierungs Sitzung auf dem TPM automatisch vom TPM geleert:</span><span class="sxs-lookup"><span data-stu-id="c4bae-166">In each of the following cases the authorization session on the TPM is flushed automatically by the TPM:</span></span>

-   <span data-ttu-id="c4bae-167">Erstellen von Autorisierungs Sitzungen</span><span class="sxs-lookup"><span data-stu-id="c4bae-167">Creating Authorization Sessions</span></span>

    <span data-ttu-id="c4bae-168">Die Sitzungs Handles der virtuellen Autorisierung sind nur im Kontext gültig, in dem Sie erstellt wurden, und die zugeordneten Ressourcen werden über die Lebensdauer des zugeordneten Kontexts hinaus nicht beibehalten.</span><span class="sxs-lookup"><span data-stu-id="c4bae-168">Virtual authorization session handles are only valid in the context that created them, and the associated resources are not preserved beyond the life of the associated context.</span></span>

-   <span data-ttu-id="c4bae-169">Löschen von Autorisierungs Sitzungen</span><span class="sxs-lookup"><span data-stu-id="c4bae-169">Clearing Authorization Sessions</span></span>

    <span data-ttu-id="c4bae-170">Der TSB macht die virtuelle Autorisierungs Sitzung ungültig, wenn er einen TPM- \_ flushspecific-oder TPM2 \_ flushcontext-Befehl für das virtuelle Handle aus dem Client Kontext empfängt.</span><span class="sxs-lookup"><span data-stu-id="c4bae-170">The TBS invalidates the virtual authorization session if it receives a TPM\_FlushSpecific or TPM2\_FlushContext command for the virtual handle from the client context.</span></span> <span data-ttu-id="c4bae-171">Wenn die Autorisierungs Sitzung auf dem TPM physisch vorhanden ist, wenn der Flush-Befehl empfangen wird, leert die TSB die physische Sitzung sofort vom TPM.</span><span class="sxs-lookup"><span data-stu-id="c4bae-171">If the authorization session is physically present on the TPM when the flush command is received, the TBS flushes the physical session from the TPM immediately.</span></span>

-   <span data-ttu-id="c4bae-172">Temporäres Entfernen von Autorisierungs Sitzungen</span><span class="sxs-lookup"><span data-stu-id="c4bae-172">Temporarily Removing Authorization Sessions</span></span>

    <span data-ttu-id="c4bae-173">Wenn Sie eine Autorisierungs Sitzung aus dem TPM entfernen, um Platz für eine neue Entität zu schaffen, führt die TSB TPM \_ savecontext oder TPM2 \_ contextsave in dieser Autorisierungs Sitzung aus.</span><span class="sxs-lookup"><span data-stu-id="c4bae-173">When evicting an authorization session from the TPM to make room for a new entity, the TBS executes TPM\_SaveContext or TPM2\_ContextSave on that authorization session.</span></span>

-   <span data-ttu-id="c4bae-174">Autorisierungs Sitzungen</span><span class="sxs-lookup"><span data-stu-id="c4bae-174">Restoring Authorization Sessions</span></span>

    <span data-ttu-id="c4bae-175">Wenn ein autorisierter TPM-Befehl an die TSB übermittelt wird, stellt die TSB sicher, dass alle virtuellen Autorisierungs Sitzungen, auf die im Befehl verwiesen wird, physisch auf dem TPM vorhanden sind.</span><span class="sxs-lookup"><span data-stu-id="c4bae-175">When an authorized TPM command is submitted to the TBS, the TBS ensures that all virtual authorization sessions referred to in the command are physically present on the TPM.</span></span> <span data-ttu-id="c4bae-176">Wenn eine der Autorisierungs Sitzungen nicht vorhanden ist, stellt die TSB Sie mit einem TPM- \_ loadcontext oder TPM2 \_ contextload wieder her.</span><span class="sxs-lookup"><span data-stu-id="c4bae-176">If any of the authorization sessions are not present, the TBS restores them with a call to TPM\_LoadContext or TPM2\_ContextLoad.</span></span> <span data-ttu-id="c4bae-177">Wenn eine Autorisierungs Sitzung nicht auf dem TPM wieder hergestellt werden kann, gibt die TSB ein \_ Ungültiges Handle von TPM E \_ \_ als TPM-Ergebnis zurück.</span><span class="sxs-lookup"><span data-stu-id="c4bae-177">If an authorization session cannot be restored to the TPM, the TBS returns TPM\_E\_INVALID\_HANDLE as the TPM result.</span></span>

<span data-ttu-id="c4bae-178">Die TSB ersetzt alle virtuellen Handles, die einer Autorisierungs Sitzung in einem Befehlsdaten Strom zugeordnet sind, durch das physische Handle der Autorisierungs Sitzung, die auf dem TPM geladen wurde.</span><span class="sxs-lookup"><span data-stu-id="c4bae-178">The TBS replaces each virtual handle associated with an authorization session in a command stream with the physical handle of the authorization session loaded on the TPM.</span></span>

<span data-ttu-id="c4bae-179">Wenn ein Befehl mit einem virtuellen handle übermittelt wird, das von den TSB nicht im Kontext des Aufrufers erkannt wird, formatiert TB einen Fehler Datenstrom für den Aufrufer mit dem Fehler TPM \_ E \_ ungültiges \_ handle.</span><span class="sxs-lookup"><span data-stu-id="c4bae-179">If a command is submitted with a virtual handle that is not recognized by the TBS in the context of the caller, the TBS formats an error stream for the caller with the error TPM\_E\_INVALID\_HANDLE.</span></span>

## <a name="transport-sessions"></a><span data-ttu-id="c4bae-180">Transport Sitzungen</span><span class="sxs-lookup"><span data-stu-id="c4bae-180">Transport Sessions</span></span>

> [!Note]  
> <span data-ttu-id="c4bae-181">Die Verarbeitung von Transport Sitzungen, wie hier beschrieben, ist spezifisch für Windows Vista und Windows Server 2008.</span><span class="sxs-lookup"><span data-stu-id="c4bae-181">The handling of transport sessions as described here is specific to Windows Vista and Windows Server 2008.</span></span>

 

<span data-ttu-id="c4bae-182">Transport Sitzungen sind ein Mechanismus, der vom TPM bereitgestellt wird, das es einem Software Stapel ermöglicht, Daten in einem Befehl bei der Übertragung zwischen der Software und dem TPM zu verschlüsseln.</span><span class="sxs-lookup"><span data-stu-id="c4bae-182">Transport sessions are a mechanism provided by the TPM that enables a software stack to encrypt data in a command as it passes between the software and the TPM.</span></span> <span data-ttu-id="c4bae-183">Dadurch wird verhindert, dass ein Angreifer die Daten abfängt, während er den Hardware Bus übergibt.</span><span class="sxs-lookup"><span data-stu-id="c4bae-183">This prevents an adversary from intercepting the data as it passes over the hardware bus.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="c4bae-184">Nur die Nutzlastdaten werden verschlüsselt.</span><span class="sxs-lookup"><span data-stu-id="c4bae-184">Only the payload data is encrypted.</span></span> <span data-ttu-id="c4bae-185">Die ausgeführten Befehle können weiterhin identifiziert werden.</span><span class="sxs-lookup"><span data-stu-id="c4bae-185">The commands being executed can still be identified.</span></span>

 

<span data-ttu-id="c4bae-186">Leider verhindert dieser Mechanismus auch, dass die TSB Nutzlastdaten untersucht.</span><span class="sxs-lookup"><span data-stu-id="c4bae-186">Unfortunately, this mechanism also prevents the TBS from examining payload data.</span></span> <span data-ttu-id="c4bae-187">In den meisten Fällen ist dies kein Problem, da die TSB nur Handles, keine Nutzlastdaten, ändert.</span><span class="sxs-lookup"><span data-stu-id="c4bae-187">In most cases this is not an issue because the TBS only modifies handles, not payload data.</span></span> <span data-ttu-id="c4bae-188">Im Fall von TPM \_ loadcontext wird das zurückgegebene Ressourcen handle jedoch durch die Verschlüsselung abgedeckt.</span><span class="sxs-lookup"><span data-stu-id="c4bae-188">However, in the case of TPM\_LoadContext for instance, the returned resource handle is covered by the encryption.</span></span> <span data-ttu-id="c4bae-189">Daher verhindert die TSB Versuche, einen TPM \_ loadcontext-Vorgang auszuführen, der von einer Transport Sitzung abgedeckt wird.</span><span class="sxs-lookup"><span data-stu-id="c4bae-189">Therefore, the TBS prevents attempts to perform a TPM\_LoadContext operation covered by a transport session.</span></span>

<span data-ttu-id="c4bae-190">Die TSB blockiert die folgenden Befehle unter Transport Sitzung:</span><span class="sxs-lookup"><span data-stu-id="c4bae-190">The TBS blocks the following commands under transport session:</span></span>

-   <span data-ttu-id="c4bae-191">TPM- \_ integrishtransport</span><span class="sxs-lookup"><span data-stu-id="c4bae-191">TPM\_EstablishTransport</span></span>
-   <span data-ttu-id="c4bae-192">TPM- \_ executetransport</span><span class="sxs-lookup"><span data-stu-id="c4bae-192">TPM\_ExecuteTransport</span></span>
-   <span data-ttu-id="c4bae-193">TPM-Beendigungs \_ \_ handle</span><span class="sxs-lookup"><span data-stu-id="c4bae-193">TPM\_Terminate\_Handle</span></span>
-   <span data-ttu-id="c4bae-194">TPM- \_ loadkey</span><span class="sxs-lookup"><span data-stu-id="c4bae-194">TPM\_LoadKey</span></span>
-   <span data-ttu-id="c4bae-195">TPM \_ evictkey</span><span class="sxs-lookup"><span data-stu-id="c4bae-195">TPM\_EvictKey</span></span>
-   <span data-ttu-id="c4bae-196">TPM \_ savekeycontext</span><span class="sxs-lookup"><span data-stu-id="c4bae-196">TPM\_SaveKeyContext</span></span>
-   <span data-ttu-id="c4bae-197">TPM \_ loadkeycontext</span><span class="sxs-lookup"><span data-stu-id="c4bae-197">TPM\_LoadKeyContext</span></span>
-   <span data-ttu-id="c4bae-198">TPM \_ saveauthcontext</span><span class="sxs-lookup"><span data-stu-id="c4bae-198">TPM\_SaveAuthContext</span></span>
-   <span data-ttu-id="c4bae-199">TPM \_ loadauthcontext</span><span class="sxs-lookup"><span data-stu-id="c4bae-199">TPM\_LoadAuthContext</span></span>
-   <span data-ttu-id="c4bae-200">TPM \_ savecontext</span><span class="sxs-lookup"><span data-stu-id="c4bae-200">TPM\_SaveContext</span></span>
-   <span data-ttu-id="c4bae-201">TPM- \_ loadcontext</span><span class="sxs-lookup"><span data-stu-id="c4bae-201">TPM\_LoadContext</span></span>
-   <span data-ttu-id="c4bae-202">TPM \_ flushspecific</span><span class="sxs-lookup"><span data-stu-id="c4bae-202">TPM\_FlushSpecific</span></span>

<span data-ttu-id="c4bae-203">Wenn einer dieser Befehle durch eine Transport Sitzung abgedeckt ist, wird der TPM E Embedded-Befehl von TSB \_ \_ \_ \_ als TPM-Ergebnis nicht unterstützt zurückgegeben.</span><span class="sxs-lookup"><span data-stu-id="c4bae-203">When any one of these commands is covered by a transport session, the TBS returns TPM\_E\_EMBEDDED\_COMMAND\_UNSUPPORTED as the TPM result.</span></span>

<span data-ttu-id="c4bae-204">Transport Sitzungs Handles werden ähnlich wie Schlüssel Handles und Autorisierungs Handles virtualisiert.</span><span class="sxs-lookup"><span data-stu-id="c4bae-204">Transport session handles are virtualized in a manner similar to key handles and authorization handles.</span></span> <span data-ttu-id="c4bae-205">Es ist eine begrenzte Anzahl gespeicherter Kontext Slots für die Transport Sitzung auf dem TPM verfügbar.</span><span class="sxs-lookup"><span data-stu-id="c4bae-205">There are a limited number of saved transport session context slots available on the TPM.</span></span>

<span data-ttu-id="c4bae-206">Der TSB macht die virtuelle Transport Sitzung ungültig, wenn einer der folgenden Fälle eintritt:</span><span class="sxs-lookup"><span data-stu-id="c4bae-206">The TBS invalidates the virtual transport session if any of the following cases occurs:</span></span>

-   <span data-ttu-id="c4bae-207">Das Flag für die Fortsetzung der Verwendung, das der Transport Sitzung im Rückgabe Befehlsstream aus dem TPM zugeordnet ist, ist **false**.</span><span class="sxs-lookup"><span data-stu-id="c4bae-207">The continue-use flag associated with the transport session in the return command stream from the TPM is **FALSE**.</span></span>

    <span data-ttu-id="c4bae-208">Wie bei den obigen Autorisierungs Sitzungen werden Transport Sitzungen von TSB nach erfolgreicher Ausführung bestimmter nicht deterministischer Befehle automatisch erneut synchronisiert, um sicherzustellen, dass der TSB-Status mit dem TPM-Status konsistent bleibt.</span><span class="sxs-lookup"><span data-stu-id="c4bae-208">As with authorization sessions above, the TBS will automatically resynchronize transport sessions after successful execution of certain nondeterministic commands to ensure that the TBS state remains consistent with the TPM state.</span></span> <span data-ttu-id="c4bae-209">Die folgenden Befehle sind betroffen:</span><span class="sxs-lookup"><span data-stu-id="c4bae-209">The affected commands are:</span></span>

    -   <span data-ttu-id="c4bae-210">TPM Ord-Delegat \_ \_ \_ Verwalten</span><span class="sxs-lookup"><span data-stu-id="c4bae-210">TPM\_ORD\_Delegate\_Manage</span></span>
    -   <span data-ttu-id="c4bae-211">TPM Ord-Delegat " \_ \_ \_ kreatebesitzdelegation"</span><span class="sxs-lookup"><span data-stu-id="c4bae-211">TPM\_ORD\_Delegate\_CreateOwnerDelegation</span></span>
    -   <span data-ttu-id="c4bae-212">TPM \_ Ord Delegat \_ \_ loadbesitzdelegierung</span><span class="sxs-lookup"><span data-stu-id="c4bae-212">TPM\_ORD\_Delegate\_LoadOwnerDelegation</span></span>

<span data-ttu-id="c4bae-213">In jedem dieser Fälle wird die Transport Sitzung auf dem TPM automatisch vom TPM geleert:</span><span class="sxs-lookup"><span data-stu-id="c4bae-213">In each of these cases, the transport session on the TPM will be flushed automatically by the TPM:</span></span>

-   <span data-ttu-id="c4bae-214">Erstellen von Transport Sitzungen</span><span class="sxs-lookup"><span data-stu-id="c4bae-214">Creating Transport Sessions</span></span>

    <span data-ttu-id="c4bae-215">Die TSB erstellt ein virtuelles Handle für jede Transport Sitzung, die von einem Client erstellt wurde.</span><span class="sxs-lookup"><span data-stu-id="c4bae-215">The TBS creates a virtual handle for each transport session created by a client.</span></span> <span data-ttu-id="c4bae-216">Virtuelle Transport Handles sind nur in dem Kontext gültig, in dem Sie erstellt wurden, und die zugeordneten Ressourcen werden über die Lebensdauer des zugeordneten Kontexts hinaus nicht beibehalten.</span><span class="sxs-lookup"><span data-stu-id="c4bae-216">Virtual transport handles are only valid in the context that created them, and the associated resources are not preserved beyond the life of the associated context.</span></span>

-   <span data-ttu-id="c4bae-217">Löschen von Transport Sitzungen</span><span class="sxs-lookup"><span data-stu-id="c4bae-217">Clearing Transport Sessions</span></span>

    <span data-ttu-id="c4bae-218">Der TSB macht die virtuelle Transport Sitzung ungültig, wenn er einen TPM- \_ flushspecific-Befehl für das virtuelle Handle aus dem Client Kontext empfängt.</span><span class="sxs-lookup"><span data-stu-id="c4bae-218">The TBS invalidates the virtual transport session if it receives a TPM\_FlushSpecific command for the virtual handle from the client context.</span></span> <span data-ttu-id="c4bae-219">Wenn die Transport Sitzung auf dem TPM physisch vorhanden ist, wenn der Flush-Befehl empfangen wird, leert die TSB die physische Sitzung sofort vom TPM.</span><span class="sxs-lookup"><span data-stu-id="c4bae-219">If the transport session is physically present on the TPM when the flush command is received, the TBS flushes the physical session from the TPM immediately.</span></span>

-   <span data-ttu-id="c4bae-220">Temporäres Entfernen von Transport Sitzungen</span><span class="sxs-lookup"><span data-stu-id="c4bae-220">Temporarily Removing Transport Sessions</span></span>

    <span data-ttu-id="c4bae-221">Wenn Sie eine Transport Sitzung aus dem TPM entfernen, um Platz für eine neue Entität zu schaffen, führt TSB den TPM \_ savecontext in dieser Transport Sitzung aus.</span><span class="sxs-lookup"><span data-stu-id="c4bae-221">When evicting a transport session from the TPM to make room for a new entity, the TBS executes TPM\_SaveContext on that transport session.</span></span>

-   <span data-ttu-id="c4bae-222">Wiederherstellen von Transport Sitzungen</span><span class="sxs-lookup"><span data-stu-id="c4bae-222">Restoring Transport Sessions</span></span>

    <span data-ttu-id="c4bae-223">Wenn ein TPM- \_ Befehl executetransport an den TSB übermittelt wird, stellt die TSB sicher, dass die Transport Sitzung, auf die im Befehl verwiesen wird, physisch auf dem TPM vorhanden ist.</span><span class="sxs-lookup"><span data-stu-id="c4bae-223">When a TPM\_ExecuteTransport command is submitted to the TBS, the TBS ensures that the transport session referred to in the command is physically present on the TPM.</span></span> <span data-ttu-id="c4bae-224">Wenn die Transport Sitzung nicht vorhanden ist, wird Sie von TSB mit einem TPM-loadcontext-Rückruf wieder hergestellt \_ .</span><span class="sxs-lookup"><span data-stu-id="c4bae-224">If the transport session is not present, the TBS restores it with a call to TPM\_LoadContext.</span></span>

<span data-ttu-id="c4bae-225">Der TSB ersetzt das virtuelle handle, das der Transport Sitzung in einem Befehlsdaten Strom zugeordnet ist, durch das physische Handle der auf dem TPM geladenen Transport Sitzung.</span><span class="sxs-lookup"><span data-stu-id="c4bae-225">The TBS replaces the virtual handle associated with the transport session in a command stream with the physical handle of the transport session loaded on the TPM.</span></span> <span data-ttu-id="c4bae-226">Wenn ein Befehl mit einem virtuellen handle übermittelt wird, das von den TSB nicht im Kontext des Aufrufers erkannt wird, formatiert TB einen Fehler Datenstrom für den Aufrufer mit einem ungültigen Handle von TPM \_ E \_ \_ .</span><span class="sxs-lookup"><span data-stu-id="c4bae-226">If a command is submitted with a virtual handle that is not recognized by the TBS in the context of the caller, the TBS formats an error stream for the caller by using TPM\_E\_INVALID\_HANDLE.</span></span>

## <a name="exclusive-transport-sessions"></a><span data-ttu-id="c4bae-227">Exklusive Transport Sitzungen</span><span class="sxs-lookup"><span data-stu-id="c4bae-227">Exclusive Transport Sessions</span></span>

<span data-ttu-id="c4bae-228">Exklusive umschließende Transport Sitzungen sind eine Möglichkeit für Software auf oberster Ebene, um zu bestimmen, ob eine andere Software während einer Kette von Befehlen auf das TPM zugegriffen hat.</span><span class="sxs-lookup"><span data-stu-id="c4bae-228">Exclusive wrapped transport sessions are a way for top-level software to determine whether any other software has accessed the TPM during a chain of commands.</span></span> <span data-ttu-id="c4bae-229">Sie verhindern nicht, dass andere Software auf das TPM zugreift, sondern nur dem Ersteller der Transport Sitzung eine Möglichkeit zur Bestimmung, dass ein anderer Zugriff aufgetreten ist.</span><span class="sxs-lookup"><span data-stu-id="c4bae-229">They do not prevent other software from accessing the TPM, they just give the creator of the transport session a means of determining that some other access occurred.</span></span> <span data-ttu-id="c4bae-230">Die TSB führt keine spezifischen Aktionen aus, um exklusive Transport Sitzungen zu behindern, aber Sie ist mit Ihnen nicht kompatibel.</span><span class="sxs-lookup"><span data-stu-id="c4bae-230">The TBS does not do anything specific to hinder exclusive transport sessions, but it is somewhat incompatible with them.</span></span> <span data-ttu-id="c4bae-231">Die TSB versucht, das natürliche Verhalten des TPM zu duplizieren, indem Sie transparent ist, sodass keine Befehle aus Kontexten bevorzugt werden, die eine exklusive Transport Sitzung einrichten.</span><span class="sxs-lookup"><span data-stu-id="c4bae-231">The TBS attempts to duplicate the natural behavior of the TPM by being transparent, so it does not favor commands from contexts that establish an exclusive transport session.</span></span> <span data-ttu-id="c4bae-232">Wenn z. B. Client B einen Befehl übermittelt, wenn sich Client a in einer exklusiven Transport Sitzung befindet, wird die exklusive Transport Sitzung von Client a ungültig.</span><span class="sxs-lookup"><span data-stu-id="c4bae-232">For example, if client B submits a command when client A is in an exclusive transport session, then it will invalidate the exclusive transport session of client A.</span></span>

<span data-ttu-id="c4bae-233">Von TSB initiierte Befehle können auch die exklusive Transport Sitzung beenden.</span><span class="sxs-lookup"><span data-stu-id="c4bae-233">Commands initiated by TBS can also terminate the exclusive transport session.</span></span> <span data-ttu-id="c4bae-234">Dies ist der Fall, wenn sich Client a in einer exklusiven Transport Sitzung befindet und ein von Client a ausgeführter Befehl eine Ressource aufruft, die im TPM nicht physisch vorhanden ist.</span><span class="sxs-lookup"><span data-stu-id="c4bae-234">This happens when client A is in an exclusive transport session, and a command executed by client A calls for a resource that is not physically present in the TPM.</span></span> <span data-ttu-id="c4bae-235">Diese Situation bewirkt, dass der TSB-Virtualisierungs-Manager einen TPM \_ loadcontext-Befehl ausführt, um diese Ressource bereitzustellen, wodurch die exklusive Transport Sitzung von Client a beendet wird.</span><span class="sxs-lookup"><span data-stu-id="c4bae-235">This situation triggers the TBS virtualization manager to execute a TPM\_LoadContext command to supply that resource, which terminates the exclusive transport session of client A.</span></span>

 

 




