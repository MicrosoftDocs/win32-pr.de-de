---
title: Gegenseitige Authentifizierung in einem Windows Sockets-Dienst mit SCP
description: Die Themen in diesem Abschnitt enthalten Codebeispiele, die zeigen, wie die gegenseitige Authentifizierung bei einem Dienst durchgeführt wird, der sich mit einem Dienst Verbindungspunkt (Service Connection Point, SCP) veröffentlicht.
ms.assetid: f730464c-95ac-4285-960c-18862f6f7852
ms.tgt_platform: multiple
keywords:
- Gegenseitige Authentifizierung in einem Windows Sockets-Dienst mit einem SCP-AD
- Active Directory, verwenden der gegenseitigen Authentifizierung, Windows Sockets Service mit einem SCP
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 527715c4a35dc15cd67f5820e6fa891b56452399
ms.sourcegitcommit: 803f3ccd65bdefe36bd851b9c6e7280be9489016
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 08/17/2020
ms.locfileid: "103858138"
---
# <a name="mutual-authentication-in-a-windows-sockets-service-with-scp"></a><span data-ttu-id="5df89-105">Gegenseitige Authentifizierung in einem Windows Sockets-Dienst mit SCP</span><span class="sxs-lookup"><span data-stu-id="5df89-105">Mutual Authentication in a Windows Sockets Service with SCP</span></span>

<span data-ttu-id="5df89-106">Die Themen in diesem Abschnitt enthalten Codebeispiele, die zeigen, wie die gegenseitige Authentifizierung bei einem Dienst durchgeführt wird, der sich mit einem Dienst Verbindungspunkt (Service Connection Point, SCP) veröffentlicht.</span><span class="sxs-lookup"><span data-stu-id="5df89-106">The topics in this section include code examples that show how to perform mutual authentication with a service that publishes itself using a service connection point (SCP).</span></span> <span data-ttu-id="5df89-107">Die Beispiele basieren auf einem Microsoft Windows Sockets-Dienst, der ein SSPI-Paket zum Verarbeiten der Aushandlung der gegenseitigen Authentifizierung zwischen einem Client und dem Dienst verwendet.</span><span class="sxs-lookup"><span data-stu-id="5df89-107">The examples are based on a Microsoft Windows Sockets service that uses an SSPI package to handle the mutual authentication negotiation between a client and the service.</span></span> <span data-ttu-id="5df89-108">Verwenden Sie die folgenden Verfahren, um die gegenseitige Authentifizierung innerhalb dieses Szenarios zu implementieren.</span><span class="sxs-lookup"><span data-stu-id="5df89-108">Use the following procedures to implement mutual authentication within this scenario.</span></span>

<span data-ttu-id="5df89-109">**So registrieren Sie SPNs in einem Verzeichnis, wenn ein Dienst installiert ist**</span><span class="sxs-lookup"><span data-stu-id="5df89-109">**To register SPNs in a directory when a service is installed**</span></span>

1.  <span data-ttu-id="5df89-110">Wenden Sie die [**dsgetspn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsgetspna) -Funktion an, um Dienst Prinzipal Namen (SPNs) für den Dienst zu verfassen.</span><span class="sxs-lookup"><span data-stu-id="5df89-110">Call the [**DsGetSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dsgetspna) function to compose service principal names (SPNs) for the service.</span></span>
2.  <span data-ttu-id="5df89-111">Wenden Sie die [**dswrite-accountspn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dswriteaccountspna) -Funktion an, um die SPNs für das Dienst Konto oder das Computer Konto in zu registrieren, in dessen Kontext der Dienst ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="5df89-111">Call the [**DsWriteAccountSpn**](/windows/desktop/api/Ntdsapi/nf-ntdsapi-dswriteaccountspna) function to register the SPNs on the service account or computer account in whose context the service will run.</span></span> <span data-ttu-id="5df89-112">Dieser Schritt muss von einem Domänen Administrator ausgeführt werden. eine Ausnahme besteht darin, dass ein Dienst, der unter dem Konto "LocalSystem" ausgeführt wird, den SPN im Format " <service class> / <host> " für das Computer Konto des Dienst Hosts registrieren kann.</span><span class="sxs-lookup"><span data-stu-id="5df89-112">This step must be performed by a domain administrator; an exception is that a service running under the LocalSystem account can register its SPN in the form "<service class>/<host>" on the computer account of the service host.</span></span>

<span data-ttu-id="5df89-113">**So überprüfen Sie die Konfiguration beim Dienst Start**</span><span class="sxs-lookup"><span data-stu-id="5df89-113">**To verify configuration at service startup**</span></span>

-   <span data-ttu-id="5df89-114">Vergewissern Sie sich, dass die entsprechenden SPNs für das Konto, unter dem der Dienst ausgeführt wird, registriert sind.</span><span class="sxs-lookup"><span data-stu-id="5df89-114">Verify that the appropriate SPNs are registered on the account under which the service is running.</span></span> <span data-ttu-id="5df89-115">Weitere Informationen finden Sie unter [Anmelde Konto-Wartungs Tasks](logon-account-maintenance-tasks.md).</span><span class="sxs-lookup"><span data-stu-id="5df89-115">For more information, see [Logon Account Maintenance Tasks](logon-account-maintenance-tasks.md).</span></span>

<span data-ttu-id="5df89-116">**So authentifizieren Sie den Dienst beim Client Start**</span><span class="sxs-lookup"><span data-stu-id="5df89-116">**To authenticate the service at client startup**</span></span>

1.  <span data-ttu-id="5df89-117">Rufen Sie die Verbindungsdaten vom Dienst Verbindungspunkt des dienstanders ab.</span><span class="sxs-lookup"><span data-stu-id="5df89-117">Retrieve connection data from the service's service connection point.</span></span>
2.  <span data-ttu-id="5df89-118">Stellen Sie eine Verbindung mit dem Dienst her.</span><span class="sxs-lookup"><span data-stu-id="5df89-118">Establish a connection to the service.</span></span>
3.  <span data-ttu-id="5df89-119">Wenden Sie die [**dsmakespn**](/windows/desktop/api/Dsparse/nf-dsparse-dsmakespna) -Funktion an, um einen SPN für den Dienst zu erstellen.</span><span class="sxs-lookup"><span data-stu-id="5df89-119">Call the [**DsMakeSpn**](/windows/desktop/api/Dsparse/nf-dsparse-dsmakespna) function to compose an SPN for the service.</span></span> <span data-ttu-id="5df89-120">Erstellen Sie den SPN aus der Zeichenfolge der bekannten Dienstklasse und die Daten, die vom Dienst Verbindungspunkt abgerufen werden.</span><span class="sxs-lookup"><span data-stu-id="5df89-120">Compose the SPN from the known service class string, and the data retrieved from the service connection point.</span></span> <span data-ttu-id="5df89-121">Diese Daten enthalten den Hostnamen des Servers, auf dem der-Dienst ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="5df89-121">This data includes the host name of the server on which the service is running.</span></span> <span data-ttu-id="5df89-122">Beachten Sie, dass es sich bei dem Hostnamen um einen DNS-Namen handeln muss.</span><span class="sxs-lookup"><span data-stu-id="5df89-122">Be aware that the host name must be a DNS name.</span></span>
4.  <span data-ttu-id="5df89-123">Verwenden Sie ein SSPI-Sicherheitspaket, um die Authentifizierung durchzuführen:</span><span class="sxs-lookup"><span data-stu-id="5df89-123">Use an SSPI security package to perform the authentication:</span></span>
    1.  <span data-ttu-id="5df89-124">Rufen Sie die [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) -Funktion auf, um die Anmelde Informationen des Clients abzurufen.</span><span class="sxs-lookup"><span data-stu-id="5df89-124">Call the [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) function to acquire the client's credentials.</span></span>
    2.  <span data-ttu-id="5df89-125">Übergeben Sie die Client Anmelde Informationen und den SPN an die [**InitializeSecurityContext**](../SecAuthN/initializesecuritycontext--general.md) -Funktion, um ein sicherheitsblob zu generieren, das für die Authentifizierung an den Dienst gesendet werden soll.</span><span class="sxs-lookup"><span data-stu-id="5df89-125">Pass the client credentials and the SPN to the [**InitializeSecurityContext**](../SecAuthN/initializesecuritycontext--general.md) function to generate a security blob to send to the service for authentication.</span></span> <span data-ttu-id="5df89-126">Legen Sie das Flag für die gegenseitige Authentifizierung von **ISC \_ req \_ \_** zum Anfordern der gegenseitigen Authentifizierung fest</span><span class="sxs-lookup"><span data-stu-id="5df89-126">Set the **ISC\_REQ\_MUTUAL\_AUTH** flag to request mutual authentication.</span></span>
    3.  <span data-ttu-id="5df89-127">Exchange-blobdienste bis zum Abschluss der Authentifizierung mit dem Dienst.</span><span class="sxs-lookup"><span data-stu-id="5df89-127">Exchange blobs with the service until the authentication is complete.</span></span>
5.  <span data-ttu-id="5df89-128">Überprüfen Sie die zurückgegebene Funktions Maske für das ISC req-Flag für die **\_ \_ gegenseitige \_** Authentifizierung.</span><span class="sxs-lookup"><span data-stu-id="5df89-128">Verify the returned capabilities mask for the **ISC\_REQ\_MUTUAL\_AUTH** flag to verify that mutual authentication was performed.</span></span>
6.  <span data-ttu-id="5df89-129">Wenn die Authentifizierung erfolgreich war, tauschen Sie den Datenverkehr mit dem authentifizierten Dienst aus.</span><span class="sxs-lookup"><span data-stu-id="5df89-129">If the authentication was successful, exchange traffic with the authenticated service.</span></span> <span data-ttu-id="5df89-130">Verwenden Sie digitales Signieren, um sicherzustellen, dass Nachrichten zwischen Client und Dienst nicht manipuliert wurden.</span><span class="sxs-lookup"><span data-stu-id="5df89-130">Use digital signing to ensure that messages between client and service have not been tampered with.</span></span> <span data-ttu-id="5df89-131">Wenn die Leistungsanforderungen nicht schwerwiegend sind, verwenden Sie die Verschlüsselung.</span><span class="sxs-lookup"><span data-stu-id="5df89-131">Unless performance requirements are severe, use encryption.</span></span> <span data-ttu-id="5df89-132">Weitere Informationen und ein Codebeispiel, das zeigt, wie die Funktionen [**makesignature**](/windows/desktop/api/sspi/nf-sspi-makesignature), [**VerifySignature**](/windows/desktop/api/sspi/nf-sspi-verifysignature), [**verschlüsseltmessage**](../SecAuthN/encryptmessage--general.md)und [**DecryptMessage**](../SecAuthN/decryptmessage--general.md) in einem SSPI-Paket verwendet werden, finden Sie unter [sicherstellen der Kommunikations Integrität während des Nachrichten Austauschs](/windows/desktop/SecAuthN/ensuring-communication-integrity-during-message-exchange).</span><span class="sxs-lookup"><span data-stu-id="5df89-132">For more information and a code example that shows how to use the [**MakeSignature**](/windows/desktop/api/sspi/nf-sspi-makesignature), [**VerifySignature**](/windows/desktop/api/sspi/nf-sspi-verifysignature), [**EncryptMessage**](../SecAuthN/encryptmessage--general.md), and [**DecryptMessage**](../SecAuthN/decryptmessage--general.md) functions in an SSPI package, see [Ensuring Communication Integrity During Message Exchange](/windows/desktop/SecAuthN/ensuring-communication-integrity-during-message-exchange).</span></span>

<span data-ttu-id="5df89-133">**So authentifizieren Sie den Client durch den Dienst, wenn ein Client eine Verbindung herstellt**</span><span class="sxs-lookup"><span data-stu-id="5df89-133">**To authenticate the client by the service when a client connects**</span></span>

1.  <span data-ttu-id="5df89-134">Laden eines SSPI-Sicherheitspakets, das die gegenseitige Authentifizierung unterstützt.</span><span class="sxs-lookup"><span data-stu-id="5df89-134">Load an SSPI security package that supports mutual authentication.</span></span>
2.  <span data-ttu-id="5df89-135">Wenn ein Client eine Verbindung herstellt, verwenden Sie das Sicherheitspaket, um die Authentifizierung durchzuführen:</span><span class="sxs-lookup"><span data-stu-id="5df89-135">When a client connects, use the security package to perform the authentication:</span></span>
    1.  <span data-ttu-id="5df89-136">Rufen Sie die [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) -Funktion auf, um die Dienst Anmelde Informationen abzurufen.</span><span class="sxs-lookup"><span data-stu-id="5df89-136">Call the [**AcquireCredentialsHandle**](../SecAuthN/acquirecredentialshandle--general.md) function to acquire the service credentials.</span></span>
    2.  <span data-ttu-id="5df89-137">Übergeben Sie die Dienst Anmelde Informationen und das vom Client empfangene sicherheitsblob an die [**Accept-SecurityContext**](../SecAuthN/acceptsecuritycontext--general.md) -Funktion, um ein sicherheitsblob zu generieren, das an den Client zurückgesendet werden soll.</span><span class="sxs-lookup"><span data-stu-id="5df89-137">Pass the service credentials and the security blob received from the client to the [**AcceptSecurityContext**](../SecAuthN/acceptsecuritycontext--general.md) function to generate a security blob to send back to the client.</span></span>
    3.  <span data-ttu-id="5df89-138">Exchange-blobschauf dem Client, bis die Authentifizierung beendet ist.</span><span class="sxs-lookup"><span data-stu-id="5df89-138">Exchange blobs with the client until the authentication is complete.</span></span>
3.  <span data-ttu-id="5df89-139">Überprüfen Sie die zurückgegebene Funktions Maske für das ASC ret-Flag für die **\_ \_ gegenseitige \_** Authentifizierung, um sicherzustellen, dass die gegenseitige Authentifizierung</span><span class="sxs-lookup"><span data-stu-id="5df89-139">Check the returned capabilities mask for the **ASC\_RET\_MUTUAL\_AUTH** flag to verify that mutual authentication was performed.</span></span>
4.  <span data-ttu-id="5df89-140">Wenn die Authentifizierung erfolgreich war, tauschen Sie den Datenverkehr mit dem authentifizierten Client aus.</span><span class="sxs-lookup"><span data-stu-id="5df89-140">If the authentication was successful, exchange traffic with the authenticated client.</span></span> <span data-ttu-id="5df89-141">Verwenden Sie digitale Signaturen und Verschlüsselung, es sei denn, die Leistung ist ein Problem</span><span class="sxs-lookup"><span data-stu-id="5df89-141">Use digital signing and encryption unless performance is an issue.</span></span>

<span data-ttu-id="5df89-142">Weitere Informationen und ein Codebeispiel für dieses Szenario für die gegenseitige Authentifizierung finden Sie unter:</span><span class="sxs-lookup"><span data-stu-id="5df89-142">For more information and a code example for this mutual authentication scenario, see:</span></span>

-   [<span data-ttu-id="5df89-143">Authentifizieren eines SCP-basierten Windows Sockets-Dienstanbieter durch einen Client</span><span class="sxs-lookup"><span data-stu-id="5df89-143">How a Client Authenticates an SCP-based Windows Sockets Service</span></span>](how-a-client-authenticates-an-scp-based-windows-sockets-service.md)
-   [<span data-ttu-id="5df89-144">Erstellen und Registrieren von SPNs für einen SCP-basierten Windows Sockets-Dienst</span><span class="sxs-lookup"><span data-stu-id="5df89-144">Composing and Registering SPNs for an SCP-based Windows Sockets Service</span></span>](composing-and-registering-spns-for-an-scp-based-windows-sockets-service.md)
-   [<span data-ttu-id="5df89-145">Authentifizieren eines Clients durch einen Windows-Sockets-Dienst</span><span class="sxs-lookup"><span data-stu-id="5df89-145">How a Windows Sockets Service Authenticates a Client</span></span>](how-a-windows-sockets-service-authenticates-a-client.md)

<span data-ttu-id="5df89-146">Weitere Informationen finden Sie unter</span><span class="sxs-lookup"><span data-stu-id="5df89-146">For more information, see:</span></span>

-   [<span data-ttu-id="5df89-147">Veröffentlichen mit Dienst Verbindungs Punkten</span><span class="sxs-lookup"><span data-stu-id="5df89-147">Publishing with service connection points</span></span>](publishing-with-service-connection-points.md)
-   [<span data-ttu-id="5df89-148">SSPI-Dokumentation</span><span class="sxs-lookup"><span data-stu-id="5df89-148">SSPI documentation</span></span>](/windows/desktop/SecAuthN/sspi)
-   [<span data-ttu-id="5df89-149">Dokumentation zu Windows Sockets</span><span class="sxs-lookup"><span data-stu-id="5df89-149">Windows Sockets documentation</span></span>](/windows/desktop/WinSock/windows-sockets-start-page-2)

 

 