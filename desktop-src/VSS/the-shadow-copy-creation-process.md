---
description: Der Erstellungs Vorgang für Schatten Kopien
ms.assetid: ca484eec-31c6-4790-9232-3ed67263f6fb
title: Der Erstellungs Vorgang für Schatten Kopien
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 4239e2b671edcaeb35b404d9b9411b43316c0212
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/07/2021
ms.locfileid: "103751600"
---
# <a name="the-shadow-copy-creation-process"></a>Der Erstellungs Vorgang für Schatten Kopien

Im folgenden finden Sie eine ausführliche Beschreibung der Rolle des Hardware Anbieters bei der Erstellung eines schattenkopiesatzes. Ein Diagramm dieses Prozesses finden Sie unter [Erstellen von Schatten Kopien für Anbieter](shadow-copy-creation-for-providers.md).

1.  Wenn die anfordernde Person jedes Volume dem Schattenkopiesatz hinzufügt, bestimmt VSS die zugeordneten LUNs. Ein übergreifendes Volume könnte beispielsweise aus mehreren LUNs bestehen. VSS erstellt mithilfe physischer Geräteinformationen für jede LUN eine anfängliche [**VDS- \_ LUN- \_ Information**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) .
2.  VSS ruft [**arelunssupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported) auf, um zu bestimmen, ob der Anbieter eine Schatten Kopie für diese LUN unterstützt. Der Hardware Anbieter verwendet die [**VDS- \_ LUN- \_ Informationen**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) , um zu bestimmen, ob die LUNs unterstützt werden. Diese Bestimmung muss alle oder nichts sein – derselbe Hardware Anbieter muss alle LUNs unterstützen, die zu einem bestimmten Volume beitragen. Im Beispiel mit einem übergreifenden Volume kann der Anbieter nicht angeben, dass er nur eine der LUNs unterstützt, aus denen das Volume besteht.
3.  Für jedes Volume im Schattenkopiesatz ruft VSS [**ivsshardwaresnapshotprovider:: beginpreparesnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-beginpreparesnapshot) mit dem gleichen Array von [**VDS- \_ LUN- \_ Informations**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) Strukturen auf. In einem einzelnen Aufruf sind alle LUNs im Array eindeutig, aber die gleiche LUN kann in einem nachfolgenden Aufruf vorkommen, wenn die gleiche LUN zu mehreren Volumes beiträgt. Der Anbieter muss diesen Fall ordnungsgemäß behandeln.
4.  Unmittelbar nach [**ivssproviderkreatesnapshotset:: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)legt VSS den schreibgeschützten, versteckten, nicht Laufwerksbuchstaben und schattenkopieflags für alle betroffenen LUNs fest. Die Flags werden mithilfe von ausgeblendeten Sektoren auf MBR-Datenträgern oder betriebssystemspezifischen Bits im Partitions Header Eintrag auf GPT-Datenträgern implementiert. Die Flags bewirken, dass alle Volumes auf den betroffenen Datenträgern auf den empfangenden Computern als schreibgeschützt und ausgeblendet angezeigt werden. Beachten Sie, dass für die schattenkopierten LUNs in dieser Phase kein Commit ausgeführt wurde, sodass im Falle eines Systemabsturzes die Flags gelöscht werden und die ursprüngliche LUN nicht beeinträchtigt wird. Das heißt, alle Volumes auf der ursprünglichen LUN werden als normal behandelt – und behalten ihre ursprünglichen Laufwerk Buchstaben Zuweisungen, eingebundenen Ordner und Lese-/Schreibstatus bei.
    > [!Note]  
    > Anbieter sollten nicht versuchen, die LUN-Flags zu ändern.

     

5.  Bei [**commitmomentaufnahmen**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)wird ein Commit für die schattenkopieluns ausgeführt. **Commitmomentaufnahmen** sollten innerhalb weniger Sekunden zurückgegeben werden, oder der gesamte Vorgang zum Erstellen von Schatten Kopien wird wahrscheinlich fehlschlagen.
6.  Nach [**commitmomentaufnahmen**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-commitsnapshots)löscht VSS die Flags für alle ursprünglichen LUNs, die an der Schatten Kopie beteiligt sind. Da für die schattenkopieluns an dieser Stelle ein Commit ausgeführt wurde, behalten die schattenkopieluns diese Flags bei.
7.  Nach dem [**ivssproviderkreatesnapshotset::P ostcommitsnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postcommitsnapshots)löscht VSS die LUN-Flags (die nach [**ivssproviderkreatesnapshotset:: EndPrepareSnapshots**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-endpreparesnapshots)festgelegt sind) und benachrichtigt die Writer, Sie zu überschreiben. VSS ruft dann die [**ivssproviderkreatesnapshotset::P verfeinern**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-prefinalcommitsnapshots) -und [**ivssproviderkreatesnapshotset::P ostfinalcommitsnapshot**](/windows/desktop/api/VsProv/nf-vsprov-ivssprovidercreatesnapshotset-postfinalcommitsnapshots) -Methoden des Anbieters auf.
8.  VSS ruft ein Array von [**VDS- \_ LUN- \_ Informations**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) Strukturen ab, eine für jede neu erstellte schattenkopielun, indem [**ivsshardwaresnapshotprovider:: gettargetluns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns)aufgerufen wird. Der Anbieter muss genügend Informationen bereitstellen, damit VSS und der Anbieter die Schatten Kopien zu einem späteren Zeitpunkt und auf jedem mit dem Subsystem verbundenen System identifizieren können. Zu diesem Zeitpunkt sollten die schattenkopieluns für diesen Computer nicht zugänglich sein – der Anbieter muss einen anderen Mechanismus als durch einfaches Lesen der Informationen aus der LUN verwenden.
9.  Für austauschen-Schatten Kopien fügt VSS Folgendes an das Dokument mit den Sicherungs Komponenten an, in dem der Schattenkopiesatz beschrieben wird:
    1.  Das ursprüngliche LUN [**VDS- \_ LUN- \_ Informations**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) Array.
    2.  Das neue [**VDS- \_ LUN- \_ Informations**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) Array der schattenkopievds.
    3.  Die Datenträger Blöcke für jedes Volume im Schattenkopiesatz.
10. Beim automatischen Importieren von Schatten Kopien beginnt der Import Vorgang. In [**ivsshardwaresnapshotprovider:: lokatuns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns)erhält der Anbieter die [**VDS- \_ LUN- \_ Informationen**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) , die zur Erstellungszeit in [**gettargetluns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) generiert werden. Während **loeruns** sollte der Anbieter diese schattenkopieluns für das System sichtbar machen. Der Anbieter sollte keinen busneuscan auslösen. VSS bewirkt, dass bei der erneuten Überprüfung und Enumeration die LUNs von PNP und den Volumes wieder online gestellt werden.
11. VSS ruft [**ivsshardwaresnapshotprovider:: fillinluninfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) für die neu eingegangenen Datenträger im System auf. VSS verwendet das VDS-LUNs- [**\_ \_ Informations**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) Array der Schattenkopie von **fillinluninfo** und vergleicht es mit den **VDS- \_ LUN- \_ Informationen** , die während der Erstellung in [**gettargetluns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) generiert werden, und die Datenträger Blöcke für jedes Volume im Schattenkopiesatz, um die neu eingegangenen schattenkopieluns zu identifizieren.
12. An diesem Punkt werden alle in den schattenkopieluns enthaltenen Volumes ausgeblendet und schreibgeschützt bereitgestellt, und VSS verfügt über eine Zuordnung vom ursprünglichen Volume zum Schattenkopievolume.

Da eine einzelne LUN Teile mehrerer Volumes enthalten kann, können die schattenkopieluns "zusätzliche" Volumes enthalten. Diese Volumes sind nicht Teil der Schattenkopiesatz und sollten nicht verwendet werden, da Sie nicht sicher sind, dass Sie einheitlich sind.

Nach dem Import kann auf die Schatten Kopie über die [**IVssBackupComponents:: Query**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-query) -Methode zugegriffen werden. Eine Schatten Kopie kann auch als Laufwerksbuchstabe, eingebundenes Ordner oder Freigabe mithilfe von [**IVssBackupComponents:: exposesnapshot**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-exposesnapshot)verfügbar gemacht werden. Ein Schattenkopiesatz kann auch mit der [**IVssBackupComponents:: breaksnapshotset**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-breaksnapshotset) -Methode in eine reguläre LUN konvertiert werden. Von dort aus können Verwaltungs Anwendungen geeignete Datenträger Verwaltungs-APIs verwenden, um die LUN weiter zu verwalten (z. b. das Ändern der Lese-/Schreibattribute)

### <a name="transportable-shadow-copies-on-a-san"></a>Über transportable Schatten Kopien in einem San

Ab Windows Server 2003, Datacenter Edition und Windows Server 2003 Enterprise Edition ermöglicht VSS die übertragbare schattenkopiesätze in einem San. Aus Sicht eines Anbieters, der LUNs zwischen Hosts transportieren kann, besteht nur wenig oder kein Unterschied zwischen einem nicht austauschen-und einem austauschen-Schatten Kopiesatz.

**Windows Server 2003, Standard Edition, Windows Server 2003, Web Edition und Windows XP:** Transportable-schattenkopiesätze werden nicht unterstützt. Alle Editionen von Windows Server 2003 mit Service Pack 1 (SP1) unterstützen austauschen schattenkopiesätze.

Transportable-schattenkopiesätze müssen mit dem VSS-Attribut " **\_ Volsnap \_ attr \_ transportable** " erstellt werden, das dem [**Kontext der Schatten \_ \_ \_ \_**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes) Kopie hinzugefügt wird Alle Volumes in der Gruppe müssen transportierbar sein. Durch Zurückgeben des Erfolgs von [**ivsshardwaresnapshotprovider:: arelunssupported**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-arelunssupported)gibt der Anbieter an, dass er nicht nur die LUN unterstützt, sondern auch, dass er die LUN transportieren kann. Die Erstellung eines austauschen-schattenkopiesatzes endet, wenn VSS die LUN-Informationen im Dokument mit den Sicherungs Komponenten aufzeichnet. Ein Schattenkopiesatz kann nur einmal nach der anfänglichen Erstellung importiert werden.

Auf dem empfangenden Computer importiert der Anforderer den Schattenkopiesatz. Die [**IVssBackupComponents:: importshots**](/windows/desktop/api/VsBackup/nf-vsbackup-ivssbackupcomponents-importsnapshots) -Methode verwendet das Sicherungs Komponenten Dokument, das den als Eingabe festgelegten Schattenkopiesatz beschreibt. Der Import erfolgt durch:

1.  VSS erstellt ein Array von [**VDS- \_ LUN- \_ Informations**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) Strukturen mit Schatten Kopien aus dem Dokument mit den Sicherungs Komponenten.
2.  Wenn VSS [**ivsshardwaresnapshotprovider:: loeruns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-locateluns)aufruft, wird das Array der [**VDS- \_ LUN- \_ Informations**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) Strukturen, die in [**ivsshardwaresnapshotprovider:: gettargetluns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) generiert werden, an den Anbieter übermittelt. Beim Verarbeiten dieser Methode sollte der Anbieter diese schattenkopieluns für das System sichtbar machen. Der Anbieter sollte keinen busneuscan auslösen. VSS löst die erneute Überprüfung und Enumeration aus, damit die LUNs von PNP und den Volumes wieder online gestellt werden können.
3.  VSS ruft [**ivsshardwaresnapshotprovider:: fillinluninfo**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-fillinluninfo) für die neu eingegangenen Datenträger im System auf. VSS verwendet das schattenkopiearray von [**VDS- \_ LUN- \_ Informations**](/windows/win32/api/vdslun/ns-vdslun-vds_lun_information) Strukturen aus **fillinluninfo** und vergleicht es mit den **VDS- \_ LUN- \_ Informationen** , die bei der Erstellung von schattenkopietrichten in [**gettargetluns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) generiert werden, und die Datenträger Blöcke für jedes Volume im Schattenkopiesatz, um die neu eingegangenen Schatten Kopien
4.  An diesem Punkt werden alle Volumes, die in den Transporten LUNs enthalten sind, ausgeblendet und schreibgeschützt bereitgestellt, und VSS verfügt über eine Zuordnung zwischen dem ursprünglichen Volume und dem Schattenkopievolume.

Für den einzelnen Computer und den austauschen-Fall ähnelt die Sequenz dem Zeitpunkt, an dem [**gettargetluns**](/windows/desktop/api/VsProv/nf-vsprov-ivsshardwaresnapshotprovider-gettargetluns) aufgerufen wird. Für den automatischen Import erfolgen die Schritte direkt nach der Erstellung.

 

 
