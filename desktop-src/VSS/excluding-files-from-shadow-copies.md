---
description: In Windows Vista und Windows Server 2008 und höher kann der Entwickler einer VSS Writer oder Anwendung bestimmte Dateien aus Schatten Kopien ausschließen.
ms.assetid: 4fe1ae94-7b2f-421a-9009-3a7e88822458
title: Ausschließen von Dateien aus Schatten Kopien
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 52546c8ddc6da62433dc610f2bf4fc2c46c5e53f
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/08/2021
ms.locfileid: "104218321"
---
# <a name="excluding-files-from-shadow-copies"></a><span data-ttu-id="5f68f-103">Ausschließen von Dateien aus Schatten Kopien</span><span class="sxs-lookup"><span data-stu-id="5f68f-103">Excluding Files from Shadow Copies</span></span>

<span data-ttu-id="5f68f-104">In Windows Vista und Windows Server 2008 und höher kann der Entwickler einer VSS Writer oder Anwendung bestimmte Dateien aus Schatten Kopien ausschließen.</span><span class="sxs-lookup"><span data-stu-id="5f68f-104">In Windows Vista and Windows Server 2008 and later, the developer of a VSS writer or application may choose to exclude certain files from shadow copies.</span></span>

<span data-ttu-id="5f68f-105">Der Speicherbereich "Leistung und Schatten Kopie" (auch als "diff Area" bezeichnet) der Verwendung einer Datei in einer Schatten Kopie hängt direkt mit der Menge der Änderungen im Inhalt der Datei zusammen, nachdem die Schatten Kopie erstellt wurde.</span><span class="sxs-lookup"><span data-stu-id="5f68f-105">The performance impact and shadow copy storage area (also called "diff area") usage of a file in a shadow copy are directly related to the amount of change in the file's contents after the shadow copy is created.</span></span> <span data-ttu-id="5f68f-106">Außerdem kann das Ausschließen von Dateien aus Schatten Kopien die Erstellung von Schatten Kopien verlangsamen.</span><span class="sxs-lookup"><span data-stu-id="5f68f-106">In addition, excluding files from shadow copies may slow down shadow copy creation.</span></span>

<span data-ttu-id="5f68f-107">Aus diesen Gründen sollte eine Datei nur dann aus Schatten Kopien ausgeschlossen werden, wenn Sie groß ist, eine bedeutende Änderung zwischen einer Schatten Kopie und der nächsten besteht und nicht gesichert werden muss.</span><span class="sxs-lookup"><span data-stu-id="5f68f-107">For these reasons, a file should be excluded from shadow copies only if it is large, undergoes significant change between one shadow copy and the next, and does not need to be backed up.</span></span>

<span data-ttu-id="5f68f-108">Sie sollten nur Dateien ausschließen, die zu Ihrer Anwendung gehören.</span><span class="sxs-lookup"><span data-stu-id="5f68f-108">You should only exclude files that belong to your application.</span></span>

<span data-ttu-id="5f68f-109">Wenn VSS \_ Volsnap \_ attr \_ kein \_ AutoRecovery-Flag im schattenkopieskontext festgelegt ist, bedeutet dies, dass die automatische Wiederherstellung deaktiviert ist und keine Dateien aus der Schatten Kopie ausgeschlossen werden können.</span><span class="sxs-lookup"><span data-stu-id="5f68f-109">If the VSS\_VOLSNAP\_ATTR\_NO\_AUTORECOVERY flag is set in the shadow copy context, this means that auto-recovery is disabled, and no files can be excluded from the shadow copy.</span></span> <span data-ttu-id="5f68f-110">Weitere Informationen finden Sie unter [**\_ VSS \_ Volume \_ Snapshot \_ Attribute**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes) Enumeration.</span><span class="sxs-lookup"><span data-stu-id="5f68f-110">For more information, see the [**\_VSS\_VOLUME\_SNAPSHOT\_ATTRIBUTES**](/windows/desktop/api/Vss/ne-vss-vss_volume_snapshot_attributes) enumeration.</span></span>

## <a name="using-the-addexcludefilesfromsnapshot-method"></a><span data-ttu-id="5f68f-111">Verwenden der addexcludefilesfromsnapshot-Methode</span><span class="sxs-lookup"><span data-stu-id="5f68f-111">Using the AddExcludeFilesFromSnapshot Method</span></span>

<span data-ttu-id="5f68f-112">Mit einem VSS Writer können Dateien wie folgt aus einer Schatten Kopie ausgeschlossen werden:</span><span class="sxs-lookup"><span data-stu-id="5f68f-112">A VSS writer can exclude files from a shadow copy as follows:</span></span>

1.  <span data-ttu-id="5f68f-113">Aufrufen der [**IVssCreateWriterMetadataEx:: addexcludefilesfromsnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadataex-addexcludefilesfromsnapshot) -Methode, um die auszuschließenden Dateien zu melden.</span><span class="sxs-lookup"><span data-stu-id="5f68f-113">Call the [**IVssCreateWriterMetadataEx::AddExcludeFilesFromSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-ivsscreatewritermetadataex-addexcludefilesfromsnapshot) method to report the files to be excluded.</span></span>
2.  <span data-ttu-id="5f68f-114">Löschen Sie in der [**CVssWriter:: OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) -Methode des Writers die Dateien aus der Schatten Kopie.</span><span class="sxs-lookup"><span data-stu-id="5f68f-114">In the writer's [**CVssWriter::OnPostSnapshot**](/windows/desktop/api/VsWriter/nf-vswriter-cvsswriter-onpostsnapshot) method, delete the files from the shadow copy.</span></span>

## <a name="using-the-filesnottosnapshot-registry-key"></a><span data-ttu-id="5f68f-115">Verwenden des Registrierungsschlüssels "filesnottosnapshot"</span><span class="sxs-lookup"><span data-stu-id="5f68f-115">Using the FilesNotToSnapshot Registry Key</span></span>

> [!Note]  
> <span data-ttu-id="5f68f-116">Der Registrierungsschlüssel **FilesNotToSnapshot** sollte nur von Anwendungen verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="5f68f-116">The **FilesNotToSnapshot** registry key is intended to be used only by applications.</span></span> <span data-ttu-id="5f68f-117">Benutzer, die versuchen, den Registrierungsschlüssel zu verwenden, erhalten Einschränkungen wie die folgenden:</span><span class="sxs-lookup"><span data-stu-id="5f68f-117">Users who attempt to use it will encounter limitations such as the following:</span></span>
>
> -   <span data-ttu-id="5f68f-118">Es können keine Dateien aus einer Schattenkopie gelöscht werden, die unter Windows Server mit dem Feature „Vorherige Versionen“ erstellt wurden.</span><span class="sxs-lookup"><span data-stu-id="5f68f-118">It cannot delete files from a shadow copy that was created on a Windows Server by using the Previous Versions feature.</span></span>
> -   <span data-ttu-id="5f68f-119">Es können keine Dateien aus Schattenkopien für freigegebene Ordner gelöscht werden.</span><span class="sxs-lookup"><span data-stu-id="5f68f-119">It cannot delete files from shadow copies for shared folders.</span></span>
> -   <span data-ttu-id="5f68f-120">Es können Dateien aus einer Schatten Kopie gelöscht werden, die mit dem Hilfsprogramm [DiskShadow](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc772172(v=ws.11)) erstellt wurde, aber es können keine Dateien aus einer Schatten Kopie gelöscht werden, die mit dem Hilfsprogramm [vssadmin](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc754968(v=ws.11)) erstellt wurde.</span><span class="sxs-lookup"><span data-stu-id="5f68f-120">It can delete files from a shadow copy that was created by using the [DiskShadow](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc772172(v=ws.11)) utility, but it cannot delete files from a shadow copy that was created by using the [Vssadmin](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc754968(v=ws.11)) utility.</span></span>
> -   <span data-ttu-id="5f68f-121">Dateien werden auf Grundlage der besten Leistung aus einer Schattenkopie gelöscht.</span><span class="sxs-lookup"><span data-stu-id="5f68f-121">Files are deleted from a shadow copy on a best-effort basis.</span></span> <span data-ttu-id="5f68f-122">Das bedeutet, dass Sie nicht unbedingt gelöscht werden.</span><span class="sxs-lookup"><span data-stu-id="5f68f-122">This means that they are not guaranteed to be deleted.</span></span>

 

<span data-ttu-id="5f68f-123">Eine VSS-Anwendung kann Dateien aus einer Schatten Kopie während der Erstellung von Schatten Kopien löschen, indem der folgende Registrierungsschlüssel verwendet wird:</span><span class="sxs-lookup"><span data-stu-id="5f68f-123">A VSS application can delete files from a shadow copy during shadow copy creation by using the following registry key:</span></span>

<span data-ttu-id="5f68f-124">**HKEY \_ local \_ Machine \\ System \\ CurrentControlSet \\ Control \\ backuprestore \\ filesnottosnapshot**</span><span class="sxs-lookup"><span data-stu-id="5f68f-124">**HKEY\_LOCAL\_MACHINE\\System\\CurrentControlSet\\Control\\BackupRestore\\FilesNotToSnapshot**</span></span>

<span data-ttu-id="5f68f-125">Dieser Registrierungsschlüssel enthält reg \_ \_ MultiSZ-Werte für jede Anwendung, deren Dateien ausgeschlossen werden können.</span><span class="sxs-lookup"><span data-stu-id="5f68f-125">This registry key has REG\_MULTI\_SZ values for each application whose files can be excluded.</span></span> <span data-ttu-id="5f68f-126">Die Dateien werden durch voll qualifizierte Pfade angegeben, die den Platzhalter enthalten können \* .</span><span class="sxs-lookup"><span data-stu-id="5f68f-126">The files are specified by fully qualified paths, which can contain the \* wildcard.</span></span>

<span data-ttu-id="5f68f-127">In allen Fällen wird der Eintrag ignoriert, wenn keine Dateien vorhanden sind, die der Pfad Zeichenfolge entsprechen.</span><span class="sxs-lookup"><span data-stu-id="5f68f-127">In all cases, the entry is ignored if there are no files that match the path string.</span></span>

<span data-ttu-id="5f68f-128">Nachdem eine Datei zum entsprechenden Wert des Registrierungsschlüssels hinzugefügt wurde, wird Sie aus der Schatten Kopie bei der Erstellung vom schattenkopieoptimierungs-Writer auf der Grundlage der besten Leistung gelöscht.</span><span class="sxs-lookup"><span data-stu-id="5f68f-128">After a file is added to the appropriate registry key value, it is deleted from the shadow copy during creation by the shadow copy optimization writer on a best-effort basis.</span></span>

<span data-ttu-id="5f68f-129">Wenn kein voll qualifizierter Pfad angegeben werden kann, kann ein Pfad auch mit der Variablen $USERPROFILE $ oder $AllVolumes $ impliziert werden.</span><span class="sxs-lookup"><span data-stu-id="5f68f-129">If a fully qualified path cannot be specified, then a path can also be implied by using the $UserProfile$ or $AllVolumes$ variable.</span></span> <span data-ttu-id="5f68f-130">Beispiel:</span><span class="sxs-lookup"><span data-stu-id="5f68f-130">For example:</span></span>

-   <span data-ttu-id="5f68f-131">$UserProfile $ \\ Directory- \\ Unterverzeichnis \\ Dateiname.\*</span><span class="sxs-lookup"><span data-stu-id="5f68f-131">$UserProfile$\\Directory\\Subdirectory\\FileName.\*</span></span>
-   <span data-ttu-id="5f68f-132">$AllVolumes $ \\ TemporaryFiles \\ \* .\*</span><span class="sxs-lookup"><span data-stu-id="5f68f-132">$AllVolumes$\\TemporaryFiles\\\*.\*</span></span>

<span data-ttu-id="5f68f-133">Um den Pfad rekursiv zu machen, fügen Sie am Ende "/s" an.</span><span class="sxs-lookup"><span data-stu-id="5f68f-133">To make the path recursive, append " /s" to the end.</span></span> <span data-ttu-id="5f68f-134">Beispiel:</span><span class="sxs-lookup"><span data-stu-id="5f68f-134">For example:</span></span>

-   <span data-ttu-id="5f68f-135">$UserProfile $ \\ Directory \\ Unterverzeichnis \\ Dateiname. \* /s</span><span class="sxs-lookup"><span data-stu-id="5f68f-135">$UserProfile$\\Directory\\Subdirectory\\FileName.\* /s</span></span>
-   <span data-ttu-id="5f68f-136">$AllVolumes $ \\ TemporaryFiles \\ \* . \* /s</span><span class="sxs-lookup"><span data-stu-id="5f68f-136">$AllVolumes$\\TemporaryFiles\\\*.\* /s</span></span>

<span data-ttu-id="5f68f-137">Die Variable $USERPROFILE $ bewirkt, dass die Pfad Zeichenfolge auf alle Benutzerprofile auf dem Computer angewendet wird.</span><span class="sxs-lookup"><span data-stu-id="5f68f-137">The $UserProfile$ variable causes the path string to be applied to all user profiles on the computer.</span></span> <span data-ttu-id="5f68f-138">Die Benutzerprofile werden durch Untersuchen des folgenden Registrierungsschlüssels aufgelistet:</span><span class="sxs-lookup"><span data-stu-id="5f68f-138">The user profiles are enumerated by examining the following registry key:</span></span>

<span data-ttu-id="5f68f-139">**HKEY \_ local \_ Machine \\ Software \\ Microsoft \\ Windows NT \\ CurrentVersion \\ ProfileList**</span><span class="sxs-lookup"><span data-stu-id="5f68f-139">**HKEY\_LOCAL\_MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion\\ProfileList**</span></span>

<span data-ttu-id="5f68f-140">Die Variable $AllVolumes $ bewirkt, dass die Pfad Zeichenfolge auf alle Schatten Kopien auf dem Computer angewendet wird.</span><span class="sxs-lookup"><span data-stu-id="5f68f-140">The $AllVolumes$ variable causes the path string to be applied to all shadow copies on the computer.</span></span> <span data-ttu-id="5f68f-141">Angenommen, der Pfad lautet "$AllVolumes $ \\ TemporaryFiles \\ \* . \* /s ", und der Computer hat drei Volumes: C:, D: und e:.</span><span class="sxs-lookup"><span data-stu-id="5f68f-141">For example, suppose the path is "$AllVolumes$\\TemporaryFiles\\\*.\* /s", and the computer has three volumes: C:, D:, and E:.</span></span> <span data-ttu-id="5f68f-142">Wenn C: und E: den Pfad " \\ TemporaryFiles \\ " enthalten und Volume D: nur den Pfad "D: Data" enthält \\ \\ , wird die Verzeichnisstruktur "c: \\ TemporaryFiles" \\ aus den Schatten Kopien von "c:" gelöscht, und die Verzeichnisstruktur "E: \\ TemporaryFiles" \\ wird aus den Schatten Kopien von "e:" gelöscht.</span><span class="sxs-lookup"><span data-stu-id="5f68f-142">If C: and E: contain the path "\\TemporaryFiles\\", and volume D: contains only the path D:\\Data\\, the directory tree C:\\TemporaryFiles\\ is deleted from shadow copies of C:, and the directory tree E:\\TemporaryFiles\\ is deleted from shadow copies of E:.</span></span>

<span data-ttu-id="5f68f-143">Administratoren können die Erweiterung der Variablen "$USERPROFILE $" mithilfe des folgenden Registrierungsschlüssels deaktivieren:</span><span class="sxs-lookup"><span data-stu-id="5f68f-143">Administrators can disable expansion of the $UserProfile$ variable by using the following registry key:</span></span>

<span data-ttu-id="5f68f-144">**HKEY \_ local \_ Machine \\ System \\ CurrentControlSet \\ Services \\ VSS- \\ Einstellungen**</span><span class="sxs-lookup"><span data-stu-id="5f68f-144">**HKEY\_LOCAL\_MACHINE\\System\\CurrentControlSet\\Services\\Vss\\Settings**</span></span>

<span data-ttu-id="5f68f-145">Geben Sie unter diesem Registrierungsschlüssel den Wert "disableuserprofileexpansion" für den Wert "Name", "reg \_ DWORD" für den Werttyp und einen Wert ungleich NULL für die Wertdaten an.</span><span class="sxs-lookup"><span data-stu-id="5f68f-145">Under this registry key, specify DisableUserProfileExpansion for the value name, REG\_DWORD for the value type, and a nonzero value for the value data.</span></span>

## <a name="about-the-filesnottobackup-registry-key"></a><span data-ttu-id="5f68f-146">Informationen zum Registrierungsschlüssel "FilesNotToBackup"</span><span class="sxs-lookup"><span data-stu-id="5f68f-146">About the FilesNotToBackup Registry Key</span></span>

<span data-ttu-id="5f68f-147">Der Registrierungsschlüssel **FilesNotToBackup** kann verwendet werden, um die Namen der Dateien und Verzeichnisse anzugeben, die von Sicherungs Anwendungen nicht gesichert oder wieder hergestellt werden sollen.</span><span class="sxs-lookup"><span data-stu-id="5f68f-147">The **FilesNotToBackup** registry key can be used to specify the names of the files and directories that backup applications should not backup or restore.</span></span> <span data-ttu-id="5f68f-148">Diese Dateien werden jedoch nicht aus Schatten Kopien ausgeschlossen.</span><span class="sxs-lookup"><span data-stu-id="5f68f-148">However, it does not exclude those files from shadow copies.</span></span> <span data-ttu-id="5f68f-149">Weitere Informationen zu diesem Registrierungsschlüssel finden Sie unter [Registrierungsschlüssel und-Werte für die Sicherung und Wiederherstellung](../backup/registry-keys-for-backup-and-restore.md).</span><span class="sxs-lookup"><span data-stu-id="5f68f-149">For more information about this registry key, see [Registry Keys and Values for Backup and Restore](../backup/registry-keys-for-backup-and-restore.md).</span></span>

 

 
