---
description: In Windows 7 implementieren allgemeine Plattform-APIs, die kernaudio-APIs verwenden, wie Media Foundation-, DirectSound-und Wave-APIs, das Streaming-Routing Feature, indem Sie den Datenstrom Wechsel von einem vorhandenen Gerät zu einem neuen standardaudioendpunkt verarbeiten.
ms.assetid: ecda0b5b-6583-43b4-a9b4-f12a95f09452
title: Überlegungen zur Implementierung von streamrouting
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 27dc1f7e3fe56d6b421ca59f528ab1a65d2261a9
ms.sourcegitcommit: c7add10d695482e1ceb72d62b8a4ebd84ea050f7
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/07/2021
ms.locfileid: "103958423"
---
# <a name="stream-routing-implementation-considerations"></a><span data-ttu-id="193e6-103">Überlegungen zur Implementierung von streamrouting</span><span class="sxs-lookup"><span data-stu-id="193e6-103">Stream Routing Implementation Considerations</span></span>

<span data-ttu-id="193e6-104">In Windows 7 implementieren allgemeine Plattform-APIs, die kernaudio-APIs verwenden, wie Media Foundation-, DirectSound-und Wave-APIs, das Streaming-Routing Feature, indem Sie den Datenstrom Wechsel von einem vorhandenen Gerät zu einem neuen standardaudioendpunkt verarbeiten.</span><span class="sxs-lookup"><span data-stu-id="193e6-104">In Windows 7, high-level platform APIs that use Core Audio APIs, such as Media Foundation, DirectSound, and Wave APIs, implement the stream routing feature by handling stream switching from an existing device to a new default audio endpoint.</span></span> <span data-ttu-id="193e6-105">Medienanwendungen, die diese APIs verwenden, verwenden das Datenstrom-Routing Verhalten ohne Änderungen an der Quelle.</span><span class="sxs-lookup"><span data-stu-id="193e6-105">Media applications that use these APIs use the stream routing behavior without any modifications to the source.</span></span> <span data-ttu-id="193e6-106">Direkte WASAPI-Clients können die Benachrichtigungen verwenden, die von den kernaudiokomponenten gesendet werden, und die streamweiterleitungs Funktion implementieren.</span><span class="sxs-lookup"><span data-stu-id="193e6-106">Direct WASAPI clients can use the notifications sent by Core Audio components and implement the stream routing feature.</span></span>

<span data-ttu-id="193e6-107">Direkte WASAPI-Clients (Medienanwendungen, die WASAPI direkt verwenden) erhalten neue Geräte-und audiositzungsbenachrichtigungen, die von kernaudiokomponenten gesendet werden.</span><span class="sxs-lookup"><span data-stu-id="193e6-107">Direct WASAPI clients (media applications that use WASAPI directly) receive new device and audio session notifications sent by Core Audio components.</span></span> <span data-ttu-id="193e6-108">Das Verhalten der streamweiterleitungs Funktion wird durch die Behandlung dieser Benachrichtigungen durch die Anwendung definiert.</span><span class="sxs-lookup"><span data-stu-id="193e6-108">The behavior of the stream routing feature is defined by how the application handles these notifications.</span></span>

<span data-ttu-id="193e6-109">Die mmdevice-API und die Audiositzung senden Benachrichtigungen zu Änderungen am Gerätestatus und Sitzungs Änderungen an WASAPI-Clients in Form von Rückrufe.</span><span class="sxs-lookup"><span data-stu-id="193e6-109">MMDevice API and the audio session send notifications about device state changes and session changes to WASAPI clients in the form of callbacks.</span></span> <span data-ttu-id="193e6-110">Um diese Benachrichtigungen zu erhalten, muss der Client seine Implementierung von [**immnotificationclient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) und [**iaudiosessionevents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents)registrieren.</span><span class="sxs-lookup"><span data-stu-id="193e6-110">To get these notifications, the client must register its implementation of [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span></span> <span data-ttu-id="193e6-111">Weitere Informationen finden Sie unter [relevante Benachrichtigungen für das Datenstrom Routing](relevant-device-notifications-for-stream-routing.md).</span><span class="sxs-lookup"><span data-stu-id="193e6-111">For more information, see [Relevant Notifications for Stream Routing](relevant-device-notifications-for-stream-routing.md).</span></span>

<span data-ttu-id="193e6-112">In dem im [Stream-Routing](stream-routing.md)beschriebenen USB-Headset-Szenario gibt eine Anwendung einen Audiostream wieder und verwendet mmdeviceapi und WASAPI, um den Stream auf dem Standard renderinggerät ( **Sprecher**) zu rendern.</span><span class="sxs-lookup"><span data-stu-id="193e6-112">In the USB headset scenario described in [Stream Routing](stream-routing.md), an application is playing an audio stream and uses MMDeviceAPI and WASAPI to render the stream on the default rendering device, **Speaker**.</span></span> <span data-ttu-id="193e6-113">Wenn das Standardgerät geändert wird, empfängt die Anwendung eine [**immnotificationclient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) -Benachrichtigung.</span><span class="sxs-lookup"><span data-stu-id="193e6-113">When the default device is changed, the application receives an [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="193e6-114">Die Anwendung empfängt außerdem [**iaudiosessionevents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) -Benachrichtigungen, die angeben, dass der Benutzer das audioendpunktgerät entfernt hat oder dass sich das Streamformat für das Gerät geändert hat, mit dem die Audiositzung verbunden ist.</span><span class="sxs-lookup"><span data-stu-id="193e6-114">The application also receives [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications indicating that the user removed the audio endpoint device or that the stream format changed for the device that the audio session is connected to.</span></span> <span data-ttu-id="193e6-115">Beim Empfang der Benachrichtigungen beendet die Anwendung das Streaming an den Sprecher Endpunkt und öffnet den Stream für das Rendering auf dem aktuellen Standard Endpunkt, dem Headset, erneut.</span><span class="sxs-lookup"><span data-stu-id="193e6-115">Upon receiving the notifications, the application stops streaming to the speaker endpoint and reopens the stream for rendering on the current default endpoint, the headset.</span></span>

![Diagramm des Datenflusses für Geräte Benachrichtigungen.](images/stream-routing.gif)

<span data-ttu-id="193e6-117">Als Reaktion auf solche Benachrichtigungen kann der Client den Datenstrom auf dem neuen Standardgerät in dem vom Benutzer ausgewählten Format erneut öffnen.</span><span class="sxs-lookup"><span data-stu-id="193e6-117">In response to such notifications, the client might reopen the stream on the new default device in the new format selected by the user.</span></span>

## <a name="stream-managment"></a><span data-ttu-id="193e6-118">Stream-Verwaltung</span><span class="sxs-lookup"><span data-stu-id="193e6-118">Stream Managment</span></span>

<span data-ttu-id="193e6-119">In der folgenden Liste sind die Schritte zusammengefasst, die ein WASAPI-Client ausführen muss, um die Datenstrom Wechselfunktion bereitzustellen.</span><span class="sxs-lookup"><span data-stu-id="193e6-119">The following list summarizes the steps that a WASAPI client must perform to provide the stream switching functionality.</span></span>

1.  <span data-ttu-id="193e6-120">Warten Sie auf die relevante [**immnotificationclient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) -Benachrichtigung.</span><span class="sxs-lookup"><span data-stu-id="193e6-120">Wait for the relevant [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="193e6-121">Wenn es sich bei dem Gerät um das Standardgerät handelt, wird die Meldung " [**immnotificationclient:: ondefaultdevicechanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) " empfangen.</span><span class="sxs-lookup"><span data-stu-id="193e6-121">If the device is the default device, the [**IMMNotificationClient::OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) notification is received.</span></span>
2.  <span data-ttu-id="193e6-122">Wenn ein neues Gerät verfügbar ist, erhalten Sie einen Verweis auf den Endpunkt des neuen Geräts.</span><span class="sxs-lookup"><span data-stu-id="193e6-122">If a new device is available, get a reference to the endpoint of the new device.</span></span> <span data-ttu-id="193e6-123">" [**Immdeviceenumerator:: getdefaultaudioendpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) " für das neue Standardgerät aufrufen.</span><span class="sxs-lookup"><span data-stu-id="193e6-123">Call [**IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) for the new default device.</span></span> <span data-ttu-id="193e6-124">Wenn das neue Gerät nicht das Standardgerät ist, können Sie das Gerät durch Aufrufen von [**immdeviceenumerator:: getdevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice)abrufen.</span><span class="sxs-lookup"><span data-stu-id="193e6-124">If the new device is not the default device, you can retrieve the device by calling [**IMMDeviceEnumerator::GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span></span> <span data-ttu-id="193e6-125">Weitere Informationen finden Sie unter [Getting the Device Endpoint for Stream Routing](getting-the-default-device-endpoint-for-stream-routing.md).</span><span class="sxs-lookup"><span data-stu-id="193e6-125">For more information, see [Getting the Device Endpoint for Stream Routing](getting-the-default-device-endpoint-for-stream-routing.md).</span></span>
3.  <span data-ttu-id="193e6-126">Warten Sie auf [**iaudiosessionevents:: onsessiontrennt**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) mit dem Wert "Reason".</span><span class="sxs-lookup"><span data-stu-id="193e6-126">Wait for the [**IAudioSessionEvents::OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) with the reason value.</span></span>
    > [!Note]  
    > <span data-ttu-id="193e6-127">Da alle diese Vorgänge asynchron sind, wird die Reihenfolge, in der die Anwendung die Benachrichtigungen über Geräte Änderung und Sitzungs Trennung empfängt, nicht vorhergesagt.</span><span class="sxs-lookup"><span data-stu-id="193e6-127">Because all of these operations are asychronous, the order in which the application receives device-change and session-disconnect notifications cannnot be predicted.</span></span> <span data-ttu-id="193e6-128">Die Anwendung muss die Benachrichtigungs Behandlung implementieren, um diese Benachrichtigungen in beliebiger Reihenfolge zu empfangen.</span><span class="sxs-lookup"><span data-stu-id="193e6-128">The application must implement notification handling to receive these notifications in any order.</span></span> <span data-ttu-id="193e6-129">In der Regel erhält die Anwendung jedoch den Wert **audiosessiondisconnect** vor der Standard Benachrichtigung für Geräteänderungen.</span><span class="sxs-lookup"><span data-stu-id="193e6-129">However, typically, the application receives **AudioSessionDisconnect** value before the default device change notification.</span></span>

     

4.  <span data-ttu-id="193e6-130">Werten Sie den Grund Wert aus, und bestimmen Sie, ob der Stream an einen anderen audioendpunkt übertragen werden muss oder ob der Stream mit einem neuen Format erneut initialisiert werden muss.</span><span class="sxs-lookup"><span data-stu-id="193e6-130">Evaluate the reason value and determine whether the stream needs to be transferred to another audio endpoint or the stream needs to be reinitialized with a new format.</span></span>
5.  <span data-ttu-id="193e6-131">Beendet das Streaming auf das alte Standardgerät, wenn der Grund darauf hinweist, dass der Datenstrom an das neue Standardgerät weitergeleitet werden soll.</span><span class="sxs-lookup"><span data-stu-id="193e6-131">Stop streaming to the old default device if the reason indicates that the stream should be re-routed to the new default device.</span></span>
6.  <span data-ttu-id="193e6-132">Führt Berechnungen zur Positions Zuordnung aus.</span><span class="sxs-lookup"><span data-stu-id="193e6-132">Perform position mapping calculations.</span></span>
7.  <span data-ttu-id="193e6-133">Öffnen Sie den Stream auf dem neuen Gerät, und übertragen Sie alle Zustandsinformationen.</span><span class="sxs-lookup"><span data-stu-id="193e6-133">Open the stream on the new device and transfer all state information.</span></span>
8.  <span data-ttu-id="193e6-134">Setzen Sie das Streaming auf dem neuen Standardgerät fort.</span><span class="sxs-lookup"><span data-stu-id="193e6-134">Resume streaming on the new default device.</span></span>
9.  <span data-ttu-id="193e6-135">Behandeln Sie die Abfahrt des alten Standard Geräts.</span><span class="sxs-lookup"><span data-stu-id="193e6-135">Handle the departure of the old default device.</span></span>

<span data-ttu-id="193e6-136">Damit der streamwechselvorgang nahtlos angezeigt wird, muss er so schnell wie möglich ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="193e6-136">To make the stream switching operation appear seamless, it must be done as quickly as possible.</span></span> <span data-ttu-id="193e6-137">Dies hängt von der Leistung der Komponenten ab, die an der erneuten Initiierung des Streams auf dem neuen Gerät beteiligt sind.</span><span class="sxs-lookup"><span data-stu-id="193e6-137">This depends on the performance of the components involved in re-initiation of the stream on the new device.</span></span>

## <a name="position-mapping-considerations"></a><span data-ttu-id="193e6-138">Überlegungen zur Positions Zuordnung</span><span class="sxs-lookup"><span data-stu-id="193e6-138">Position Mapping Considerations</span></span>

<span data-ttu-id="193e6-139">Wenn die Anwendung die Benachrichtigungen " [**immnotificationclient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) " und " [**iaudiosessionevents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) " erhält, kann Sie die vorhandenen Streams an das neue Standardgerät weiterleiten.</span><span class="sxs-lookup"><span data-stu-id="193e6-139">When the application gets [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications, it can route the existing streams to the new default device.</span></span> <span data-ttu-id="193e6-140">Wenn ein vorhandener Audiostream unterbrochen und auf dem neuen Gerät geöffnet wird, muss das Rendering auf dem neuen Gerät an der Position beginnen, an der der Stream auf dem alten Gerät angehalten wurde.</span><span class="sxs-lookup"><span data-stu-id="193e6-140">When an existing audio stream is interrupted and opened on the new device, rendering on the new device must start at the position at which the stream was stopped on the old device.</span></span> <span data-ttu-id="193e6-141">Zu diesem Zweck muss die Anwendung die letzte bekannte Geräte Position aufweisen, um die Startposition auf dem neuen Gerät zu berechnen.</span><span class="sxs-lookup"><span data-stu-id="193e6-141">To do this, the application must have the last known device position, to calculate the start position on the new device.</span></span> <span data-ttu-id="193e6-142">Diese Position kann z. b. als Delta Offset für die nachfolgende Positions Zuordnung verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="193e6-142">For example, this position can be used as the delta offset for subsequent position mapping.</span></span> <span data-ttu-id="193e6-143">Wenn der Stream das Rendering startet, kann die neue Geräte Position der zwischengespeicherten Geräte Position neu zugeordnet werden.</span><span class="sxs-lookup"><span data-stu-id="193e6-143">When the stream starts rendering, the new device position can be remapped to the cached device position.</span></span>

<span data-ttu-id="193e6-144">In den folgenden Schritten wird der Prozess der nahtlosen Datenstrom Umstellung zusammengefasst.</span><span class="sxs-lookup"><span data-stu-id="193e6-144">The following steps summarize the process of making a seamless stream transition.</span></span>

1.  <span data-ttu-id="193e6-145">Zwischenspeichern der letzten Geräte Position des Streams auf dem alten Gerät.</span><span class="sxs-lookup"><span data-stu-id="193e6-145">Cache the last device position of the stream on the old device.</span></span>
2.  <span data-ttu-id="193e6-146">Beendet den Stream auf dem alten Gerät.</span><span class="sxs-lookup"><span data-stu-id="193e6-146">Stop the stream on the old device.</span></span>
3.  <span data-ttu-id="193e6-147">Führen Sie Neuzuordnung von Berechnungen durch, um die neue Position zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="193e6-147">Perform remapping calculations to get the new position.</span></span>
4.  <span data-ttu-id="193e6-148">Startet das Rendern des Streams auf dem neuen Gerät.</span><span class="sxs-lookup"><span data-stu-id="193e6-148">Start rendering the stream on the new device.</span></span>
5.  <span data-ttu-id="193e6-149">Geben Sie den alten Stream frei.</span><span class="sxs-lookup"><span data-stu-id="193e6-149">Release the old stream.</span></span>

<span data-ttu-id="193e6-150">Während des Übergangs muss die Anwendung sicherstellen, dass die Uhr nicht synchron ist, was zu nicht Synchronisierungs-Audiodaten und Videostreams führt.</span><span class="sxs-lookup"><span data-stu-id="193e6-150">During the transition, the application must ensure that the clock does not get out of synchronization, resulting in out-of-sync audio and video streams.</span></span> <span data-ttu-id="193e6-151">Dies kann vorkommen, wenn die Videobeispiele weiterhin gerouteten werden, während der Audiodatenstrom an das neue Gerät weitergeleitet wird.</span><span class="sxs-lookup"><span data-stu-id="193e6-151">This can occur if the video samples continue to render while the audio stream is routed to the new device.</span></span> <span data-ttu-id="193e6-152">Die Anwendung muss die Uhrzeit Position für die Neuzuordnung Zwischenspeichern und sicherstellen, dass die Videobeispiele erst gerendert werden, wenn der Audiodatenstrom auf dem neuen Gerät wieder geöffnet wird, sodass die Audiodaten und die Videostreams synchronisiert werden, wenn der Clip das Rendering wieder aufnimmt.</span><span class="sxs-lookup"><span data-stu-id="193e6-152">The application must cache the clock position for the remapping calculation and make sure that the video samples are not rendered until the audio stream is reopened on the new device, so that when the clip resumes rendering, the audio and the video streams are synchronized.</span></span> <span data-ttu-id="193e6-153">In einigen Fällen, in denen die Präsentationszeit zum Rendern der Videorahmen auf der audiouhr basiert, reicht es aus, den Audiostream zu beenden, bis der Streamwechsel beendet ist und keine weitere Implementierung der Positions Zuordnung für den Videostream für die audiovideosynchronisierung erforderlich ist.</span><span class="sxs-lookup"><span data-stu-id="193e6-153">In some cases, where the presentation time for rendering the video frames is based on the audio clock, it is sufficient to stop the audio stream until stream switching is complete and no other position mapping implementation for the video stream is necessary for audio video synchronization.</span></span>

<span data-ttu-id="193e6-154">Wenn beim Rendern [**iaudiorenderclient:: GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) einen Fehler zurückgibt, weil das alte Gerät verloren gegangen ist, muss die Anwendung den alten Stream nicht beenden, da der Streamingvorgang bereits beendet wurde.</span><span class="sxs-lookup"><span data-stu-id="193e6-154">If while rendering, [**IAudioRenderClient::GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) returns an error because the old device is lost, the application need not stop the old stream because the streaming operation has already terminated.</span></span> <span data-ttu-id="193e6-155">Informationen zur Behandlung dieses Fehlers finden Sie unter wieder [herstellen nach einem Invalid-Device Fehler](recovering-from-an-invalid-device-error.md).</span><span class="sxs-lookup"><span data-stu-id="193e6-155">For information about handling this error, see [Recovering from an Invalid-Device Error](recovering-from-an-invalid-device-error.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="193e6-156">Zugehörige Themen</span><span class="sxs-lookup"><span data-stu-id="193e6-156">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="193e6-157">Informationen über die mmdevice-API</span><span class="sxs-lookup"><span data-stu-id="193e6-157">About MMDevice API</span></span>](mmdevice-api.md)
</dt> <dt>

[<span data-ttu-id="193e6-158">Informationen zu WASAPI</span><span class="sxs-lookup"><span data-stu-id="193e6-158">About WASAPI</span></span>](wasapi.md)
</dt> <dt>

[<span data-ttu-id="193e6-159">Streamrouting</span><span class="sxs-lookup"><span data-stu-id="193e6-159">Stream Routing</span></span>](stream-routing.md)
</dt> </dl>

 

 



