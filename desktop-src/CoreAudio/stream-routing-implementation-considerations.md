---
description: Erfahren Sie mehr über Implementierungsüberlegungen für das Streamrouting. APIs implementieren Streamrouting, indem sie den Datenstromwechsel zu einem neuen Standardaudioendpunkt behandeln.
ms.assetid: ecda0b5b-6583-43b4-a9b4-f12a95f09452
title: Überlegungen zur Implementierung des Streamroutings
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 62bd753fe027c92ffac9f5a41cea589b600d7f26
ms.sourcegitcommit: 51ef825fb48f15e1aa30e8795988f10dc2b2155c
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 06/14/2021
ms.locfileid: "112068036"
---
# <a name="stream-routing-implementation-considerations"></a><span data-ttu-id="b8c29-104">Überlegungen zur Implementierung des Streamroutings</span><span class="sxs-lookup"><span data-stu-id="b8c29-104">Stream Routing Implementation Considerations</span></span>

<span data-ttu-id="b8c29-105">In Windows 7 implementieren plattformübergreifende APIs, die Core Audio-APIs wie Media Foundation-, DirectSound- und Wave-APIs verwenden, das Streamroutingfeature, indem sie den Streamwechsel von einem vorhandenen Gerät zu einem neuen Standardaudioendpunkt behandeln.</span><span class="sxs-lookup"><span data-stu-id="b8c29-105">In Windows 7, high-level platform APIs that use Core Audio APIs, such as Media Foundation, DirectSound, and Wave APIs, implement the stream routing feature by handling stream switching from an existing device to a new default audio endpoint.</span></span> <span data-ttu-id="b8c29-106">Medienanwendungen, die diese APIs verwenden, verwenden das Streamroutingverhalten ohne Änderungen an der Quelle.</span><span class="sxs-lookup"><span data-stu-id="b8c29-106">Media applications that use these APIs use the stream routing behavior without any modifications to the source.</span></span> <span data-ttu-id="b8c29-107">Direkte WASAPI-Clients können die von Core Audio-Komponenten gesendeten Benachrichtigungen verwenden und das Streamroutingfeature implementieren.</span><span class="sxs-lookup"><span data-stu-id="b8c29-107">Direct WASAPI clients can use the notifications sent by Core Audio components and implement the stream routing feature.</span></span>

<span data-ttu-id="b8c29-108">Direkte WASAPI-Clients (Medienanwendungen, die WASAPI direkt verwenden) erhalten neue Geräte- und Audiositzungsbenachrichtigungen, die von Core Audio-Komponenten gesendet werden.</span><span class="sxs-lookup"><span data-stu-id="b8c29-108">Direct WASAPI clients (media applications that use WASAPI directly) receive new device and audio session notifications sent by Core Audio components.</span></span> <span data-ttu-id="b8c29-109">Das Verhalten der Streamroutingfunktion wird durch die Art und Weise definiert, wie die Anwendung diese Benachrichtigungen behandelt.</span><span class="sxs-lookup"><span data-stu-id="b8c29-109">The behavior of the stream routing feature is defined by how the application handles these notifications.</span></span>

<span data-ttu-id="b8c29-110">Die MMDevice-API und die Audiositzung senden Benachrichtigungen über Gerätestatusänderungen und Sitzungsänderungen an WASAPI-Clients in Form von Rückrufen.</span><span class="sxs-lookup"><span data-stu-id="b8c29-110">MMDevice API and the audio session send notifications about device state changes and session changes to WASAPI clients in the form of callbacks.</span></span> <span data-ttu-id="b8c29-111">Um diese Benachrichtigungen zu erhalten, muss der Client seine Implementierung von [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) und [**IAudioSessionEvents registrieren.**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents)</span><span class="sxs-lookup"><span data-stu-id="b8c29-111">To get these notifications, the client must register its implementation of [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents).</span></span> <span data-ttu-id="b8c29-112">Weitere Informationen finden Sie unter [Relevante Benachrichtigungen für das Streamrouting.](relevant-device-notifications-for-stream-routing.md)</span><span class="sxs-lookup"><span data-stu-id="b8c29-112">For more information, see [Relevant Notifications for Stream Routing](relevant-device-notifications-for-stream-routing.md).</span></span>

<span data-ttu-id="b8c29-113">In dem unter Streamrouting beschriebenen USB-Headsetszenario gibt eine Anwendung einen Audiostream wieder und verwendet MMDeviceAPI und WASAPI, um den Stream auf dem Standardrenderinggerät Zu **rendern: Speaker.** [](stream-routing.md)</span><span class="sxs-lookup"><span data-stu-id="b8c29-113">In the USB headset scenario described in [Stream Routing](stream-routing.md), an application is playing an audio stream and uses MMDeviceAPI and WASAPI to render the stream on the default rendering device, **Speaker**.</span></span> <span data-ttu-id="b8c29-114">Wenn das Standardgerät geändert wird, erhält die Anwendung eine [**IMMNotificationClient-Benachrichtigung.**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient)</span><span class="sxs-lookup"><span data-stu-id="b8c29-114">When the default device is changed, the application receives an [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="b8c29-115">Die Anwendung empfängt außerdem [**IAudioSessionEvents-Benachrichtigungen,**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) die darauf hinweisen, dass der Benutzer das Audioendpunktgerät entfernt hat oder dass sich das Streamformat für das Gerät geändert hat, mit dem die Audiositzung verbunden ist.</span><span class="sxs-lookup"><span data-stu-id="b8c29-115">The application also receives [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications indicating that the user removed the audio endpoint device or that the stream format changed for the device that the audio session is connected to.</span></span> <span data-ttu-id="b8c29-116">Nach dem Empfang der Benachrichtigungen beendet die Anwendung das Streaming an den Sprecherendpunkt und öffnet den Stream erneut für das Rendering auf dem aktuellen Standardendpunkt, dem Headset.</span><span class="sxs-lookup"><span data-stu-id="b8c29-116">Upon receiving the notifications, the application stops streaming to the speaker endpoint and reopens the stream for rendering on the current default endpoint, the headset.</span></span>

![Diagramm des Datenflusses für Gerätebenachrichtigungen.](images/stream-routing.gif)

<span data-ttu-id="b8c29-118">Als Reaktion auf solche Benachrichtigungen kann der Client den Stream auf dem neuen Standardgerät in dem vom Benutzer ausgewählten neuen Format erneut öffnen.</span><span class="sxs-lookup"><span data-stu-id="b8c29-118">In response to such notifications, the client might reopen the stream on the new default device in the new format selected by the user.</span></span>

## <a name="stream-managment"></a><span data-ttu-id="b8c29-119">Stream-Managment</span><span class="sxs-lookup"><span data-stu-id="b8c29-119">Stream Managment</span></span>

<span data-ttu-id="b8c29-120">In der folgenden Liste sind die Schritte zusammengefasst, die ein WASAPI-Client ausführen muss, um die Funktion zum Wechseln des Streams zu bieten.</span><span class="sxs-lookup"><span data-stu-id="b8c29-120">The following list summarizes the steps that a WASAPI client must perform to provide the stream switching functionality.</span></span>

1.  <span data-ttu-id="b8c29-121">Warten Sie auf die relevante [**IMMNotificationClient-Benachrichtigung.**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient)</span><span class="sxs-lookup"><span data-stu-id="b8c29-121">Wait for the relevant [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) notification.</span></span> <span data-ttu-id="b8c29-122">Wenn das Gerät das Standardgerät ist, wird die [**Benachrichtigung IMMNotificationClient::OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) empfangen.</span><span class="sxs-lookup"><span data-stu-id="b8c29-122">If the device is the default device, the [**IMMNotificationClient::OnDefaultDeviceChanged**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immnotificationclient-ondefaultdevicechanged) notification is received.</span></span>
2.  <span data-ttu-id="b8c29-123">Wenn ein neues Gerät verfügbar ist, erhalten Sie einen Verweis auf den Endpunkt des neuen Geräts.</span><span class="sxs-lookup"><span data-stu-id="b8c29-123">If a new device is available, get a reference to the endpoint of the new device.</span></span> <span data-ttu-id="b8c29-124">Rufen [**Sie IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) für das neue Standardgerät auf.</span><span class="sxs-lookup"><span data-stu-id="b8c29-124">Call [**IMMDeviceEnumerator::GetDefaultAudioEndpoint**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdefaultaudioendpoint) for the new default device.</span></span> <span data-ttu-id="b8c29-125">Wenn das neue Gerät nicht das Standardgerät ist, können Sie es abrufen, indem Sie [**IMMDeviceEnumerator::GetDevice aufrufen.**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice)</span><span class="sxs-lookup"><span data-stu-id="b8c29-125">If the new device is not the default device, you can retrieve the device by calling [**IMMDeviceEnumerator::GetDevice**](/windows/desktop/api/Mmdeviceapi/nf-mmdeviceapi-immdeviceenumerator-getdevice).</span></span> <span data-ttu-id="b8c29-126">Weitere Informationen finden Sie unter [Abrufen des Geräteendpunkts für das Streamrouting.](getting-the-default-device-endpoint-for-stream-routing.md)</span><span class="sxs-lookup"><span data-stu-id="b8c29-126">For more information, see [Getting the Device Endpoint for Stream Routing](getting-the-default-device-endpoint-for-stream-routing.md).</span></span>
3.  <span data-ttu-id="b8c29-127">Warten Sie, bis [**IAudioSessionEvents::OnSessionDisconnected mit**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) dem Grundwert verbunden ist.</span><span class="sxs-lookup"><span data-stu-id="b8c29-127">Wait for the [**IAudioSessionEvents::OnSessionDisconnected**](/windows/desktop/api/Audiopolicy/nf-audiopolicy-iaudiosessionevents-onsessiondisconnected) with the reason value.</span></span>
    > [!Note]  
    > <span data-ttu-id="b8c29-128">Da alle diese Vorgänge achron sind, kann die Reihenfolge, in der die Anwendung Benachrichtigungen zu Geräteänderung und Sitzungstrennung empfängt, nicht vorhergesagt werden.</span><span class="sxs-lookup"><span data-stu-id="b8c29-128">Because all of these operations are asychronous, the order in which the application receives device-change and session-disconnect notifications cannnot be predicted.</span></span> <span data-ttu-id="b8c29-129">Die Anwendung muss die Benachrichtigungsverarbeitung implementieren, um diese Benachrichtigungen in beliebiger Reihenfolge zu empfangen.</span><span class="sxs-lookup"><span data-stu-id="b8c29-129">The application must implement notification handling to receive these notifications in any order.</span></span> <span data-ttu-id="b8c29-130">In der Regel empfängt die Anwendung jedoch den **Wert AudioSessionDisconnect,** bevor die Standardbenachrichtigung zur Geräteänderung angezeigt wird.</span><span class="sxs-lookup"><span data-stu-id="b8c29-130">However, typically, the application receives **AudioSessionDisconnect** value before the default device change notification.</span></span>

     

4.  <span data-ttu-id="b8c29-131">Werten Sie den Grundwert aus, und bestimmen Sie, ob der Stream an einen anderen Audioendpunkt übertragen oder mit einem neuen Format erneut initialisiert werden muss.</span><span class="sxs-lookup"><span data-stu-id="b8c29-131">Evaluate the reason value and determine whether the stream needs to be transferred to another audio endpoint or the stream needs to be reinitialized with a new format.</span></span>
5.  <span data-ttu-id="b8c29-132">Beenden Sie das Streaming auf das alte Standardgerät, wenn der Grund darauf hinweist, dass der Stream an das neue Standardgerät umgeroutet werden soll.</span><span class="sxs-lookup"><span data-stu-id="b8c29-132">Stop streaming to the old default device if the reason indicates that the stream should be re-routed to the new default device.</span></span>
6.  <span data-ttu-id="b8c29-133">Führen Sie Positionszuordnungsberechnungen durch.</span><span class="sxs-lookup"><span data-stu-id="b8c29-133">Perform position mapping calculations.</span></span>
7.  <span data-ttu-id="b8c29-134">Öffnen Sie den Stream auf dem neuen Gerät, und übertragen Sie alle Zustandsinformationen.</span><span class="sxs-lookup"><span data-stu-id="b8c29-134">Open the stream on the new device and transfer all state information.</span></span>
8.  <span data-ttu-id="b8c29-135">Setzen Sie das Streaming auf dem neuen Standardgerät wieder auf.</span><span class="sxs-lookup"><span data-stu-id="b8c29-135">Resume streaming on the new default device.</span></span>
9.  <span data-ttu-id="b8c29-136">Behandeln Sie den Abbruch des alten Standardgeräts.</span><span class="sxs-lookup"><span data-stu-id="b8c29-136">Handle the departure of the old default device.</span></span>

<span data-ttu-id="b8c29-137">Damit der Datenstromwechsel nahtlos angezeigt wird, muss er so schnell wie möglich erfolgen.</span><span class="sxs-lookup"><span data-stu-id="b8c29-137">To make the stream switching operation appear seamless, it must be done as quickly as possible.</span></span> <span data-ttu-id="b8c29-138">Dies hängt von der Leistung der Komponenten ab, die an der erneuten Initiierung des Streams auf dem neuen Gerät beteiligt sind.</span><span class="sxs-lookup"><span data-stu-id="b8c29-138">This depends on the performance of the components involved in re-initiation of the stream on the new device.</span></span>

## <a name="position-mapping-considerations"></a><span data-ttu-id="b8c29-139">Überlegungen zur Positionszuordnung</span><span class="sxs-lookup"><span data-stu-id="b8c29-139">Position Mapping Considerations</span></span>

<span data-ttu-id="b8c29-140">Wenn die Anwendung [**IMMNotificationClient-**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) und [**IAudioSessionEvents-Benachrichtigungen**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) erhält, kann sie die vorhandenen Streams an das neue Standardgerät routen.</span><span class="sxs-lookup"><span data-stu-id="b8c29-140">When the application gets [**IMMNotificationClient**](/windows/desktop/api/Mmdeviceapi/nn-mmdeviceapi-immnotificationclient) and [**IAudioSessionEvents**](/windows/desktop/api/Audiopolicy/nn-audiopolicy-iaudiosessionevents) notifications, it can route the existing streams to the new default device.</span></span> <span data-ttu-id="b8c29-141">Wenn ein vorhandener Audiostream unterbrochen und auf dem neuen Gerät geöffnet wird, muss das Rendering auf dem neuen Gerät an der Position beginnen, an der der Stream auf dem alten Gerät beendet wurde.</span><span class="sxs-lookup"><span data-stu-id="b8c29-141">When an existing audio stream is interrupted and opened on the new device, rendering on the new device must start at the position at which the stream was stopped on the old device.</span></span> <span data-ttu-id="b8c29-142">Hierzu muss die Anwendung über die letzte bekannte Geräteposition verfügen, um die Startposition auf dem neuen Gerät zu berechnen.</span><span class="sxs-lookup"><span data-stu-id="b8c29-142">To do this, the application must have the last known device position, to calculate the start position on the new device.</span></span> <span data-ttu-id="b8c29-143">Diese Position kann beispielsweise als Deltaoffset für die nachfolgende Positionszuordnung verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="b8c29-143">For example, this position can be used as the delta offset for subsequent position mapping.</span></span> <span data-ttu-id="b8c29-144">Wenn das Rendern des Streams beginnt, kann die neue Geräteposition der zwischengespeicherten Geräteposition neu zugeordnet werden.</span><span class="sxs-lookup"><span data-stu-id="b8c29-144">When the stream starts rendering, the new device position can be remapped to the cached device position.</span></span>

<span data-ttu-id="b8c29-145">In den folgenden Schritten wird der Prozess eines nahtlosen Datenstromübergangs zusammengefasst.</span><span class="sxs-lookup"><span data-stu-id="b8c29-145">The following steps summarize the process of making a seamless stream transition.</span></span>

1.  <span data-ttu-id="b8c29-146">Speichern Sie die letzte Geräteposition des Streams auf dem alten Gerät zwischen.</span><span class="sxs-lookup"><span data-stu-id="b8c29-146">Cache the last device position of the stream on the old device.</span></span>
2.  <span data-ttu-id="b8c29-147">Beenden Sie den Stream auf dem alten Gerät.</span><span class="sxs-lookup"><span data-stu-id="b8c29-147">Stop the stream on the old device.</span></span>
3.  <span data-ttu-id="b8c29-148">Führen Sie Neuberechnungen durch, um die neue Position zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="b8c29-148">Perform remapping calculations to get the new position.</span></span>
4.  <span data-ttu-id="b8c29-149">Beginnen Sie mit dem Rendern des Streams auf dem neuen Gerät.</span><span class="sxs-lookup"><span data-stu-id="b8c29-149">Start rendering the stream on the new device.</span></span>
5.  <span data-ttu-id="b8c29-150">Geben Sie den alten Stream frei.</span><span class="sxs-lookup"><span data-stu-id="b8c29-150">Release the old stream.</span></span>

<span data-ttu-id="b8c29-151">Während des Übergangs muss die Anwendung sicherstellen, dass die Uhr nicht aus der Synchronisierung herauskommt, was zu nicht synchronisierten Audio- und Videostreams führt.</span><span class="sxs-lookup"><span data-stu-id="b8c29-151">During the transition, the application must ensure that the clock does not get out of synchronization, resulting in out-of-sync audio and video streams.</span></span> <span data-ttu-id="b8c29-152">Dies kann auftreten, wenn die Videobeispiele weiterhin gerendert werden, während der Audiostream an das neue Gerät geroutet wird.</span><span class="sxs-lookup"><span data-stu-id="b8c29-152">This can occur if the video samples continue to render while the audio stream is routed to the new device.</span></span> <span data-ttu-id="b8c29-153">Die Anwendung muss die Uhrposition für die Neuberechnung zwischenspeichern und sicherstellen, dass die Videobeispiele erst gerendert werden, wenn der Audiostream auf dem neuen Gerät erneut geöffnet wird, sodass die Audio- und Videostreams synchronisiert werden, wenn der Clip wieder gerendert wird.</span><span class="sxs-lookup"><span data-stu-id="b8c29-153">The application must cache the clock position for the remapping calculation and make sure that the video samples are not rendered until the audio stream is reopened on the new device, so that when the clip resumes rendering, the audio and the video streams are synchronized.</span></span> <span data-ttu-id="b8c29-154">In einigen Fällen, in denen die Präsentationszeit für das Rendern der Videoframes auf der Audiouhr basiert, ist es ausreichend, den Audiostream zu beenden, bis der Streamwechsel abgeschlossen ist und keine andere Implementierung der Positionszuordnung für den Videostream für die Audiovideosynchronisierung erforderlich ist.</span><span class="sxs-lookup"><span data-stu-id="b8c29-154">In some cases, where the presentation time for rendering the video frames is based on the audio clock, it is sufficient to stop the audio stream until stream switching is complete and no other position mapping implementation for the video stream is necessary for audio video synchronization.</span></span>

<span data-ttu-id="b8c29-155">Wenn [**IAudioRenderClient::GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) während des Renderings einen Fehler zurückgibt, weil das alte Gerät verloren geht, muss die Anwendung den alten Stream nicht beenden, da der Streamingvorgang bereits beendet wurde.</span><span class="sxs-lookup"><span data-stu-id="b8c29-155">If while rendering, [**IAudioRenderClient::GetBuffer**](/windows/desktop/api/Audioclient/nf-audioclient-iaudiorenderclient-getbuffer) returns an error because the old device is lost, the application need not stop the old stream because the streaming operation has already terminated.</span></span> <span data-ttu-id="b8c29-156">Informationen zur Behandlung dieses Fehlers finden Sie unter [Wiederherstellen nach einem Invalid-Device Fehlers.](recovering-from-an-invalid-device-error.md)</span><span class="sxs-lookup"><span data-stu-id="b8c29-156">For information about handling this error, see [Recovering from an Invalid-Device Error](recovering-from-an-invalid-device-error.md).</span></span>

## <a name="related-topics"></a><span data-ttu-id="b8c29-157">Zugehörige Themen</span><span class="sxs-lookup"><span data-stu-id="b8c29-157">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="b8c29-158">Informationen zur MMDevice-API</span><span class="sxs-lookup"><span data-stu-id="b8c29-158">About MMDevice API</span></span>](mmdevice-api.md)
</dt> <dt>

[<span data-ttu-id="b8c29-159">Informationen zu WASAPI</span><span class="sxs-lookup"><span data-stu-id="b8c29-159">About WASAPI</span></span>](wasapi.md)
</dt> <dt>

[<span data-ttu-id="b8c29-160">Streamrouting</span><span class="sxs-lookup"><span data-stu-id="b8c29-160">Stream Routing</span></span>](stream-routing.md)
</dt> </dl>

 

 



