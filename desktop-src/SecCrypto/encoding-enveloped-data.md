---
description: Die Syntax der kryptografischen Nachricht kann verwendet werden, um eingeschlossene Nachrichten zu codieren.
ms.assetid: f35aacda-6827-42e9-b7ac-58dc007fc697
title: Codieren von eingeschlossenen Daten
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 53dc20fc7483ba1ef364d8b59824d26bd14d458d
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/07/2021
ms.locfileid: "104567812"
---
# <a name="encoding-enveloped-data"></a><span data-ttu-id="f869a-103">Codieren von eingeschlossenen Daten</span><span class="sxs-lookup"><span data-stu-id="f869a-103">Encoding Enveloped Data</span></span>

<span data-ttu-id="f869a-104">Eingeschlossene Daten bestehen aus verschlüsseltem Inhalt beliebiger Typen und verschlüsselten Inhalts Verschlüsselungs-Sitzungs Schlüsseln für einen oder mehrere Empfänger.</span><span class="sxs-lookup"><span data-stu-id="f869a-104">Enveloped data consists of encrypted content of any type and encrypted content-encryption session keys for one or more recipients.</span></span> <span data-ttu-id="f869a-105">Eingeschlossene Nachrichten behalten den Inhalt des geheimen Schlüssels der Nachricht bei und erlauben nur bestimmten Personen oder Entitäten, den Inhalt abzurufen.</span><span class="sxs-lookup"><span data-stu-id="f869a-105">Enveloped messages keep the contents of the message secret and allow only specified persons or entities to retrieve the contents.</span></span>

<span data-ttu-id="f869a-106">Cryptographic Message Syntax (CMS) kann verwendet werden, um eingeschlossene Nachrichten zu codieren.</span><span class="sxs-lookup"><span data-stu-id="f869a-106">Cryptographic message syntax (CMS) can be used to encode enveloped messages.</span></span> <span data-ttu-id="f869a-107">CMS unterstützt drei Schlüssel Verwaltungsverfahren: Schlüssel Transport, Schlüssel Übereinstimmung und zuvor verteilte symmetrische Schlüssel Verschlüsselungsschlüssel (KEK).</span><span class="sxs-lookup"><span data-stu-id="f869a-107">CMS supports three key management techniques: key transport, key agreement, and previously distributed symmetric key-encryption keys (KEK).</span></span> <span data-ttu-id="f869a-108">Zuvor verteilter symmetrischer KEK wird auch als "Mailing List Key Distribution" bezeichnet.</span><span class="sxs-lookup"><span data-stu-id="f869a-108">Previously distributed symmetric KEK are also known as mailing list key distribution.</span></span>

<span data-ttu-id="f869a-109">In jeder dieser drei Verfahren wird ein einzelner Sitzungsschlüssel generiert, um die eingeschlossene Nachricht zu verschlüsseln.</span><span class="sxs-lookup"><span data-stu-id="f869a-109">In each of these three techniques, a single session key is generated to encrypt the enveloped message.</span></span> <span data-ttu-id="f869a-110">Wichtige Verwaltungsprobleme behandeln die Art und Weise, wie der Sitzungsschlüssel vom Absender verschlüsselt und von einem Empfänger entschlüsselt wird.</span><span class="sxs-lookup"><span data-stu-id="f869a-110">Key management issues deal with the way that session key is encrypted by the sender and decrypted by a receiver.</span></span> <span data-ttu-id="f869a-111">Eine einzelne verschlüsselte Nachricht kann mithilfe einer Mischung aus den Schlüssel Verwaltungsverfahren an viele Empfänger verteilt werden.</span><span class="sxs-lookup"><span data-stu-id="f869a-111">A single encrypted message can be distributed to many recipients using a mixture of the key management techniques.</span></span>

<span data-ttu-id="f869a-112">Die Schlüsselverwaltung des Schlüssel Transports verwendet den öffentlichen Schlüssel eines beabsichtigten Empfängers, um den Sitzungsschlüssel zu verschlüsseln.</span><span class="sxs-lookup"><span data-stu-id="f869a-112">Key transport key management uses an intended receiver's public key to encrypt the session key.</span></span> <span data-ttu-id="f869a-113">Der Empfänger entschlüsselt den Sitzungsschlüssel mithilfe des privaten Schlüssels, der dem öffentlichen Schlüssel zugeordnet ist, der für die Verschlüsselung verwendet wurde.</span><span class="sxs-lookup"><span data-stu-id="f869a-113">The receiver decrypts the session key using the private key associated with the public key that was used to encrypt.</span></span> <span data-ttu-id="f869a-114">Der Empfänger verwendet dann den entschlüsselten Sitzungsschlüssel, um die eingeschlossenen Daten zu entschlüsseln.</span><span class="sxs-lookup"><span data-stu-id="f869a-114">The receiver then uses the decrypted session key to decrypt the enveloped data.</span></span> <span data-ttu-id="f869a-115">Bei Verwendung des Schlüssel Transports hat der Empfänger keine Informationen über die Identität des Absenders bestätigt.</span><span class="sxs-lookup"><span data-stu-id="f869a-115">When key transport is used, the receiver has not confirmed information on the identity of the sender.</span></span>

<span data-ttu-id="f869a-116">In der Schlüssel Vereinbarungs Verwaltung wird ein temporärer, kurzlebiger Diffie-Hellman privater Schlüssel generiert und verwendet, um den Sitzungsschlüssel zu verschlüsseln.</span><span class="sxs-lookup"><span data-stu-id="f869a-116">In key agreement management, a temporary, ephemeral Diffie-Hellman private key is generated and used to encrypt the session key.</span></span> <span data-ttu-id="f869a-117">Der öffentliche Schlüssel, der dem kurzlebigen privaten Schlüssel entspricht, ist als Teil der Empfängerinformationen der Nachricht enthalten.</span><span class="sxs-lookup"><span data-stu-id="f869a-117">The public key corresponding to the ephemeral private key is included as part of the message's recipient information.</span></span> <span data-ttu-id="f869a-118">Der Empfänger entschlüsselt den Sitzungsschlüssel mit dem empfangenen kurzlebigen Schlüssel und verwendet diesen entschlüsselten Sitzungsschlüssel, um die eingeschlossene Nachricht zu entschlüsseln.</span><span class="sxs-lookup"><span data-stu-id="f869a-118">The recipient decrypts the session key using the received ephemeral key and uses this decrypted session key to decrypt the enveloped message.</span></span> <span data-ttu-id="f869a-119">Mithilfe der kurzlebigen Schlüssel Vereinbarung in Verbindung mit dem privaten Schlüssel des Empfängers verfügt der Nachrichtenempfänger über bestätigte Informationen über die Identität des Absenders.</span><span class="sxs-lookup"><span data-stu-id="f869a-119">Using ephemeral key agreement in conjunction with the receiver's private key, the message receiver does have confirmed information on the identity of the sender.</span></span>

<span data-ttu-id="f869a-120">Bei der Schlüsselverwaltung mit zuvor verteilten [*symmetrischen Schlüsseln*](../secgloss/s-gly.md)enthält jede Nachricht den Inhalts Verschlüsselungsschlüssel, der mit einem zuvor verteilten Schlüssel Verschlüsselungsschlüssel verschlüsselt wurde.</span><span class="sxs-lookup"><span data-stu-id="f869a-120">For key management using previously distributed [*symmetric keys*](../secgloss/s-gly.md), each message includes the content-encryption key that has been encrypted with a previously distributed key-encryption key.</span></span> <span data-ttu-id="f869a-121">Empfänger verwenden den zuvor verteilten Schlüssel Verschlüsselungsschlüssel zum Entschlüsseln des Inhalts Verschlüsselungsschlüssels. verwenden Sie dann den entschlüsselten Inhalts Verschlüsselungsschlüssel, um die eingeschlossene Nachricht zu entschlüsseln.</span><span class="sxs-lookup"><span data-stu-id="f869a-121">Receivers use the previously distributed key-encryption key to decrypt the content encryption key, then use the decrypted content-encryption key to decrypt the enveloped message.</span></span>

<span data-ttu-id="f869a-122">In der folgenden Abbildung ist eine typische CMS-Sequenz von Ereignissen für die Codierung von eingeschlossenen Daten dargestellt.</span><span class="sxs-lookup"><span data-stu-id="f869a-122">A typical CMS sequence of events for encoding enveloped data, is shown in the following illustration.</span></span>

![Codieren von eingeschlossenen Daten](images/envelmsg.png)

-   <span data-ttu-id="f869a-124">Ein Zeiger auf die [*Klartext*](../secgloss/p-gly.md) -Nachricht wird abgerufen.</span><span class="sxs-lookup"><span data-stu-id="f869a-124">A pointer to the [*plaintext*](../secgloss/p-gly.md) message is retrieved.</span></span>
-   <span data-ttu-id="f869a-125">Ein symmetrischer ([*Sitzungs*](../secgloss/s-gly.md)-) Schlüssel wird generiert.</span><span class="sxs-lookup"><span data-stu-id="f869a-125">A symmetric ([*session*](../secgloss/s-gly.md)) key is generated.</span></span>
-   <span data-ttu-id="f869a-126">Der [*symmetrische Schlüssel*](../secgloss/s-gly.md) und der angegebene Verschlüsselungsalgorithmus werden verwendet, um die Nachrichten Daten zu verschlüsseln.</span><span class="sxs-lookup"><span data-stu-id="f869a-126">The [*symmetric key*](../secgloss/s-gly.md) and specified encryption algorithm are used to encrypt the message data.</span></span>
-   <span data-ttu-id="f869a-127">Ein [*Zertifikat Speicher*](../secgloss/c-gly.md) wird geöffnet.</span><span class="sxs-lookup"><span data-stu-id="f869a-127">A [*certificate store*](../secgloss/c-gly.md) is opened.</span></span>
-   <span data-ttu-id="f869a-128">Das Zertifikat des Empfängers wird aus dem Speicher abgerufen.</span><span class="sxs-lookup"><span data-stu-id="f869a-128">The recipient's certificate is retrieved from the store.</span></span>
-   <span data-ttu-id="f869a-129">Der [*öffentliche Schlüssel*](../secgloss/p-gly.md) wird aus dem Zertifikat des Empfängers abgerufen.</span><span class="sxs-lookup"><span data-stu-id="f869a-129">The [*public key*](../secgloss/p-gly.md) is retrieved from the recipient's certificate.</span></span>
-   <span data-ttu-id="f869a-130">Mithilfe des öffentlichen Schlüssels des Empfängers wird der symmetrische Schlüssel verschlüsselt.</span><span class="sxs-lookup"><span data-stu-id="f869a-130">Using the recipient's public key, the symmetric key is encrypted.</span></span>
-   <span data-ttu-id="f869a-131">Aus dem Zertifikat des Empfängers wird die ID des Empfängers abgerufen.</span><span class="sxs-lookup"><span data-stu-id="f869a-131">From the recipient's certificate, the recipient's ID is retrieved.</span></span>
-   <span data-ttu-id="f869a-132">Die folgenden Informationen sind in der Digital umgerufenen Nachricht enthalten: der Daten Verschlüsselungsalgorithmus, die verschlüsselten Daten, der verschlüsselte symmetrische Schlüssel und die Struktur der Empfängerinformationen.</span><span class="sxs-lookup"><span data-stu-id="f869a-132">The following information is included in the digitally enveloped message: the data encryption algorithm, the encrypted data, the encrypted symmetric key, and the recipient information structure.</span></span>

<span data-ttu-id="f869a-133">Verwenden Sie das folgende Verfahren, wenn Sie Nachrichten Funktionen auf niedriger Ebene verwenden möchten, um die gerade aufgelisteten Aufgaben zu erledigen.</span><span class="sxs-lookup"><span data-stu-id="f869a-133">To use low-level message functions to accomplish the typical tasks just listed, use the following procedure.</span></span>

<span data-ttu-id="f869a-134">**So codieren Sie eine eingeschlossene Nachricht**</span><span class="sxs-lookup"><span data-stu-id="f869a-134">**To encode an enveloped message**</span></span>

1.  <span data-ttu-id="f869a-135">Erstellen oder Abrufen des Inhalts.</span><span class="sxs-lookup"><span data-stu-id="f869a-135">Create or retrieve the content.</span></span>
2.  <span data-ttu-id="f869a-136">Verschaffen Sie sich einen Kryptografieanbieter.</span><span class="sxs-lookup"><span data-stu-id="f869a-136">Get a cryptographic provider.</span></span>
3.  <span data-ttu-id="f869a-137">Erhalten Sie ein Empfänger Zertifikat.</span><span class="sxs-lookup"><span data-stu-id="f869a-137">Get a recipient certificate.</span></span>
4.  <span data-ttu-id="f869a-138">Initialisieren Sie die eingefügte CMSG-Struktur zum [**\_ \_ Codieren von \_ Informationen**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) .</span><span class="sxs-lookup"><span data-stu-id="f869a-138">Initialize the [**CMSG\_ENVELOPED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) structure.</span></span>
5.  <span data-ttu-id="f869a-139">Sie können [**cryptmsgcalculateencodedlength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) aufrufen, um die Größe des codierten nachrichtenblobs zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="f869a-139">Call [**CryptMsgCalculateEncodedLength**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgcalculateencodedlength) to get the size of the encoded message BLOB.</span></span> <span data-ttu-id="f869a-140">Arbeitsspeicher zuweisen.</span><span class="sxs-lookup"><span data-stu-id="f869a-140">Allocate memory for it.</span></span>
6.  <span data-ttu-id="f869a-141">Nennen Sie [**cryptmsgopentoencode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), und übergeben Sie CMSG \_ für *dwmsgtype* und einen Zeiger auf [**CMSG \_ enveloped \_ encode \_ Info**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) for *pvmsgencodeinfo*.</span><span class="sxs-lookup"><span data-stu-id="f869a-141">Call [**CryptMsgOpenToEncode**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgopentoencode), passing in CMSG\_ENVELOPED for *dwMsgType* and a pointer to [**CMSG\_ENVELOPED\_ENCODE\_INFO**](/windows/desktop/api/Wincrypt/ns-wincrypt-cmsg_enveloped_encode_info) for *pvMsgEncodeInfo*.</span></span> <span data-ttu-id="f869a-142">Als Ergebnis dieses Aufrufes wird ein Handle für die geöffnete Nachricht angezeigt.</span><span class="sxs-lookup"><span data-stu-id="f869a-142">As a result of this call, you will get a handle to the opened message.</span></span>
7.  <span data-ttu-id="f869a-143">Nennen Sie [**cryptmsgupdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), und übergeben Sie das in Schritt 6 abgerufene Handle und einen Zeiger auf die zu verschlüsselnden, umschlossenen und codierten Daten.</span><span class="sxs-lookup"><span data-stu-id="f869a-143">Call [**CryptMsgUpdate**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgupdate), passing in the handle retrieved in step 6 and a pointer to the data that is to be encrypted, enveloped, and encoded.</span></span> <span data-ttu-id="f869a-144">Diese Funktion kann so oft wie nötig aufgerufen werden, um den Codierungsprozess abzuschließen.</span><span class="sxs-lookup"><span data-stu-id="f869a-144">This function can be called as many times as necessary to complete the encoding process.</span></span>
8.  <span data-ttu-id="f869a-145">Aufrufen von [**cryptmsggetparam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), übergeben des in Schritt 6 abgerufenen Handles und der entsprechenden Parametertypen für den Zugriff auf die gewünschten, codierten Daten.</span><span class="sxs-lookup"><span data-stu-id="f869a-145">Call [**CryptMsgGetParam**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsggetparam), passing in the handle retrieved in step 6 and the appropriate parameter types to access the desired, encoded data.</span></span> <span data-ttu-id="f869a-146">Übergeben Sie z. b. CMSG \_ Content \_ param, um einen Zeiger auf die gesamte PKCS 7-Nachricht zu erhalten \# .</span><span class="sxs-lookup"><span data-stu-id="f869a-146">For example, pass in CMSG\_CONTENT\_PARAM to get a pointer to the entire PKCS \#7 message.</span></span>

    <span data-ttu-id="f869a-147">Wenn das Ergebnis dieser Codierung als [*innere Daten*](../secgloss/i-gly.md) für eine andere codierte Nachricht verwendet werden soll, z. b. eine eingeschlossene Nachricht, muss der CMSG-Parameter für den \_ Bare-Content- \_ \_ Parameter übergeben werden.</span><span class="sxs-lookup"><span data-stu-id="f869a-147">If the result of this encoding is to be used as the [*inner data*](../secgloss/i-gly.md) for another encoded message, such as an enveloped message, the CMSG\_BARE\_CONTENT\_PARAM parameter must be passed.</span></span> <span data-ttu-id="f869a-148">Ein Beispiel finden Sie unter [alternativer Code zum Codieren einer](alternate-code-for-encoding-an-enveloped-message.md)eingeschlossenen Nachricht.</span><span class="sxs-lookup"><span data-stu-id="f869a-148">For an example, see [Alternate Code for Encoding an Enveloped Message](alternate-code-for-encoding-an-enveloped-message.md).</span></span>

9.  <span data-ttu-id="f869a-149">Schließen Sie die Nachricht, indem Sie [**cryptmsgclose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose)aufrufen.</span><span class="sxs-lookup"><span data-stu-id="f869a-149">Close the message by calling [**CryptMsgClose**](/windows/desktop/api/Wincrypt/nf-wincrypt-cryptmsgclose).</span></span>

<span data-ttu-id="f869a-150">Das Ergebnis dieser Prozedur ist eine codierte Nachricht, die die verschlüsselten Daten, den [*symmetrischen Schlüssel*](../secgloss/s-gly.md) , der mit den öffentlichen Schlüsseln des Empfängers verschlüsselt ist, und die Datenstrukturen der Empfängerinformationen enthält.</span><span class="sxs-lookup"><span data-stu-id="f869a-150">The result of this procedure is an encoded message that contains the encrypted data, the [*symmetric key*](../secgloss/s-gly.md) that is encrypted with the recipient's public keys, and the recipient information data structures.</span></span> <span data-ttu-id="f869a-151">Die Kombination aus verschlüsseltem Inhalt und einem verschlüsselten symmetrischen Schlüssel für einen Empfänger ist ein [*digitaler Umschlag*](../secgloss/d-gly.md) für diesen Empfänger.</span><span class="sxs-lookup"><span data-stu-id="f869a-151">The combination of encrypted content and an encrypted symmetric key for a recipient is a [*digital envelope*](../secgloss/d-gly.md) for that recipient.</span></span> <span data-ttu-id="f869a-152">Jeder Inhaltstyp kann für mehrere Empfänger umgehüllt werden.</span><span class="sxs-lookup"><span data-stu-id="f869a-152">Any type of content can be enveloped for multiple recipients.</span></span>

## <a name="related-topics"></a><span data-ttu-id="f869a-153">Zugehörige Themen</span><span class="sxs-lookup"><span data-stu-id="f869a-153">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="f869a-154">Beispiel-C-Programm: Codieren einer eingeschlossenen, signierten Nachricht</span><span class="sxs-lookup"><span data-stu-id="f869a-154">Example C Program: Encoding an Enveloped, Signed Message</span></span>](example-c-program-encoding-an-enveloped-signed-message.md)
</dt> </dl>

 

 
