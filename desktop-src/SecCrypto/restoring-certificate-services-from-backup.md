---
description: Zeigt, wie die Sicherungsfunktionen der Zertifikat Dienste zum Wiederherstellen einer Zertifikat Dienst Datenbank und der zugehörigen Dateien verwendet werden können.
ms.assetid: f4914f45-629d-4f24-8328-d7f27e8a0062
title: Zertifikat Dienste werden von der Sicherung wieder hergestellt
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 8f5adf46d802194909397a3b70483b3cf43bb409
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/08/2021
ms.locfileid: "106351516"
---
# <a name="restoring-certificate-services-from-backup"></a><span data-ttu-id="a4bb7-103">Zertifikat Dienste werden von der Sicherung wieder hergestellt</span><span class="sxs-lookup"><span data-stu-id="a4bb7-103">Restoring Certificate Services from Backup</span></span>

<span data-ttu-id="a4bb7-104">Das folgende Szenario zeigt, wie die Sicherungsfunktionen der Zertifikat Dienste zum Wiederherstellen einer Zertifikat Dienst Datenbank und der zugehörigen Dateien verwendet werden können.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-104">The following scenario shows how the Certificate Services backup functions can be used to restore and recover a Certificate Services database and its associated files.</span></span> <span data-ttu-id="a4bb7-105">Der Wiederherstellungs Vorgang umfasst das Schreiben der in einem Sicherungs Satz enthaltenen Dateien auf den Datenträger.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-105">The restoration process involves writing the files contained in a backup set to disk.</span></span> <span data-ttu-id="a4bb7-106">Sie können mehrere Sicherungs Sätze wiederherstellen (eine vollständige Sicherung plus null oder mehr inkrementelle Sicherungen), aber alle Wiederherstellungen müssen vor Beginn des Wiederherstellungs Vorgangs vollständig ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-106">You may restore multiple backup sets (one full backup plus zero or more incremental backups), but all restores must be complete prior to beginning the recovery process.</span></span> <span data-ttu-id="a4bb7-107">Der Wiederherstellungsprozess umfasst Zertifikat Dienste, die Protokolldateien wiedergeben, um die Konsistenz der Datenbank und der Protokolldateien sicherzustellen</span><span class="sxs-lookup"><span data-stu-id="a4bb7-107">The recovery process involves Certificate Services replaying log files to ensure database and log file consistency, thereby ensuring database integrity.</span></span> <span data-ttu-id="a4bb7-108">Das Szenario veranschaulicht die Funktionsaufrufe zum Wiederherstellen der Sicherungs Sätze und zum Benachrichtigen der Zertifikat Dienste der Wiederherstellungs Parameter.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-108">The scenario illustrates the function calls to restore the backup sets and inform Certificate Services of the recovery parameters.</span></span>

<span data-ttu-id="a4bb7-109">Vor der Implementierung dieses Szenarios muss eine vorhandene vollständige Sicherung der Zertifikat Dienst Datenbank vorhanden sein.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-109">An existing full backup of the Certificate Services database must exist before implementing this scenario.</span></span>

1.  <span data-ttu-id="a4bb7-110">Laden Sie die Certadm.dll Bibliothek in den Arbeitsspeicher (durch Aufrufen von [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span><span class="sxs-lookup"><span data-stu-id="a4bb7-110">Load the Certadm.dll library into memory (by calling [**LoadLibrary**](/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)).</span></span>
2.  <span data-ttu-id="a4bb7-111">Rufen Sie die Adresse der einzelnen erforderlichen Funktionen in Certadm.dll (über [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)) ab.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-111">Retrieve the address of each of the necessary functions in Certadm.dll (by means of [**GetProcAddress**](/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress)).</span></span> <span data-ttu-id="a4bb7-112">Verwenden Sie diese Adressen, wenn Sie die Funktionen in den verbleibenden Schritten aufrufen.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-112">Use these addresses when calling the functions in the remaining steps.</span></span>
3.  <span data-ttu-id="a4bb7-113">Wenden Sie [**cerzrvisserveronline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) an, um zu bestimmen, ob die Zertifikat Dienste online sind.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-113">Call [**CertSrvIsServerOnline**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvisserveronlinew) to determine whether Certificate Services is online.</span></span> <span data-ttu-id="a4bb7-114">Wenn die Zertifikat Dienste ausgeführt werden, fahren Sie Sie herunter, bevor Sie fortfahren.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-114">If Certificate Services is running, shut it down before proceeding.</span></span> <span data-ttu-id="a4bb7-115">Die Zertifikat Dienste dürfen nicht online sein, damit die Wiederherstellungs Vorgänge erfolgreich ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-115">Certificate Services must not be online for the restore operations to be successful.</span></span>
4.  <span data-ttu-id="a4bb7-116">Nennen Sie [**cerzrvrestoreprepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestorepreparew) , um eine Wiederherstellungs Sitzung zu starten.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-116">Call [**CertSrvRestorePrepare**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestorepreparew) to begin a restore session.</span></span> <span data-ttu-id="a4bb7-117">Das resultierende Sicherungs Kontext Handle der Zertifikat Dienste wird von mehreren der anderen Funktionen verwendet.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-117">The resulting Certificate Services backup context handle will be used by several of the other functions.</span></span>
5.  <span data-ttu-id="a4bb7-118">Bestimmen Sie den Pfad für den Speicherort der Datenbank.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-118">Determine the path for the database location.</span></span> <span data-ttu-id="a4bb7-119">Während eines Sicherungs Szenarios wäre dieser Wert über einen Befehl von " [**cerzrvrestoregetdatabaselocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw)" verfügbar. Dieser Wert sollte als Teil der Sicherung gespeichert worden sein.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-119">During a backup scenario, this value would have been available from a call to [**CertSrvRestoreGetDatabaseLocations**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoregetdatabaselocationsw); this value should have been stored as part of the backup.</span></span>
6.  <span data-ttu-id="a4bb7-120">Erstellen Sie eine Wiederherstellungs Zuordnung, die den Namen der wiederhergestellten Datenbank angibt.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-120">Create a restore map specifying the name of the restored database.</span></span> <span data-ttu-id="a4bb7-121">Eine mapremap-Struktur für die Daten Bank Wiederherstellung ( \_ ccrstmapw) für Zertifikat Dienste wird zum Angeben einer Wiederherstellungs Zuordnung verwendet.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-121">A Certificate Services database restore map structure (CSEDB\_RSTMAPW) is used to specify a restore map.</span></span> <span data-ttu-id="a4bb7-122">Legen \_ Sie das **pwszdatabasename** -Element von csedb rstmapw und das \_ **pwsznewdatabasename** -Element von csedb rstmapw auf den Daten Bank Speicherort fest, der in Schritt 5 festgelegt wurde.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-122">Set the CSEDB\_RSTMAPW's **pwszDatabaseName** member and the CSEDB\_RSTMAPW's **pwszNewDatabaseName** member to the database location determined in step 5.</span></span> <span data-ttu-id="a4bb7-123">Wenn die wiederhergestellte Datenbank einen anderen Namen als die Sicherungs Datenbank aufweisen soll, legen \_ Sie den **pwsznewdatabasename** -Member der csedb-rstmapw auf den neuen Datenbanknamen fest.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-123">Optionally, if the restored database is to have a different name than the backup database, set the CSEDB\_RSTMAPW's **pwszNewDatabaseName** member to the new database name.</span></span>
7.  <span data-ttu-id="a4bb7-124">Wenn Sie sicherstellen möchten, dass Änderungen, die nach dem Durchführen der Sicherung an der Datenbank vorgenommen wurden, nicht erneut angewendet werden, nachdem die Daten Bank Wiederherstellung durchgeführt wurde (als Teil der Daten Bank Wiederherstellung beim nächsten Starten der Zertifikat Dienste), löschen Sie Dateien aus der aktiven Datenbank und dem Protokoll Verzeichnis des Zielservers.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-124">If you want to ensure that modifications made to the database after the backup was performed are not reapplied after database restore is complete (as part of database recovery performed during the next Certificate Services startup), delete files from the target server's active database and log directories.</span></span>
8.  <span data-ttu-id="a4bb7-125">Kopieren Sie die Dateien, die in der vollständigen Sicherung enthalten sind, in die aktive Datenbank und die Protokoll Verzeichnisse des Zielservers.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-125">Copy the files contained in the full backup to the target server's active database and log directories.</span></span>
9.  <span data-ttu-id="a4bb7-126">Nennen Sie [**cerzrvrestoreregister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw) , um einen Wiederherstellungs Vorgang für die vollständige Sicherung zu registrieren.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-126">Call [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw) to register a restore operation for the full backup.</span></span> <span data-ttu-id="a4bb7-127">**Cerzrvrestoreregiester** verwendet die in Schritt 6 angegebene Wiederherstellungs Zuordnung.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-127">**CertSrvRestoreRegister** uses the restore map specified in step 6.</span></span> <span data-ttu-id="a4bb7-128">**Certsrvrestoreregiester** gibt auch den Speicherort der Sicherungs Datenbank und der Protokolle an.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-128">**CertSrvRestoreRegister** also specifies the location of the backup database and logs.</span></span> <span data-ttu-id="a4bb7-129">Durch das Aufrufen von " **certrvrestoreregiester** " wird erzwungen, dass Zertifikat Dienste beim nächsten Start einen Wiederherstellungs Vorgang versuchen.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-129">Calling **CertSrvRestoreRegister** will force Certificate Services to attempt a restore operation the next time it is started.</span></span> <span data-ttu-id="a4bb7-130">Außerdem wird verhindert, dass Zertifikat Dienste Zertifikat Anforderungen verarbeiten, bis die Wiederherstellung beendet ist.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-130">It also prevents Certificate Services from processing Certificate Requests until the restoration is complete.</span></span>
10. <span data-ttu-id="a4bb7-131">Nennen Sie [**cerzrvrestoreregistercomplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete), wodurch die in Schritt 8 gestartete Registrierungs Aktivität abgeschlossen wird.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-131">Call [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete), thereby finishing the registration activity that started in step 8.</span></span> <span data-ttu-id="a4bb7-132">Beachten Sie, dass die Registrierung eines Wiederherstellungs Vorgangs eine Anweisung für die Zertifikat Dienste ist, die beim Start befolgt werden sollen. die tatsächliche Wiederherstellung wird erst ausgeführt, nachdem die Zertifikat Dienste gestartet wurden.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-132">Note that the registration of a restore operation is an instruction for Certificate Services to follow when it is started; the actual recovery will take place only after Certificate Services is started.</span></span>
11. <span data-ttu-id="a4bb7-133">Kopieren Sie für jede wieder herzustellende inkrementelle Sicherung die Dateien, die in der inkrementellen Sicherung enthalten sind, in das aktive Protokoll Verzeichnis des Zielservers, und klicken Sie dann auf [](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete) [**cerzrvrestoreregistercomplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw).</span><span class="sxs-lookup"><span data-stu-id="a4bb7-133">For each incremental backup to be restored, copy the files contained in the incremental backup to the target server's active log directory, then call [**CertSrvRestoreRegister**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregisterw), followed by a call to [**CertSrvRestoreRegisterComplete**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreregistercomplete).</span></span> <span data-ttu-id="a4bb7-134">Die Registrierung der inkrementellen Sicherungen für die Wiederherstellung kann in beliebiger Reihenfolge erfolgen, aber nur der Satz von Dateien für eine inkrementelle Sicherung muss vor jedem Rückruf von **certsrvrestoreregiester** auf den Server kopiert werden.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-134">The registration of the incremental backups for restoration can occur in any order, but only the set of files for one incremental backup should be copied to the server before each call to **CertSrvRestoreRegister**.</span></span>
12. <span data-ttu-id="a4bb7-135">Kopieren Sie die dynamischen Dateien der Zertifikat Dienste auf den Zielserver.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-135">Copy the Certificate Services dynamic files to the target server.</span></span> <span data-ttu-id="a4bb7-136">Die dynamischen Dateien wurden während der Sicherung identifiziert, als " [**certrvbackupgetdynamicfilelist**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) " aufgerufen wurde.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-136">The dynamic files would have been identified during the backup when [**CertSrvBackupGetDynamicFileList**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvbackupgetdynamicfilelistw) was called.</span></span> <span data-ttu-id="a4bb7-137">Möglicherweise ist es erforderlich, den World Wide Web Publishing-Dienstanbieter anzuhalten, damit die dynamischen Dateien überschrieben werden können.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-137">It may be necessary to stop the World Wide Web Publishing Service to allow overwriting the dynamic files.</span></span>
13. <span data-ttu-id="a4bb7-138">Nennen Sie [**cerzrvrestoreend**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreend) , um die Wiederherstellungs Sitzung zu beenden.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-138">Call [**CertSrvRestoreEnd**](/windows/desktop/api/Certbcli/nf-certbcli-certsrvrestoreend) to end the restore session.</span></span>
14. <span data-ttu-id="a4bb7-139">Starten Sie die Zertifikat Dienst Anwendung manuell (oder warten Sie bis zum nächsten Neustart, damit Sie automatisch gestartet wird).</span><span class="sxs-lookup"><span data-stu-id="a4bb7-139">Start the Certificate Services application manually (or wait until the next restart for it to start automatically).</span></span> <span data-ttu-id="a4bb7-140">Wenn die Zertifikat Dienste gestartet werden, wird festgestellt, ob ein Wiederherstellungs Vorgang registriert wurde. Wenn ein Wiederherstellungs Vorgang registriert wurde, wird die Wiederherstellung der Zertifikat Dienste gestartet.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-140">When Certificate Services starts, it will determine whether a restore operation has been registered; if a restore operation has been registered, Certificate Services will begin the recovery.</span></span> <span data-ttu-id="a4bb7-141">Zertifikat Dienste verarbeiten keine Zertifikat Anforderungen, bis der Wiederherstellungs Vorgang abgeschlossen ist.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-141">Certificate Services will not process any certificate requests until the recovery operation is completed.</span></span>

> [!Note]  
> <span data-ttu-id="a4bb7-142">Wenn eine Wiederherstellung vollständig ist, ist es wichtig, dass Sie eine neue vollständige Sicherung der Zertifikat Dienst Datenbank erstellen.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-142">When a recovery is complete, it is important that you make a new full backup of the Certificate Services database.</span></span> <span data-ttu-id="a4bb7-143">Dies ist erforderlich, um die wiederhergestellten Protokolldateien abzuschneiden und einen Basis Sicherungs Satz für zukünftige Wiederherstellungen einzurichten.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-143">This is necessary to truncate the restored log files and to establish a base backup set for future restores.</span></span> <span data-ttu-id="a4bb7-144">Sicherungen, die nach einer Wiederherstellung ausgeführt werden, können nicht mit Sicherungen (vollständig oder inkrementell) gemischt werden Das heißt, nachdem eine Zertifikat Dienst Datenbank wieder hergestellt wurde und sich in einem nachfolgenden Zustand befindet, können Sie mit den Sicherungen vor der Wiederherstellung die Datenbank in diesem nachfolgenden Zustand wiederherstellen.</span><span class="sxs-lookup"><span data-stu-id="a4bb7-144">Backups performed after a restore cannot be mixed with backups (full or incremental) taken before the restore; that is, after a certificate services database is restored and has progressed to a subsequent state, you cannot use the pre-restoration backups to restore the database to that subsequent state.</span></span>

 

 

 
