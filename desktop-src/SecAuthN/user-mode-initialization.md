---
description: Verteilte (Client/Server) Anwendungen verwenden Sicherheitspakete zum Abrufen authentifizierter Verbindungen und zum Austauschen von Nachrichten.
ms.assetid: 8f28177f-335a-4fa2-bf66-2ec1698bebec
title: Benutzermodusinitialisierung
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 473b06daf2e1c3612b02583d203ce4cd9afebabd
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/08/2021
ms.locfileid: "103960332"
---
# <a name="user-mode-initialization"></a><span data-ttu-id="de791-103">Benutzermodusinitialisierung</span><span class="sxs-lookup"><span data-stu-id="de791-103">User Mode Initialization</span></span>

<span data-ttu-id="de791-104">Verteilte (Client/Server) Anwendungen verwenden [*Sicherheitspakete*](../secgloss/s-gly.md) zum Abrufen authentifizierter Verbindungen und zum Austauschen von Nachrichten.</span><span class="sxs-lookup"><span data-stu-id="de791-104">Distributed (client/server) applications use [*security packages*](../secgloss/s-gly.md) to obtain authenticated connections and to exchange messages.</span></span> <span data-ttu-id="de791-105">Die Anwendung ruft Security Support Provider Schnittstellen Funktionen (SSPI) auf, die von [SSP/APS implementierte Funktionen](authentication-functions.md)zugeordnet sind, sowie Funktionen, die [von SSP/APS im Benutzermodus implementiert](authentication-functions.md)werden.</span><span class="sxs-lookup"><span data-stu-id="de791-105">The application calls security support provider interface (SSPI) functions which are mapped to [functions implemented by SSP/APs](authentication-functions.md), and [functions implemented by User-mode SSP/APs](authentication-functions.md).</span></span> <span data-ttu-id="de791-106">Diese Zuordnung wird von der Sicherheitsanbieter-dll (Secur32.dll oder Security.dll) ausgeführt, die in die Client-und Server Prozesse dynamisch geladen werden kann.</span><span class="sxs-lookup"><span data-stu-id="de791-106">This mapping is performed by the security provider DLL (Secur32.dll or Security.dll), which can be loaded into the client and server processes dynamically.</span></span> <span data-ttu-id="de791-107">Die dll kann auch statisch mit Secur32. lib verknüpft werden.</span><span class="sxs-lookup"><span data-stu-id="de791-107">The DLL can also be statically linked using Secur32.lib.</span></span> <span data-ttu-id="de791-108">Sowohl die dll als auch die lib werden mit dem Microsoft Windows Software Development Kit (SDK) ausgeliefert.</span><span class="sxs-lookup"><span data-stu-id="de791-108">Both the DLL and LIB ship with the Microsoft Windows Software Development Kit (SDK).</span></span>

<span data-ttu-id="de791-109">Das Laden des Sicherheitspakets in den Client-oder Server Prozess wird vom System übernommen, wenn die SSP/AP-dll, die das Sicherheitspaket enthält, ordnungsgemäß registriert ist.</span><span class="sxs-lookup"><span data-stu-id="de791-109">Loading the security package into the client or server's process is handled by the system, if the SSP/AP DLL that contains the security package is properly registered.</span></span>

<span data-ttu-id="de791-110">Der Server beginnt mit dem Abrufen einer sicheren Verbindung mit einem Client, indem er einen Port überwacht und darauf wartet, dass ein Client eine Nachricht sendet.</span><span class="sxs-lookup"><span data-stu-id="de791-110">The server begins the process of obtaining a secure connection with a client by monitoring a port, waiting for a client to send a message.</span></span> <span data-ttu-id="de791-111">Der Client beginnt mit dem Abrufen einer sicheren Verbindung zum Server durch Aufrufen der SSPI-Funktion [**InitializeSecurityContext (allgemein)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta).</span><span class="sxs-lookup"><span data-stu-id="de791-111">The client begins the process of obtaining a secure connection to the server by calling the SSPI function [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta).</span></span> <span data-ttu-id="de791-112">Diese Funktion wird der [**spinitlsamodecontext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) -Funktion des benutzerdefinierten Sicherheitspakets zugeordnet.</span><span class="sxs-lookup"><span data-stu-id="de791-112">This function is mapped to the custom security package's [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) function.</span></span> <span data-ttu-id="de791-113">**Spinitlsamodecontext** gibt ein Token an den Client zurück, das es an den Server weiterleitet.</span><span class="sxs-lookup"><span data-stu-id="de791-113">**SpInitLsaModeContext** returns a token to the client, who forwards it to the server.</span></span>

<span data-ttu-id="de791-114">Wenn das Token vom Client empfangen wird, ruft der Server die SSPI-Funktion " [**Accept-SecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext)" auf, die an die [**spaccept tlsamodecontext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) -Funktion des Sicherheitspakets gesendet wird.</span><span class="sxs-lookup"><span data-stu-id="de791-114">Upon receiving the token from the client, the server calls the SSPI function [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext), which is dispatched to the security package's [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) function.</span></span> <span data-ttu-id="de791-115">Wenn die **spaccept tlsamodecontext** -Funktion erfolgreich ist und keine weitere Verarbeitung erforderlich ist, um den Sicherheitskontext einzurichten, sollte die Funktion den Status Erfolg an den Aufrufer zurückgeben \_ .</span><span class="sxs-lookup"><span data-stu-id="de791-115">If the **SpAcceptLsaModeContext** function succeeds and no more processing is required to establish the security context, the function should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="de791-116">Wenn eine zusätzliche Verarbeitung erforderlich ist, sollte die Funktion Sekunden zurückgeben \_ , die ich \_ weiterhin \_ benötigter, und ein Token an den Server zurückgeben.</span><span class="sxs-lookup"><span data-stu-id="de791-116">If additional processing is required, the function should return SEC\_I\_CONTINUE\_NEEDED, and return a token to the server.</span></span> <span data-ttu-id="de791-117">Der Server leitet das Token an den Client weiter, der [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta) erneut aufruft.</span><span class="sxs-lookup"><span data-stu-id="de791-117">The server forwards the token to the client, who calls [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta) again.</span></span>

<span data-ttu-id="de791-118">Dieser aufrufende Cycle kann so oft wie nötig wiederholt werden, bis eine authentifizierte Verbindung hergestellt ist oder fehlschlägt.</span><span class="sxs-lookup"><span data-stu-id="de791-118">This calling cycle may be repeated as often as necessary until an authenticated connection is established or fails.</span></span> <span data-ttu-id="de791-119">Wenn während dieses Vorgangs die [**spaccept tlsamodecontext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) -oder [**spinitlsamodecontext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) -Funktion erfolgreich ausgeführt wird und keine weitere Verarbeitung erforderlich ist, um den [*Sicherheitskontext*](../secgloss/s-gly.md)einzurichten, sollte die Funktion den Status \_ Erfolg an den Aufrufer zurückgeben.</span><span class="sxs-lookup"><span data-stu-id="de791-119">During this process, if the [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) or [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) function succeeds and no more processing is required to establish the [*security context*](../secgloss/s-gly.md), the function should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="de791-120">Wenn eine zusätzliche Verarbeitung erforderlich ist, sollte die Funktion Sekunden zurückgeben, die \_ ich \_ weiterhin \_ benötigter, und ein Token an den Aufrufer zurückgeben, der für die Weiterleitung verantwortlich ist.</span><span class="sxs-lookup"><span data-stu-id="de791-120">If additional processing is required, the function should return SEC\_I\_CONTINUE\_NEEDED, and return a token to the caller, who is responsible for forwarding it.</span></span>

<span data-ttu-id="de791-121">Das Protokoll, das vom Sicherheitspaket implementiert wird, bestimmt, wie oft dieser Cycle wiederholt wird.</span><span class="sxs-lookup"><span data-stu-id="de791-121">The protocol implemented by the security package determines the number of times this cycle is repeated.</span></span> <span data-ttu-id="de791-122">Beispielsweise ist in Sicherheitspaketen, die die dreiseitige gegenseitige Authentifizierung unterstützen, die Aufruf Sequenz wie folgt:</span><span class="sxs-lookup"><span data-stu-id="de791-122">For example, in security packages that supports three-leg mutual authentication, the calling sequence is as follows:</span></span>

1.  <span data-ttu-id="de791-123">Der Client ruft ein Token durch Aufrufen von [**InitializeSecurityContext (allgemein)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta)ab und sendet ihn an den Server.</span><span class="sxs-lookup"><span data-stu-id="de791-123">Client obtains a token by calling [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta), and sends it to the server.</span></span> <span data-ttu-id="de791-124">Der Server Ruft beim ersten Mal " [**akzeptsecuritycontext (allgemein)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext) " auf und ruft ein Antwort Token zurück, das an den Client gesendet wird.</span><span class="sxs-lookup"><span data-stu-id="de791-124">The server calls [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext) the first time, and gets back a reply token which it sends to the client.</span></span>
2.  <span data-ttu-id="de791-125">Der Client verwendet das Token, das vom Server in einem zweiten [**callalizesecuritycontext-Befehl (allgemein)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta)empfangen wurde, und ruft ein endgültiges Token ab.</span><span class="sxs-lookup"><span data-stu-id="de791-125">The client uses the token received from the server in a second call to [**InitializeSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-initializesecuritycontexta), and gets back a final token.</span></span> <span data-ttu-id="de791-126">Der Client sendet dieses Token an den Server.</span><span class="sxs-lookup"><span data-stu-id="de791-126">The client sends this token to the server.</span></span>
3.  <span data-ttu-id="de791-127">Der Server empfängt das in "bin 2" generierte Token, das im letzten Abruf von " [**akzeptsecuritycontext (allgemein)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext)" verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="de791-127">The server receives the token generated in leg 2 which it uses in the final call to [**AcceptSecurityContext (General)**](/windows/win32/api/sspi/nf-sspi-acceptsecuritycontext).</span></span>

<span data-ttu-id="de791-128">Wenn die [**spaccept tlsamodecontext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) -Funktion und die [**spinitlsamodecontext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) -Funktion erfolgreich sind und keine weitere Verarbeitung erforderlich ist, um den Sicherheitskontext einzurichten, sollten die Funktionen dem Aufrufer den Status Erfolg zurückgeben \_ .</span><span class="sxs-lookup"><span data-stu-id="de791-128">When the [**SpAcceptLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spacceptlsamodecontextfn) and [**SpInitLsaModeContext**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinitlsamodecontextfn) functions succeed and no more processing is required to establish the security context, the functions should return STATUS\_SUCCESS to the caller.</span></span> <span data-ttu-id="de791-129">Wenn das benutzerdefinierte Sicherheitspaket die Funktionen unterstützt, die [von SSP/APS im Benutzermodus implementiert](authentication-functions.md)werden, muss **spaccept tlsamodecontext** und **spinitlsamodecontext** über den *mappedcontext* -Parameter **true** zurückgeben.</span><span class="sxs-lookup"><span data-stu-id="de791-129">Additionally, if the custom security package supports the [functions implemented by user-mode SSP/APs](authentication-functions.md), **SpAcceptLsaModeContext** and **SpInitLsaModeContext** must return **TRUE** by way of the *MappedContext* parameter.</span></span> <span data-ttu-id="de791-130">Der *mappedcontext* -Wert wird nicht an die Anwendung zurückgegeben. Sie wird von der LSA abgefangen.</span><span class="sxs-lookup"><span data-stu-id="de791-130">The *MappedContext* value is not passed back to the application; it is intercepted by the LSA.</span></span>

<span data-ttu-id="de791-131">Wenn *mappedcontext* auf **true** festgelegt ist, ruft die LSA die [**spusermodeinitialize**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spusermodeinitializefn) -Funktion der SSP/AP-dll auf.</span><span class="sxs-lookup"><span data-stu-id="de791-131">When *MappedContext* is **true**, the LSA calls the SSP/AP DLL's [**SpUsermodeInitialize**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spusermodeinitializefn) function.</span></span> <span data-ttu-id="de791-132">Diese Funktion stellt Tabellen mit Zeigern für die Benutzermodus-Funktionen bereit, die von den einzelnen Sicherheitspaketen implementiert werden.</span><span class="sxs-lookup"><span data-stu-id="de791-132">This function provides tables of pointers to the user-mode functions implemented by each security package.</span></span> <span data-ttu-id="de791-133">Die [**spinstanceiniit**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinstanceinitfn) -Funktion jedes Pakets wird mithilfe der von **spusermodeinitialize** zurückgegebenen Funktionstabellen aufgerufen.</span><span class="sxs-lookup"><span data-stu-id="de791-133">Each package's [**SpInstanceInit**](/windows/desktop/api/Ntsecpkg/nc-ntsecpkg-spinstanceinitfn) function is called, using the function tables returned by **SpUsermodeInitialize**.</span></span> <span data-ttu-id="de791-134">**Spinstanceinit** empfängt eine Tabelle mit Zeigern auf [LSA-Funktionen, die von SSP/APS im Benutzermodus aufgerufen werden](authentication-functions.md).</span><span class="sxs-lookup"><span data-stu-id="de791-134">**SpInstanceInit** receives a table of pointers to [LSA functions called by user-mode SSP/APs](authentication-functions.md).</span></span>

 

 
