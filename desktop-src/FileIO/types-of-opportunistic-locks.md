---
description: Beschreibt die opportunistischen Sperren auf Ebene 1, Ebene 2, Batch und Filter.
ms.assetid: 06136348-0c08-4e9c-9c96-fd3af33cbdc0
title: Typen von opportunistischen Sperren
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: a755a6ff766f5d19e13d4b269c1ba4bb9803e934
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/08/2021
ms.locfileid: "103867691"
---
# <a name="types-of-opportunistic-locks"></a><span data-ttu-id="53e10-103">Typen von opportunistischen Sperren</span><span class="sxs-lookup"><span data-stu-id="53e10-103">Types of Opportunistic Locks</span></span>

<span data-ttu-id="53e10-104">Die opportunistischen Lock-Vorgänge funktionieren mit vier Typen von opportunistischen Sperren: Ebene 1, Ebene 2, Batch und Filter.</span><span class="sxs-lookup"><span data-stu-id="53e10-104">The opportunistic lock operations work with four types of opportunistic locks: level 1, level 2, batch, and filter.</span></span> <span data-ttu-id="53e10-105">*Exklusive opportunistische Sperren* sind Ebene 1, Batch und Filter sperren.</span><span class="sxs-lookup"><span data-stu-id="53e10-105">*Exclusive opportunistic locks* are level 1, batch, and filter locks.</span></span> <span data-ttu-id="53e10-106">Wenn ein Thread eine beliebige Art von exklusiver Sperre für eine Datei hat, kann er nicht auch über eine Sperre der Ebene 2 für dieselbe Datei verfügen.</span><span class="sxs-lookup"><span data-stu-id="53e10-106">If a thread has any type of exclusive lock on a file, it cannot also have a level 2 lock on the same file.</span></span>

## <a name="level-1-opportunistic-locks"></a><span data-ttu-id="53e10-107">Opportunistische Sperren der Ebene 1</span><span class="sxs-lookup"><span data-stu-id="53e10-107">Level 1 Opportunistic Locks</span></span>

<span data-ttu-id="53e10-108">Eine opportunistische Sperre der Ebene 1 in einer Datei ermöglicht einem Client, in der Datei zu lesen und sowohl Lese-als auch Schreib Daten aus der Datei lokal zu speichern.</span><span class="sxs-lookup"><span data-stu-id="53e10-108">A level 1 opportunistic lock on a file allows a client to read ahead in the file and cache both read-ahead and write data from the file locally.</span></span> <span data-ttu-id="53e10-109">Solange der Client ausschließlich auf eine Datei zugreifen kann, besteht keine Gefahr, dass die Daten Zusammenstellung eine opportunistische Sperre der Ebene 1 darstellt.</span><span class="sxs-lookup"><span data-stu-id="53e10-109">As long as the client has sole access to a file, there is no danger to data coherency in providing a level 1 opportunistic lock.</span></span>

<span data-ttu-id="53e10-110">Der Client kann eine opportunistische Sperre der Ebene 1 nach dem Öffnen einer Datei anfordern.</span><span class="sxs-lookup"><span data-stu-id="53e10-110">The client can request a level 1 opportunistic lock after opening a file.</span></span> <span data-ttu-id="53e10-111">Wenn die Datei nicht von einem anderen Client (oder keinem anderen Thread auf demselben Client) geöffnet ist, kann der Server die opportunistische Sperre erteilen.</span><span class="sxs-lookup"><span data-stu-id="53e10-111">If no other client (or no other thread on the same client) has the file open, the server may grant the opportunistic lock.</span></span> <span data-ttu-id="53e10-112">Der Client kann dann Lese-und Schreib Daten lokal aus der Datei Zwischenspeichern.</span><span class="sxs-lookup"><span data-stu-id="53e10-112">The client can then cache read and write data from the file locally.</span></span> <span data-ttu-id="53e10-113">Wenn die Datei von einem anderen Client geöffnet wurde, lehnt der Server die opportunistische Sperre ab, und der Client hat keine lokale Zwischenspeicherung.</span><span class="sxs-lookup"><span data-stu-id="53e10-113">If another client has opened the file, then the server refuses the opportunistic lock and the client does no local caching.</span></span> <span data-ttu-id="53e10-114">(Der Server kann die opportunistische Sperre auch aus anderen Gründen ablehnen, wie z. b. das unterstützen von opportunistischen Sperren.)</span><span class="sxs-lookup"><span data-stu-id="53e10-114">(The server may refuse the opportunistic lock for other reasons as well, such as not supporting opportunistic locks.)</span></span>

<span data-ttu-id="53e10-115">Wenn der Server eine Datei öffnet, die bereits über eine opportunistische Sperre der Ebene 1 verfügt, wird der Freigabe Status der Datei vom Server überprüft, bevor die opportunistische Sperre der Ebene 1 unterbrochen wird.</span><span class="sxs-lookup"><span data-stu-id="53e10-115">When the server opens a file that already has a level 1 opportunistic lock on it, the server examines the sharing state of the file before it breaks the level 1 opportunistic lock.</span></span> <span data-ttu-id="53e10-116">Wenn der Server die Sperre nach dieser Prüfung unterbrochen hat, ist die Zeit, die der Client mit der früheren Sperre verbringt, den Schreib Cache zu leeren, die Zeit, die der Client zum Anfordern der Datei benötigt.</span><span class="sxs-lookup"><span data-stu-id="53e10-116">If the server breaks the lock after this examination, the time the client with the former lock spends flushing its write cache is time the client requesting the file must wait.</span></span> <span data-ttu-id="53e10-117">Dieses Zeitaufwand bedeutet, dass opportunistische Sperren der Ebene 1 für Dateien vermieden werden sollten, die von vielen Clients geöffnet werden.</span><span class="sxs-lookup"><span data-stu-id="53e10-117">This time expenditure means that level 1 opportunistic locks should be avoided on files that many clients open.</span></span>

<span data-ttu-id="53e10-118">Da der Server jedoch den Freigabe Zustand überprüft, bevor die Sperre unterbrochen wird, wird der Server in dem Fall, in dem der Server eine offene Anforderung aufgrund eines Freigabe Konflikts ablehnt, nicht unterbrochen.</span><span class="sxs-lookup"><span data-stu-id="53e10-118">However, because the server checks the sharing state before it breaks the lock, in the case where the server would deny an open request due to a sharing conflict the server does not break the lock.</span></span> <span data-ttu-id="53e10-119">Wenn Sie z. b. eine Datei geöffnet, die Freigabe für Schreibvorgänge verweigert und eine Sperre der Ebene 1 erhalten haben, verweigert der Server die Anforderung eines anderen Clients zum Öffnen der Datei zum Schreiben, bevor Sie die Sperre für die Datei sogar prüft.</span><span class="sxs-lookup"><span data-stu-id="53e10-119">For example, if you have opened a file, denied sharing for write operations, and obtained a level 1 lock, the server denies another client's request to open the file for writing before it even examines your lock on the file.</span></span> <span data-ttu-id="53e10-120">In dieser Instanz wird die opportunistische Sperre nicht abgebrochen.</span><span class="sxs-lookup"><span data-stu-id="53e10-120">In this instance, your opportunistic lock is not broken.</span></span>

<span data-ttu-id="53e10-121">Ein Beispiel für die Funktionsweise einer opportunistischen Sperre der Stufe 1 finden Sie unter Beispiel für eine opportunistische Sperre der Ebene 1.</span><span class="sxs-lookup"><span data-stu-id="53e10-121">For an example of how a level 1 opportunistic lock works, see Level 1 Opportunistic Lock Example.</span></span> <span data-ttu-id="53e10-122">Weitere Informationen zum unterbrechen opportunistischer Sperren finden Sie unter unter [brechen von opportunistischen Sperren](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="53e10-122">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="level-2-opportunistic-locks"></a><span data-ttu-id="53e10-123">Opportunistische Sperren der Ebene 2</span><span class="sxs-lookup"><span data-stu-id="53e10-123">Level 2 Opportunistic Locks</span></span>

<span data-ttu-id="53e10-124">Eine opportunistische Sperre der Ebene 2 teilt einem Client mit, dass es mehrere gleichzeitige Clients einer Datei gibt, die er noch nicht geändert hat.</span><span class="sxs-lookup"><span data-stu-id="53e10-124">A level 2 opportunistic lock informs a client that there are multiple concurrent clients of a file and that none has yet modified it.</span></span> <span data-ttu-id="53e10-125">Diese Sperre ermöglicht dem Client das Ausführen von Lesevorgängen und das Abrufen von Dateiattributen mithilfe von zwischengespeicherten oder Lesevorgängen für lokale Informationen, aber der Client muss alle anderen Anforderungen (z. b. für Schreibvorgänge) an den Server senden.</span><span class="sxs-lookup"><span data-stu-id="53e10-125">This lock allows the client to perform read operations and obtain file attributes using cached or read-ahead local information, but the client must send all other requests (such as for write operations) to the server.</span></span> <span data-ttu-id="53e10-126">Die Anwendung sollte die opportunistische Sperre der Ebene 2 verwenden, wenn Sie davon ausgehen, dass andere Anwendungen nach dem Zufallsprinzip in die Datei schreiben oder die Datei nach dem Zufallsprinzip oder sequenziell lesen möchten.</span><span class="sxs-lookup"><span data-stu-id="53e10-126">Your application should use the level 2 opportunistic lock when you expect other applications to write to the file at random or read the file at random or sequentially.</span></span>

<span data-ttu-id="53e10-127">Eine opportunistische Sperre der Ebene 2 ähnelt einer opportunistischen Filter-Sperre.</span><span class="sxs-lookup"><span data-stu-id="53e10-127">A level 2 opportunistic lock is very similar to a filter opportunistic lock.</span></span> <span data-ttu-id="53e10-128">In den meisten Fällen sollte Ihre Anwendung die opportunistische Sperre der Ebene 2 verwenden.</span><span class="sxs-lookup"><span data-stu-id="53e10-128">In most situations, your application should use the level 2 opportunistic lock.</span></span> <span data-ttu-id="53e10-129">Verwenden Sie nur die Filter Sperre, wenn Sie keine Lesevorgänge für Lesevorgänge durchführen möchten, um Verstöße gegen den Freigabe Modus in der Zeitspanne zwischen dem Öffnen der Datei und dem Empfang der Sperre durch die Anwendung zu verursachen.</span><span class="sxs-lookup"><span data-stu-id="53e10-129">Only use the filter lock if you do not want open operations for reading to cause sharing-mode violations in the time span between your application's opening the file and receiving the lock.</span></span> <span data-ttu-id="53e10-130">Weitere Informationen finden Sie unter Filtern von opportunistischen Sperren und [Server Antwort zum Öffnen von Anforderungen für gesperrte Dateien](server-response-to-open-requests-on-locked-files.md).</span><span class="sxs-lookup"><span data-stu-id="53e10-130">For more information, see Filter Opportunistic Locks and [Server Response to Open Requests on Locked Files](server-response-to-open-requests-on-locked-files.md).</span></span>

<span data-ttu-id="53e10-131">Weitere Informationen zum unterbrechen opportunistischer Sperren finden Sie unter unter [brechen von opportunistischen Sperren](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="53e10-131">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="batch-opportunistic-locks"></a><span data-ttu-id="53e10-132">Opportunistische Sperren in Batches</span><span class="sxs-lookup"><span data-stu-id="53e10-132">Batch Opportunistic Locks</span></span>

<span data-ttu-id="53e10-133">Eine opportunistische Batch-Sperre bearbeitet Datei Öffnungen und-sperren.</span><span class="sxs-lookup"><span data-stu-id="53e10-133">A batch opportunistic lock manipulates file openings and closings.</span></span> <span data-ttu-id="53e10-134">Beispielsweise kann die Batchdatei bei der Ausführung einer Batchdatei für jede Zeile der Datei geöffnet und geschlossen werden.</span><span class="sxs-lookup"><span data-stu-id="53e10-134">For example, in the execution of a batch file, the batch file may be opened and closed once for each line of the file.</span></span> <span data-ttu-id="53e10-135">Eine opportunistische Batch-Sperre öffnet die Batchdatei auf dem Server und hält Sie offen.</span><span class="sxs-lookup"><span data-stu-id="53e10-135">A batch opportunistic lock opens the batch file on the server and keeps it open.</span></span> <span data-ttu-id="53e10-136">Wenn der Befehlsprozessor die Batchdatei "öffnet" und "schließt", fängt der Netzwerk-Redirector die Befehle "Öffnen" und "Schließen" ab.</span><span class="sxs-lookup"><span data-stu-id="53e10-136">As the command processor "opens" and "closes" the batch file, the network redirector intercepts the open and close commands.</span></span> <span data-ttu-id="53e10-137">Alle Server Empfangs Befehle sind die Befehle zum Suchen und lesen.</span><span class="sxs-lookup"><span data-stu-id="53e10-137">All the server receives are the seek and read commands.</span></span> <span data-ttu-id="53e10-138">Wenn der Client ebenfalls liest, empfängt der Server höchstens einmal eine bestimmte Lese Anforderung.</span><span class="sxs-lookup"><span data-stu-id="53e10-138">If the client is also reading ahead, the server receives a particular read request at most one time.</span></span>

<span data-ttu-id="53e10-139">Beim Öffnen einer Datei, die bereits eine opportunistische Batch Sperre aufweist, wird der Freigabe Status der Datei vom Server überprüft, nachdem die Sperre unterbrochen wurde.</span><span class="sxs-lookup"><span data-stu-id="53e10-139">When opening a file that already has a batch opportunistic lock, the server checks the sharing state of the file after breaking the lock.</span></span> <span data-ttu-id="53e10-140">Durch diese Überprüfung erhält der Inhaber der Sperre die Möglichkeit, den Cache zu leeren und das Datei Handle zu schließen.</span><span class="sxs-lookup"><span data-stu-id="53e10-140">This check gives the holder of the lock a chance to complete flushing its cache and to close the file handle.</span></span> <span data-ttu-id="53e10-141">Bei einem während der Freigabe Überprüfung versuchten Öffnungsvorgang führt dies nicht zu einem Fehler bei der Freigabe Überprüfung, wenn der sperreninhaber die Sperre freigibt.</span><span class="sxs-lookup"><span data-stu-id="53e10-141">An open operation attempted during the sharing check does not cause the sharing check to fail if the lock holder releases the lock.</span></span>

<span data-ttu-id="53e10-142">Ein Beispiel für die Funktionsweise einer Batch-opportunistischen Sperre finden Sie unter Beispiel für eine Batch-opportunistische Sperre.</span><span class="sxs-lookup"><span data-stu-id="53e10-142">For an example of how a batch opportunistic lock works, see Batch Opportunistic Lock Example.</span></span> <span data-ttu-id="53e10-143">Weitere Informationen zum unterbrechen opportunistischer Sperren finden Sie unter unter [brechen von opportunistischen Sperren](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="53e10-143">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

## <a name="filter-opportunistic-locks"></a><span data-ttu-id="53e10-144">Filtern von opportunistischen Sperren</span><span class="sxs-lookup"><span data-stu-id="53e10-144">Filter Opportunistic Locks</span></span>

<span data-ttu-id="53e10-145">Eine durch einen Filter opportunistische Sperre sperrt eine Datei, sodass Sie nicht für den Schreib-oder Lösch Zugriff geöffnet werden kann.</span><span class="sxs-lookup"><span data-stu-id="53e10-145">A filter opportunistic lock locks a file so that it cannot be opened for either write or delete access.</span></span> <span data-ttu-id="53e10-146">Alle Clients müssen in der Lage sein, die Datei freizugeben.</span><span class="sxs-lookup"><span data-stu-id="53e10-146">All clients must be able to share the file.</span></span> <span data-ttu-id="53e10-147">Filter sperren ermöglichen es Anwendungen, nicht eindringliche Filter Vorgänge für Datei Daten auszuführen (z. b. einen Compiler, der Quellcode oder ein Katalogisierungs Programm öffnet).</span><span class="sxs-lookup"><span data-stu-id="53e10-147">Filter locks allow applications to perform nonintrusive filtering operations on file data (for example, a compiler opening source code or a cataloging program).</span></span>

<span data-ttu-id="53e10-148">Eine opportunistische Filter-Sperre unterscheidet sich von einer opportunistischen Sperre der Ebene 2 darin, dass das Lesen von Lesevorgängen für Lesevorgänge ohne Freigabe Modus in der Zeitspanne zwischen dem Öffnen der Datei und dem Empfang der Sperre ermöglicht wird.</span><span class="sxs-lookup"><span data-stu-id="53e10-148">A filter opportunistic lock differs from a level 2 opportunistic lock in that it allows open operations for reading to occur without sharing-mode violations in the time span between your application's opening the file and receiving the lock.</span></span> <span data-ttu-id="53e10-149">Die opportunistische Filter-Sperre ist die beste Sperre, wenn es wichtig ist, anderen Clients Lesezugriff zu gewähren.</span><span class="sxs-lookup"><span data-stu-id="53e10-149">The filter opportunistic lock is the best lock to use when it is important to allow other clients reading access.</span></span> <span data-ttu-id="53e10-150">In anderen Fällen sollte Ihre Anwendung eine opportunistische Sperre der Ebene 2 verwenden.</span><span class="sxs-lookup"><span data-stu-id="53e10-150">In other cases, your application should use a level 2 opportunistic lock.</span></span> <span data-ttu-id="53e10-151">Die opportunistische Sperre eines Filters unterscheidet sich von einer opportunistischen Batch-Sperre darin, dass es nicht zulässt, dass mehrere Öffnungen und Verarbeitungen vom Netzwerkredirector auf die Art und Weise durchgeführt werden, in der eine Batch opportunistische Sperre erfolgt</span><span class="sxs-lookup"><span data-stu-id="53e10-151">A filter opportunistic lock differs from a batch opportunistic lock in that it does not allow multiple openings and closings to be handled by the network redirector the way a batch opportunistic lock does.</span></span>

<span data-ttu-id="53e10-152">Die Anwendung sollte in drei Schritten eine opportunistische Filter Sperre für eine Datei anfordern:</span><span class="sxs-lookup"><span data-stu-id="53e10-152">Your application should request a filter opportunistic lock on a file in three steps:</span></span>

1.  <span data-ttu-id="53e10-153">Verwenden Sie [**die Funktion "**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) Funktion", um ein Handle für die Datei zu öffnen, bei der der *desiredAccess* -Parameter auf NULL festgelegt ist, sodass kein Zugriff angegeben ist, und der *dwsharemode* -Parameter auf das **\_ \_ leseflag für die Dateifreigabe** festgelegt ist, um die Freigabe</span><span class="sxs-lookup"><span data-stu-id="53e10-153">Use the [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) function to open a handle to the file with the *DesiredAccess* parameter set to zero, indicating no access, and the *dwShareMode* parameter set to the **FILE\_SHARE\_READ** flag to allow sharing for reading.</span></span> <span data-ttu-id="53e10-154">Das an dieser Stelle erhaltene Handle wird als Sperr Handle bezeichnet.</span><span class="sxs-lookup"><span data-stu-id="53e10-154">The handle obtained at this point is called the locking handle.</span></span>
2.  <span data-ttu-id="53e10-155">Fordern Sie eine Sperre für dieses Handle mit dem Code für den Code der Code- [**\_ \_ \_ Oplock-Anforderung**](/windows/win32/api/winioctl/ni-winioctl-fsctl_request_filter_oplock) an.</span><span class="sxs-lookup"><span data-stu-id="53e10-155">Request a lock on this handle with the [**FSCTL\_REQUEST\_FILTER\_OPLOCK**](/windows/win32/api/winioctl/ni-winioctl-fsctl_request_filter_oplock) control code.</span></span>
3.  <span data-ttu-id="53e10-156">Wenn die Sperre erteilt wurde, öffnen Sie die Datei mit " [**kreatefile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) " erneut, wobei " *desiredAccess* " auf das **generische \_ leseflag** festgelegt ist.</span><span class="sxs-lookup"><span data-stu-id="53e10-156">When the lock is granted, use [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea) to open the file again with *DesiredAccess* set to the **GENERIC\_READ** flag.</span></span> <span data-ttu-id="53e10-157">Legen Sie *dwsharemode* auf **das \_ \_ leseflag für die Dateifreigabe** fest, damit andere Benutzer die Datei lesen können, während Sie geöffnet ist. das Flag zum **Löschen der Datei \_ Freigabe \_** ermöglicht anderen Benutzern, die Datei zu löschen, während Sie geöffnet ist, oder beides.</span><span class="sxs-lookup"><span data-stu-id="53e10-157">Set *dwShareMode* to the **FILE\_SHARE\_READ** flag to allow others to read the file while you have it open, the **FILE\_SHARE\_DELETE** flag to allow others to mark the file for deletion while you have it open, or both.</span></span> <span data-ttu-id="53e10-158">Das an dieser Stelle erhaltene Handle wird als Lese Handle bezeichnet.</span><span class="sxs-lookup"><span data-stu-id="53e10-158">The handle obtained at this point is called the read handle.</span></span>

<span data-ttu-id="53e10-159">Verwenden Sie das Lese handle, um aus dem Inhalt der Datei zu lesen oder in diesen zu schreiben.</span><span class="sxs-lookup"><span data-stu-id="53e10-159">Use the read handle to read from or write to the contents of the file.</span></span>

<span data-ttu-id="53e10-160">Beim Öffnen einer Datei, die bereits eine opportunistische Filter Sperre aufweist, unterbricht der Server die Sperre und überprüft dann den Freigabe Zustand der Datei.</span><span class="sxs-lookup"><span data-stu-id="53e10-160">When opening a file that already has a filter opportunistic lock, the server breaks the lock and then checks the sharing state of the file.</span></span> <span data-ttu-id="53e10-161">Durch diese Überprüfung erhält der Client, der die frühere opportunistische Sperre aufrecht erhält, die Möglichkeit, alle zwischengespeicherten Daten abzubrechen und die Unterbrechung zu bestätigen.</span><span class="sxs-lookup"><span data-stu-id="53e10-161">This check gives the client that held the former opportunistic lock a chance to abandon any cached data and acknowledge the break.</span></span> <span data-ttu-id="53e10-162">Bei einem während dieser Freigabe Überprüfung versuchten Öffnungsvorgang führt dies nicht dazu, dass die Freigabe Überprüfung fehlschlägt, wenn der frühere Sperr Inhaber die Sperre freigibt.</span><span class="sxs-lookup"><span data-stu-id="53e10-162">An open operation attempted during this sharing check does not cause the sharing check to fail if the former lock holder releases the lock.</span></span> <span data-ttu-id="53e10-163">Das Dateisystem hält den Öffnungsvorgang in Abeyance, bis der Besitzer der Sperre sowohl das Lese Handle als auch das Sperr handle schließt.</span><span class="sxs-lookup"><span data-stu-id="53e10-163">The file system holds in abeyance the open operation until the lock's owner closes both the read handle and then the locking handle.</span></span> <span data-ttu-id="53e10-164">Nachdem dies geschehen ist, kann die Anforderung des anderen Clients fortgesetzt werden.</span><span class="sxs-lookup"><span data-stu-id="53e10-164">After this is done, the other client's open request can proceed.</span></span>

<span data-ttu-id="53e10-165">Weitere Informationen zum unterbrechen opportunistischer Sperren finden Sie unter unter [brechen von opportunistischen Sperren](breaking-opportunistic-locks.md).</span><span class="sxs-lookup"><span data-stu-id="53e10-165">For more information on breaking opportunistic locks, see [Breaking Opportunistic Locks](breaking-opportunistic-locks.md).</span></span>

 

 
