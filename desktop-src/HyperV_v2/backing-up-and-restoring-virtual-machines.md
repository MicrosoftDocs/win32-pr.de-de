---
description: Hyper-V verwendet die Volumeschattenkopie-Dienst (VSS) zum Sichern und Wiederherstellen virtueller Maschinen.
ms.assetid: 94C67F22-658D-49DD-9588-6BB4FCF7ADA9
title: Sichern und Wiederherstellen von virtuellen Computern
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 6f9cf6d5b80a4c7392fb38e893a4fafad3f90435
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/07/2021
ms.locfileid: "106359054"
---
# <a name="backing-up-and-restoring-virtual-machines"></a><span data-ttu-id="8290c-103">Sichern und Wiederherstellen von virtuellen Computern</span><span class="sxs-lookup"><span data-stu-id="8290c-103">Backing up and restoring virtual machines</span></span>

<span data-ttu-id="8290c-104">Hyper-V verwendet die Volumeschattenkopie-Dienst (VSS) zum Sichern und Wiederherstellen virtueller Maschinen.</span><span class="sxs-lookup"><span data-stu-id="8290c-104">Hyper-V uses the Volume Shadow Copy Service (VSS) to backup and restore virtual machines.</span></span> <span data-ttu-id="8290c-105">Wenn die Sicherungsdienste (volumemomentaufnahme) im Gast Betriebssystem installiert sind, wird ein VSS-Anforderer installiert, mit dem VSS Writer im Gast Betriebssystem an der Sicherung der virtuellen Maschine teilnehmen können.</span><span class="sxs-lookup"><span data-stu-id="8290c-105">If the backup (volume snapshot) integration services are installed in the guest operating system, a VSS requester is installed that will allow VSS writers in the guest operating system to participate in the backup of the virtual machine.</span></span> <span data-ttu-id="8290c-106">Weitere Informationen finden Sie in den folgenden Abschnitten:</span><span class="sxs-lookup"><span data-stu-id="8290c-106">For details, see the following sections:</span></span>

-   [<span data-ttu-id="8290c-107">Sichern der virtuellen Computer</span><span class="sxs-lookup"><span data-stu-id="8290c-107">Backing up the virtual machines</span></span>](#backing-up-the-virtual-machines)
-   [<span data-ttu-id="8290c-108">Wiederherstellen der virtuellen Computer</span><span class="sxs-lookup"><span data-stu-id="8290c-108">Restoring the virtual machines</span></span>](#restoring-the-virtual-machines)
-   [<span data-ttu-id="8290c-109">Failoverclustering und Hyper-V-VSS</span><span class="sxs-lookup"><span data-stu-id="8290c-109">Failover clustering and Hyper-V VSS</span></span>](#failover-clustering-and-hyper-v-vss)
-   [<span data-ttu-id="8290c-110">Details zum Hyper-V-VSS-Writer</span><span class="sxs-lookup"><span data-stu-id="8290c-110">Details on the Hyper-V VSS Writer</span></span>](#details-on-the-hyper-v-vss-writer)
-   [<span data-ttu-id="8290c-111">Zugehörige Themen</span><span class="sxs-lookup"><span data-stu-id="8290c-111">Related topics</span></span>](#related-topics)

## <a name="backing-up-the-virtual-machines"></a><span data-ttu-id="8290c-112">Sichern der virtuellen Computer</span><span class="sxs-lookup"><span data-stu-id="8290c-112">Backing up the virtual machines</span></span>

<span data-ttu-id="8290c-113">Hyper-V verwendet einen von zwei Mechanismen, um jeden virtuellen Computer zu sichern.</span><span class="sxs-lookup"><span data-stu-id="8290c-113">Hyper-V uses one of two mechanisms to back up each virtual machine.</span></span> <span data-ttu-id="8290c-114">Der Standard Sicherungsmechanismus wird als "gespeicherte Zustands Methode" bezeichnet, bei der der virtuelle Computer während der Verarbeitung des prepareforsnapshot-Ereignisses in einen gespeicherten Zustand versetzt wird, Momentaufnahmen der entsprechenden Volumes entnommen werden und der virtuelle Computer während der Verarbeitung des PostSnapshot-Ereignisses in den vorherigen Zustand zurückversetzt wird.</span><span class="sxs-lookup"><span data-stu-id="8290c-114">The default backup mechanism is called the "Saved State" method, where the virtual machine is put into a saved state during the processing of the PrepareForSnapshot event, snapshots are taken of the appropriate volumes, and the virtual machine is returned to the previous state during the processing of the PostSnapshot event.</span></span>

<span data-ttu-id="8290c-115">Der andere Sicherungsmechanismus wird als "untergeordnete VM-Momentaufnahme"-Methode bezeichnet, die VSS innerhalb des untergeordneten virtuellen Computers verwendet, um an der Sicherung teilzunehmen.</span><span class="sxs-lookup"><span data-stu-id="8290c-115">The other backup mechanism is called the "Child VM Snapshot" method, which uses VSS inside the child virtual machine to participate in the backup.</span></span> <span data-ttu-id="8290c-116">Damit die "untergeordnete VM-Momentaufnahme"-Methode unterstützt wird, müssen alle folgenden Bedingungen erfüllt sein:</span><span class="sxs-lookup"><span data-stu-id="8290c-116">For the "Child VM Snapshot" method to be supported, all of the following conditions must be met:</span></span>

-   <span data-ttu-id="8290c-117">Der Integrations Dienst für Sicherungen (volumemomentaufnahme) ist installiert und wird auf dem untergeordneten virtuellen Computer ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="8290c-117">Backup (volume snapshot) Integration Service is installed and running in the child virtual machine.</span></span> <span data-ttu-id="8290c-118">Der Dienst Name lautet "Hyper-V-Volumeschattenkopie-Requestor".</span><span class="sxs-lookup"><span data-stu-id="8290c-118">The service name is "Hyper-V Volume Shadow Copy Requestor".</span></span>
-   <span data-ttu-id="8290c-119">Der untergeordnete virtuelle Computer muss sich im Status wird ausgeführt befinden.</span><span class="sxs-lookup"><span data-stu-id="8290c-119">The child virtual machine must be in the running state.</span></span>
-   <span data-ttu-id="8290c-120">Der Speicherort der Momentaufnahme Dateien für den virtuellen Computer ist auf das gleiche Volume im Host Betriebssystem als die VHD-Dateien für den virtuellen Computer festgelegt.</span><span class="sxs-lookup"><span data-stu-id="8290c-120">The Snapshot File Location for the virtual machine is set to be the same volume in the host operating system as the VHD files for the virtual machine.</span></span>
-   <span data-ttu-id="8290c-121">Alle Volumes auf dem untergeordneten virtuellen Computer sind Basis Datenträger, und es sind keine dynamischen Datenträger vorhanden.</span><span class="sxs-lookup"><span data-stu-id="8290c-121">All volumes on the child virtual machine are basic disks and there are no dynamic disks.</span></span>
-   <span data-ttu-id="8290c-122">Alle Datenträger auf dem untergeordneten virtuellen Computer müssen ein Dateisystem verwenden, das Momentaufnahmen unterstützt (z. b. NTFS).</span><span class="sxs-lookup"><span data-stu-id="8290c-122">All disks on the child virtual machine must use a file system that supports snapshots (for example, NTFS).</span></span>

<span data-ttu-id="8290c-123">Im Allgemeinen ist der Vorgang zum Sichern virtueller Computer identisch mit der Beschreibung unter [Übersicht über die Verarbeitung einer Sicherung unter VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span><span class="sxs-lookup"><span data-stu-id="8290c-123">In general, the process for backing up virtual machines is the same as described in [Overview of Processing a Backup Under VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span></span> <span data-ttu-id="8290c-124">Das einmalige Verhalten tritt auf, wenn der Hyper-v-VSS Writer (Teil des "Hyper-v-Verwaltungsdienst für virtuelle Computer") das prepareforsnapshot-Ereignis verarbeitet.</span><span class="sxs-lookup"><span data-stu-id="8290c-124">The unique behavior happens when the Hyper-V VSS writer (part of the "Hyper-V Virtual Machine Management" service) processes the PrepareForSnapshot event.</span></span> <span data-ttu-id="8290c-125">Wenn die Sicherung mithilfe der Methode "untergeordneter VM-Momentaufnahme" durchgeführt wurde, wird eine zusätzliche Verarbeitung ausgeführt, Sie ist jedoch für den untergeordneten virtuellen Computer nicht sichtbar.</span><span class="sxs-lookup"><span data-stu-id="8290c-125">If the backup was done using the "Child VM Snapshot" method, there is additional processing done but it is not visible to the child virtual machine.</span></span>

<span data-ttu-id="8290c-126">Im folgenden Verfahren wird beschrieben, wie Sie virtuelle Computer sichern.</span><span class="sxs-lookup"><span data-stu-id="8290c-126">The following procedure describes how to back up virtual machines.</span></span>

<span data-ttu-id="8290c-127">**So sichern Sie virtuelle Computer**</span><span class="sxs-lookup"><span data-stu-id="8290c-127">**To back up virtual machines**</span></span>

1.  <span data-ttu-id="8290c-128">Wenn die Methode "gespeicherter Zustand" verwendet wird, wird die virtuelle Maschine für jeden virtuellen Computer in den Writer-Metadaten in einen gespeicherten Zustand versetzt.</span><span class="sxs-lookup"><span data-stu-id="8290c-128">For each virtual machine in the writer metadata, if the "Saved State" method is used, the virtual machine is put into a saved state.</span></span> <span data-ttu-id="8290c-129">Bei virtuellen Computern, die die "untergeordnete VM-Momentaufnahme"-Methode verwenden, verarbeitet der Hyper-V-Volumeschattenkopie-Requestor-Dienst auf dem untergeordneten virtuellen Computer die Sicherung, wie in [Übersicht über die Verarbeitung einer Sicherung unter VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss)beschrieben</span><span class="sxs-lookup"><span data-stu-id="8290c-129">For virtual machines using the "Child VM Snapshot" method, the Hyper-V Volume Shadow Copy Requestor Service in the child virtual machine processes the backup as detailed in [Overview of Processing a Backup Under VSS](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss).</span></span> <span data-ttu-id="8290c-130">Alle VSS-Ereignisse auf dem untergeordneten virtuellen Computer treten während der Verarbeitung des Host Betriebssystems des prepareforsnapshot-Ereignisses auf.</span><span class="sxs-lookup"><span data-stu-id="8290c-130">All VSS events on the child virtual machine occur during the host operating system processing of the PrepareForSnapshot event.</span></span>
2.  <span data-ttu-id="8290c-131">Nachdem alle virtuellen Computer entweder in den gespeicherten Zustand versetzt wurden oder Momentaufnahmen erstellt wurden, wird die Hyper-V-VSS Writer vom prepareforsnapshot-Ereignis zurückgegeben.</span><span class="sxs-lookup"><span data-stu-id="8290c-131">After all virtual machines have either been put in the saved state or had snapshots taken, the Hyper-V VSS writer returns from the PrepareForSnapshot event.</span></span> <span data-ttu-id="8290c-132">Die Hyper-V-VSS Writer werden während der Freeze-und der Thaw-Ereignisse nicht verarbeitet.</span><span class="sxs-lookup"><span data-stu-id="8290c-132">No processing is done by the Hyper-V VSS writer during the Freeze and Thaw events.</span></span>
3.  <span data-ttu-id="8290c-133">Wenn der Hyper-v-VSS Writer das PostSnapshot-Ereignis verarbeitet, werden virtuelle Computer, die mithilfe der Methode "gespeicherter Zustand" gesichert wurden und von der Hyper-v-VSS Writer in einen gespeicherten Zustand versetzt wurden, in den Zustand zurückversetzt, in dem Sie sich vor dem Start der Sicherung befanden.</span><span class="sxs-lookup"><span data-stu-id="8290c-133">When the Hyper-V VSS writer processes the PostSnapshot event, virtual machines that were backed up using the "Saved State" method and were put into a saved state by the Hyper-V VSS writer are returned to the state they were in before the backup started.</span></span> <span data-ttu-id="8290c-134">Bei den virtuellen Computern, die mithilfe der Methode "untergeordneter VM-Momentaufnahme" gesichert wurden, wird für das Host Image der VHD-Dateien, für die die Momentaufnahmen erstellt wurden, ein Rollback auf die Momentaufnahme ausgeführt, die während der Verarbeitung des prepareforsnapshot-Ereignisses erstellt wurde.</span><span class="sxs-lookup"><span data-stu-id="8290c-134">For the virtual machines that were backed up using the "Child VM Snapshot" method, the host image of the VHD files that had the snapshots taken are rolled back to the snapshot taken during the processing of the PrepareForSnapshot event.</span></span> <span data-ttu-id="8290c-135">Diese Verarbeitung erfolgt unabhängig von den VSS-Writern auf den untergeordneten virtuellen Computern, sodass die erstellten Momentaufnahmen automatisch wiederherstellbar sein müssen.</span><span class="sxs-lookup"><span data-stu-id="8290c-135">This processing is done independently of the VSS writers on the child virtual machines so the snapshots taken must be auto-recoverable.</span></span> <span data-ttu-id="8290c-136">(**VSS \_ Volsnap \_ attr \_ No \_ AutoRecovery** ist nicht im Kontext festgelegt.)</span><span class="sxs-lookup"><span data-stu-id="8290c-136">(**VSS\_VOLSNAP\_ATTR\_NO\_AUTORECOVERY** is not set in the context.)</span></span>

<span data-ttu-id="8290c-137">Teil Sicherungen werden nicht unterstützt.</span><span class="sxs-lookup"><span data-stu-id="8290c-137">Partial backups are not supported.</span></span> <span data-ttu-id="8290c-138">Wenn von einem virtuellen Computer keine Momentaufnahme erstellt werden kann, werden keine virtuellen Computer gesichert.</span><span class="sxs-lookup"><span data-stu-id="8290c-138">If any virtual machine fails to create a snapshot, no virtual machines will be backed up.</span></span>

> [!Note]  
> <span data-ttu-id="8290c-139">Pass-Through-und iSCSI-Datenträger sind für das Host Betriebssystem nicht sichtbar und werden daher nicht durch die Hyper-V-VSS Writer gesichert.</span><span class="sxs-lookup"><span data-stu-id="8290c-139">Pass-through and iSCSI disks are not visible to the host operating system and therefore not backed up by the Hyper-V VSS writer.</span></span> <span data-ttu-id="8290c-140">Sicherungen dieser Volumes müssen vollständig auf dem virtuellen Computer durchgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="8290c-140">Backups of these volumes must be done entirely on the virtual machine.</span></span>

 

## <a name="restoring-the-virtual-machines"></a><span data-ttu-id="8290c-141">Wiederherstellen der virtuellen Computer</span><span class="sxs-lookup"><span data-stu-id="8290c-141">Restoring the virtual machines</span></span>

<span data-ttu-id="8290c-142">Die Wiederherstellung der virtuellen Maschinen erfolgt vollständig durch das Host Betriebssystem. die VSS-Writer auf den untergeordneten virtuellen Maschinen sind nicht beteiligt.</span><span class="sxs-lookup"><span data-stu-id="8290c-142">Restoring the virtual machines is done entirely by the host operating system; the VSS writers on the child virtual machines are not involved.</span></span>

<span data-ttu-id="8290c-143">Im folgenden Verfahren wird beschrieben, wie virtuelle Computer wieder hergestellt werden.</span><span class="sxs-lookup"><span data-stu-id="8290c-143">The following procedure describes how to restore virtual machines.</span></span>

<span data-ttu-id="8290c-144">**So stellen Sie virtuelle Maschinen wieder her**</span><span class="sxs-lookup"><span data-stu-id="8290c-144">**To restore virtual machines**</span></span>

1.  <span data-ttu-id="8290c-145">Während der Verarbeitung des vorab-Ereignisses wird das Hyper-V-VSS Writer ausgeschaltet, und alle virtuellen Computer, die wieder hergestellt werden sollen, werden gelöscht.</span><span class="sxs-lookup"><span data-stu-id="8290c-145">During the processing of the PreRestore event, the Hyper-V VSS writer turns off and deletes any virtual machines that are about to be restored.</span></span>
2.  <span data-ttu-id="8290c-146">Nachdem alle VSS-Writer das PreRestore-Ereignis verarbeitet haben, werden die Dateien wieder hergestellt.</span><span class="sxs-lookup"><span data-stu-id="8290c-146">After all VSS writers have processed the PreRestore event, the files are restored.</span></span>
3.  <span data-ttu-id="8290c-147">Während der Verarbeitung des postrestore-Ereignisses Ruft das Hyper-V-VSS Writer die [**IVssComponent:: getfilerestorestatus**](/windows/desktop/api/vswriter/nf-vswriter-ivsscomponent-getfilerestorestatus) -Methode auf.</span><span class="sxs-lookup"><span data-stu-id="8290c-147">During the processing of the PostRestore event, the Hyper-V VSS writer calls the [**IVssComponent::GetFileRestoreStatus**](/windows/desktop/api/vswriter/nf-vswriter-ivsscomponent-getfilerestorestatus) method.</span></span> <span data-ttu-id="8290c-148">Wenn die Rückgabe nicht **VSS \_ RS \_ all** ist, ruft das Hyper-V-VSS Writer die [**setschreiterfailure**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-setwriterfailure) -Methode auf und gibt **false** aus der [**OnPostRestore**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-onpostrestore) -Methode zurück.</span><span class="sxs-lookup"><span data-stu-id="8290c-148">If the return is not **VSS\_RS\_ALL**, then the Hyper-V VSS writer calls the [**SetWriterFailure**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-setwriterfailure) method and returns **False** from the [**OnPostRestore**](/windows/desktop/api/vswriter/nf-vswriter-cvsswriter-onpostrestore) method.</span></span>
4.  <span data-ttu-id="8290c-149">Für jeden virtuellen Computer, der wieder hergestellt wurde, wird der virtuelle Computer vom Hyper-v-VSS Writer beim Hyper-v-Verwaltungsdienst registriert.</span><span class="sxs-lookup"><span data-stu-id="8290c-149">For each virtual machine that was restored, the Hyper-V VSS writer registers the virtual machine with the Hyper-V management service.</span></span> <span data-ttu-id="8290c-150">Wenn die virtuelle Maschine an einem nicht standardmäßigen Speicherort wieder hergestellt wird, wird im Standard Speicherort, der mit diesem Speicherort verknüpft wird, eine symbolische Verknüpfung erstellt.</span><span class="sxs-lookup"><span data-stu-id="8290c-150">If the virtual machine is restored to a nondefault location, a symbolic link is created in the default location linking to that location.</span></span>
5.  <span data-ttu-id="8290c-151">Für jede wiederhergestellte VHD wird der Speicherort mit dem für diesen virtuellen Computer angegebenen virtuellen Computer verglichen.</span><span class="sxs-lookup"><span data-stu-id="8290c-151">For each VHD that was restored, the location is compared with the one specified for that virtual machine.</span></span> <span data-ttu-id="8290c-152">Wenn sich der Speicherort unterscheidet, wird die Konfiguration mit dem richtigen Speicherort aktualisiert.</span><span class="sxs-lookup"><span data-stu-id="8290c-152">If the location is different, then the configuration is updated with the proper location.</span></span>
6.  <span data-ttu-id="8290c-153">Die Netzwerkkonfiguration wird aktualisiert.</span><span class="sxs-lookup"><span data-stu-id="8290c-153">The network configuration is updated.</span></span> <span data-ttu-id="8290c-154">Wenn die virtuellen Switches, mit denen der virtuelle Computer bei der Sicherung verbunden war, weiterhin beendet werden, werden neue Ports erstellt und mit dem virtuellen Computer verbunden.</span><span class="sxs-lookup"><span data-stu-id="8290c-154">If the virtual switches that the virtual machine was connected to when it was backed up still exit, new ports are created and connected to the virtual machine.</span></span>

## <a name="failover-clustering-and-hyper-v-vss"></a><span data-ttu-id="8290c-155">Failoverclustering und Hyper-V-VSS</span><span class="sxs-lookup"><span data-stu-id="8290c-155">Failover clustering and Hyper-V VSS</span></span>

<span data-ttu-id="8290c-156">Die Hyper-V-VSS Writer berücksichtigt keine Überlegungen zu virtuellen Computern, die Teil eines Failoverclusters sind.</span><span class="sxs-lookup"><span data-stu-id="8290c-156">The Hyper-V VSS writer does not give any consideration to virtual machines that are part of a failover cluster.</span></span> <span data-ttu-id="8290c-157">Während der Sicherung und Wiederherstellung des gespeicherten Zustands wird die virtuelle Maschine in den gespeicherten Zustand versetzt oder vollständig gelöscht.</span><span class="sxs-lookup"><span data-stu-id="8290c-157">During both the "Saved State" method backups and all restores, the virtual machine would be put into the saved state or deleted entirely.</span></span> <span data-ttu-id="8290c-158">Dies wird als Fehler des Clustering-Dienstanbieter angesehen und bewirkt, dass für die Anwendungen auf diesen Knoten ein Failover auf andere Knoten durchgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="8290c-158">This would be seen as a failure by the clustering service and cause the applications on those nodes to be failed over to other nodes.</span></span> <span data-ttu-id="8290c-159">Um dies bei Sicherungen mit dem Status "gespeichert" zu vermeiden, muss der Zustand der virtuellen Maschine mithilfe des Clustering-Dienstanbieter gespeichert werden.</span><span class="sxs-lookup"><span data-stu-id="8290c-159">To avoid this during "Saved State" backups, the virtual machine state must be saved using the clustering service.</span></span> <span data-ttu-id="8290c-160">Um dies während einer Wiederherstellung zu vermeiden, müssen die Ressourcen auf dem virtuellen Computer offline geschaltet werden.</span><span class="sxs-lookup"><span data-stu-id="8290c-160">To avoid this during a restore, the resources on the virtual machine would need to be taken offline.</span></span>

## <a name="details-on-the-hyper-v-vss-writer"></a><span data-ttu-id="8290c-161">Details zum Hyper-V-VSS-Writer</span><span class="sxs-lookup"><span data-stu-id="8290c-161">Details on the Hyper-V VSS Writer</span></span>

<span data-ttu-id="8290c-162">Writer-Name: Microsoft Hyper-V VSS Writer</span><span class="sxs-lookup"><span data-stu-id="8290c-162">Writer Name: Microsoft Hyper-V VSS Writer</span></span>

<span data-ttu-id="8290c-163">Writer-ID: 66841cd04ded-4l4b-8F 17-bd23f 8ddc3de</span><span class="sxs-lookup"><span data-stu-id="8290c-163">Writer ID: 66841cd4-6ded-4f4b-8f17-fd23f8ddc3de</span></span>

## <a name="related-topics"></a><span data-ttu-id="8290c-164">Zugehörige Themen</span><span class="sxs-lookup"><span data-stu-id="8290c-164">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="8290c-165">Übersicht über die Verarbeitung einer Sicherung unter VSS</span><span class="sxs-lookup"><span data-stu-id="8290c-165">Overview of Processing a Backup Under VSS</span></span>](/windows/desktop/VSS/overview-of-processing-a-backup-under-vss)
</dt> <dt>

[<span data-ttu-id="8290c-166">Übersicht über die Verarbeitung einer Wiederherstellung unter VSS</span><span class="sxs-lookup"><span data-stu-id="8290c-166">Overview of Processing a Restore Under VSS</span></span>](/windows/desktop/VSS/overview-of-processing-a-restore-under-vss)
</dt> </dl>

 

 
