---
description: Wenn eine Benutzeranwendung Daten von Objekten auf dem System über einen WMI-Anbieter anfordert, bedeutet der Identitätswechsel, dass der Anbieter Anmelde Informationen anzeigt, die die Sicherheitsstufe des Clients anstelle der Anbieter darstellen.
ms.assetid: 6d54f234-45aa-445b-ad50-7d5a9946c134
ms.tgt_platform: multiple
title: Annehmen der Identität eines Clients
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 162857d90c8bddb70d90eb2e10efbc08537299d9
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/08/2021
ms.locfileid: "103866888"
---
# <a name="impersonating-a-client"></a><span data-ttu-id="54dcd-103">Annehmen der Identität eines Clients</span><span class="sxs-lookup"><span data-stu-id="54dcd-103">Impersonating a Client</span></span>

<span data-ttu-id="54dcd-104">Wenn eine Benutzeranwendung Daten von Objekten auf dem System über einen WMI-Anbieter anfordert, bedeutet der Identitätswechsel, dass der Anbieter Anmelde Informationen anzeigt, die die Sicherheitsstufe des Clients anstelle des Anbieters darstellen.</span><span class="sxs-lookup"><span data-stu-id="54dcd-104">When a user application requests data from objects on the system through a WMI provider, impersonation means the provider presents credentials that represent the client's security level rather than the provider's.</span></span> <span data-ttu-id="54dcd-105">Durch den Identitätswechsel wird verhindert, dass ein Client nicht autorisierten Zugriff auf Informationen auf dem System erhält.</span><span class="sxs-lookup"><span data-stu-id="54dcd-105">Impersonation prevents a client from obtaining unauthorized access to information on the system.</span></span>

<span data-ttu-id="54dcd-106">In diesem Thema werden die folgenden Abschnitte erläutert:</span><span class="sxs-lookup"><span data-stu-id="54dcd-106">The following sections are discussed in this topic:</span></span>

-   [<span data-ttu-id="54dcd-107">Registrieren eines Anbieters für den Identitätswechsel</span><span class="sxs-lookup"><span data-stu-id="54dcd-107">Registering a Provider for Impersonation</span></span>](#registering-a-provider-for-impersonation)
-   [<span data-ttu-id="54dcd-108">Festlegen von Identitätswechsel Ebenen innerhalb eines Anbieters</span><span class="sxs-lookup"><span data-stu-id="54dcd-108">Setting Impersonation Levels Within a Provider</span></span>](#setting-impersonation-levels-within-a-provider)
-   [<span data-ttu-id="54dcd-109">Beibehalten von Sicherheitsstufen in einem Anbieter</span><span class="sxs-lookup"><span data-stu-id="54dcd-109">Maintaining Security Levels in a Provider</span></span>](#maintaining-security-levels-in-a-provider)
-   [<span data-ttu-id="54dcd-110">Behandeln von Zugriffen auf Abgelehnte Nachrichten in einem Anbieter</span><span class="sxs-lookup"><span data-stu-id="54dcd-110">Handling Access Denied Messages in a Provider</span></span>](#handling-access-denied-messages-in-a-provider)
-   [<span data-ttu-id="54dcd-111">Teil Instanzen der Berichterstellung</span><span class="sxs-lookup"><span data-stu-id="54dcd-111">Reporting Partial Instances</span></span>](#reporting-partial-instances)
-   [<span data-ttu-id="54dcd-112">Partielle Enumerationen für Berichte</span><span class="sxs-lookup"><span data-stu-id="54dcd-112">Reporting Partial Enumerations</span></span>](#reporting-partial-enumerations)
-   [<span data-ttu-id="54dcd-113">Debuggen des Zugriffs verweigerten Codes</span><span class="sxs-lookup"><span data-stu-id="54dcd-113">Debugging Your Access Denied Code</span></span>](#debugging-your-access-denied-code)
-   [<span data-ttu-id="54dcd-114">Zugehörige Themen</span><span class="sxs-lookup"><span data-stu-id="54dcd-114">Related topics</span></span>](#related-topics)

<span data-ttu-id="54dcd-115">WMI wird in der Regel unter Verwendung des Sicherheits Kontexts LocalServer als administrativer Dienst mit hoher Sicherheitsstufe ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="54dcd-115">WMI typically runs as an administrative service at a high security level, using the LocalServer security context.</span></span> <span data-ttu-id="54dcd-116">Durch die Verwendung eines administrativen Dienstanbieter erhält WMI die Möglichkeit, auf privilegierte Informationen zuzugreifen.</span><span class="sxs-lookup"><span data-stu-id="54dcd-116">Using an administrative service gives WMI the means to access privileged information.</span></span> <span data-ttu-id="54dcd-117">Wenn Sie einen Anbieter für Informationen aufrufen, übergibt WMI seine Sicherheits-ID (Security Identifier, SID) an den Anbieter, sodass der Anbieter auf Informationen mit der gleichen hohen Sicherheitsstufe zugreifen kann.</span><span class="sxs-lookup"><span data-stu-id="54dcd-117">When calling a provider for information, WMI passes its security identifier (SID) to the provider, enabling the provider to access information at the same high security level.</span></span>

<span data-ttu-id="54dcd-118">Während des Startvorgangs der WMI-Anwendung gibt das Windows-Betriebssystem der WMI-Anwendung den Sicherheitskontext des Benutzers, der den Vorgang begonnen hat.</span><span class="sxs-lookup"><span data-stu-id="54dcd-118">During the WMI application launch process, the Windows operating system gives the WMI application the security context of the user who began the process.</span></span> <span data-ttu-id="54dcd-119">Der Sicherheitskontext des Benutzers ist in der Regel eine niedrigere Sicherheitsstufe als LocalServer, sodass der Benutzer möglicherweise nicht über die Berechtigung verfügt, auf alle Informationen zuzugreifen, die für WMI verfügbar sind.</span><span class="sxs-lookup"><span data-stu-id="54dcd-119">The security context of the user is typically a lower security level than LocalServer, so the user may not have permission to access all of the information available to WMI.</span></span> <span data-ttu-id="54dcd-120">Wenn die Benutzeranwendung dynamische Informationen anfordert, übergibt WMI die SID des Benutzers an den entsprechenden Anbieter.</span><span class="sxs-lookup"><span data-stu-id="54dcd-120">When the user application asks for dynamic information, WMI passes the SID of the user to the corresponding provider.</span></span> <span data-ttu-id="54dcd-121">Bei entsprechender Schreibweise versucht der Anbieter, auf Informationen mit der Benutzer-SID und nicht mit der Anbieter-SID zuzugreifen.</span><span class="sxs-lookup"><span data-stu-id="54dcd-121">If written appropriately, the provider attempts to access information with the user SID, rather than the provider SID.</span></span>

<span data-ttu-id="54dcd-122">Damit der Anbieter die Identität der Client Anwendung erfolgreich annehmen kann, müssen die Client Anwendung und der Anbieter die folgenden Kriterien erfüllen:</span><span class="sxs-lookup"><span data-stu-id="54dcd-122">For the provider to successfully impersonate the client application, the client application and provider must meet the following criteria:</span></span>

-   <span data-ttu-id="54dcd-123">Die Client Anwendung muss WMI mit einer com-Verbindungs Sicherheitsstufe von RPC-c-IMP-Ebene Identitätswechsel oder **RPC- \_ c- \_ IMP- \_ Ebene \_**- **\_ \_ \_ \_ Delegaten** aufruft.</span><span class="sxs-lookup"><span data-stu-id="54dcd-123">The client application must call WMI with a COM connection security level of **RPC\_C\_IMP\_LEVEL\_IMPERSONATE** or **RPC\_C\_IMP\_LEVEL\_DELEGATE**.</span></span> <span data-ttu-id="54dcd-124">Weitere Informationen finden Sie unter Verwalten der [WMI-Sicherheit](maintaining-wmi-security.md).</span><span class="sxs-lookup"><span data-stu-id="54dcd-124">For more information, see [Maintaining WMI Security](maintaining-wmi-security.md).</span></span>
-   <span data-ttu-id="54dcd-125">Der Anbieter muss sich bei WMI als Identitätswechsel Anbieter registrieren.</span><span class="sxs-lookup"><span data-stu-id="54dcd-125">The provider must register with WMI as an impersonation provider.</span></span> <span data-ttu-id="54dcd-126">Weitere Informationen finden Sie unter [Registrieren eines Anbieters für](#registering-a-provider-for-impersonation)den Identitätswechsel.</span><span class="sxs-lookup"><span data-stu-id="54dcd-126">For more information, see [Registering a Provider for Impersonation](#registering-a-provider-for-impersonation).</span></span>
-   <span data-ttu-id="54dcd-127">Der Anbieter muss vor dem Zugriff auf privilegierte Informationen zur Sicherheitsebene der Client Anwendung wechseln.</span><span class="sxs-lookup"><span data-stu-id="54dcd-127">The provider must switch to the security level of the client application before accessing privileged information.</span></span> <span data-ttu-id="54dcd-128">Weitere Informationen finden Sie unter [Festlegen von Identitätswechsel Ebenen innerhalb eines Anbieters](#setting-impersonation-levels-within-a-provider).</span><span class="sxs-lookup"><span data-stu-id="54dcd-128">For more information, see [Setting Impersonation Levels Within a Provider](#setting-impersonation-levels-within-a-provider).</span></span>
-   <span data-ttu-id="54dcd-129">Der Anbieter muss Fehlerbedingungen ordnungsgemäß behandeln, wenn der Zugriff auf diese Informationen verweigert wird.</span><span class="sxs-lookup"><span data-stu-id="54dcd-129">The provider must correctly handle error conditions if access to this information is denied.</span></span> <span data-ttu-id="54dcd-130">Weitere Informationen finden Sie unter [Behandeln von Zugriffen auf Abgelehnte Nachrichten in einem Anbieter](#handling-access-denied-messages-in-a-provider).</span><span class="sxs-lookup"><span data-stu-id="54dcd-130">For more information, see [Handling Access Denied Messages in a Provider](#handling-access-denied-messages-in-a-provider).</span></span>

## <a name="registering-a-provider-for-impersonation"></a><span data-ttu-id="54dcd-131">Registrieren eines Anbieters für den Identitätswechsel</span><span class="sxs-lookup"><span data-stu-id="54dcd-131">Registering a Provider for Impersonation</span></span>

<span data-ttu-id="54dcd-132">WMI übergibt die SID einer Client Anwendung nur an Anbieter, die als Identitäts Anbieter registriert sind.</span><span class="sxs-lookup"><span data-stu-id="54dcd-132">WMI only passes the SID of a client application to providers who have registered as impersonation providers.</span></span> <span data-ttu-id="54dcd-133">Zum Aktivieren eines Anbieters für die Durchführung des Identitäts Wechsels ist es erforderlich, dass Sie den Anbieter Registrierungsprozess ändern.</span><span class="sxs-lookup"><span data-stu-id="54dcd-133">Enabling a provider to perform impersonation requires that you modify the provider registration process.</span></span>

<span data-ttu-id="54dcd-134">Im folgenden Verfahren wird beschrieben, wie ein Anbieter für den Identitätswechsel registriert wird.</span><span class="sxs-lookup"><span data-stu-id="54dcd-134">The following procedure describes how to register a provider for impersonation.</span></span> <span data-ttu-id="54dcd-135">In diesem Verfahren wird davon ausgegangen, dass Sie den Registrierungsprozess bereits verstanden haben.</span><span class="sxs-lookup"><span data-stu-id="54dcd-135">The procedure assumes that you already understand the registration process.</span></span> <span data-ttu-id="54dcd-136">Weitere Informationen zum Registrierungsprozess finden Sie unter [Registrieren eines Anbieters](registering-a-provider.md).</span><span class="sxs-lookup"><span data-stu-id="54dcd-136">For more information about the registration process, see [Registering a Provider](registering-a-provider.md).</span></span>

<span data-ttu-id="54dcd-137">**So registrieren Sie einen Anbieter für den Identitätswechsel**</span><span class="sxs-lookup"><span data-stu-id="54dcd-137">**To register a provider for impersonation**</span></span>

1.  <span data-ttu-id="54dcd-138">Legen Sie die Eigenschaft "Identitätswechsel [**Ebene**](swbemsecurity-impersonationlevel.md) " der [**\_ \_ Win32Provider**](--win32provider.md) -Klasse, die den Anbieter darstellt, auf 1 fest.</span><span class="sxs-lookup"><span data-stu-id="54dcd-138">Set the [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) property of the [**\_\_Win32Provider**](--win32provider.md) class that represents your provider to 1.</span></span>

    <span data-ttu-id="54dcd-139">Die Eigenschaft "Identitätswechsel [**Ebene**](swbemsecurity-impersonationlevel.md) " dokumentiert, ob der Anbieter Identitätswechsel unterstützt.</span><span class="sxs-lookup"><span data-stu-id="54dcd-139">The [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) property documents whether the provider supports impersonation or not.</span></span> <span data-ttu-id="54dcd-140">Das Festlegen von "Identitätswechsel **Ebene** " auf "0" gibt an, dass der Anbieter die Identität des Clients nicht annimmt und alle angeforderten Vorgänge im gleichen Benutzer Kontext wie WMI ausführt.</span><span class="sxs-lookup"><span data-stu-id="54dcd-140">Setting **ImpersonationLevel** to 0 indicates that the provider does not impersonate the client and performs all requested operations in the same user context as WMI.</span></span> <span data-ttu-id="54dcd-141">Das Festlegen von "Identitätswechsel **Ebene** " auf 1 gibt an, dass der Anbieter Identitätswechsel Aufrufe verwendet, um im Auftrag des Clients ausgeführte Vorgänge zu überprüfen.</span><span class="sxs-lookup"><span data-stu-id="54dcd-141">Setting **ImpersonationLevel** to 1 indicates that the provider uses impersonation calls to check operations performed on behalf of the client.</span></span>

2.  <span data-ttu-id="54dcd-142">Legen Sie die Eigenschaft " **peruserinitialization** " der [**\_ \_ Win32Provider**](--win32provider.md) -Klasse auf " **true**" fest.</span><span class="sxs-lookup"><span data-stu-id="54dcd-142">Set the **PerUserInitialization** property of the same [**\_\_Win32Provider**](--win32provider.md) class to **TRUE**.</span></span>

> [!Note]  
> <span data-ttu-id="54dcd-143">Wenn Sie einen Anbieter registrieren, bei dem die [**\_ \_ Win32Provider**](--win32provider.md) -Eigenschaft **initializeasadminfirst** auf **true** festgelegt ist, verwendet der Anbieter das Thread Sicherheits Token auf Verwaltungsebene nur während der Initialisierungsphase.</span><span class="sxs-lookup"><span data-stu-id="54dcd-143">If you register a provider with the [**\_\_Win32Provider**](--win32provider.md) property **InitializeAsAdminFirst** set to **TRUE**, then the provider uses the administration-level thread security token only during the initialization phase.</span></span> <span data-ttu-id="54dcd-144">Während ein Anrufe an " [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) " nicht fehlschlägt, verwendet der Anbieter den Sicherheitskontext von WMI und nicht den Client.</span><span class="sxs-lookup"><span data-stu-id="54dcd-144">While a call to [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) does not fail, the provider uses the security context of WMI and not of the client.</span></span>

 

<span data-ttu-id="54dcd-145">Im folgenden Codebeispiel wird gezeigt, wie ein Anbieter für den Identitätswechsel registriert wird.</span><span class="sxs-lookup"><span data-stu-id="54dcd-145">The following code example shows how to register a provider for impersonation.</span></span>

``` syntax
instance of __Win32Provider
{
    CLSID = "{FD4F53E0-65DC-11d1-AB64-00C04FD9159E}";
    ImpersonationLevel = 1;
    Name = "MS_NT_EVENTLOG_PROVIDER";
    PerUserInitialization = TRUE;
};
```

## <a name="setting-impersonation-levels-within-a-provider"></a><span data-ttu-id="54dcd-146">Festlegen von Identitätswechsel Ebenen innerhalb eines Anbieters</span><span class="sxs-lookup"><span data-stu-id="54dcd-146">Setting Impersonation Levels Within a Provider</span></span>

<span data-ttu-id="54dcd-147">Wenn Sie einen Anbieter registrieren, bei dem die [**\_ \_ Win32Provider**](--win32provider.md) -Klassen Eigenschaft Identitätswechsel [**Ebene**](swbemsecurity-impersonationlevel.md) auf 1 festgelegt ist, ruft WMI Ihren Anbieter auf, um die Identität verschiedener Clients anzunehmen.</span><span class="sxs-lookup"><span data-stu-id="54dcd-147">If you register a provider with the [**\_\_Win32Provider**](--win32provider.md) class property [**ImpersonationLevel**](swbemsecurity-impersonationlevel.md) set to 1, then WMI calls your provider to impersonate various clients.</span></span> <span data-ttu-id="54dcd-148">Um diese Aufrufe zu verarbeiten, verwenden Sie die Funktionen " [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) " und " [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) com" in ihrer Implementierung der [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) -Schnittstelle.</span><span class="sxs-lookup"><span data-stu-id="54dcd-148">To handle these calls, use the [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) and [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) COM functions in your implementation of the [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) interface.</span></span>

<span data-ttu-id="54dcd-149">Die Funktion " [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) " ermöglicht einem Server, die Identität des Clients anzunehmen, der den-Befehl durchgeführt hat.</span><span class="sxs-lookup"><span data-stu-id="54dcd-149">The [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) function allows a server to impersonate the client that made the call.</span></span> <span data-ttu-id="54dcd-150">Durch das Platzieren eines Aufrufes von **CoImpersonateClient** in Ihre Implementierung von [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices)ermöglichen Sie dem Anbieter, das Thread Token des Anbieters so festzulegen, dass es dem Thread Token des Clients entspricht, und die Identität des Clients anzunehmen.</span><span class="sxs-lookup"><span data-stu-id="54dcd-150">By placing a call to **CoImpersonateClient** into your implementation of [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices), you allow your provider to set the thread token of the provider to match the thread token of the client, and thus impersonate the client.</span></span> <span data-ttu-id="54dcd-151">Wenn Sie " **CoImpersonateClient**" nicht aufzurufen, führt Ihr Anbieter Code auf Administratorebene aus, um ein potenzielles Sicherheitsrisiko zu schaffen.</span><span class="sxs-lookup"><span data-stu-id="54dcd-151">If you do not call **CoImpersonateClient**, your provider executes code at an administrator level of security, thereby creating a potential security vulnerability.</span></span> <span data-ttu-id="54dcd-152">Wenn Ihr Anbieter temporär als Administrator fungieren oder die Zugriffs Überprüfung manuell ausführen muss, wenden Sie sich an [**corevertstoself**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself).</span><span class="sxs-lookup"><span data-stu-id="54dcd-152">If your provider temporarily needs to act as an administrator or perform the access check manually, then call [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself).</span></span>

<span data-ttu-id="54dcd-153">Im Gegensatz zu " [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient)" ist [**corevertteself**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) eine com-Funktion, die Thread Identitätswechsel Ebenen behandelt.</span><span class="sxs-lookup"><span data-stu-id="54dcd-153">In contrast to [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient), [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) is a COM function that handles thread impersonation levels.</span></span> <span data-ttu-id="54dcd-154">In diesem Fall ändert **coreverttself** die Identitätswechsel Ebene zurück in die ursprüngliche Identitätswechsel Einstellung.</span><span class="sxs-lookup"><span data-stu-id="54dcd-154">In this case, **CoRevertToSelf** changes the impersonation level back to the original impersonation setting.</span></span> <span data-ttu-id="54dcd-155">Im Allgemeinen ist der Anbieter anfänglich ein Administrator und wechselt zwischen " **CoImpersonateClient** " und " **corevertstoself** ", je nachdem, ob er einen Aufruf durchführen soll, der den Aufrufer oder seine eigenen Aufrufe darstellt.</span><span class="sxs-lookup"><span data-stu-id="54dcd-155">In general, the provider is initially an administrator and alternates between **CoImpersonateClient** and **CoRevertToSelf** depending on whether it is making a call that represents the caller or its own calls.</span></span> <span data-ttu-id="54dcd-156">Es liegt in der Verantwortung des Anbieters, diese Aufrufe ordnungsgemäß zu platzieren, damit keine Sicherheitslücke für den Endbenutzer verfügbar gemacht wird.</span><span class="sxs-lookup"><span data-stu-id="54dcd-156">It is the responsibility of the provider to place these calls correctly so as not to expose a security hole to the end user.</span></span> <span data-ttu-id="54dcd-157">Der Anbieter sollte z. b. nur native Windows-Funktionen innerhalb der Code Sequenz mit Identitätswechsel aufzurufen.</span><span class="sxs-lookup"><span data-stu-id="54dcd-157">For example, the provider should only call native Windows functions within the impersonated code sequence.</span></span>

> [!Note]  
> <span data-ttu-id="54dcd-158">Der Zweck von " [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) " und " [**corevertstoself**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) " ist das Festlegen der Sicherheit für einen Anbieter.</span><span class="sxs-lookup"><span data-stu-id="54dcd-158">The purpose of [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) and [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself) is to set security for a provider.</span></span> <span data-ttu-id="54dcd-159">Wenn Sie feststellen, dass Ihr Identitätswechsel fehlgeschlagen ist, sollten Sie über [**iwbewbjectsink:: SetStatus**](/windows/desktop/api/Wbemcli/nf-wbemcli-iwbemobjectsink-setstatus)einen passenden Vervollständigungs Code an WMI zurückgeben.</span><span class="sxs-lookup"><span data-stu-id="54dcd-159">If you determine that your impersonation has failed, you should return an appropriate completion code to WMI through [**IWbemObjectSink::SetStatus**](/windows/desktop/api/Wbemcli/nf-wbemcli-iwbemobjectsink-setstatus).</span></span> <span data-ttu-id="54dcd-160">Weitere Informationen finden Sie unter [Behandeln von Zugriffen auf Abgelehnte Nachrichten in einem Anbieter](#handling-access-denied-messages-in-a-provider).</span><span class="sxs-lookup"><span data-stu-id="54dcd-160">For more information, see [Handling Access Denied Messages in a Provider](#handling-access-denied-messages-in-a-provider).</span></span>

 

## <a name="maintaining-security-levels-in-a-provider"></a><span data-ttu-id="54dcd-161">Beibehalten von Sicherheitsstufen in einem Anbieter</span><span class="sxs-lookup"><span data-stu-id="54dcd-161">Maintaining Security Levels in a Provider</span></span>

<span data-ttu-id="54dcd-162">Anbieter können " [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) " nicht einmal in einer Implementierung von " [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) " abrufen und davon ausgehen, dass die Identitätswechsel-Anmelde Informationen für die Dauer des Anbieters vorhanden sind.</span><span class="sxs-lookup"><span data-stu-id="54dcd-162">Providers cannot call [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) one time in an implementation of [**IWbemServices**](/windows/desktop/api/WbemCli/nn-wbemcli-iwbemservices) and assume that the impersonation credentials remain in place for the duration of the provider.</span></span> <span data-ttu-id="54dcd-163">Verwenden Sie stattdessen " **CoImpersonateClient** " mehrmals im Verlauf einer Implementierung, damit WMI die Anmelde Informationen nicht ändert.</span><span class="sxs-lookup"><span data-stu-id="54dcd-163">Instead, call **CoImpersonateClient** multiple times during the course of an implementation to keep WMI from changing the credentials.</span></span>

<span data-ttu-id="54dcd-164">Der Hauptgrund für das Festlegen des Identitäts Wechsels für einen Anbieter ist das erneute eintreten.</span><span class="sxs-lookup"><span data-stu-id="54dcd-164">The main concern for setting impersonation for a provider is reentrancy.</span></span> <span data-ttu-id="54dcd-165">In diesem Zusammenhang ist das erneute eintreten, wenn ein Anbieter WMI für Informationen aufruft und wartet, bis WMI einen Rückruf an den Anbieter sendet.</span><span class="sxs-lookup"><span data-stu-id="54dcd-165">In this context, reentrancy is when a provider makes a call to WMI for information and waits until WMI calls back into the provider.</span></span> <span data-ttu-id="54dcd-166">Im wesentlichen verlässt der Ausführungs Thread den Anbieter Code, nur um den Code zu einem späteren Zeitpunkt erneut einzugeben.</span><span class="sxs-lookup"><span data-stu-id="54dcd-166">In essence, the thread of execution leaves the provider code, only to reenter the code at a later date.</span></span> <span data-ttu-id="54dcd-167">Reentry ist ein Bestandteil des Entwurfs von com und ist in der Regel kein Problem.</span><span class="sxs-lookup"><span data-stu-id="54dcd-167">Reentry is a part of the design of COM, and is generally not a concern.</span></span> <span data-ttu-id="54dcd-168">Wenn der Ausführungs Thread jedoch in WMI wechselt, übernimmt der Thread die Identitätswechsel Ebenen von WMI.</span><span class="sxs-lookup"><span data-stu-id="54dcd-168">However, when the thread of execution enters WMI, the thread takes on the impersonation levels of WMI.</span></span> <span data-ttu-id="54dcd-169">Wenn der Thread an den Anbieter zurückgegeben wird, müssen Sie die Identitätswechsel Ebenen mit einem weiteren aufrufungsebene von [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient)zurücksetzen.</span><span class="sxs-lookup"><span data-stu-id="54dcd-169">When the thread returns to the provider, you must reset the impersonation levels with another call to [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient).</span></span>

<span data-ttu-id="54dcd-170">Wenn Sie sich vor Sicherheitslücken in Ihrem Anbieter schützen möchten, sollten Sie nur dann wieder eintretende Aufrufe von WMI ausführen, während Sie die Identität des Clients annehmen.</span><span class="sxs-lookup"><span data-stu-id="54dcd-170">To protect yourself from security holes in your provider, you should make reentrant calls into WMI only while impersonating the client.</span></span> <span data-ttu-id="54dcd-171">Das heißt, dass Aufrufe von WMI erfolgen sollten, nachdem Sie " [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) " und vor dem Aufruf von " [**corevertdeself**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself)" aufgerufen haben.</span><span class="sxs-lookup"><span data-stu-id="54dcd-171">That is, calls to WMI should be made after you call [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) and before you call [**CoRevertToSelf**](/windows/win32/api/combaseapi/nf-combaseapi-coreverttoself).</span></span> <span data-ttu-id="54dcd-172">Da **CoRevertToSelf** bewirkt, dass der Identitätswechsel auf die Benutzerebene festgelegt wird, die von WMI ausgeführt wird, werden im allgemeinen "LocalSystem", Wiedereintritts fähige Aufrufe an WMI nach dem Aufruf von " **CoRevertToSelf** " dem Benutzer und allen Anbietern mit dem Namen sehr viel mehr Funktionen zugewiesen, als Sie hätten.</span><span class="sxs-lookup"><span data-stu-id="54dcd-172">Because **CoRevertToSelf** causes the impersonation to be set to the user level WMI is running, generally LocalSystem, reentrant calls to WMI after calling **CoRevertToSelf** could give the user, and any providers called, a lot more capabilities than they should have.</span></span>

> [!Note]  
> <span data-ttu-id="54dcd-173">Wenn Sie eine Systemfunktion oder eine andere Schnittstellen Methode aufzurufen, wird der Kontext des aufrufskontexts nicht garantiert beibehalten.</span><span class="sxs-lookup"><span data-stu-id="54dcd-173">If you call a system function or another interface method, the call context is not guaranteed to be maintained.</span></span>

 

## <a name="handling-access-denied-messages-in-a-provider"></a><span data-ttu-id="54dcd-174">Behandeln von Zugriffen auf Abgelehnte Nachrichten in einem Anbieter</span><span class="sxs-lookup"><span data-stu-id="54dcd-174">Handling Access Denied Messages in a Provider</span></span>

<span data-ttu-id="54dcd-175">Die meisten Zugriffs Verweigerungs Fehlermeldungen werden angezeigt, wenn ein Client eine Klasse oder Informationen anfordert, auf die Sie keinen Zugriff haben.</span><span class="sxs-lookup"><span data-stu-id="54dcd-175">Most Access Denied error messages appear when a client requests a class or information to which they do not have access.</span></span> <span data-ttu-id="54dcd-176">Wenn der Anbieter die Fehlermeldung "Zugriff verweigert" an WMI zurückgibt und diese an den Client weitergegeben wird, kann der Client ableiten, dass die Informationen vorhanden sind.</span><span class="sxs-lookup"><span data-stu-id="54dcd-176">If the provider returns an Access Denied error message to WMI and WMI passes this on to the client, the client can infer that the information exists.</span></span> <span data-ttu-id="54dcd-177">In einigen Fällen kann dies ein Sicherheits Verstoß sein.</span><span class="sxs-lookup"><span data-stu-id="54dcd-177">In some situations, this can be a breach of security.</span></span> <span data-ttu-id="54dcd-178">Daher sollte der Anbieter die Nachricht nicht an den Client weitergeben.</span><span class="sxs-lookup"><span data-stu-id="54dcd-178">Therefore, your provider should not propagate the message to the client.</span></span> <span data-ttu-id="54dcd-179">Stattdessen sollte der Satz von Klassen, den der Anbieter bereitgestellt hätte, nicht verfügbar gemacht werden.</span><span class="sxs-lookup"><span data-stu-id="54dcd-179">Instead, the set of classes that the provider would have supplied should not be exposed.</span></span> <span data-ttu-id="54dcd-180">Entsprechend sollte ein dynamischer Instanzanbieter die zugrunde liegende Datenquelle aufrufen, um zu bestimmen, wie die Nachrichten vom Typ "Zugriff verweigert" behandelt werden.</span><span class="sxs-lookup"><span data-stu-id="54dcd-180">Similarly, a dynamic instance provider should call to the underlying data source to determine how to deal with Access Denied messages.</span></span> <span data-ttu-id="54dcd-181">Es liegt in der Verantwortung des Anbieters, diese Philosophie in der WMI-Umgebung zu replizieren.</span><span class="sxs-lookup"><span data-stu-id="54dcd-181">It is the responsibility of the provider to replicate that philosophy into the WMI environment.</span></span> <span data-ttu-id="54dcd-182">Weitere Informationen finden Sie unter [Reporting partieller Instanzen](#reporting-partial-instances) und [melden partieller Enumerationen](#reporting-partial-enumerations).</span><span class="sxs-lookup"><span data-stu-id="54dcd-182">For more information, see [Reporting Partial Instances](#reporting-partial-instances) and [Reporting Partial Enumerations](#reporting-partial-enumerations).</span></span>

<span data-ttu-id="54dcd-183">Wenn Sie bestimmen, wie der Anbieter zugriffverweigerungs-Nachrichten behandeln soll, müssen Sie den Code schreiben und Debuggen.</span><span class="sxs-lookup"><span data-stu-id="54dcd-183">When you determine how your provider should handle Access Denied messages, you must write and debug your code.</span></span> <span data-ttu-id="54dcd-184">Beim Debuggen ist es häufig sinnvoll, eine Verweigerung aufgrund von geringem Identitätswechsel und eine Verweigerung aufgrund eines Fehlers im Code zu unterscheiden.</span><span class="sxs-lookup"><span data-stu-id="54dcd-184">While debugging, it is often convenient to distinguish between a denial due to low impersonation, and a denial due to an error in your code.</span></span> <span data-ttu-id="54dcd-185">Sie können einen einfachen Test in Ihrem Code verwenden, um den Unterschied zu bestimmen.</span><span class="sxs-lookup"><span data-stu-id="54dcd-185">You can use a simple test in your code to determine the difference.</span></span> <span data-ttu-id="54dcd-186">Weitere Informationen finden Sie unter [Debuggen des Codes für den Zugriff verweigert](#debugging-your-access-denied-code).</span><span class="sxs-lookup"><span data-stu-id="54dcd-186">For more information, see [Debugging your Access Denied Code](#debugging-your-access-denied-code).</span></span>

## <a name="reporting-partial-instances"></a><span data-ttu-id="54dcd-187">Teil Instanzen der Berichterstellung</span><span class="sxs-lookup"><span data-stu-id="54dcd-187">Reporting Partial Instances</span></span>

<span data-ttu-id="54dcd-188">Ein häufiges Vorkommen einer Nachricht vom Typ "Zugriff verweigert" besteht darin, dass WMI nicht alle Informationen zum Ausfüllen einer Instanz bereitstellen kann.</span><span class="sxs-lookup"><span data-stu-id="54dcd-188">One common occurrence of an Access Denied message is when WMI cannot provide all the information to fill an instance.</span></span> <span data-ttu-id="54dcd-189">Ein Client kann z. b. über die Berechtigung zum Anzeigen eines Festplatten Laufwerks verfügen, aber möglicherweise nicht über die Berechtigung, zu sehen, wie viel Speicherplatz auf dem Festplattenlaufwerk selbst verfügbar ist.</span><span class="sxs-lookup"><span data-stu-id="54dcd-189">For example, a client may have the authority to view a hard disk drive object, but may not have authority to see how much space is available on the hard disk drive itself.</span></span> <span data-ttu-id="54dcd-190">Der Anbieter muss festlegen, wie jede Situation behandelt werden soll, wenn der Anbieter eine Instanz aufgrund einer Zugriffsverletzung nicht vollständig mit Eigenschaften auffüllen kann.</span><span class="sxs-lookup"><span data-stu-id="54dcd-190">Your provider must determine how to handle any situation when the provider cannot completely fill an instance with properties due to an access violation.</span></span>

<span data-ttu-id="54dcd-191">WMI erfordert keine einzige Antwort an Clients, die partiellen Zugriff auf eine Instanz haben.</span><span class="sxs-lookup"><span data-stu-id="54dcd-191">WMI does not require a single response to clients that have partial access to an instance.</span></span> <span data-ttu-id="54dcd-192">Stattdessen ermöglicht WMI Version 1. x dem Anbieter eine der folgenden Optionen:</span><span class="sxs-lookup"><span data-stu-id="54dcd-192">Instead, WMI version 1.x allows the provider one of the following options:</span></span>

-   <span data-ttu-id="54dcd-193">Fehler beim gesamten Vorgang mit **WBEM \_ E \_ Access \_ verweigert** und gibt keine Instanzen zurück.</span><span class="sxs-lookup"><span data-stu-id="54dcd-193">Fail the entire operation with **WBEM\_E\_ACCESS\_DENIED** and return no instances.</span></span>

    <span data-ttu-id="54dcd-194">Geben Sie zusammen mit **WBEM \_ E \_ Access \_ denied** ein Fehler Objekt zurück, um den Grund für die Verweigerung zu beschreiben.</span><span class="sxs-lookup"><span data-stu-id="54dcd-194">Return an error object along with **WBEM\_E\_ACCESS\_DENIED**, to describe the reason for the denial.</span></span>

-   <span data-ttu-id="54dcd-195">Geben Sie alle verfügbaren Eigenschaften zurück, und füllen Sie nicht verfügbare Eigenschaften mit **null**.</span><span class="sxs-lookup"><span data-stu-id="54dcd-195">Return all available properties, and fill unavailable properties with **NULL**.</span></span>

> [!Note]  
> <span data-ttu-id="54dcd-196">Stellen Sie sicher, dass das Zurückgeben von **WBEM \_ E \_ Access \_ denied** keine Sicherheitslücke in Ihrem Unternehmen erzeugt.</span><span class="sxs-lookup"><span data-stu-id="54dcd-196">Make sure that returning **WBEM\_E\_ACCESS\_DENIED** does not create a security hole in your enterprise.</span></span>

 

## <a name="reporting-partial-enumerations"></a><span data-ttu-id="54dcd-197">Partielle Enumerationen für Berichte</span><span class="sxs-lookup"><span data-stu-id="54dcd-197">Reporting Partial Enumerations</span></span>

<span data-ttu-id="54dcd-198">Ein weiteres häufiges Vorkommen einer Zugriffsverletzung ist, wenn WMI keine Enumeration zurückgeben kann.</span><span class="sxs-lookup"><span data-stu-id="54dcd-198">Another common occurrence of an access violation is when WMI cannot return all of an enumeration.</span></span> <span data-ttu-id="54dcd-199">Beispielsweise kann ein Client auf alle lokalen Netzwerk Computer Objekte zugreifen, aber möglicherweise nicht auf die Anzeige von Computer Objekten außerhalb seiner Domäne zugreifen.</span><span class="sxs-lookup"><span data-stu-id="54dcd-199">For example, a client may have access to view all of the local network computer objects, but may not have access to view computer objects outside of his domain.</span></span> <span data-ttu-id="54dcd-200">Der Anbieter muss festlegen, wie jede Situation behandelt werden soll, in der eine Enumeration aufgrund einer Zugriffsverletzung nicht abgeschlossen werden kann.</span><span class="sxs-lookup"><span data-stu-id="54dcd-200">Your provider must determine how to handle any situation when an enumeration cannot be completed due to an access violation.</span></span>

<span data-ttu-id="54dcd-201">Wie bei einem Instanzanbieter erfordert WMI keine einzige Antwort auf eine partielle Enumeration.</span><span class="sxs-lookup"><span data-stu-id="54dcd-201">As with an instance provider, WMI does not require a single response to a partial enumeration.</span></span> <span data-ttu-id="54dcd-202">Stattdessen ermöglicht WMI Version 1. x einem Anbieter eine der folgenden Optionen:</span><span class="sxs-lookup"><span data-stu-id="54dcd-202">Instead, WMI version 1.x allows a provider one of the following options:</span></span>

-   <span data-ttu-id="54dcd-203">Gibt **WBEM \_ S \_ keinen \_ Fehler** für alle Instanzen zurück, auf die der Anbieter zugreifen kann.</span><span class="sxs-lookup"><span data-stu-id="54dcd-203">Return **WBEM\_S\_NO\_ERROR** for all instances that the provider can access.</span></span>

    <span data-ttu-id="54dcd-204">Wenn Sie diese Option verwenden, weiß der Benutzer nicht, dass einige Instanzen nicht verfügbar waren.</span><span class="sxs-lookup"><span data-stu-id="54dcd-204">If you use this option, the user is not aware that some instances were not available.</span></span> <span data-ttu-id="54dcd-205">Eine Reihe von Anbietern, z. b. solche, die Structured Query Language (SQL) mit Sicherheit auf Zeilenebene verwenden, geben erfolgreiche partielle Ergebnisse zurück, indem die Sicherheitsstufe des Aufrufers zum Definieren des Resultsets verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="54dcd-205">A number of providers, such as those using Structured Query Language (SQL) with row-level security, return successful partial results using the security level of the caller to define the result set.</span></span>

-   <span data-ttu-id="54dcd-206">Fehler beim gesamten Vorgang mit **WBEM \_ E \_ Access \_ verweigert** und gibt keine Instanzen zurück.</span><span class="sxs-lookup"><span data-stu-id="54dcd-206">Fail the entire operation with **WBEM\_E\_ACCESS\_DENIED** and return no instances.</span></span>

    <span data-ttu-id="54dcd-207">Der Anbieter kann optional ein Fehler Objekt einschließen, das die Situation für den Client beschreibt.</span><span class="sxs-lookup"><span data-stu-id="54dcd-207">The provider may optionally include an error object that describes the situation to the client.</span></span> <span data-ttu-id="54dcd-208">Beachten Sie, dass einige Anbieter möglicherweise serialisiert auf Datenquellen zugreifen und bis auf die Enumeration keine Verweigerungen auftreten.</span><span class="sxs-lookup"><span data-stu-id="54dcd-208">Note that some providers may access data sources serially and may not encounter denials until partway through the enumeration.</span></span>

-   <span data-ttu-id="54dcd-209">Gibt alle Instanzen zurück, auf die zugegriffen werden kann, gibt jedoch auch den nicht Fehlerstatus Code " **WBEM \_ S \_ Access \_ denied**" zurück.</span><span class="sxs-lookup"><span data-stu-id="54dcd-209">Return all of the instances that can be accessed but also return the nonerror status code **WBEM\_S\_ACCESS\_DENIED**.</span></span>

    <span data-ttu-id="54dcd-210">Der Anbieter sollte die Verweigerung während der Enumeration beachten und die Bereitstellung von Instanzen fortsetzen, wobei der Statuscode nicht Fehler beendet wird.</span><span class="sxs-lookup"><span data-stu-id="54dcd-210">The provider should note the denial during enumeration and may continue providing instances, finishing up with the nonerror status code.</span></span> <span data-ttu-id="54dcd-211">Der Anbieter kann die Enumeration bei der ersten Verweigerung auch beenden.</span><span class="sxs-lookup"><span data-stu-id="54dcd-211">The provider may also elect to terminate the enumeration at the first denial.</span></span> <span data-ttu-id="54dcd-212">Die Begründung für diese Option besteht darin, dass unterschiedliche Anbieter unterschiedliche Abruf Paradigmen haben.</span><span class="sxs-lookup"><span data-stu-id="54dcd-212">The justification for this option is that different providers have different retrieval paradigms.</span></span> <span data-ttu-id="54dcd-213">Ein Anbieter hat möglicherweise bereits Instanzen übermittelt, bevor er eine Zugriffsverletzung entdeckt.</span><span class="sxs-lookup"><span data-stu-id="54dcd-213">A provider may have already delivered instances before discovering an access violation.</span></span> <span data-ttu-id="54dcd-214">Einige Anbieter haben möglicherweise die Möglichkeit, weitere Instanzen bereitzustellen, die andere möglicherweise beenden möchten.</span><span class="sxs-lookup"><span data-stu-id="54dcd-214">Some providers may elect to continue providing other instances and others may wish to terminate.</span></span>

<span data-ttu-id="54dcd-215">Aufgrund der com-Struktur können Sie keine Informationen während eines Fehlers mit Ausnahme eines Fehler Objekts zurück Mars Hallen.</span><span class="sxs-lookup"><span data-stu-id="54dcd-215">Due to the structure of COM, you cannot marshal back any information during an error except for an error object.</span></span> <span data-ttu-id="54dcd-216">Daher können Sie nicht sowohl Informationen als auch einen Fehlercode zurückgeben.</span><span class="sxs-lookup"><span data-stu-id="54dcd-216">Therefore, you cannot return both information and an error code.</span></span> <span data-ttu-id="54dcd-217">Wenn Sie Informationen zurückgeben möchten, müssen Sie stattdessen einen nicht Fehlerstatus Code verwenden.</span><span class="sxs-lookup"><span data-stu-id="54dcd-217">If you choose to return information, you must use a nonerror status code instead.</span></span>

## <a name="debugging-your-access-denied-code"></a><span data-ttu-id="54dcd-218">Debuggen des Zugriffs verweigerten Codes</span><span class="sxs-lookup"><span data-stu-id="54dcd-218">Debugging Your Access Denied Code</span></span>

<span data-ttu-id="54dcd-219">Einige Anwendungen verwenden möglicherweise Identitätswechsel Ebenen, die niedriger als die Identitätswechsel **Ebene der RPC- \_ C- \_ \_ Ebene \_** sind.</span><span class="sxs-lookup"><span data-stu-id="54dcd-219">Some applications may use impersonation levels lower than **RPC\_C\_IMP\_LEVEL\_IMPERSONATE**.</span></span> <span data-ttu-id="54dcd-220">In diesem Fall tritt bei den meisten Identitätswechsel Aufrufen des Anbieters für die Client Anwendung ein Fehler auf.</span><span class="sxs-lookup"><span data-stu-id="54dcd-220">In this case, most impersonation calls made by the provider for the client application will fail.</span></span> <span data-ttu-id="54dcd-221">Zum erfolgreichen entwerfen und Implementieren eines Anbieters müssen Sie diese Idee beachten.</span><span class="sxs-lookup"><span data-stu-id="54dcd-221">To successfully design and implement a provider, you must keep this idea in mind.</span></span>

<span data-ttu-id="54dcd-222">Standardmäßig ist die einzige andere Identitätswechsel Ebene, die auf einen Anbieter zugreifen kann, der **RPC- \_ C- \_ IMP- \_ Ebene \_**.</span><span class="sxs-lookup"><span data-stu-id="54dcd-222">By default, the only other level of impersonation that can access a provider is **RPC\_C\_IMP\_LEVEL\_IDENTIFY**.</span></span> <span data-ttu-id="54dcd-223">In Fällen, in denen eine Client Anwendung die **RPC- \_ C-Ebene " \_ IMP- \_ Ebene \_**" verwendet, gibt " [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) " keinen Fehlercode zurück.</span><span class="sxs-lookup"><span data-stu-id="54dcd-223">In cases where a client application uses **RPC\_C\_IMP\_LEVEL\_IDENTIFY**, [**CoImpersonateClient**](/windows/win32/api/combaseapi/nf-combaseapi-coimpersonateclient) does not return an error code.</span></span> <span data-ttu-id="54dcd-224">Stattdessen nimmt der Anbieter den Client nur zu Identifizierungs Zwecken an.</span><span class="sxs-lookup"><span data-stu-id="54dcd-224">Instead, the provider impersonates the client for identification purposes only.</span></span> <span data-ttu-id="54dcd-225">Daher geben die meisten vom Anbieter aufgerufenen Windows-Methoden eine Meldung "Zugriff verweigert" zurück.</span><span class="sxs-lookup"><span data-stu-id="54dcd-225">Therefore, most Windows methods called by the provider will return an access denied message.</span></span> <span data-ttu-id="54dcd-226">Dies ist in der Praxis harmlos, da Benutzer keine ungeeigneten Aktionen ausführen dürfen.</span><span class="sxs-lookup"><span data-stu-id="54dcd-226">This is harmless in practice, as users will not be permitted to do anything inappropriate.</span></span> <span data-ttu-id="54dcd-227">Allerdings kann es bei der Anbieter Entwicklung nützlich sein, um zu ermitteln, ob der Client tatsächlich einen Identitätswechsel durchgeführt hat.</span><span class="sxs-lookup"><span data-stu-id="54dcd-227">However, it may be useful during provider development to know whether the client was truly impersonated or not.</span></span>

<span data-ttu-id="54dcd-228">Der Code erfordert, dass die folgenden Verweise und \# include-Anweisungen ordnungsgemäß kompiliert werden.</span><span class="sxs-lookup"><span data-stu-id="54dcd-228">The code requires the following references and \#include statements to compile correctly.</span></span>


```C++
#define _WIN32_DCOM
#include <iostream>
using namespace std;
#include <wbemidl.h>
```



<span data-ttu-id="54dcd-229">Im folgenden Codebeispiel wird veranschaulicht, wie bestimmt wird, ob ein Anbieter erfolgreich eine Client Anwendung angenommen hat.</span><span class="sxs-lookup"><span data-stu-id="54dcd-229">The following code example shows how to determine whether a provider has successfully impersonated a client application.</span></span>


```C++
DWORD dwImp = 0;
HANDLE hThreadTok;
DWORD dwBytesReturned;
BOOL bRes;

// You must call this before trying to open a thread token!
CoImpersonateClient();

bRes = OpenThreadToken(
    GetCurrentThread(),
    TOKEN_QUERY,
    TRUE,
    &hThreadTok
);

if (bRes == FALSE)
{
    printf("Unable to read thread token (%d)\n", GetLastError());
    return 0;
}

bRes = GetTokenInformation(
    hThreadTok,
    TokenImpersonationLevel, 
    &dwImp,
    sizeof(DWORD),
    &dwBytesReturned
);

if (!bRes)
{
    printf("Unable to read impersonation level\n");
    CloseHandle(hThreadTok);
    return 0;
}

switch (dwImp)
{
case SecurityAnonymous:
    printf("SecurityAnonymous\n");
    break;

case SecurityIdentification:
    printf("SecurityIdentification\n");
    break;

case SecurityImpersonation:
    printf("SecurityImpersonation\n");
    break;

case SecurityDelegation:
    printf("SecurityDelegation\n");
    break;

default:
    printf("Error. Unable to determine impersonation level\n");
    break;
}

CloseHandle(hThreadTok);
```



## <a name="related-topics"></a><span data-ttu-id="54dcd-230">Zugehörige Themen</span><span class="sxs-lookup"><span data-stu-id="54dcd-230">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="54dcd-231">Entwickeln eines WMI-Anbieters</span><span class="sxs-lookup"><span data-stu-id="54dcd-231">Developing a WMI Provider</span></span>](developing-a-wmi-provider.md)
</dt> <dt>

[<span data-ttu-id="54dcd-232">Festlegen von namepace-Sicherheits Deskriptoren</span><span class="sxs-lookup"><span data-stu-id="54dcd-232">Setting Namepace Security Descriptors</span></span>](setting-namespace-security-descriptors.md)
</dt> <dt>

[<span data-ttu-id="54dcd-233">Sichern Ihres Anbieters</span><span class="sxs-lookup"><span data-stu-id="54dcd-233">Securing Your Provider</span></span>](securing-your-provider.md)
</dt> </dl>

 

 
