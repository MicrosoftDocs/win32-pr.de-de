---
description: Jeder Dienst verfügt über einen Steuerelement Handler, die Handlerfunktion, die vom Steuerelement Verteiler aufgerufen wird, wenn der Dienst Prozess eine Steuerungs Anforderung von einem Dienst Steuerungsprogramm empfängt.
ms.assetid: 437334ed-05fa-4ab6-aab3-dc2739113e19
title: Dienststeuerungshandler-Funktion
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1303bff45421ee7206d02be9ee30066324648823
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/07/2021
ms.locfileid: "106343278"
---
# <a name="service-control-handler-function"></a><span data-ttu-id="9e352-103">Dienststeuerungshandler-Funktion</span><span class="sxs-lookup"><span data-stu-id="9e352-103">Service Control Handler Function</span></span>

<span data-ttu-id="9e352-104">Jeder Dienst verfügt über einen Steuerelement Handler, die [**Handlerfunktion**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) , die vom Steuerelement Verteiler aufgerufen wird, wenn der Dienst Prozess eine Steuerungs Anforderung von einem Dienst Steuerungsprogramm empfängt.</span><span class="sxs-lookup"><span data-stu-id="9e352-104">Each service has a control handler, the [**Handler**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) function, that is invoked by the control dispatcher when the service process receives a control request from a service control program.</span></span> <span data-ttu-id="9e352-105">Daher wird diese Funktion im Kontext des Steuerelement Verteilers ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="9e352-105">Therefore, this function executes in the context of the control dispatcher.</span></span> <span data-ttu-id="9e352-106">Ein Beispiel finden Sie unter [Schreiben einer Steuerelement Handler-Funktion](writing-a-control-handler-function.md).</span><span class="sxs-lookup"><span data-stu-id="9e352-106">For an example, see [Writing a Control Handler Function](writing-a-control-handler-function.md).</span></span>

<span data-ttu-id="9e352-107">Ein Dienst ruft die [**registerservicectrlhandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) -oder [**RegisterServiceCtrlHandlerEx**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlerexa) -Funktion auf, um seine Dienststeuerungs-Handlerfunktion zu registrieren.</span><span class="sxs-lookup"><span data-stu-id="9e352-107">A service calls the [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) or [**RegisterServiceCtrlHandlerEx**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlerexa) function to register its service control handler function.</span></span>

<span data-ttu-id="9e352-108">Wenn der Dienst Steuerungs Handler aufgerufen wird, muss der Dienst die [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) -Funktion aufrufen, um seinen Status nur dann an den SCM zu melden, wenn die Verarbeitung des Steuerungs Codes bewirkt, dass der Dienststatus geändert wird.</span><span class="sxs-lookup"><span data-stu-id="9e352-108">When the service control handler is invoked, the service must call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function to report its status to the SCM only if handling the control code causes the service status to change.</span></span> <span data-ttu-id="9e352-109">Wenn die Verarbeitung des Steuerungs Codes nicht bewirkt, dass der Dienststatus geändert wird, ist es nicht erforderlich, **SetServiceStatus** aufzurufen.</span><span class="sxs-lookup"><span data-stu-id="9e352-109">If handling the control code does not cause the service status to change, it is not necessary to call **SetServiceStatus**.</span></span>

<span data-ttu-id="9e352-110">Ein Dienst Steuerungsprogramm kann Steuerungsanforderungen mithilfe der [**ControlService**](/windows/desktop/api/Winsvc/nf-winsvc-controlservice) -Funktion senden.</span><span class="sxs-lookup"><span data-stu-id="9e352-110">A service control program can send control requests using the [**ControlService**](/windows/desktop/api/Winsvc/nf-winsvc-controlservice) function.</span></span> <span data-ttu-id="9e352-111">Alle Dienste müssen den Steuerungs Code der **\_ Dienststeuerungs- \_ Abfrage** akzeptieren und verarbeiten.</span><span class="sxs-lookup"><span data-stu-id="9e352-111">All services must accept and process the **SERVICE\_CONTROL\_INTERROGATE** control code.</span></span> <span data-ttu-id="9e352-112">Sie können die Annahme der anderen Kontrollcodes durch Aufrufen von [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus)aktivieren oder deaktivieren.</span><span class="sxs-lookup"><span data-stu-id="9e352-112">You can enable or disable acceptance of the other control codes by calling [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus).</span></span> <span data-ttu-id="9e352-113">Sie müssen die [**registerdevicenotifi-**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) Funktion aufrufen, um den Steuerungs Code der **Dienst \_ Steuerung \_ deviceevent** zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="9e352-113">To receive the **SERVICE\_CONTROL\_DEVICEEVENT** control code, you must call the [**RegisterDeviceNotification**](/windows/desktop/api/winuser/nf-winuser-registerdevicenotificationa) function.</span></span> <span data-ttu-id="9e352-114">Dienste können auch zusätzliche benutzerdefinierte Steuerungs Codes verarbeiten.</span><span class="sxs-lookup"><span data-stu-id="9e352-114">Services can also handle additional user-defined control codes.</span></span>

<span data-ttu-id="9e352-115">Wenn ein Dienst den Steuerungs Code für die **\_ \_ Beendigung der Dienst Kontrolle** annimmt, muss er **nach der Bestätigung \_ \_** angeh **\_ alten** werden.</span><span class="sxs-lookup"><span data-stu-id="9e352-115">If a service accepts the **SERVICE\_CONTROL\_STOP** control code, it must stop upon receipt, going to either the **SERVICE\_STOP\_PENDING** or **SERVICE\_STOPPED** state.</span></span> <span data-ttu-id="9e352-116">Nachdem der SCM diesen Steuerungs Code gesendet hat, sendet er keine anderen Steuerungs Codes.</span><span class="sxs-lookup"><span data-stu-id="9e352-116">After the SCM sends this control code, it will not send other control codes.</span></span>

<span data-ttu-id="9e352-117">**Windows XP:** Wenn der Dienst **keinen \_ Fehler** zurückgibt und weiterhin ausgeführt wird, empfängt er weiterhin Steuerungs Codes.</span><span class="sxs-lookup"><span data-stu-id="9e352-117">**Windows XP:** If the service returns **NO\_ERROR** and continues to run, it continues to receive control codes.</span></span> <span data-ttu-id="9e352-118">Dieses Verhalten hat sich seit Windows Server 2003 und Windows XP mit Service Pack 2 (SP2) geändert.</span><span class="sxs-lookup"><span data-stu-id="9e352-118">This behavior changed starting with Windows Server 2003 and Windows XP with Service Pack 2 (SP2).</span></span>

<span data-ttu-id="9e352-119">Der Steuerelement Handler muss innerhalb von 30 Sekunden zurückgeben, oder der SCM gibt einen Fehler zurück.</span><span class="sxs-lookup"><span data-stu-id="9e352-119">The control handler must return within 30 seconds, or the SCM returns an error.</span></span> <span data-ttu-id="9e352-120">Wenn ein Dienst eine lange Verarbeitung ausführen muss, während der Dienst den Steuerelement Handler ausführt, sollte er einen sekundären Thread erstellen, um die lange Verarbeitung auszuführen, und dann vom Steuerelement Handler zurückgeben.</span><span class="sxs-lookup"><span data-stu-id="9e352-120">If a service must do lengthy processing when the service is executing the control handler, it should create a secondary thread to perform the lengthy processing, and then return from the control handler.</span></span> <span data-ttu-id="9e352-121">Dadurch wird verhindert, dass der Dienst den Steuerelement Verteiler bindet.</span><span class="sxs-lookup"><span data-stu-id="9e352-121">This prevents the service from tying up the control dispatcher.</span></span> <span data-ttu-id="9e352-122">Wenn Sie z. b. die Anforderung zum Beenden für einen Dienst verarbeiten, der lange dauert, erstellen Sie einen weiteren Thread, um den Vorgang zu beenden.</span><span class="sxs-lookup"><span data-stu-id="9e352-122">For example, when handling the stop request for a service that takes a long time, create another thread to handle the stop process.</span></span> <span data-ttu-id="9e352-123">Der Steuerelement Handler sollte einfach [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) mit dem **Dienst \_ " \_ ausstehende Nachricht Abbrechen** " aufrufen und zurückgeben.</span><span class="sxs-lookup"><span data-stu-id="9e352-123">The control handler should simply call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_STOP\_PENDING** message and return.</span></span>

<span data-ttu-id="9e352-124">Wenn der Benutzer das System herunterfährt, erhalten alle Steuerelemente, die [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) mit dem Dienst aufgerufen haben, den Steuerungs Code für das **\_ \_ vorab Herunterfahren der Dienst Kontrolle** . **\_ \_**</span><span class="sxs-lookup"><span data-stu-id="9e352-124">When the user shuts down the system, all control handlers that have called [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_ACCEPT\_PRESHUTDOWN** control code receive the **SERVICE\_CONTROL\_PRESHUTDOWN** control code.</span></span> <span data-ttu-id="9e352-125">Der Dienststeuerungs-Manager wartet, bis der Dienst beendet wird oder der angegebene Timeout Wert für das vorherunter fahren abläuft (dieser Wert kann mit der [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) -Funktion festgelegt werden).</span><span class="sxs-lookup"><span data-stu-id="9e352-125">The service control manager waits until the service stops or the specified preshutdown time-out value expires (this value can be set with the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) function).</span></span> <span data-ttu-id="9e352-126">Dieser Steuerungs Code sollte nur in besonderen Fällen verwendet werden, da ein Dienst, der diese Benachrichtigung verarbeitet, das Herunterfahren des Systems blockiert, bis der Dienst beendet wird oder das Timeout Intervall für das vorherunter fahren abläuft.</span><span class="sxs-lookup"><span data-stu-id="9e352-126">This control code should be used only in special circumstances, because a service that handles this notification blocks system shutdown until the service stops or the preshutdown time-out interval expires.</span></span>

<span data-ttu-id="9e352-127">Nachdem die Benachrichtigungen vor dem Herunterfahren abgeschlossen wurden, erhalten alle Steuerelement Handler, die [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) mit dem Dienst mit dem **Dienst " \_ \_ herunter** fahren" aufgerufen haben, den Steuerungs Code für das Herunterfahren der **Dienst \_ \_ Kontrolle** .</span><span class="sxs-lookup"><span data-stu-id="9e352-127">After the preshutdown notifications have been completed, all control handlers that have called [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) with the **SERVICE\_ACCEPT\_SHUTDOWN** control code receive the **SERVICE\_CONTROL\_SHUTDOWN** control code.</span></span> <span data-ttu-id="9e352-128">Sie werden in der Reihenfolge benachrichtigt, in der Sie in der Datenbank der installierten Dienste angezeigt werden.</span><span class="sxs-lookup"><span data-stu-id="9e352-128">They are notified in the order that they appear in the database of installed services.</span></span> <span data-ttu-id="9e352-129">Standardmäßig hat ein Dienst ungefähr 20 Sekunden Zeit, um Bereinigungs Tasks auszuführen, bevor das System heruntergefahren wird.</span><span class="sxs-lookup"><span data-stu-id="9e352-129">By default, a service has approximately 20 seconds to perform cleanup tasks before the system shuts down.</span></span> <span data-ttu-id="9e352-130">Nach Ablauf dieses Zeitraums wird das Herunterfahren des Systems unabhängig davon fortgesetzt, ob der Dienst beendet wurde.</span><span class="sxs-lookup"><span data-stu-id="9e352-130">After this time expires, system shutdown proceeds regardless of whether service shutdown is complete.</span></span> <span data-ttu-id="9e352-131">Beachten Sie, dass der Dienst weiterhin ausgeführt wird, wenn das System nicht neu gestartet oder ausgeschaltet wird.</span><span class="sxs-lookup"><span data-stu-id="9e352-131">Note that if the system is left in the shutdown state (not restarted or powered down), the service continues to run.</span></span>

<span data-ttu-id="9e352-132">Wenn für den Dienst mehr Zeit zum Bereinigen benötigt wird, **werden \_ ausstehende** Statusmeldungen angehalten und ein Wait-Hinweis gesendet, sodass der Dienst Controller weiß, wie lange gewartet werden muss, bevor eine Berichterstattung an das System erfolgt, in dem der Dienst heruntergefahren wird.</span><span class="sxs-lookup"><span data-stu-id="9e352-132">If the service requires more time to cleanup, it sends **STOP\_PENDING** status messages, along with a wait hint, so the service controller knows how long to wait before reporting to the system that service shutdown is complete.</span></span> <span data-ttu-id="9e352-133">Um zu verhindern, dass ein Dienst heruntergefahren wird, gibt es jedoch eine Beschränkung, wie lange der Dienst Controller wartet.</span><span class="sxs-lookup"><span data-stu-id="9e352-133">However, to prevent a service from stopping shutdown, there is a limit to how long the service controller waits.</span></span> <span data-ttu-id="9e352-134">Wenn der Dienst über das Dienste-Snap-in heruntergefahren wird, beträgt der Grenzwert 125 Sekunden oder 125.000 Millisekunden.</span><span class="sxs-lookup"><span data-stu-id="9e352-134">If the service is being shut down through the Services snap-in, the limit is 125 seconds, or 125,000 milliseconds.</span></span> <span data-ttu-id="9e352-135">Wenn das Betriebssystem neu gestartet wird, wird das Zeitlimit im Wert von **WaitToKillServiceTimeout** (in Millisekunden) des folgenden Registrierungsschlüssels angegeben:</span><span class="sxs-lookup"><span data-stu-id="9e352-135">If the operating system is rebooting, the time limit is specified in the **WaitToKillServiceTimeout** value (in milliseconds) of the following registry key:</span></span>

<span data-ttu-id="9e352-136">**HKEY \_ local \_ Machine \\ System \\ CurrentControlSet- \\ Steuerelement**</span><span class="sxs-lookup"><span data-stu-id="9e352-136">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control**</span></span>

> [!IMPORTANT]
> <span data-ttu-id="9e352-137">Ein Dienst sollte nicht versuchen, das Zeitlimit durch Ändern dieses Werts zu erhöhen.</span><span class="sxs-lookup"><span data-stu-id="9e352-137">A service should not attempt to increase the time limit by modifying this value.</span></span> <span data-ttu-id="9e352-138">Wenn Sie **waitykillservicetimeout** per Hand festlegen müssen, sollte der Wert in Millisekunden angegeben werden.</span><span class="sxs-lookup"><span data-stu-id="9e352-138">If you do need to set **WaitToKillServiceTimeout** by hand, the value should be in milliseconds.</span></span>

<span data-ttu-id="9e352-139">Kunden müssen das Betriebssystem schnell Herunterfahren.</span><span class="sxs-lookup"><span data-stu-id="9e352-139">Customers require fast shutdown of the operating system.</span></span> <span data-ttu-id="9e352-140">Wenn z. b. ein Computer, auf dem das PowerShell-Betriebsnetz ausgeführt wird, das Herunterfahren nicht beenden kann, bevor die Leistung von UPS nicht mehr besteht,</span><span class="sxs-lookup"><span data-stu-id="9e352-140">For example, if a computer running on UPS power cannot complete shutdown before the UPS runs out of power, data can be lost.</span></span> <span data-ttu-id="9e352-141">Daher sollten die-Dienste ihre Bereinigungs Aufgaben so schnell wie möglich ausführen.</span><span class="sxs-lookup"><span data-stu-id="9e352-141">Therefore, services should complete their cleanup tasks as quickly as possible.</span></span> <span data-ttu-id="9e352-142">Es wird empfohlen, nicht gespeicherte Daten zu minimieren, indem Sie Daten in regelmäßigen Abständen speichern, die auf dem Datenträger gespeicherten Daten nachverfolgen und nur die nicht gespeicherten Daten beim Herunterfahren speichern.</span><span class="sxs-lookup"><span data-stu-id="9e352-142">It is a good practice to minimize unsaved data by saving data on a regular basis, keeping track of the data that is saved to disk, and only saving your unsaved data on shutdown.</span></span> <span data-ttu-id="9e352-143">Da der Computer heruntergefahren wird, verbringen Sie nicht Zeit, zugeordneten Arbeitsspeicher oder andere Systemressourcen freizugeben.</span><span class="sxs-lookup"><span data-stu-id="9e352-143">Because the computer is being shut down, do not spend time releasing allocated memory or other system resources.</span></span> <span data-ttu-id="9e352-144">Wenn Sie einen Server Benachrichtigen müssen, den Sie beenden möchten, minimieren Sie die Zeit, die auf eine Antwort gewartet hat, da Netzwerkprobleme das Herunterfahren des Dienes verzögern könnten.</span><span class="sxs-lookup"><span data-stu-id="9e352-144">If you need to notify a server that you are exiting, minimize the time spent waiting for a reply, because network problems could delay the shutdown of your service.</span></span>

<span data-ttu-id="9e352-145">Beachten Sie, dass der SCM beim Herunterfahren von Diensten standardmäßig keine Abhängigkeiten berücksichtigt.</span><span class="sxs-lookup"><span data-stu-id="9e352-145">Note that during service shutdown, by default, the SCM does not take dependencies into consideration.</span></span> <span data-ttu-id="9e352-146">Der SCM listet die ausgelaufenden Dienste auf und sendet den Befehl zum **\_ \_ Herunterfahren der Dienst Kontrolle** .</span><span class="sxs-lookup"><span data-stu-id="9e352-146">The SCM enumerates the list of running services and sends the **SERVICE\_CONTROL\_SHUTDOWN** command.</span></span> <span data-ttu-id="9e352-147">Daher kann ein Dienst fehlschlagen, weil ein anderer Dienst, von dem er abhängt, bereits beendet wurde.</span><span class="sxs-lookup"><span data-stu-id="9e352-147">Therefore, a service may fail because another service it depends on has already stopped.</span></span>

<span data-ttu-id="9e352-148">Um die Konfiguration der Dienste manuell festzulegen, erstellen Sie einen Registrierungs Wert mit mehreren Zeichen folgen, der die Dienstnamen in der Reihenfolge enthält, in der Sie heruntergefahren werden sollen, und weisen Sie ihn wie folgt dem **preshutdownorder** -Wert des Steuer Elements zu.</span><span class="sxs-lookup"><span data-stu-id="9e352-148">To set the shutdown order of services manually, create a multistring registry value that contains the service names in the order in which they should be shut down and assign it to the Control key's **PreshutdownOrder** value, as follows:</span></span>

<span data-ttu-id="9e352-149">**HKEY \_ local \_ Machine \\ System \\ CurrentControlSet \\ Control \\ preshutdownorder = "Shutdown Order"**</span><span class="sxs-lookup"><span data-stu-id="9e352-149">**HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\PreshutdownOrder="Shutdown Order"**</span></span>

<span data-ttu-id="9e352-150">Verwenden Sie die Funktion [**setprocessshutdownparameters**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setprocessshutdownparameters) , um die Shutdown-Reihenfolge abhängiger Dienste von der Anwendung festzulegen.</span><span class="sxs-lookup"><span data-stu-id="9e352-150">To set the shutdown order of dependent services from your application, use the [**SetProcessShutdownParameters**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-setprocessshutdownparameters) function.</span></span> <span data-ttu-id="9e352-151">Der SCM verwendet diese Funktion, um dem Handler die Priorität 0x1e0 zu übergeben.</span><span class="sxs-lookup"><span data-stu-id="9e352-151">The SCM uses this function to give its handler 0x1E0 priority.</span></span> <span data-ttu-id="9e352-152">Der SCM sendet **Dienst \_ Steuerungs \_** Benachrichtigungen für das Herunterfahren, wenn der zugehörige Steuerelement Handler aufgerufen wird, und wartet, bis die Dienste beendet werden, bevor er vom Steuerelement Handler</span><span class="sxs-lookup"><span data-stu-id="9e352-152">The SCM sends **SERVICE\_CONTROL\_SHUTDOWN** notifications when its control handler is called and waits for the services to exit before returning from its control handler.</span></span>

## <a name="related-topics"></a><span data-ttu-id="9e352-153">Zugehörige Themen</span><span class="sxs-lookup"><span data-stu-id="9e352-153">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="9e352-154">Schreiben einer Steuerelement Handler-Funktion</span><span class="sxs-lookup"><span data-stu-id="9e352-154">Writing a Control Handler Function</span></span>](writing-a-control-handler-function.md)
</dt> </dl>

 

 
