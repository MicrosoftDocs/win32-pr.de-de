---
description: Wenn ein Dienst Steuerungsprogramm anfordert, dass ein neuer Dienst ausgeführt wird, startet der Dienststeuerungs-Manager (SCM) den Dienst und sendet eine Start Anforderung an den Steuerelement Verteiler.
ms.assetid: e55e056f-7628-4e3d-9aea-b55c371b4287
title: ServiceMain-Dienstfunktion
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: ed50f0f378f348415e56827a09fcf17eea7fc330
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/08/2021
ms.locfileid: "103960631"
---
# <a name="service-servicemain-function"></a><span data-ttu-id="63d3b-103">ServiceMain-Dienstfunktion</span><span class="sxs-lookup"><span data-stu-id="63d3b-103">Service ServiceMain Function</span></span>

<span data-ttu-id="63d3b-104">Wenn ein Dienst Steuerungsprogramm anfordert, dass ein neuer Dienst ausgeführt wird, startet der Dienststeuerungs-Manager (SCM) den Dienst und sendet eine Start Anforderung an den Steuerelement Verteiler.</span><span class="sxs-lookup"><span data-stu-id="63d3b-104">When a service control program requests that a new service run, the Service Control Manager (SCM) starts the service and sends a start request to the control dispatcher.</span></span> <span data-ttu-id="63d3b-105">Der Steuerelement Verteiler erstellt einen neuen Thread, um die [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) -Funktion für den Dienst auszuführen.</span><span class="sxs-lookup"><span data-stu-id="63d3b-105">The control dispatcher creates a new thread to execute the [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function for the service.</span></span> <span data-ttu-id="63d3b-106">Ein Beispiel finden Sie unter [Schreiben einer ServiceMain-Funktion](writing-a-servicemain-function.md).</span><span class="sxs-lookup"><span data-stu-id="63d3b-106">For an example, see [Writing a ServiceMain Function](writing-a-servicemain-function.md).</span></span>

<span data-ttu-id="63d3b-107">Die [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) -Funktion sollte die folgenden Aufgaben ausführen:</span><span class="sxs-lookup"><span data-stu-id="63d3b-107">The [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona) function should perform the following tasks:</span></span>

1.  <span data-ttu-id="63d3b-108">Initialisieren Sie alle globalen Variablen.</span><span class="sxs-lookup"><span data-stu-id="63d3b-108">Initialize all global variables.</span></span>
2.  <span data-ttu-id="63d3b-109">Wenn Sie die [**registerservicectrlhandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) -Funktion sofort aufrufen, um eine [**Handlerfunktion**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) zum Verarbeiten von Steuerungsanforderungen für den Dienst zu registrieren.</span><span class="sxs-lookup"><span data-stu-id="63d3b-109">Call the [**RegisterServiceCtrlHandler**](/windows/desktop/api/Winsvc/nf-winsvc-registerservicectrlhandlera) function immediately to register a [**Handler**](/windows/desktop/api/Winsvc/nc-winsvc-lphandler_function) function to handle control requests for the service.</span></span> <span data-ttu-id="63d3b-110">Der Rückgabewert von **registerservicectrlhandler** ist ein *Dienststatus handle* , das in Aufrufen verwendet wird, um den SCM über den Dienststatus zu benachrichtigen.</span><span class="sxs-lookup"><span data-stu-id="63d3b-110">The return value of **RegisterServiceCtrlHandler** is a *service status handle* that will be used in calls to notify the SCM of the service status.</span></span>
3.  <span data-ttu-id="63d3b-111">Initialisierung ausführen.</span><span class="sxs-lookup"><span data-stu-id="63d3b-111">Perform initialization.</span></span> <span data-ttu-id="63d3b-112">Wenn die Ausführungszeit des Initialisierungs Codes sehr kurz sein soll (weniger als eine Sekunde), kann die Initialisierung direkt in [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona)ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="63d3b-112">If the execution time of the initialization code is expected to be very short (less than one second), initialization can be performed directly in [**ServiceMain**](/windows/win32/api/winsvc/nc-winsvc-lpservice_main_functiona).</span></span>

    <span data-ttu-id="63d3b-113">Wenn die Initialisierungs Zeit voraussichtlich länger als eine Sekunde ist, sollte der Dienst eine der folgenden Initialisierungs Verfahren verwenden:</span><span class="sxs-lookup"><span data-stu-id="63d3b-113">If the initialization time is expected to be longer than one second, the service should use one of the following initialization techniques:</span></span>

    -   <span data-ttu-id="63d3b-114">Aufrufen der [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) -Funktion für den Berichts Dienst, der \_ ausgeführt wird, aber keine Steuerelemente akzeptieren, bis die Initialisierung abgeschlossen ist</span><span class="sxs-lookup"><span data-stu-id="63d3b-114">Call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function to report SERVICE\_RUNNING but accept no controls until initialization is finished.</span></span> <span data-ttu-id="63d3b-115">Der Dienst führt dies durch Aufrufen von **SetServiceStatus** , wobei **dwcurrentstate** auf Dienst wird \_ ausgeführt und **dwcontrolsaccepted** in der [**Dienst \_ Status**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) Struktur auf 0 festgelegt ist.</span><span class="sxs-lookup"><span data-stu-id="63d3b-115">The service does this by calling **SetServiceStatus** with **dwCurrentState** set to SERVICE\_RUNNING and **dwControlsAccepted** set to 0 in the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span> <span data-ttu-id="63d3b-116">Dadurch wird sichergestellt, dass der SCM keine Steuerungsanforderungen an den Dienst sendet, bevor er bereit ist, und den SCM zum Verwalten anderer Dienste freigibt.</span><span class="sxs-lookup"><span data-stu-id="63d3b-116">This ensures that the SCM will not send any control requests to the service before it is ready and frees the SCM to manage other services.</span></span> <span data-ttu-id="63d3b-117">Dieser Ansatz für die Initialisierung wird für die Leistung empfohlen, insbesondere für Autostart-Dienste.</span><span class="sxs-lookup"><span data-stu-id="63d3b-117">This approach to initialization is recommended for performance, especially for autostart services.</span></span>
    -   <span data-ttu-id="63d3b-118">Der Berichts \_ Dienst \_ steht aus, es werden keine Steuerelemente akzeptiert, und Sie können einen Wait-Hinweis angeben.</span><span class="sxs-lookup"><span data-stu-id="63d3b-118">Report SERVICE\_START\_PENDING, accept no controls, and specify a wait hint.</span></span> <span data-ttu-id="63d3b-119">Wenn der Initialisierungs Code des Diensts Tasks ausführt, die voraussichtlich länger als der anfängliche Wait-Hinweis Wert dauern, muss der Code die Funktion [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) regelmäßig aufrufen (möglicherweise mit einem überarbeiteten warte Hinweis), um anzugeben, dass der Fortschritt ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="63d3b-119">If your service's initialization code performs tasks that are expected to take longer than the initial wait hint value, your code must call the [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) function periodically (possibly with a revised wait hint) to indicate that progress is being made.</span></span> <span data-ttu-id="63d3b-120">Stellen Sie sicher, dass **SetServiceStatus** nur aufgerufen wird, wenn die Initialisierung fortgesetzt wird.</span><span class="sxs-lookup"><span data-stu-id="63d3b-120">Be sure to call **SetServiceStatus** only if the initialization is making progress.</span></span> <span data-ttu-id="63d3b-121">Andernfalls kann der SCM warten, bis der Dienst \_ ausgeführt wird, wenn der Dienst ausgeführt wird, vorausgesetzt, der Dienst wird fortgesetzt, und der Start anderer Dienste wird blockiert.</span><span class="sxs-lookup"><span data-stu-id="63d3b-121">Otherwise the SCM can wait for your service to enter the SERVICE\_RUNNING state assuming that your service is making progress and block other services from starting.</span></span> <span data-ttu-id="63d3b-122">Wenn Sie nicht sicher sind, dass der Thread, der die Initialisierung ausführt, tatsächlich Fortschritte macht, sollten Sie **SetServiceStatus** nicht in einem separaten Thread aufrufen.</span><span class="sxs-lookup"><span data-stu-id="63d3b-122">Do not call **SetServiceStatus** from a separate thread unless you are sure the thread performing the initialization is truly making progress.</span></span>

        <span data-ttu-id="63d3b-123">Ein Dienst, der diesen Ansatz verwendet, kann auch einen Prüf Punkt Wert angeben und den Wert in regelmäßigen Abständen während einer langwierigen Initialisierung erhöhen.</span><span class="sxs-lookup"><span data-stu-id="63d3b-123">A service that uses this approach can also specify a check-point value and increment the value periodically during a lengthy initialization.</span></span> <span data-ttu-id="63d3b-124">Das Programm, mit dem der Dienst gestartet wurde, kann [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) oder [**queryservicestatusex**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatusex) aufrufen, um den letzten Prüf Punkt Wert aus dem SCM abzurufen und den Wert zu verwenden, um dem Benutzer den inkrementellen Fortschritt zu melden.</span><span class="sxs-lookup"><span data-stu-id="63d3b-124">The program that started the service can call [**QueryServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatus) or [**QueryServiceStatusEx**](/windows/desktop/api/Winsvc/nf-winsvc-queryservicestatusex) to obtain the latest check-point value from the SCM and use the value to report incremental progress to the user.</span></span>

4.  <span data-ttu-id="63d3b-125">Wenn die Initialisierung abgeschlossen ist, müssen Sie [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) aufrufen, um den Dienststatus auf Dienst Ausführung festzulegen, \_ und die Steuerelemente angeben, die der Dienst akzeptieren soll.</span><span class="sxs-lookup"><span data-stu-id="63d3b-125">When initialization is complete, call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to set the service state to SERVICE\_RUNNING and specify the controls that the service is prepared to accept.</span></span> <span data-ttu-id="63d3b-126">Eine Liste der Steuerelemente finden Sie in der [**Dienst \_ Status**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) Struktur.</span><span class="sxs-lookup"><span data-stu-id="63d3b-126">For a list of controls, see the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure.</span></span>
5.  <span data-ttu-id="63d3b-127">Führen Sie die Dienst Tasks aus, oder geben Sie, falls keine ausstehenden Aufgaben vorhanden sind, die Steuerung an den Aufrufer zurück.</span><span class="sxs-lookup"><span data-stu-id="63d3b-127">Perform the service tasks, or, if there are no pending tasks, return control to the caller.</span></span> <span data-ttu-id="63d3b-128">Jede Änderung des Dienst Zustands erfordert einen Aufrufen von [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) , um neue Statusinformationen zu melden.</span><span class="sxs-lookup"><span data-stu-id="63d3b-128">Any change in the service state warrants a call to [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to report new status information.</span></span>
6.  <span data-ttu-id="63d3b-129">Wenn ein Fehler auftritt, während der Dienst initialisiert wird oder ausgeführt wird, sollte der Dienst [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) aufrufen, um den Dienststatus auf \_ Beenden ausstehend festzulegen, wenn die \_ Bereinigung langwierig ist.</span><span class="sxs-lookup"><span data-stu-id="63d3b-129">If an error occurs while the service is initializing or running, the service should call [**SetServiceStatus**](/windows/desktop/api/Winsvc/nf-winsvc-setservicestatus) to set the service state to SERVICE\_STOP\_PENDING if cleanup will be lengthy.</span></span> <span data-ttu-id="63d3b-130">Nachdem die Bereinigung abgeschlossen ist, können Sie **SetServiceStatus** aufrufen, um den Dienststatus auf den Dienst festzulegen, der \_ vom letzten zu beendenden Thread beendet wurde.</span><span class="sxs-lookup"><span data-stu-id="63d3b-130">After cleanup is complete, call **SetServiceStatus** to set the service state to SERVICE\_STOPPED from the last thread to terminate.</span></span> <span data-ttu-id="63d3b-131">Stellen Sie sicher, dass Sie die Member " **dwservicespecificexitcode** " und " **dwWin32ExitCode** " der [**Dienst \_ Status**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) Struktur festlegen, um den Fehler zu identifizieren.</span><span class="sxs-lookup"><span data-stu-id="63d3b-131">Be sure to set the **dwServiceSpecificExitCode** and **dwWin32ExitCode** members of the [**SERVICE\_STATUS**](/windows/desktop/api/Winsvc/ns-winsvc-service_status) structure to identify the error.</span></span>

## <a name="related-topics"></a><span data-ttu-id="63d3b-132">Zugehörige Themen</span><span class="sxs-lookup"><span data-stu-id="63d3b-132">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="63d3b-133">Schreiben einer ServiceMain-Funktion</span><span class="sxs-lookup"><span data-stu-id="63d3b-133">Writing a ServiceMain Function</span></span>](writing-a-servicemain-function.md)
</dt> </dl>

 

 
