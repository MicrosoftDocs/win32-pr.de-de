---
description: Erfahren Sie mehr über den Schutz von Antischadsoftware-Benutzermodus-Diensten und darüber, wie Sie dieses Feature in ihren Antimalwaredienst einschließen können.
ms.assetid: 88875a0d-9027-43f2-8411-34f9ff428fe5
title: Schutz vor schadsoftwarediensten
ms.topic: article
ms.date: 08/02/2018
ms.openlocfilehash: 5e7783eb307381d368900332b5e761ad62785913
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/08/2021
ms.locfileid: "104050471"
---
# <a name="protecting-anti-malware-services"></a><span data-ttu-id="ea8c2-103">Schutz vor schadsoftwarediensten</span><span class="sxs-lookup"><span data-stu-id="ea8c2-103">Protecting Anti-Malware Services</span></span>

<span data-ttu-id="ea8c2-104">Windows 8.1 wurde ein neues Konzept geschützter Dienste eingeführt, um antischadsoftwaredienste zu schützen, die häufig durch Schadsoftware angegriffen werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-104">Windows 8.1 introduced a new concept of protected services to protect anti-malware services, which are a frequent target of attack by malware.</span></span>

<span data-ttu-id="ea8c2-105">Erfahren Sie mehr über den Schutz von Antischadsoftware-Benutzermodus-Diensten und darüber, wie Sie dieses Feature in ihren Antimalwaredienst einschließen können.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-105">Learn about protecting anti-malware (AM) user mode services and how you can opt to include this feature in your anti-malware service.</span></span>

<span data-ttu-id="ea8c2-106">Diese Informationen gelten für die folgenden Betriebssysteme und deren Nachfolger:</span><span class="sxs-lookup"><span data-stu-id="ea8c2-106">This information applies to the following operating systems and their successors:</span></span>

-   <span data-ttu-id="ea8c2-107">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="ea8c2-107">Windows 8.1</span></span>
-   <span data-ttu-id="ea8c2-108">Windows Server 2012 R2</span><span class="sxs-lookup"><span data-stu-id="ea8c2-108">Windows Server 2012 R2</span></span>

<span data-ttu-id="ea8c2-109">Die hier erläuterten Verweise und Ressourcen werden am Ende dieses Themas aufgelistet.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-109">References and resources discussed here are listed at the end of this topic.</span></span>

## <a name="introduction"></a><span data-ttu-id="ea8c2-110">Einführung</span><span class="sxs-lookup"><span data-stu-id="ea8c2-110">Introduction</span></span>

<span data-ttu-id="ea8c2-111">Die meisten antischadsoftwarelösungen beinhalten einen Benutzermodusdienst, der spezielle Vorgänge zum erkennen und Entfernen von Schadsoftware aus dem System ausführt.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-111">Most anti-malware solutions include a user-mode service that performs specialized operations to detect and remove malware from the system.</span></span> <span data-ttu-id="ea8c2-112">Dieser Benutzermodusdienst ist auch häufig für das Herunterladen der neuesten Virendefinitionen und Signaturen verantwortlich.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-112">This user-mode service is also frequently responsible for downloading the latest virus definitions and signatures.</span></span> <span data-ttu-id="ea8c2-113">Dieser Benutzermodusdienst wird zu einem häufigen Ziel von Schadsoftware, da es sich um die Single Point of Failure, den Schutz auf einem System zu deaktivieren.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-113">This user-mode service becomes a frequent target of malware because it’s the single point of failure to disable protection on a system.</span></span> <span data-ttu-id="ea8c2-114">Um Angriffe auf den Benutzermodusdienst zu verteidigen, müssen antischadsoftwarehersteller Ihrer Software viele Funktionen und Heuristik hinzufügen.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-114">To defend against attacks on the user-mode service, anti-malware vendors have to add a lot of functionality and heuristics to their software.</span></span> <span data-ttu-id="ea8c2-115">Diese Techniken sind jedoch nicht vollständig schwerwiegend und sind tendenziell fehleranfällig, da Sie Funktionen identifizieren müssen, die Windows in Ihrem Dienst ausführt, und diese Funktionen selektiv aktivieren.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-115">However, such techniques are not completely foolproof and tend to be error prone because they have to identify functionality that Windows performs on their service and selectively enable that functionality.</span></span>

<span data-ttu-id="ea8c2-116">In Windows 8.1 wurde ein neues Konzept des geschützten Diensts eingeführt, mit dem Antischadsoftware-benutzermodusdienste als geschützter Dienst gestartet werden können.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-116">In Windows 8.1, a new concept of protected service has been introduced to allow anti-malware user-mode services to be launched as a protected service.</span></span> <span data-ttu-id="ea8c2-117">Nachdem der Dienst als geschützt gestartet wurde, verwendet Windows die Code Integrität, um nur vertrauenswürdigen Code zum Laden in den geschützten Dienst zuzulassen.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-117">After the service is launched as protected, Windows uses code integrity to only allow trusted code to load into the protected service.</span></span> <span data-ttu-id="ea8c2-118">Windows schützt diese Prozesse auch vor Code Einschleusung und anderen Angriffen von Administrator Prozessen.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-118">Windows also protects these processes from code injection and other attacks from admin processes.</span></span>

<span data-ttu-id="ea8c2-119">In diesem Dokument wird beschrieben, wie ein antischadsoftwarehersteller mit einem Early Launch Anti-Malware-Treiber (Elam) dieses Feature abonnieren und den antischadsoftwaredienst als geschützten Dienst starten kann.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-119">This document describes how an anti-malware vendor with an Early Launch Anti-Malware (ELAM) driver can opt-in to this feature and launch their anti-malware service as a protected service.</span></span>

## <a name="system-protected-process"></a><span data-ttu-id="ea8c2-120">System geschützter Prozess</span><span class="sxs-lookup"><span data-stu-id="ea8c2-120">System protected process</span></span>

<span data-ttu-id="ea8c2-121">Ab Windows 8.1 wurde ein neues Sicherheitsmodell in den Kernel eingefügt, um gegen schädliche Angriffe auf systemkritische Komponenten besser zu schützen.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-121">Starting with Windows 8.1, a new security model has been put in place in the kernel to better defend against malicious attacks on system-critical components.</span></span> <span data-ttu-id="ea8c2-122">Dieses neue Sicherheitsmodell erweitert die geschützte Prozess Infrastruktur früherer Windows-Versionen, die für bestimmte Szenarien verwendet werden, z. b. die Wiedergabe von DRM-Inhalten, in ein allgemeines Modell, das von Drittanbietern für Antischadsoftware verwendet werden kann.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-122">This new security model extends the protected process infrastructure previous versions of Windows used for specific scenarios, such as playing DRM content, into a general-purpose model that can be used by 3rd party anti-malware vendors.</span></span> <span data-ttu-id="ea8c2-123">Die geschützte Prozess Infrastruktur ermöglicht nur das Laden von vertrauenswürdigem und signiertem Code und verfügt über eine integrierte Abwehr gegen Code einschleusungs Angriffe.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-123">The protected process infrastructure only allows trusted, signed code to load and has built-in defense against code injection attacks.</span></span>

<span data-ttu-id="ea8c2-124">Weitere Informationen zu geschützten Prozessen finden Sie [unter geschützte Prozesse in Windows Vista](https://download.microsoft.com/download/a/f/7/af7777e5-7dcd-4800-8a0a-b18336565f5b/process_vista.doc) .</span><span class="sxs-lookup"><span data-stu-id="ea8c2-124">See [Protected Processes in Windows Vista](https://download.microsoft.com/download/a/f/7/af7777e5-7dcd-4800-8a0a-b18336565f5b/process_vista.doc) for more information on protected processes.</span></span>

<span data-ttu-id="ea8c2-125">Das neue Sicherheitsmodell verwendet eine etwas andere Variante der Schutz Prozess Infrastruktur, die als System geschützter Prozess bezeichnet wird. Dies ist für dieses Feature besser geeignet, da der DRM-Inhalt dadurch getrennt bleibt.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-125">The new security model uses a slightly different variant of the protection process infrastructure called system protected process, which is more suitable for this feature as this keeps the DRM content separate.</span></span> <span data-ttu-id="ea8c2-126">Jeder System geschützte Prozess verfügt über eine zugeordnete Ebene oder ein zugeordnetes Attribut, das die Signatur Richtlinie des signierten Codes angibt, der innerhalb des Prozesses geladen werden darf.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-126">Each system protected process has an associated level or attribute, which indicates the signature policy of the signed code allowed to load within the process.</span></span> <span data-ttu-id="ea8c2-127">Nachdem die antimalwaredienste den geschützten Dienst Modus gewählt haben, dürfen in diesem Prozess nur Windows-signierter Code oder Code, der mit den Zertifikaten des antischadsoftwareherstellers signiert ist, geladen werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-127">After the anti-malware services have opted into the protected service mode, only Windows signed code or code signed with the anti-malware vendor’s certificates are allowed to load in that process.</span></span> <span data-ttu-id="ea8c2-128">Ebenso haben andere geschützte Prozessebenen verschiedene Code Richtlinien, die von Windows erzwungen werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-128">Similarly, other protected process levels have different code policies enforced by Windows.</span></span>

## <a name="requirements"></a><span data-ttu-id="ea8c2-129">Anforderungen</span><span class="sxs-lookup"><span data-stu-id="ea8c2-129">Requirements</span></span>

<span data-ttu-id="ea8c2-130">Damit ein Antischadsoftware-Benutzermodusdienst als geschützter Dienst ausgeführt werden kann, muss auf dem Windows-Computer auf dem antischadsoftwarehersteller ein Elam-Treiber installiert sein.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-130">For an anti-malware user-mode service to run as a protected service, the anti-malware vendor must have an ELAM driver installed on the Windows machine.</span></span> <span data-ttu-id="ea8c2-131">Zusätzlich zu den vorhandenen Zertifizierungsanforderungen des Elam-Treibers muss der Treiber über einen eingebetteten Ressourcenabschnitt verfügen, der die Informationen der Zertifikate enthält, die zum Signieren der Dienst Binärdateien im Benutzermodus verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-131">In addition to the existing ELAM driver certification requirements, the driver must have an embedded resource section containing the information of the certificates used to sign the user mode service binaries.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="ea8c2-132">In Windows 8.1 muss die Zertifizierungs Kette entweder ein bekannter Stamm sein, der von der Treiber Überprüfung bestimmt wird, oder das Stamm Zertifikat muss eingeschlossen werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-132">In Windows 8.1, the certification chain either has to be a known root as determined by driver verification, or the root certificate must be included.</span></span>

 

<span data-ttu-id="ea8c2-133">Während des Startvorgangs wird dieser Ressourcenabschnitt aus dem Elam-Treiber extrahiert, um die Zertifikat Informationen zu überprüfen und den antischadsoftwaredienst zu registrieren.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-133">During the boot process, this resource section will be extracted from the ELAM driver to validate the certificate information and register the anti-malware service.</span></span> <span data-ttu-id="ea8c2-134">Der antischadsoftwaredienst kann auch während der Antimalware-Installation registriert werden, indem eine spezielle API aufgerufen wird, wie weiter unten in diesem Dokument beschrieben.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-134">The anti-malware service can also be registered during the anti-malware software installation process by calling a special API, as described later in this document.</span></span>

<span data-ttu-id="ea8c2-135">Nachdem der Ressourcenabschnitt erfolgreich vom Elam-Treiber extrahiert und der Benutzermodusdienst registriert wurde, kann der Dienst als geschützter Dienst gestartet werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-135">After the resource section is successfully extracted from the ELAM driver and the user-mode service is registered, the service is allowed to launch as protected service.</span></span> <span data-ttu-id="ea8c2-136">Nachdem der Dienst als geschützt gestartet wurde, sind andere nicht geschützte Prozesse im System nicht in der Lage, Threads einzufügen, und Sie dürfen nicht in den virtuellen Arbeitsspeicher des geschützten Prozesses schreiben.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-136">After the service is launched as protected, other non-protected processes on the system won't be able to inject threads, and they wont' be allowed to write into the virtual memory of the protected process.</span></span>

<span data-ttu-id="ea8c2-137">Außerdem müssen alle nicht-Windows-DLLs, die in den geschützten Prozess geladen werden, mit einem entsprechenden Zertifikat signiert werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-137">In addition, any non-Windows DLLs that get loaded into the protected process must be signed with an appropriate certificate.</span></span>

<span data-ttu-id="ea8c2-138">Weitere Informationen zu Elam-Treibern finden Sie unter [Antischadsoftware-Frühstart](/windows/desktop/w8cookbook/secured-boot) .</span><span class="sxs-lookup"><span data-stu-id="ea8c2-138">See [Early launch antimalware](/windows/desktop/w8cookbook/secured-boot) for more information on ELAM drivers.</span></span>

### <a name="anti-malware-service-signing-requirements"></a><span data-ttu-id="ea8c2-139">Signatur Anforderungen des antischadsoftwarediensts</span><span class="sxs-lookup"><span data-stu-id="ea8c2-139">Anti-malware service signing requirements</span></span>

<span data-ttu-id="ea8c2-140">Der Benutzermodusdienst, der als geschützt gestartet werden muss, muss mit gültigen Zertifikaten signiert sein.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-140">The user-mode service that needs to be launched as protected must be signed with valid certificates.</span></span> <span data-ttu-id="ea8c2-141">Die Dienst-exe muss mit einem Seiten Hash signiert werden, und alle nicht-Windows-DLLs, die in den Dienst geladen werden, müssen ebenfalls mit denselben Zertifikaten signiert werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-141">The service EXE must be page hash signed, and any non-Windows DLLs that get loaded into the service must be also signed with the same certificates.</span></span> <span data-ttu-id="ea8c2-142">Der Hash dieser Zertifikate muss der Ressourcen Datei hinzugefügt werden, die mit dem Elam-Treiber verknüpft wird.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-142">The hash of these certificates must be added into the resource file, which will be linked into the ELAM driver.</span></span>

> [!Note]  
> <span data-ttu-id="ea8c2-143">SHA256-Datei-/Seitenhashes müssen verwendet werden, auch wenn Zertifikate weiterhin SHA1 aufweisen können.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-143">SHA256 file/page hashes must be used, though certificates may continue to be SHA1.</span></span>

 

### <a name="primary-signature-recommended"></a><span data-ttu-id="ea8c2-144">Primäre Signatur (empfohlen)</span><span class="sxs-lookup"><span data-stu-id="ea8c2-144">Primary signature (recommended)</span></span>

<span data-ttu-id="ea8c2-145">Es wird empfohlen, dass antischadsoftwarehersteller Ihr vorhandenes Authenticode-Zertifikat verwenden, um Ihre Antischadsoftware-Dienst Binärdateien zu signieren, und dass der Hashwert dieses Authenticode-Zertifikats im Ressourcenabschnitt enthalten ist, um das Zertifikat anzugeben, das zum Signieren der Dienst Binärdateien verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-145">We recommend that anti-malware vendors use their existing Authenticode certificate to sign their anti-malware service binaries, and that the hash of this Authenticode certificate be included in the resource section to indicate the certificate that's used to sign the service binaries.</span></span> <span data-ttu-id="ea8c2-146">Wenn Sie dieses Zertifikat aktualisieren, muss eine neuere Version des Elam-Treibers mit den aktualisierten zertifikathashes veröffentlicht werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-146">If you update this certificate, a newer version of the ELAM driver must be released with the updated certificate hashes.</span></span>

### <a name="secondary-signature-optional"></a><span data-ttu-id="ea8c2-147">Sekundäre Signatur (optional)</span><span class="sxs-lookup"><span data-stu-id="ea8c2-147">Secondary signature (optional)</span></span>

<span data-ttu-id="ea8c2-148">Antischadsoftwareanbieter haben die Möglichkeit, eine private Zertifizierungsstelle einzurichten und Zertifikate dieser Zertifizierungsstelle zu verwenden, um die Binärdateien des antischadsoftwarediensts als sekundäre Signatur zu signieren.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-148">Anti-malware vendors have the option to set up a private CA and use certificates from this CA to code sign the anti-malware service binaries as a secondary signature.</span></span> <span data-ttu-id="ea8c2-149">Der Hauptvorteil bei der Verwendung der privaten Zertifizierungsstelle besteht darin, dass es Anbietern ermöglicht, Zertifikate mit einer spezialisierten EKU-Eigenschaft zu erstellen, die zur Unterscheidung zwischen mehreren Produkten desselben Herstellers verwendet werden kann.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-149">The main advantage of using the private CA is that it enables vendors to create certificates with a specialized EKU property, which can be used to differentiate between multiple products from the same vendor.</span></span> <span data-ttu-id="ea8c2-150">Außerdem entfällt die Notwendigkeit, den Elam-Treiber aufgrund eines Zertifikats Ablaufs zu aktualisieren, da die Zertifikate der privaten Zertifizierungsstelle in der Regel über längere Ablaufzeiten verfügen.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-150">It also reduces the need to update your ELAM driver due to certificate expiry, as the private CA certs typically have longer expiry dates.</span></span>

<span data-ttu-id="ea8c2-151">Beachten Sie Folgendes: Wenn die Dienst Binärdateien mit den privaten Zertifizierungsstellen Zertifikaten signiert sind, müssen die Binärdateien auch Dual mit den vorhandenen Authenticode-Zertifikaten signiert sein.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-151">Note that if the service binaries are signed with the private CA certs, the binaries must also be dual signed with the existing Authenticode certificates.</span></span> <span data-ttu-id="ea8c2-152">Wenn die Binärdateien nicht von einer bekannten vertrauenswürdigen Zertifizierungsstelle (z. b. VeriSign) signiert werden, ist der Benutzer des Computers in den Binärdateien nicht vertrauenswürdig, da Sie der privaten Zertifizierungsstelle nicht vertrauen können.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-152">If the binaries are not signed by a well-known trusted CA (for example VeriSign), the user of the machine has no confidence in the binaries because they cannot trust the private CA.</span></span> <span data-ttu-id="ea8c2-153">Beim dualen Signieren der Binärdateien mit dem vorhandenen Authenticode-Zertifikat können die Binärdateien auch auf untergeordneten Betriebssystemen ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-153">Dual signing the binaries with the existing Authenticode certificate also allows the binaries to run on down-level operating systems.</span></span>

<span data-ttu-id="ea8c2-154">Weitere Informationen zum Einrichten und Installieren der Zertifizierungsstelle finden Sie unter [Einrichten einer](/previous-versions/windows/desktop/ms755466(v=vs.85)) Zertifizierungsstelle und [Installieren der Zertifizierungs](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))Stelle.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-154">For more info about how to set up and install the Certificate Authority, see [Setting Up a Certificate Authority](/previous-versions/windows/desktop/ms755466(v=vs.85)) and [Install the Certification Authority](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11)).</span></span>

> [!Note]  
> <span data-ttu-id="ea8c2-155">Aus Kompatibilitätsgründen mit Windows Vista oder Windows XP (oder Windows 7 ohne den SHA2-Patch) können Sie den Schalter "/as" verwenden, wenn Sie die Binärdateien mit [SignTool.exe](/windows/desktop/SecCrypto/signtool) mit den SHA256-Datei-/Seitenhashes signieren.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-155">For compatibility with Windows Vista or Windows XP (or Windows 7 without the SHA2 patch), you can use the "/as" switch when signing your binaries with [SignTool.exe](/windows/desktop/SecCrypto/signtool) with the SHA256 file/page hashes.</span></span> <span data-ttu-id="ea8c2-156">Dadurch wird die Signatur der Datei als sekundäre Signatur hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-156">This will add the signature as a secondary signature to the file.</span></span> <span data-ttu-id="ea8c2-157">SHA1 Signieren Sie die Datei zuerst, da Windows XP, Windows Vista und Windows 7 nur die erste Signatur sehen.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-157">SHA1 sign the file first, since Windows XP, Windows Vista, and Windows 7 will only see the first signature.</span></span>

 

### <a name="dll-signing-requirements"></a><span data-ttu-id="ea8c2-158">DLL-Signierungs Anforderungen</span><span class="sxs-lookup"><span data-stu-id="ea8c2-158">DLL signing requirements</span></span>

<span data-ttu-id="ea8c2-159">Wie bereits erwähnt, müssen alle nicht-Windows-DLLs, die in den geschützten Dienst geladen werden, mit demselben Zertifikat signiert werden, das zum Signieren des antischadsoftwarediensts verwendet wurde.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-159">As mentioned earlier, any non-Windows DLLs that get loaded into the protected service must be signed with the same certificate that was used to sign the anti-malware service.</span></span>

### <a name="catalog-signing"></a><span data-ttu-id="ea8c2-160">Katalog Signierung</span><span class="sxs-lookup"><span data-stu-id="ea8c2-160">Catalog Signing</span></span>

<span data-ttu-id="ea8c2-161">Antischadsoftwarehersteller können von anderen Unternehmen entwickelte Pakete einschließen, ohne die binären Signaturen zu aktualisieren.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-161">Anti-malware vendors can include packages developed by other companies without updating the binary signatures.</span></span> <span data-ttu-id="ea8c2-162">Dies kann erreicht werden, indem die Binärdateien in einen Katalog eingeschlossen werden, der mit Ihrem Authenticode-Zertifikat signiert ist, indem die folgenden Schritte ausgeführt werden:</span><span class="sxs-lookup"><span data-stu-id="ea8c2-162">This can be achieved by including the binaries in a catalog which is signed with their Authenticode certificate, accomplished by following these steps:</span></span>

1. <span data-ttu-id="ea8c2-163">Generieren eines Katalogs mit [MakeCat](/windows/desktop/SecCrypto/makecat)</span><span class="sxs-lookup"><span data-stu-id="ea8c2-163">Generate a catalog using [MakeCat](/windows/desktop/SecCrypto/makecat)</span></span>
2. <span data-ttu-id="ea8c2-164">Fügen Sie alle Binärdateien ohne entsprechende Signatur zum Katalog hinzu.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-164">Add all of the binaries without an appropriate signature to the catalog</span></span>
3. <span data-ttu-id="ea8c2-165">Signieren Sie den Katalog wie jede andere Binärdatei mit dem Authenticode-Zertifikat.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-165">Sign the catalog with the Authenticode certificate, as you would any other binary</span></span>
4. <span data-ttu-id="ea8c2-166">Verwenden [Sie die Add Catalog](/windows/desktop/api/Mscat/nf-mscat-cryptcatadminaddcatalog) -Funktion, um den Katalog mit der Anwendung einzubeziehen.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-166">Use the [add catalog](/windows/desktop/api/Mscat/nf-mscat-cryptcatadminaddcatalog) function to include the catalog with the application.</span></span>

<span data-ttu-id="ea8c2-167">Wenn die Code Integrität über die Pakete ohne entsprechende Signatur hinausgeht, sucht Sie nach einem Katalog mit einer genehmigten Signatur.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-167">When code integrity comes across the packages without an appropriate signature, it will search for a catalog with an approved signature.</span></span> <span data-ttu-id="ea8c2-168">Dieser Katalog findet so lange, wie diese Schritte befolgt werden und mit der Anwendung installiert wird.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-168">It will find this catalog as long as these steps are followed and it is installed with the application.</span></span>


## <a name="resource-file-info"></a><span data-ttu-id="ea8c2-169">Ressourcen Dateiinformationen</span><span class="sxs-lookup"><span data-stu-id="ea8c2-169">Resource file info</span></span>

<span data-ttu-id="ea8c2-170">Eine Ressourcen Datei muss erstellt und mit dem Elam-Treiber verknüpft werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-170">A resource file must be created and linked into the ELAM driver.</span></span> <span data-ttu-id="ea8c2-171">Der Hash des Zertifikats muss zusammen mit anderen Zertifikat Informationen in der Ressourcen Datei hinzugefügt werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-171">The hash of the certificate, along with other certificate information, must be added in the resource file.</span></span>

<span data-ttu-id="ea8c2-172">Der Ressourcenabschnitt muss sich im folgenden Layout befinden, damit das System die Ressourcen aus dem Binär Image extrahieren und die eingebetteten Zertifikat Informationen überprüfen können.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-172">The resource section must be in the following layout for the system to successfully extract the resources from the binary image and validate the embedded certificate information.</span></span>

``` syntax
MicrosoftElamCertificateInfo  MSElamCertInfoID
{
      3, // count of entries
      L”CertHash1\0”,
      Algorithm,
      L”EKU1\0”,
      L”CertHash2\0”,
      Algorithm,
      L”\0”, //No EKU for cert hash 2
      L”CertHash3\0”,
      Algorithm,
      L”EKU3a;EKU3b;EKU3c\0”,  //multiple EKU entries supported (max: 3)
}
```

<span data-ttu-id="ea8c2-173">Weitere Informationen zur benutzerdefinierten Ressourcen Datei finden Sie unter [benutzerdefinierte Ressource](/windows/desktop/menurc/user-defined-resource).</span><span class="sxs-lookup"><span data-stu-id="ea8c2-173">For more info about user-defined resource file, see [User-Defined Resource](/windows/desktop/menurc/user-defined-resource).</span></span>

### <a name="certhash"></a><span data-ttu-id="ea8c2-174">CertHash</span><span class="sxs-lookup"><span data-stu-id="ea8c2-174">CertHash</span></span>

<span data-ttu-id="ea8c2-175">Der Hash des Zertifikats, das verwendet wird, um den antischadsoftwaredienst zu signieren.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-175">The hash of the certificate that's used to sign the anti-malware service.</span></span> <span data-ttu-id="ea8c2-176">Das CertMgr.exe Tool, das im Windows SDK enthalten ist, kann zum Abrufen des Hashs verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-176">The CertMgr.exe tool, which ships in the Windows SDK, can be used to obtain the hash.</span></span>

``` syntax
certmgr.exe –v <path to the signed file>
```

<span data-ttu-id="ea8c2-177">Beispiel:</span><span class="sxs-lookup"><span data-stu-id="ea8c2-177">For example:</span></span>

![Zertifikat Hash für geschützten Dienst von Antischadsoftware (CertHash)](images/cert-hash-example.png)

### <a name="algorithm"></a><span data-ttu-id="ea8c2-179">Algorithmus</span><span class="sxs-lookup"><span data-stu-id="ea8c2-179">Algorithm</span></span>

<span data-ttu-id="ea8c2-180">Der Algorithmuswert stellt den Algorithmus des Zertifikats dar.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-180">The algorithm value represents the algorithm of the certificate.</span></span> <span data-ttu-id="ea8c2-181">Diese algorithmuswerte werden unterstützt:</span><span class="sxs-lookup"><span data-stu-id="ea8c2-181">These algorithm values are supported:</span></span>

<dl> <span data-ttu-id="ea8c2-182">0x8004 – SHA1</span><span class="sxs-lookup"><span data-stu-id="ea8c2-182">0x8004 – SHA1</span></span>  
<span data-ttu-id="ea8c2-183">0x800c – SHA256</span><span class="sxs-lookup"><span data-stu-id="ea8c2-183">0x800c – SHA256</span></span>  
<span data-ttu-id="ea8c2-184">0x800d – SHA384</span><span class="sxs-lookup"><span data-stu-id="ea8c2-184">0X800d – SHA384</span></span>  
<span data-ttu-id="ea8c2-185">0x800e – SHA512</span><span class="sxs-lookup"><span data-stu-id="ea8c2-185">0x800e – SHA512</span></span>  
</dl>

<span data-ttu-id="ea8c2-186">Denken Sie daran, den Wert des Algorithmus (wie oben dargestellt) und nicht den tatsächlichen Namen des Algorithmus einzubeziehen.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-186">Remember to include the value of the algorithm (as shown above) and not the actual name of the algorithm.</span></span> <span data-ttu-id="ea8c2-187">Wenn das Zertifikat beispielsweise auf dem SHA256-Algorithmus basiert, schließen Sie 0x800c in den Ressourcenabschnitt ein.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-187">For example, if the cert is based on the SHA256 algorithm, include 0x800c in the resource section.</span></span>

### <a name="eku"></a><span data-ttu-id="ea8c2-188">EKU</span><span class="sxs-lookup"><span data-stu-id="ea8c2-188">EKU</span></span>

<span data-ttu-id="ea8c2-189">Das EKU-Objekt stellt eine einzelne EKU (Extended Key Usage)-Eigenschaft eines Zertifikats dar.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-189">The EKU object represents a single extended key usage (EKU) property of a certificate.</span></span> <span data-ttu-id="ea8c2-190">Dies ist optional, und " \\ 0" sollte angegeben werden, wenn dem Zertifikat keine EKUs zugeordnet sind. In einem Fall, in dem mehrere Produkte und Dienste von einem einzelnen antischadsoftwarehersteller auf demselben System ausgeführt werden, kann der antischadsoftwarehersteller die EKU-Eigenschaft des privaten Zertifizierungsstellen Zertifikats verwenden, um einen Dienst von einem anderen zu unterscheiden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-190">This is optional and “\\0” should be specified if no EKUs are associated with the cert. In a case where there are multiple products and services from a single anti-malware vendor running on the same system, the anti-malware vendor can use the EKU property of the private CA certificate to differentiate one service from another.</span></span> <span data-ttu-id="ea8c2-191">Wenn beispielsweise zwei Dienste auf dem System vom gleichen antischadsoftwarehersteller ausgeführt werden und von derselben Zertifizierungsstelle signiert werden, kann der Dienst, der als geschützt gestartet werden muss, mit einem Zertifikat signiert werden, das von der Zertifizierungsstelle ausgestellt wurde, die eine Sonder-EKU enthält.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-191">For example, if there are two services running on the system from the same anti-malware vendor and signed by the same CA, the service that needs to be launched as protected can be signed with a cert issued by CA that contains a special EKU.</span></span> <span data-ttu-id="ea8c2-192">Diese EKU muss dem Ressourcenabschnitt hinzugefügt werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-192">This EKU must be added to the resource section.</span></span> <span data-ttu-id="ea8c2-193">Die EKU wird dann vom System registriert und mit dem Zertifikat Hash gekoppelt, um den Dienst als geschützt zu validieren und zu starten.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-193">The EKU is then registered by the system and paired with the certificate hash for validating and launching the service as protected.</span></span>

<span data-ttu-id="ea8c2-194">Beachten Sie, dass die Zertifikatskette das Code Signatur-EKU (1.3.6.1.5.5.7.3.3) enthalten muss. diese EKU darf jedoch nicht im Ressourcenabschnitt des Elam-Treibers enthalten sein.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-194">Note that the certificate chain must include the Code Signing EKU (1.3.6.1.5.5.7.3.3), but this EKU must not be included in the resource section of the ELAM driver.</span></span>

> [!Note]  
> <span data-ttu-id="ea8c2-195">Wenn die EKU-Informationen in den Zertifikat Informationen des Elam-Treibers enthalten sind, muss beim Signieren der Binärdateien dieselbe EKU verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-195">If EKU information is included in certificate information for the ELAM driver, then the same EKU must be used when signing your binaries.</span></span>

 

### <a name="count"></a><span data-ttu-id="ea8c2-196">Anzahl</span><span class="sxs-lookup"><span data-stu-id="ea8c2-196">Count</span></span>

<span data-ttu-id="ea8c2-197">Wenn die Binärdatei des Antischadsoftware-Diensts mit dem Authenticode-Zertifikat und dem privaten Zertifizierungsstellen Zertifikat signiert ist, müssen im Ressourcenabschnitt nur die Informationen der privaten Zertifizierungsstellen Zertifikate hinzugefügt werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-197">If the anti-malware service binary is signed with the Authenticode certificate as well as the private CA certificate, only the private CA certificate information must be added in the resource section.</span></span>

## <a name="launching-anti-malware-services-as-protected"></a><span data-ttu-id="ea8c2-198">Antischadsoftwaredienste werden als geschützt gestartet</span><span class="sxs-lookup"><span data-stu-id="ea8c2-198">Launching anti-malware services as protected</span></span>

### <a name="registering-the-service"></a><span data-ttu-id="ea8c2-199">Registrieren des Diensts</span><span class="sxs-lookup"><span data-stu-id="ea8c2-199">Registering the service</span></span>

<span data-ttu-id="ea8c2-200">Der antischadsoftwaredienst muss beim System registriert werden, bevor er als geschützt gestartet werden kann.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-200">The anti-malware service must be registered with the system before it can be started as protected.</span></span> <span data-ttu-id="ea8c2-201">Während der Installation der Antimalwaresoftware kann das Installationsprogramm den Elam-Treiber installieren und das System neu starten, damit der Dienst automatisch registriert wird.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-201">During the installation of the anti-malware software, the installer can install the ELAM driver and reboot the system to automatically register the service.</span></span> <span data-ttu-id="ea8c2-202">Das System registriert den Dienst bei der Startzeit durch Extrahieren der Zertifikat Informationen aus der oben genannten Ressourcen Datei, die mit dem Elam-Treiber verknüpft ist.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-202">The system will register the service at boot time by extracting the certificate information from the aforementioned resource file that is linked into the ELAM driver.</span></span>

<span data-ttu-id="ea8c2-203">Während der Installationsphase wird dringend empfohlen, das System neu zu starten, damit der Elam-Treiber geladen wird und den Status des Systems überprüft.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-203">During the installation phase, it is highly recommended that the system is restarted in order for the ELAM driver to get loaded and validate the state of the system.</span></span> <span data-ttu-id="ea8c2-204">In Fällen, in denen ein Neustart vermieden werden muss, stellt Windows jedoch auch einen Mechanismus bereit, mit dem der antimalwareinstaller den Dienst mithilfe einer API als geschützt registrieren kann.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-204">However, for cases where a reboot must be avoided, Windows also exposes a mechanism for the anti-malware installer to register the service as protected using an API.</span></span>

### <a name="registering-the-service-without-rebooting-the-system"></a><span data-ttu-id="ea8c2-205">Registrieren des Dienstanbieter, ohne das System neu zu starten</span><span class="sxs-lookup"><span data-stu-id="ea8c2-205">Registering the service without rebooting the system</span></span>

<span data-ttu-id="ea8c2-206">Während der Installation kann ein antischadsoftwareinstallations-Installer die [**installelamcertifieupeinfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) -API anrufen und ein Handle für die Elam-Treiberdatei bereitstellen.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-206">During the installation, an anti-malware software installer can call the [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) API and provide a handle to the ELAM driver file.</span></span> <span data-ttu-id="ea8c2-207">Das System öffnet den Elam-Treiber, ruft interne Routinen auf, um sicherzustellen, dass der Elam-Treiber ordnungsgemäß signiert ist, und extrahiert die Zertifikat Informationen aus dem Ressourcenabschnitt, der dem Elam-Treiber zugeordnet ist.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-207">The system opens the ELAM driver, calls internal routines to make sure the ELAM driver is signed properly, and extracts the certificate information from the resource section associated with the ELAM driver.</span></span> <span data-ttu-id="ea8c2-208">Informationen zur Funktions Syntax finden Sie unter [**installelamcertifiereinfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo).</span><span class="sxs-lookup"><span data-stu-id="ea8c2-208">For function syntax see [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo).</span></span>

<span data-ttu-id="ea8c2-209">Codebeispiel:</span><span class="sxs-lookup"><span data-stu-id="ea8c2-209">Code example:</span></span>


```C++
HANDLE FileHandle = NULL;

FileHandle = CreateFile(<Insert Elam driver file name>,
                        FILE_READ_DATA,
                        FILE_SHARE_READ,
                        NULL,
                        OPEN_EXISTING,
                        FILE_ATTRIBUTE_NORMAL,
                        NULL
                        );

if (InstallElamCertificateInfo(FileHandle) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}
```



### <a name="starting-the-service-as-protected"></a><span data-ttu-id="ea8c2-210">Starten des dienstanals geschützt</span><span class="sxs-lookup"><span data-stu-id="ea8c2-210">Starting the service as protected</span></span>

<span data-ttu-id="ea8c2-211">Das Installationsprogramm kann die folgenden Schritte ausführen, um den Dienst als geschützt zu erstellen, zu konfigurieren und zu starten:</span><span class="sxs-lookup"><span data-stu-id="ea8c2-211">The installer can follow these steps to create, configure, and start the service as protected:</span></span>

1.  <span data-ttu-id="ea8c2-212">Rufen Sie die API "| [**ateservice**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) " auf, um ein Dienst Objekt zu erstellen und es der Datenbank des Dienststeuerungs-Managers (SCM) hinzuzufügen.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-212">Call the [**CreateService**](/windows/desktop/api/Winsvc/nf-winsvc-createservicea) API to create a service object and add it to the service control manager (SCM) database.</span></span>
2.  <span data-ttu-id="ea8c2-213">Aufrufen der [**SetServiceObjectSecurity**](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity) -API, um die Sicherheits Beschreibung des in Schritt 1 erstellten Dienst Objekts festzulegen.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-213">Call the [**SetServiceObjectSecurity**](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity) API to set the security descriptor of the service object created in step 1.</span></span>
3.  <span data-ttu-id="ea8c2-214">Rufen Sie die [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) -API auf, um den Dienst als geschützt zu markieren, und geben Sie dabei den neuen Wert für den neuen **Dienst \_ Konfigurations Start als \_ \_ geschützten** Enumerationswert an, der in winsvc. h (ab Windows 8.1)</span><span class="sxs-lookup"><span data-stu-id="ea8c2-214">Call the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) API to mark the service as protected, specifying the new **SERVICE\_CONFIG\_LAUNCH\_PROTECTED** enumeration value, which has been added in Winsvc.h (as of Windows 8.1).</span></span>

    <span data-ttu-id="ea8c2-215">Codebeispiel:</span><span class="sxs-lookup"><span data-stu-id="ea8c2-215">Code example:</span></span>

    ```C++
    SERVICE_LAUNCH_PROTECTED_INFO Info;
    SC_HANDLE hService;

    Info.dwLaunchProtected = SERVICE_LAUNCH_PROTECTED_ANTIMALWARE_LIGHT;

    hService = CreateService (/* ... */);

    if (ChangeServiceConfig2(hService,
                             SERVICE_CONFIG_LAUNCH_PROTECTED,
                             &Info) == FALSE)
    {
        Result = GetLastError();
    }
    ```

    

4.  <span data-ttu-id="ea8c2-216">Aufrufen der [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) -API, um den Dienst zu starten.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-216">Call the [**StartService**](/windows/desktop/api/Winsvc/nf-winsvc-startservicea) API to start the service.</span></span> <span data-ttu-id="ea8c2-217">Wenn der Dienst als geschützt gestartet wird, prüft SCM das CI-Subsystem (Code Integrity), um die Zertifikat Informationen zu validieren.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-217">When starting the service as protected, SCM checks with Code Integrity (CI) subsystem to validate the certificate information.</span></span> <span data-ttu-id="ea8c2-218">Nachdem die Zertifikat Informationen von CI überprüft wurden, wird der Dienst vom SCM als geschützt gestartet.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-218">After the certificate information is validated by CI, SCM launches the service as protected.</span></span>
    1.  <span data-ttu-id="ea8c2-219">Beachten Sie, dass dieser Schritt fehlschlägt, wenn Sie den Dienst nicht durch Aufrufen der [**installelamcertifiprieinfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) -API registriert haben.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-219">Note that this step fails if you haven’t registered the service by calling the [**InstallELAMCertificateInfo**](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo) API.</span></span>
    2.  <span data-ttu-id="ea8c2-220">Wenn der Dienst während der Systemstartphase für den automatischen Start konfiguriert wurde, können Sie diesen Schritt vermeiden und einfach das System neu starten.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-220">If the service has been configured to start automatically during the system startup phase, you can avoid this step and simply reboot the system.</span></span> <span data-ttu-id="ea8c2-221">Während eines Neustarts registriert das System den Dienst automatisch (wenn der Elam-Treiber erfolgreich gestartet wurde) und startet den Dienst im geschützten Modus.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-221">During a reboot, the system automatically registers the service (if the ELAM driver starts successfully) and starts the service in protected mode.</span></span>

### <a name="launching-a-child-process-as-protected"></a><span data-ttu-id="ea8c2-222">Starten eines untergeordneten Prozesses als geschützt</span><span class="sxs-lookup"><span data-stu-id="ea8c2-222">Launching a child process as protected</span></span>

<span data-ttu-id="ea8c2-223">Das neue Sicherheitsmodell ermöglicht es den antimalwaregeschützten Diensten auch, untergeordnete Prozesse als geschützt zu starten.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-223">The new security model also allows the anti-malware protected services to launch child processes as protected.</span></span> <span data-ttu-id="ea8c2-224">Diese untergeordneten Prozesse werden auf derselben Schutz Ebene wie der übergeordnete Dienst ausgeführt, und Ihre Binärdateien müssen mit demselben Zertifikat signiert werden, das über den Elam-Ressourcenabschnitt registriert wurde.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-224">These child processes will run at the same protection level as the parent service and their binaries must be signed with the same certificate that has been registered via ELAM resource section.</span></span>

<span data-ttu-id="ea8c2-225">Um den Schutz durch Antischadsoftware zuzulassen, um den untergeordneten Prozess als geschützt zu starten, wurde ein neuer erweiterter Attribut Schlüssel ( **proc \_ Thread \_ Attribute \_ Protection \_ Level**) verfügbar gemacht, der mit der [**updateprocthreadattribute**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) -API verwendet werden muss.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-225">In order to allow anti-malware protected service to launch child process as protected, a new extended attribute key, **PROC\_THREAD\_ATTRIBUTE\_PROTECTION\_LEVEL**, has been exposed and must be used with the [**UpdateProcThreadAttribute**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute) API.</span></span> <span data-ttu-id="ea8c2-226">Ein Zeiger auf den Attribut Wert der **\_ \_ gleichen Schutz Ebene** muss an die **updateprocthreadattribute** -API übermittelt werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-226">A pointer to the attribute value of **PROTECTION\_LEVEL\_SAME** must be passed into the **UpdateProcThreadAttribute** API.</span></span>

<span data-ttu-id="ea8c2-227">Hinweise:</span><span class="sxs-lookup"><span data-stu-id="ea8c2-227">Notes:</span></span>

-   <span data-ttu-id="ea8c2-228">Damit dieses neue Attribut verwendet werden kann, muss der Dienst auch **Create \_ protected \_ Process** im Parameter Prozesserstellungsflags des Aufrufens "up" angeben. [](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa)</span><span class="sxs-lookup"><span data-stu-id="ea8c2-228">In order to use this new attribute, the service must also specify **CREATE\_PROTECTED\_PROCESS** in the process creation flags parameter of the [**CreateProcess**](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa) call.</span></span>
-   <span data-ttu-id="ea8c2-229">Sie müssen Ihre Dienst Binärdateien mithilfe des/AC-Schalters signiert haben, um das Zertifikat zu integrieren, um es zu einer bekannten Zertifizierungsstelle zu verketten.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-229">You need to have your service binaries signed using the /ac switch to include the cross-certificate to chain it up to a known CA.</span></span> <span data-ttu-id="ea8c2-230">Selbst signiertes Zertifikat ohne ordnungsgemäße Verkettung für eine bekannte Stamm Zertifizierungsstelle funktioniert nicht.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-230">Self-signed cert without proper chaining to a known root CA will not work.</span></span>

<span data-ttu-id="ea8c2-231">Codebeispiel:</span><span class="sxs-lookup"><span data-stu-id="ea8c2-231">Code example:</span></span>


```C++
DWORD ProtectionLevel = PROTECTION_LEVEL_SAME;
SIZE_T AttributeListSize;

STARTUPINFOEXW StartupInfoEx = { 0 };

StartupInfoEx.StartupInfo.cb = sizeof(StartupInfoEx);

if (InitializeProcThreadAttributeList(NULL,
                                      1,
                                      0,
                                      &AttributeListSize) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

StartupInfoEx.lpAttributeList = (LPPROC_THREAD_ATTRIBUTE_LIST) HeapAlloc(
    GetProcessHeap(),
    0,
    AttributeListSize
    );

if (InitializeProcThreadAttributeList(StartupInfoEx.lpAttributeList,
                                      1,
                                      0,
                                      &AttributeListSize) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

if (UpdateProcThreadAttribute(StartupInfoEx.lpAttributeList,
                              0,
                              PROC_THREAD_ATTRIBUTE_PROTECTION_LEVEL,
                              &ProtectionLevel,
                              sizeof(ProtectionLevel),
                              NULL,
                              NULL) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}

PROCESS_INFORMATION ProcessInformation = { 0 };

if (CreateProcessW(ApplicationName,
                   CommandLine,
                   ProcessAttributes,
                   ThreadAttributes,
                   InheritHandles,
                   EXTENDED_STARTUPINFO_PRESENT | CREATE_PROTECTED_PROCESS,
                   Environment,
                   CurrentDirectory,
                   (LPSTARTUPINFOW)&StartupInfoEx,
                   &ProcessInformation) == FALSE)
{
    Result = GetLastError();
    goto exitFunc;
}
```



## <a name="updates-and-servicing"></a><span data-ttu-id="ea8c2-232">Updates und Wartung</span><span class="sxs-lookup"><span data-stu-id="ea8c2-232">Updates and servicing</span></span>

<span data-ttu-id="ea8c2-233">Nachdem der antischadsoftwaredienst als geschützt gestartet wurde, können andere nicht geschützte Prozesse (und sogar Administratoren) den Dienst nicht mehr unterbinden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-233">After the anti-malware service is launched as protected, other non-protected processes (and even admins) aren't able to stop the service.</span></span> <span data-ttu-id="ea8c2-234">Bei Aktualisierungen der Dienst Binärdateien muss der antischadsoftwaredienst einen Rückruf vom Installationsprogramm empfangen, um sich selbst zu unterbinden, damit er gewartet werden kann.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-234">In the case of updates to the service binaries, the anti-malware service needs to receive a callback from the installer to stop itself so that it can be serviced.</span></span> <span data-ttu-id="ea8c2-235">Nachdem der Dienst beendet wurde, kann der antimalwareinstaller Upgrades ausführen und dann die oben beschriebenen Schritte in den Abschnitten [Registrieren des Diensts](https://www.bing.com/search?q=Registering+the+service) und [Starten des Diensts als geschützt](#starting-the-service-as-protected) ausführen, um das Zertifikat zu registrieren und den Dienst als geschützt zu starten.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-235">After the service is stopped, the anti-malware installer can perform upgrades and then follow the steps described above in the [Registering the service](https://www.bing.com/search?q=Registering+the+service) and [Starting the service as protected](#starting-the-service-as-protected) sections to register the certificate and start the service as protected.</span></span>

<span data-ttu-id="ea8c2-236">Beachten Sie, dass der Dienst sicherstellen muss, dass nur vertrauenswürdige Aufrufer den Dienst abbrechen können.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-236">Note that the service should ensure that only trusted callers can stop the service.</span></span> <span data-ttu-id="ea8c2-237">Wenn dies nicht vertrauenswürdige Aufrufer zulässt, wird der Zweck des Schutzes des dienstanzdienstanbieter</span><span class="sxs-lookup"><span data-stu-id="ea8c2-237">Allowing untrusted callers to do so defeats the purpose of protecting the service.</span></span>

### <a name="unregistering-the-service"></a><span data-ttu-id="ea8c2-238">Aufheben der Registrierung des Dienstanbieter</span><span class="sxs-lookup"><span data-stu-id="ea8c2-238">Unregistering the service</span></span>

<span data-ttu-id="ea8c2-239">Wenn Sie einen geschützten Dienst deinstallieren, muss sich der Dienst durch Aufrufen der [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) -API als ungeschützt kennzeichnen.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-239">When you uninstall a protected service, the service must mark itself as unprotected by calling the [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) API.</span></span> <span data-ttu-id="ea8c2-240">Beachten Sie, dass der [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) -Aufrufe durch den geschützten Dienst selbst erfolgen muss, da das System keinen nicht geschützten Prozess zum Ändern der Konfiguration eines geschützten dienstanlässt.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-240">Note that because the system doesn't allow any non-protected process to alter the configuration of a protected service, the call to [**ChangeServiceConfig2**](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a) must be made by the protected service itself.</span></span> <span data-ttu-id="ea8c2-241">Nachdem der Dienst für die Ausführung als ungeschützt konfiguriert wurde, kann das Deinstallationsprogramm einfach die entsprechenden Schritte ausführen, um die Antischadsoftware aus dem System zu entfernen.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-241">After the service has been reconfigured to run as unprotected, the uninstaller can simply take appropriate steps to remove the anti-malware software from the system.</span></span>

## <a name="debugging-an-anti-malware-protected-service"></a><span data-ttu-id="ea8c2-242">Debuggen eines geschützten Antimalwarediensts</span><span class="sxs-lookup"><span data-stu-id="ea8c2-242">Debugging an anti-malware protected service</span></span>

<span data-ttu-id="ea8c2-243">Im Rahmen des Sicherheitsmodells für den geschützten Prozess können andere nicht geschützte Prozesse keine Threads einfügen oder in den virtuellen Speicher des geschützten Prozesses schreiben.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-243">As part of the protected process security model, other non-protected processes aren't able to inject threads or write into the virtual memory of the protected process.</span></span> <span data-ttu-id="ea8c2-244">Ein Kernel Debugger (KD) ist jedoch für das Debuggen von geschützten antischadsoftwareprozessen zulässig.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-244">However a kernel debugger (KD) is allowed for debugging any anti-malware protected processes.</span></span> <span data-ttu-id="ea8c2-245">Der KD kann auch verwendet werden, um zu überprüfen, ob der antischadsoftwaredienst als geschützt ausgeführt wird oder nicht:</span><span class="sxs-lookup"><span data-stu-id="ea8c2-245">The KD can also be used to check if the anti-malware service is running as protected or not:</span></span>

``` syntax
dt –r1 nt!_EPROCESS <Process Address>
+0x67a Protection       : _PS_PROTECTION
      +0x000 Level            : 0x31 '1'
      +0x000 Type             : 0y0001
      +0x000 Signer           : 0y0011
```

<span data-ttu-id="ea8c2-246">Wenn der Wert des *Typmembers* 0y0001 ist, wird der Dienst als geschützt ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-246">If the value of the *Type* member is 0y0001, the service is running as protected.</span></span>

<span data-ttu-id="ea8c2-247">Außerdem sind nur die folgenden SC-Befehle für den antischadsoftwaregeschützten Dienst zulässig:</span><span class="sxs-lookup"><span data-stu-id="ea8c2-247">In addition, only the following SC commands are allowed on anti-malware protected service:</span></span>

-   `sc config start=Auto`
-   `sc qc`
-   `sc start`
-   `sc interrogate`
-   `sc sdshow`

<span data-ttu-id="ea8c2-248">Wenn der Debugger angefügt ist, verwenden Sie das folgende Flag in der Registrierung, um den Debugger zu unterbrechen, wenn unsignierte Binärdateien (oder nicht signierte) in den geschützten Dienst für Antischadsoftware geladen werden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-248">If the debugger is attached, use the following flag in the registry to break in the debugger when unsigned (or inappropriately signed) binaries are loaded into the anti-malware protected service.</span></span>

``` syntax
Key:   HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\CI
Value: DebugFlags      REG_DWORD
```

<span data-ttu-id="ea8c2-249">Legen Sie den Wert auf **00000400** fest, um im Debugger zu unterbrechen, wenn die Signatur Validierung fehlschlägt.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-249">Set the value to **00000400** to break in the debugger when the signature validation fails.</span></span>

> [!Note]  
> <span data-ttu-id="ea8c2-250">Einschränkungen für den geschützten Prozess:</span><span class="sxs-lookup"><span data-stu-id="ea8c2-250">Protected Process limitations:</span></span>
>
> 1.  <span data-ttu-id="ea8c2-251">Prozesse, die über eine Benutzeroberfläche oder eine GUI verfügen, können nicht geschützt werden, weil der Kernel einen Prozess im Arbeitsspeicher sperrt und keine Schreibvorgänge zulässt.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-251">Processes that have UI or a GUI cannot be protected because of the way the kernel locks a process in memory and does not allow writes to it.</span></span>
> 2.  <span data-ttu-id="ea8c2-252">Vor Windows 10, Version 1703 (Creators Update), können geschützte Prozesse die TLS-oder SSL-Kommunikationsprotokolle aufgrund von Einschränkungen bei der Freigabe von Zertifikaten zwischen der lokalen Sicherheits Autorität (Local Security Authority, LSA) und einem geschützten Prozess nicht verwenden.</span><span class="sxs-lookup"><span data-stu-id="ea8c2-252">Prior to Windows 10, version 1703 (the Creators update), protected processes cannot use the TLS or SSL communication protocols due to limitations of certificate sharing between the Local Security Authority (LSA) and a protected process.</span></span>

 

## <a name="resources"></a><span data-ttu-id="ea8c2-253">Ressourcen</span><span class="sxs-lookup"><span data-stu-id="ea8c2-253">Resources</span></span>

<span data-ttu-id="ea8c2-254">Weitere Informationen:</span><span class="sxs-lookup"><span data-stu-id="ea8c2-254">For more info, see:</span></span>

-   [<span data-ttu-id="ea8c2-255">Antischadsoftware-Frühstart</span><span class="sxs-lookup"><span data-stu-id="ea8c2-255">Early launch antimalware</span></span>](/windows/desktop/w8cookbook/secured-boot)
-   <span data-ttu-id="ea8c2-256">[Geschützte Prozesse in Windows Vista](/previous-versions/windows/hardware/download/dn550976(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="ea8c2-256">[Protected Processes in Windows Vista](/previous-versions/windows/hardware/download/dn550976(v=vs.85))</span></span>
-   <span data-ttu-id="ea8c2-257">[Einrichten einer Zertifizierungsstelle](/previous-versions/windows/desktop/ms755466(v=vs.85))</span><span class="sxs-lookup"><span data-stu-id="ea8c2-257">[Setting Up a Certificate Authority](/previous-versions/windows/desktop/ms755466(v=vs.85))</span></span>
-   <span data-ttu-id="ea8c2-258">[Installieren der Zertifizierungsstelle](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))</span><span class="sxs-lookup"><span data-stu-id="ea8c2-258">[Install the Certification Authority](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj125375(v=ws.11))</span></span>
-   [<span data-ttu-id="ea8c2-259">Benutzerdefinierte Ressource</span><span class="sxs-lookup"><span data-stu-id="ea8c2-259">User-Defined Resource</span></span>](/windows/desktop/menurc/user-defined-resource)

<span data-ttu-id="ea8c2-260">Auf diese Windows-API-Funktionen wird in diesem Artikel verwiesen:</span><span class="sxs-lookup"><span data-stu-id="ea8c2-260">These Windows API functions are referenced in this article:</span></span>

-   [<span data-ttu-id="ea8c2-261">**ChangeServiceConfig2**</span><span class="sxs-lookup"><span data-stu-id="ea8c2-261">**ChangeServiceConfig2**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-changeserviceconfig2a)
-   [<span data-ttu-id="ea8c2-262">**CreateProcess**</span><span class="sxs-lookup"><span data-stu-id="ea8c2-262">**CreateProcess**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa)
-   [<span data-ttu-id="ea8c2-263">**CreateService**</span><span class="sxs-lookup"><span data-stu-id="ea8c2-263">**CreateService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-createservicea)
-   [<span data-ttu-id="ea8c2-264">**Initializeprocthreadattributelist**</span><span class="sxs-lookup"><span data-stu-id="ea8c2-264">**InitializeProcThreadAttributeList**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-initializeprocthreadattributelist)
-   [<span data-ttu-id="ea8c2-265">**Installelamcertifialisieinfo**</span><span class="sxs-lookup"><span data-stu-id="ea8c2-265">**InstallELAMCertificateInfo**</span></span>](/windows/win32/api/sysinfoapi/nf-sysinfoapi-installelamcertificateinfo)
-   [<span data-ttu-id="ea8c2-266">**SetServiceObjectSecurity**</span><span class="sxs-lookup"><span data-stu-id="ea8c2-266">**SetServiceObjectSecurity**</span></span>](/windows/desktop/api/winsvc/nf-winsvc-setserviceobjectsecurity)
-   [<span data-ttu-id="ea8c2-267">**Start Service**</span><span class="sxs-lookup"><span data-stu-id="ea8c2-267">**StartService**</span></span>](/windows/desktop/api/Winsvc/nf-winsvc-startservicea)
-   [<span data-ttu-id="ea8c2-268">**Updateprocthreadattribute**</span><span class="sxs-lookup"><span data-stu-id="ea8c2-268">**UpdateProcThreadAttribute**</span></span>](/windows/desktop/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute)

 

 
