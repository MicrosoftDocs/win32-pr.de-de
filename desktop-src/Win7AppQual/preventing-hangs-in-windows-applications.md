---
description: Erfahren Sie, wie Sie Abstürze in Windows-Anwendungen für Windows 7-und Windows Server 2008 R2-Plattformen vermeiden.
ms.assetid: 698a046b-1934-49cd-a717-d61e7e1ec534
title: Verhindern von Blockaden in Windows-Anwendungen
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 35a2d8fac95039f20c8c684c50138933c54750c3
ms.sourcegitcommit: af9983bab40fe0b042f177ce7ca79f2eb0f9d0e8
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 02/06/2021
ms.locfileid: "104050656"
---
# <a name="preventing-hangs-in-windows-applications"></a><span data-ttu-id="0b7c0-103">Verhindern von Blockaden in Windows-Anwendungen</span><span class="sxs-lookup"><span data-stu-id="0b7c0-103">Preventing Hangs in Windows Applications</span></span>

## <a name="affected-platforms"></a><span data-ttu-id="0b7c0-104">Betroffene Plattformen</span><span class="sxs-lookup"><span data-stu-id="0b7c0-104">Affected Platforms</span></span>

<span data-ttu-id="0b7c0-105">**Clients** -Windows 7</span><span class="sxs-lookup"><span data-stu-id="0b7c0-105">**Clients** - Windows 7</span></span>  
<span data-ttu-id="0b7c0-106">**Server** -Windows Server 2008 R2</span><span class="sxs-lookup"><span data-stu-id="0b7c0-106">**Servers** - Windows Server 2008 R2</span></span>  









## <a name="description"></a><span data-ttu-id="0b7c0-107">BESCHREIBUNG</span><span class="sxs-lookup"><span data-stu-id="0b7c0-107">Description</span></span>

<span data-ttu-id="0b7c0-108">**Nicht mehr Benutzer Perspektive**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-108">**Hangs - User Perspective**</span></span>

<span data-ttu-id="0b7c0-109">Benutzer wie reaktionsfähige Anwendungen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-109">Users like responsive applications.</span></span> <span data-ttu-id="0b7c0-110">Wenn Sie auf ein Menü klicken, soll die Anwendung sofort reagieren, auch wenn Sie gerade Ihre Arbeit druckt.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-110">When they click a menu, they want the application to react instantly, even if it is currently printing their work.</span></span> <span data-ttu-id="0b7c0-111">Wenn Sie ein langes Dokument in Ihrem bevorzugten Textprozessor speichern, möchten Sie die Eingabe fortsetzen, während der Datenträger immer noch spinnt.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-111">When they save a lengthy document in their favorite word processor, they want to continue typing while the disk is still spinning.</span></span> <span data-ttu-id="0b7c0-112">Wenn die Anwendung nicht rechtzeitig auf Ihre Eingaben reagiert, treten die Benutzer ungeduldig auf.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-112">Users get impatient rather quickly when the application does not react in a timely fashion to their input.</span></span>

<span data-ttu-id="0b7c0-113">Ein Programmierer könnte viele legitime Gründe erkennen, wenn eine Anwendung nicht sofort auf Benutzereingaben reagiert.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-113">A programmer might recognize many legitimate reasons for an application not to instantly respond to user input.</span></span> <span data-ttu-id="0b7c0-114">Die Anwendung ist möglicherweise ausgelastet, um einige Daten neu zu berechnen oder einfach darauf zu warten, dass die Datenträger-e/a vollständig ist.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-114">The application might be busy recalculating some data, or simply waiting for its disk I/O to complete.</span></span> <span data-ttu-id="0b7c0-115">Aus der Benutzer Recherche wissen wir jedoch, dass Benutzer nach wenigen Sekunden nicht mehr Reaktionsfähigkeit verärgert sind und frustriert werden.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-115">However, from user research, we know that users get annoyed and frustrated after just a couple of seconds of unresponsiveness.</span></span> <span data-ttu-id="0b7c0-116">Nach 5 Sekunden versuchen Sie, eine nicht reagierende Anwendung zu beenden.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-116">After 5 seconds, they will try to terminate a hung application.</span></span> <span data-ttu-id="0b7c0-117">Neben abstürzen sind Anwendungs Abstürze bei der Arbeit mit Win32-Anwendungen die häufigste Quelle für die Benutzer Unterbrechung.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-117">Next to crashes, application hangs are the most common source of user disruption when working with Win32 applications.</span></span>

<span data-ttu-id="0b7c0-118">Es gibt viele verschiedene Hauptursachen für Anwendungs Abstürze, nicht alle, die sich in einer nicht reagierenden Benutzeroberfläche selbst manifestieren.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-118">There are many different root causes for application hangs, and not all of them manifest themselves in an unresponsive UI.</span></span> <span data-ttu-id="0b7c0-119">Eine nicht reagierende Benutzeroberfläche ist jedoch eine der gängigsten Abstürze, und dieses Szenario erhält derzeit die meisten Betriebssystemunterstützung sowohl für die Erkennung als auch für die Wiederherstellung.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-119">However, an unresponsive UI is one of the most common hang experiences, and this scenario currently receives the most operating system support for both detection as well as recovery.</span></span> <span data-ttu-id="0b7c0-120">Windows erkennt automatisch Debuginformationen, sammelt Sie und beendet oder startet nicht reagierende Anwendungen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-120">Windows automatically detects, collects debug information, and optionally terminates or restarts hung applications.</span></span> <span data-ttu-id="0b7c0-121">Andernfalls muss der Benutzer den Computer möglicherweise neu starten, um eine nicht reagierende Anwendung wiederherzustellen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-121">Otherwise, the user might have to restart the machine in order to recover a hung application.</span></span>

<span data-ttu-id="0b7c0-122">**Abstürze: Betriebs System Perspektive**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-122">**Hangs - Operating System Perspective**</span></span>

<span data-ttu-id="0b7c0-123">Wenn eine Anwendung (oder genauer, ein Thread) ein Fenster auf dem Desktop erstellt, wechselt Sie in einen impliziten Vertrag mit dem Desktopfenster-Manager (DWM), um Fenster Meldungen rechtzeitig zu verarbeiten.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-123">When an application (or more accurately, a thread) creates a window on the desktop, it enters into an implicit contract with the Desktop Window Manager (DWM) to process window messages in a timely fashion.</span></span> <span data-ttu-id="0b7c0-124">Der DWM stellt Nachrichten (Tastatur-/Maus-Eingaben und Meldungen von anderen Fenstern sowie selbst) in die Thread spezifische Nachrichten Warteschlange.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-124">The DWM posts messages (keyboard/mouse input and messages from other windows, as well as itself) into the thread-specific message queue.</span></span> <span data-ttu-id="0b7c0-125">Der Thread ruft diese Nachrichten über die Nachrichten Warteschlange ab und sendet Sie.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-125">The thread retrieves and dispatches those messages via its message queue.</span></span> <span data-ttu-id="0b7c0-126">Wenn der Thread die Warteschlange nicht durch den Aufruf von getMessage () verarbeitet, werden die Nachrichten nicht verarbeitet, und das Fenster hängt nicht aus: die Warteschlange kann nicht neu gezeichnet werden, und es kann keine Eingabe vom Benutzer akzeptiert werden.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-126">If the thread does not service the queue by calling GetMessage(), messages are not processed, and the window hangs: it can neither redraw nor can it accept input from the user.</span></span> <span data-ttu-id="0b7c0-127">Das Betriebssystem erkennt diesen Zustand durch Anfügen eines Timers an ausstehende Nachrichten in der Nachrichten Warteschlange.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-127">The operating system detects this state by attaching a timer to pending messages in the message queue.</span></span> <span data-ttu-id="0b7c0-128">Wenn eine Nachricht nicht innerhalb von 5 Sekunden abgerufen wurde, deklariert die DWM das Fenster, das nicht mehr reagiert.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-128">If a message has not been retrieved within 5 seconds, the DWM declares the window to be hung.</span></span> <span data-ttu-id="0b7c0-129">Sie können diesen speziellen Fenster Zustand über die ishungappwindow ()-API Abfragen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-129">You can query this particular window state via the IsHungAppWindow() API.</span></span>

<span data-ttu-id="0b7c0-130">Die Erkennung ist nur der erste Schritt.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-130">Detection is only the first step.</span></span> <span data-ttu-id="0b7c0-131">An diesem Punkt kann der Benutzer die Anwendung immer noch nicht beenden. Wenn Sie auf die Schaltfläche "X (schließen)" klicken, wird eine "WM Close"- \_ Meldung angezeigt, die genau wie jede andere Nachricht in der Nachrichten Warteschlange hängen bleibt.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-131">At this point, the user still cannot even terminate the application - clicking the X (Close) button would result in a WM\_CLOSE message, which would be stuck in the message queue just like any other message.</span></span> <span data-ttu-id="0b7c0-132">Der Desktopfenster-Manager unterstützt durch das nahtlose ausblenden und anschließende ersetzen des angehängten Fensters durch eine "inaktive" Kopie, die eine Bitmap des vorherigen Client Bereichs des ursprünglichen Fensters anzeigt (und das Hinzufügen von "antwortet nicht" zur Titelleiste).</span><span class="sxs-lookup"><span data-stu-id="0b7c0-132">The Desktop Window Manager assists by seamlessly hiding and then replacing the hung window with a 'ghost' copy displaying a bitmap of the original window's previous client area (and adding "Not Responding" to the title bar).</span></span> <span data-ttu-id="0b7c0-133">Solange der Thread des ursprünglichen Fensters keine Nachrichten abruft, verwaltet der DWM beide Fenster gleichzeitig, ermöglicht aber nur die Interaktion mit der inaktiven Kopie.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-133">As long as the original window's thread does not retrieve messages, the DWM manages both windows simultaneously, but allows the user to interact only with the ghost copy.</span></span> <span data-ttu-id="0b7c0-134">Mithilfe dieses inaktiven Fensters kann der Benutzer die nicht reagierende Anwendung nur verschieben, minimieren und am wichtigsten schließen, aber seinen internen Zustand nicht ändern.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-134">Using this ghost window, the user can only move, minimize, and - most importantly - close the unresponsive application, but not change its internal state.</span></span>

<span data-ttu-id="0b7c0-135">Die gesamte Ghost-Darstellung sieht wie folgt aus:</span><span class="sxs-lookup"><span data-stu-id="0b7c0-135">The whole ghost experience looks like this:</span></span>

![Screenshot, der das Dialogfeld "Notepad antwortet nicht" anzeigt](images/preventinghangs-ghostwindow.gif)

<span data-ttu-id="0b7c0-137">Der Desktopfenster-Manager führt ein letztes Ergebnis aus. Sie wird in Windows-Fehlerberichterstattung integriert, sodass der Benutzer die Anwendung nicht nur schließen und optional neu starten kann, sondern auch wertvolle Debugdaten an Microsoft senden kann.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-137">The Desktop Window Manager does one last thing; it integrates with Windows Error Reporting, allowing the user to not only close and optionally restart the application, but also send valuable debugging data back to Microsoft.</span></span> <span data-ttu-id="0b7c0-138">Sie können diese systemstillstanddaten für Ihre eigenen Anwendungen erhalten, indem Sie sich auf der winqual-Website anmelden.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-138">You can get this hang data for your own applications by signing up at the Winqual website.</span></span>

<span data-ttu-id="0b7c0-139">Windows 7 hat diesem Vorgang ein neues Feature hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-139">Windows 7 added one new feature to this experience.</span></span> <span data-ttu-id="0b7c0-140">Das Betriebssystem analysiert die nicht reagierende Anwendung und erteilt dem Benutzer unter bestimmten Umständen die Möglichkeit, einen blockierenden Vorgang abzubrechen und die Anwendung wieder in Reaktion zu nehmen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-140">The operating system analyzes the hung application and, under certain circumstances, gives the user the option to cancel a blocking operation and make the application responsive again.</span></span> <span data-ttu-id="0b7c0-141">Die aktuelle Implementierung unterstützt den Abbruch von blockierenden socketaufrufen. weitere Vorgänge werden in zukünftigen Versionen vom Benutzer abgebrochen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-141">The current implementation supports cancellation of blocking Socket calls; more operations will be user-cancelable in future releases.</span></span>

<span data-ttu-id="0b7c0-142">Führen Sie die folgenden Schritte aus, um Ihre Anwendung in die Benutzeroberflächen-Wiederherstellung zu integrieren und die verfügbaren Daten optimal zu nutzen:</span><span class="sxs-lookup"><span data-stu-id="0b7c0-142">To integrate your application with the hang recovery experience and to make the most out of the available data, follow these steps:</span></span>

-   <span data-ttu-id="0b7c0-143">Stellen Sie sicher, dass Ihre Anwendung für Neustart und Wiederherstellung registriert wird, sodass Sie für den Benutzer so einfach wie möglich ist.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-143">Ensure that your application registers for restart and recovery, making a hang as pain-free as possible to the user.</span></span> <span data-ttu-id="0b7c0-144">Eine ordnungsgemäß registrierte Anwendung kann automatisch neu gestartet werden, wenn die meisten nicht gespeicherten Daten intakt sind.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-144">A properly registered application can automatically restart with most of its unsaved data intact.</span></span> <span data-ttu-id="0b7c0-145">Dies funktioniert sowohl für den Anwendungs Absturz als auch für Abstürze.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-145">This works for both application hangs and crashes.</span></span>
-   <span data-ttu-id="0b7c0-146">Erhalten Sie Informationen zu Häufigkeit und zum Debuggen von Daten für Ihre nicht abgestürzten und abgestürzten Anwendungen von der winqual-Website.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-146">Get frequency information as well as debugging data for your hung and crashed applications from the Winqual website.</span></span> <span data-ttu-id="0b7c0-147">Diese Informationen können auch während der Beta Version verwendet werden, um Ihren Code zu verbessern.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-147">You can use this information even during your Beta to improve your code.</span></span> <span data-ttu-id="0b7c0-148">Eine kurze Übersicht finden Sie unter "Einführung in Windows-Fehlerberichterstattung".</span><span class="sxs-lookup"><span data-stu-id="0b7c0-148">See "Introducing Windows Error Reporting" for a brief overview.</span></span>
-   <span data-ttu-id="0b7c0-149">Sie können das Ghosting-Feature in der Anwendung mithilfe eines Aufrufens von disableprocesswindowsghosting () deaktivieren.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-149">You can disable the ghosting feature in your application via a call to DisableProcessWindowsGhosting ().</span></span> <span data-ttu-id="0b7c0-150">Dadurch wird jedoch verhindert, dass der durchschnittliche Benutzer eine nicht reagierende Anwendung schließt und neu startet und häufig einen Neustart beendet.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-150">However, this prevents the average user from closing and restarting a hung application and often ends in a reboot.</span></span>

<span data-ttu-id="0b7c0-151">**Hängt von der Entwickler Perspektive ab**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-151">**Hangs - Developer Perspective**</span></span>

<span data-ttu-id="0b7c0-152">Das Betriebssystem definiert einen Anwendungs Absturz als Benutzeroberflächen-Thread, der Nachrichten mindestens 5 Sekunden lang nicht verarbeitet hat.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-152">The operating system defines an application hang as a UI thread that has not processed messages for at least 5 seconds.</span></span> <span data-ttu-id="0b7c0-153">Offensichtliche Fehler verursachen einige Probleme, z. b. einen Thread, der auf ein Ereignis wartet, das nie signalisiert wird, und zwei Threads, die jeweils eine Sperre haben und versuchen, die anderen zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-153">Obvious bugs cause some hangs, for example, a thread waiting for an event that is never signaled, and two threads each holding a lock and trying to acquire the others.</span></span> <span data-ttu-id="0b7c0-154">Sie können diese Fehler ohne zu viel Aufwand beheben.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-154">You can fix those bugs without too much effort.</span></span> <span data-ttu-id="0b7c0-155">Viele Abstürze sind jedoch nicht so klar.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-155">However, many hangs are not so clear.</span></span> <span data-ttu-id="0b7c0-156">Ja, der UI-Thread ruft keine Nachrichten ab, aber er ist gleichermaßen ausgelastet, um andere "wichtige" Aufgaben zu erledigen, und wird schließlich zur Verarbeitung von Nachrichten zurückkehren.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-156">Yes, the UI thread is not retrieving messages - but it is equally busy doing other 'important' work and will eventually come back to processing messages.</span></span>

<span data-ttu-id="0b7c0-157">Der Benutzer erkennt dies jedoch als Fehler.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-157">However, the user perceives this as a bug.</span></span> <span data-ttu-id="0b7c0-158">Der Entwurf sollte den Erwartungen des Benutzers entsprechen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-158">The design should match the user's expectations.</span></span> <span data-ttu-id="0b7c0-159">Wenn der Entwurf der Anwendung zu einer nicht reagierenden Anwendung führt, muss sich der Entwurf ändern.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-159">If the application's design leads to an unresponsive application, the design will have to change.</span></span> <span data-ttu-id="0b7c0-160">Und das ist wichtig, und die Reaktionsfähigkeit kann nicht wie ein Code Fehler korrigiert werden. Hierfür müssen Sie während der Entwurfsphase vorab arbeiten durcharbeiten.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-160">Finally, and this is important, unresponsiveness cannot be fixed like a code bug; it requires upfront work during the design phase.</span></span> <span data-ttu-id="0b7c0-161">Wenn Sie versuchen, die vorhandene Codebasis einer Anwendung zu reaktivieren, um die Benutzeroberfläche reaktionsfähiger zu machen, ist oft zu teuer.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-161">Trying to retrofit an application's existing code base to make the UI more responsive is often too expensive.</span></span> <span data-ttu-id="0b7c0-162">Die folgenden Entwurfs Richtlinien können hilfreich sein.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-162">The following design guidelines might help.</span></span>

-   <span data-ttu-id="0b7c0-163">Stellen Sie die UI-Reaktionsfähigkeit zu einer Anforderung der obersten Ebene. der Benutzer sollte sich immer die Kontrolle über Ihre Anwendung fühlen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-163">Make UI responsiveness a top-level requirement; the user should always feel in control of your application</span></span>
-   <span data-ttu-id="0b7c0-164">Stellen Sie sicher, dass Benutzer Vorgänge abbrechen können, die länger als eine Sekunde dauern und/oder der Vorgang im Hintergrund ausgeführt werden kann. Bereitstellen der entsprechenden Fortschritts Benutzeroberfläche bei Bedarf</span><span class="sxs-lookup"><span data-stu-id="0b7c0-164">Ensure that users can cancel operations that take longer than one second to complete and/or that operations can complete in the background; provide appropriate progress UI if necessary</span></span>

![Screenshot, der das Dialogfeld "Elemente kopieren" anzeigt.](images/preventinghangs-progressbar.gif)

-   <span data-ttu-id="0b7c0-166">Lange Ausführungs-oder Blockierungs Vorgänge als Hintergrundaufgaben in die Warteschlange stellen (hierfür ist ein wohl gedachte Messaging Mechanismus erforderlich, um den UI-Thread zu informieren, wenn die Arbeit abgeschlossen wurde)</span><span class="sxs-lookup"><span data-stu-id="0b7c0-166">Queue long-running or blocking operations as background tasks (this requires a well-thought out messaging mechanism to inform the UI thread when work has been completed)</span></span>
-   <span data-ttu-id="0b7c0-167">Den Code für UI-Threads einfach aufbewahren; so viele blockierende API-Aufrufe wie möglich entfernen</span><span class="sxs-lookup"><span data-stu-id="0b7c0-167">Keep the code for UI threads simple; remove as many blocking API calls as possible</span></span>
-   <span data-ttu-id="0b7c0-168">Fenster und Dialogfelder nur anzeigen, wenn Sie bereit und voll funktionstüchtig sind.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-168">Show windows and dialogs only when they are ready and fully operational.</span></span> <span data-ttu-id="0b7c0-169">Wenn im Dialogfeld Informationen angezeigt werden sollen, die zu viel ressourcenintensiv sind, zeigen Sie zuerst einige generische Informationen an, und aktualisieren Sie Sie im laufenden Betrieb, wenn weitere Daten verfügbar werden.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-169">If the dialog needs to display information that is too resource-intensive to calculate, show some generic information first and update it on the fly when more data becomes available.</span></span> <span data-ttu-id="0b7c0-170">Ein gutes Beispiel ist das Dialogfeld mit den Ordnereigenschaften aus Windows-Explorer.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-170">A good example is the folder properties dialog from Windows Explorer.</span></span> <span data-ttu-id="0b7c0-171">Es muss die Gesamtgröße des Ordners, Informationen, die nicht im Dateisystem verfügbar sind, anzeigen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-171">It needs to display the folder's total size, information that is not readily available from the file system.</span></span> <span data-ttu-id="0b7c0-172">Das Dialogfeld wird sofort angezeigt, und das Feld "size" wird von einem Arbeits Thread aktualisiert:</span><span class="sxs-lookup"><span data-stu-id="0b7c0-172">The dialog shows up right away and the "size" field is updated from a worker thread:</span></span>

![Screenshot, der die Seite "Allgemein" der Windows-Eigenschaften mit dem Text "size", "size on Disk" und "enthält" enthält.](images/preventinghangs-updatingdialog.gif)

<span data-ttu-id="0b7c0-174">Leider gibt es keine einfache Möglichkeit, eine reaktionsfähige Anwendung zu entwerfen und zu schreiben.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-174">Unfortunately, there is no simple way to design and write a responsive application.</span></span> <span data-ttu-id="0b7c0-175">Windows bietet kein einfaches asynchrones Framework, das eine einfache Planung von Blockierungen oder lang andauernden Vorgängen ermöglicht.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-175">Windows does not provide a simple asynchronous framework that would allow for easy scheduling of blocking or long-running operations.</span></span> <span data-ttu-id="0b7c0-176">In den folgenden Abschnitten werden einige bewährte Methoden zum Verhindern von Abstürzen und zum Hervorheben einiger häufig verwendeter Fehler vorgestellt.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-176">The following sections introduce some of the best practices in preventing hangs and highlight some of the common pitfalls.</span></span>

## <a name="best-practices"></a><span data-ttu-id="0b7c0-177">Bewährte Methoden</span><span class="sxs-lookup"><span data-stu-id="0b7c0-177">Best Practices</span></span>

<span data-ttu-id="0b7c0-178">**UI-Thread einfach halten**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-178">**Keep the UI Thread Simple**</span></span>

<span data-ttu-id="0b7c0-179">Die primäre Aufgabe der UI-Thread ist das Abrufen und Verteilen von Nachrichten.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-179">The UI thread's primary responsibility is to retrieve and dispatch messages.</span></span> <span data-ttu-id="0b7c0-180">Jede andere Art von Arbeit stellt das Risiko dar, das Fenster zu hängen, das im Besitz dieses Threads ist.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-180">Any other kind of work introduces the risk of hanging the windows owned by this thread.</span></span>

<span data-ttu-id="0b7c0-181">**Können**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-181">**Do:**</span></span>

-   <span data-ttu-id="0b7c0-182">Verschieben Sie ressourcenintensive oder unbegrenzte Algorithmen, die zu Vorgängen mit langer Laufzeit in Arbeitsthreads führen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-182">Move resource-intensive or unbounded algorithms that result in long-running operations to worker threads</span></span>
-   <span data-ttu-id="0b7c0-183">Identifizieren Sie beliebig viele blockierende Funktionsaufrufe, und versuchen Sie, Sie in die Arbeitsthreads zu verschieben. jede Funktion, die eine andere DLL aufrufen, sollte verdächtig sein.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-183">Identify as many blocking function calls as possible and try to move them to worker threads; any function calling into another DLL should be suspicious</span></span>
-   <span data-ttu-id="0b7c0-184">Führen Sie einen zusätzlichen Aufwand aus, um alle Datei-e/a-und Netzwerk-API-Aufrufe aus Ihrem Arbeits Thread zu entfernen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-184">Make an extra effort to remove all file I/O and networking API calls from your worker thread.</span></span> <span data-ttu-id="0b7c0-185">Diese Funktionen können viele Sekunden blockieren, wenn nicht Minuten.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-185">These functions can block for many seconds if not minutes.</span></span> <span data-ttu-id="0b7c0-186">Wenn Sie im UI-Thread eine beliebige Art von e/a ausführen müssen, sollten Sie die Verwendung asynchroner e/a-Vorgänge in Erwägung ziehen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-186">If you need to do any kind of I/O in the UI thread, consider using asynchronous I/O</span></span>
-   <span data-ttu-id="0b7c0-187">Beachten Sie, dass der UI-Thread auch alle von Ihrem Prozess gehosteten STA-COM-Server (Single-Threaded Apartment) bedient. Wenn Sie einen blockierenden Rückruf ausführen, werden diese com-Server erst wieder reagiert, wenn Sie die Nachrichten Warteschlange erneut bedienen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-187">Be aware that your UI thread is also servicing all single-threaded apartment (STA) COM servers hosted by your process; if you make a blocking call, these COM servers will be unresponsive until you service the message queue again</span></span>

<span data-ttu-id="0b7c0-188">**Vermeiden Sie Folgendes:**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-188">**Do not:**</span></span>

-   <span data-ttu-id="0b7c0-189">Warten Sie auf ein beliebiges Kernel Objekt (z. b. Ereignis oder Mutex), der länger als eine sehr kurze Zeitspanne ist. Wenn Sie überhaupt warten müssen, empfiehlt es sich, MsgWaitForMultipleObjects () zu verwenden, wodurch die Blockierung beim Eintreffen einer neuen Nachricht blockiert wird.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-189">Wait on any kernel object (like Event or Mutex) for more than a very short amount of time; if you have to wait at all, consider using MsgWaitForMultipleObjects(), which will unblock when a new message arrives</span></span>
-   <span data-ttu-id="0b7c0-190">Freigeben der Fenster Nachrichten Warteschlange eines Threads mit einem anderen Thread mithilfe der attachthreadinput ()-Funktion.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-190">Share a thread's window message queue with another thread by using the AttachThreadInput() function.</span></span> <span data-ttu-id="0b7c0-191">Es ist nicht nur äußerst schwierig, den Zugriff auf die Warteschlange ordnungsgemäß zu synchronisieren, sondern kann auch verhindern, dass das Windows-Betriebssystem ein nicht reagierendes Fenster ordnungsgemäß erkennt</span><span class="sxs-lookup"><span data-stu-id="0b7c0-191">It is not only extremely difficult to properly synchronize access to the queue, it also can prevent the Windows operating system from properly detecting a hung window</span></span>
-   <span data-ttu-id="0b7c0-192">Verwenden Sie TerminateThread () für alle Arbeitsthreads.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-192">Use TerminateThread() on any of your worker threads.</span></span> <span data-ttu-id="0b7c0-193">Das Beenden eines Threads auf diese Weise lässt nicht zu, dass Sperren oder Signalereignisse freigegeben werden, und kann problemlos zu verwaisten Synchronisierungs Objekten führen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-193">Terminating a thread in this way will not allow it to release locks or signal events and can easily result in orphaned synchronization objects</span></span>
-   <span data-ttu-id="0b7c0-194">Einen "unbekannten" Code aus dem UI-Thread aufzurufen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-194">Call into any 'unknown' code from your UI thread.</span></span> <span data-ttu-id="0b7c0-195">Dies trifft vor allem dann zu, wenn Ihre Anwendung über ein Erweiterbarkeits Modell verfügt. Es gibt keine Garantie, dass Code von Drittanbietern ihren Reaktions Richtlinien folgt.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-195">This is especially true if your application has an extensibility model; there is no guarantee that 3rd-party code follows your responsiveness guidelines</span></span>
-   <span data-ttu-id="0b7c0-196">Alle blockierenden Broadcast Aufrufe durchführen SendMessage (HWND- \_ Broadcast) versetzt Sie in die Gnade aller nicht geschriebenen Anwendungen, die zurzeit ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-196">Make any kind of blocking broadcast call; SendMessage(HWND\_BROADCAST) puts you at the mercy of every ill-written application currently running</span></span>

<span data-ttu-id="0b7c0-197">**Implementieren von asynchronen Mustern**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-197">**Implement Asynchronous Patterns**</span></span>

<span data-ttu-id="0b7c0-198">Zum Entfernen von Vorgängen mit langer Ausführungszeit oder Blockierung aus dem UI-Thread muss ein asynchrones Framework implementiert werden, das das Auslagern dieser Vorgänge an Arbeitsthreads ermöglicht.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-198">Removing long-running or blocking operations from the UI thread requires implementing an asynchronous framework that allows offloading those operations to worker threads.</span></span>

<span data-ttu-id="0b7c0-199">**Können**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-199">**Do:**</span></span>

-   <span data-ttu-id="0b7c0-200">Verwenden Sie asynchrone Fenster Nachrichten-APIs in Ihrem UI-Thread, insbesondere, indem Sie SendMessage durch einen der nicht blockierenden Peers ersetzen: PostMessage, sendnotifymess oder sendmessagecallback.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-200">Use asynchronous window message APIs in your UI thread, especially by replacing SendMessage with one of its non-blocking peers: PostMessage, SendNotifyMessage, or SendMessageCallback</span></span>
-   <span data-ttu-id="0b7c0-201">Verwenden Sie Hintergrundthreads zum Ausführen von Aufgaben mit langer Ausführungszeit oder Blockierung.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-201">Use background threads to execute long-running or blocking tasks.</span></span> <span data-ttu-id="0b7c0-202">Verwenden der neuen Thread Pool-API zum Implementieren von Arbeitsthreads</span><span class="sxs-lookup"><span data-stu-id="0b7c0-202">Use the new thread pool API to implement your worker threads</span></span>
-   <span data-ttu-id="0b7c0-203">Bereitstellen von Abbruch Unterstützung für Hintergrundaufgaben mit langer Ausführungszeit.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-203">Provide cancellation support for long-running background tasks.</span></span> <span data-ttu-id="0b7c0-204">Für blockierende e/a-Vorgänge verwenden Sie den e/a-Abbruch, aber nur als letzten Ausweg. Es ist nicht einfach, den "Right"-Vorgang abzubrechen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-204">For blocking I/O operations, use I/O cancellation, but only as a last resort; it's not easy to cancel the 'right' operation</span></span>
-   <span data-ttu-id="0b7c0-205">Implementieren eines asynchronen Entwurfs für verwalteten Code mithilfe des iasynkresult-Musters oder mithilfe von Ereignissen</span><span class="sxs-lookup"><span data-stu-id="0b7c0-205">Implement an asynchronous design for managed code by using the IAsyncResult pattern or by using Events</span></span>

<span data-ttu-id="0b7c0-206">**Verwenden von Sperren**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-206">**Use Locks Wisely**</span></span>

<span data-ttu-id="0b7c0-207">Die Anwendung oder dll benötigt sperren, um den Zugriff auf die internen Datenstrukturen zu synchronisieren.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-207">Your application or DLL needs locks to synchronize access to its internal data structures.</span></span> <span data-ttu-id="0b7c0-208">Die Verwendung mehrerer Sperren erhöht die Parallelität und sorgt für eine reaktionsfähigere Anwendung.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-208">Using multiple locks increases parallelism and makes your application more responsive.</span></span> <span data-ttu-id="0b7c0-209">Wenn Sie jedoch mehrere Sperren verwenden, erhöht sich auch die Wahrscheinlichkeit, dass diese Sperren in verschiedenen Reihen folgen abgerufen werden, sodass Ihre Threads Deadlock werden.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-209">However, using multiple locks also increases the chance of acquiring those locks in different orders and causing your threads to deadlock.</span></span> <span data-ttu-id="0b7c0-210">Wenn zwei Threads jeweils eine Sperre aufweisen und dann versuchen, die Sperre des anderen Threads abzurufen, bilden Ihre Vorgänge eine zirkuläre Wartezeit, die den Fortschritt für diese Threads blockiert.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-210">If two threads each hold a lock and then try to acquire the other thread's lock, their operations will form a circular wait that blocks any forward progress for these threads.</span></span> <span data-ttu-id="0b7c0-211">Sie können diesen Deadlock nur vermeiden, indem Sie sicherstellen, dass alle Threads in der Anwendung immer alle Sperren in derselben Reihenfolge abrufen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-211">You can avoid this deadlock only by ensuring that all threads in the application always acquire all locks in the same order.</span></span> <span data-ttu-id="0b7c0-212">Es ist jedoch nicht immer einfach, Sperren in der Reihenfolge "Right" zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-212">However, it isn't always easy to acquire locks in the 'right' order.</span></span> <span data-ttu-id="0b7c0-213">Software Komponenten können zusammengesetzt werden, aber Sperr Übernahmen sind nicht möglich.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-213">Software components can be composed, but lock acquisitions cannot.</span></span> <span data-ttu-id="0b7c0-214">Wenn Ihr Code eine andere Komponente aufruft, werden die Sperren dieser Komponente nun Teil der impliziten Sperr Reihenfolge, selbst wenn Sie keine Einblicke in diese Sperren haben.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-214">If your code calls some other component, that component's locks now become part of your implicit lock order - even if you have no visibility into those locks.</span></span>

<span data-ttu-id="0b7c0-215">Es ist sogar noch schwieriger, da Sperr Vorgänge weit mehr als die üblichen Funktionen für kritische Abschnitte, Mutexen und andere herkömmliche Sperren enthalten.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-215">Things get even harder because locking operations include far more than the usual functions for Critical Sections, Mutexes, and other traditional locks.</span></span> <span data-ttu-id="0b7c0-216">Alle blockierenden Aufrufe, die Thread Grenzen überschreiten, verfügen über Synchronisierungs Eigenschaften, die zu einem Deadlock führen können.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-216">Any blocking call that crosses thread boundaries has synchronization properties that can result in a deadlock.</span></span> <span data-ttu-id="0b7c0-217">Der aufrufende Thread führt einen Vorgang mit der Semantik "abrufen" aus und kann die Blockierung erst wieder entsperren, wenn der Ziel Thread "Releases" aufruft.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-217">The calling thread performs an operation with 'acquire' semantics and cannot unblock until the target thread 'releases' that call.</span></span> <span data-ttu-id="0b7c0-218">Eine Reihe von User32-Funktionen (z. b. SendMessage) sowie viele blockierende com-Aufrufe fallen in diese Kategorie.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-218">Quite a few User32 functions (for example SendMessage), as well as many blocking COM calls fall into this category.</span></span>

<span data-ttu-id="0b7c0-219">Noch schlimmer ist, dass das Betriebssystem über eine eigene interne prozessspezifische Sperre verfügt, die bei der Ausführung des Codes manchmal angehalten wird.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-219">Worse yet, the operating system has its own internal process-specific lock that sometimes is held while your code executes.</span></span> <span data-ttu-id="0b7c0-220">Diese Sperre wird abgerufen, wenn DLLs in den Prozess geladen werden, und wird daher als "Loadersperre" bezeichnet.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-220">This lock is acquired when DLLs are loaded into the process, and is therefore called the 'loader lock.'</span></span> <span data-ttu-id="0b7c0-221">Die DllMain-Funktion wird immer unter der Loadersperre ausgeführt. Wenn Sie Sperren in DllMain erwerben (was nicht der Grund ist), müssen Sie das Lade Modul in der Sperr Reihenfolge sperren.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-221">The DllMain function always executes under the loader lock; if you acquire any locks in DllMain (and you should not), you need to make the loader lock part of your lock order.</span></span> <span data-ttu-id="0b7c0-222">Wenn Sie bestimmte Win32-APIs aufrufen, erhalten Sie möglicherweise auch die Loadersperre in ihren Namen, wie z. b. LoadLibraryEx, GetModuleHandle und vor allem CoCreateInstance.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-222">Calling certain Win32 APIs might also acquire the loader lock on your behalf - functions like LoadLibraryEx, GetModuleHandle, and especially CoCreateInstance.</span></span>

<span data-ttu-id="0b7c0-223">Um dies zu verknüpfen, sehen Sie sich den unten stehenden Beispielcode an.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-223">To tie all of this together, look at the sample code below.</span></span> <span data-ttu-id="0b7c0-224">Diese Funktion ruft mehrere Synchronisierungs Objekte ab und definiert implizit eine Sperr Reihenfolge, was bei der flüchtigen Überprüfung nicht unbedingt offensichtlich ist.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-224">This function acquires multiple synchronization objects and implicitly defines a lock order, something that is not necessarily obvious on cursory inspection.</span></span> <span data-ttu-id="0b7c0-225">Bei einem Funktions Eintrag erhält der Code einen kritischen Abschnitt und gibt ihn nicht bis zum Beenden der Funktion frei. Dadurch wird der Code zum obersten Knoten in unserer Sperr Hierarchie.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-225">On function entry, the code acquires a Critical Section and does not release it until function exit, thereby making it the top node in our lock hierarchy.</span></span> <span data-ttu-id="0b7c0-226">Der Code ruft dann die Win32-Funktion "LoadIcon ()" auf, die unter den überdecken den Ladevorgang des Betriebssystems aufrufen kann, um diese Binärdatei zu laden.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-226">The code then calls the Win32 function LoadIcon(), which under the covers might call into the Operating System Loader to load this binary.</span></span> <span data-ttu-id="0b7c0-227">Dieser Vorgang würde die Loadersperre abrufen, die jetzt auch Teil dieser Sperr Hierarchie wird (stellen Sie sicher, dass die DllMain-Funktion die g CS-Sperre nicht erhält \_ ).</span><span class="sxs-lookup"><span data-stu-id="0b7c0-227">This operation would acquire the loader lock, which now also becomes part of this lock hierarchy (make sure the DllMain function does not acquire the g\_cs lock).</span></span> <span data-ttu-id="0b7c0-228">Als Nächstes ruft der Code SendMessage () auf, einen blockierenden Thread übergreifenden Vorgang, der nicht zurückgegeben wird, wenn der UI-Thread antwortet.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-228">Next the code calls SendMessage(), a blocking cross-thread operation, which will not return unless the UI thread responds.</span></span> <span data-ttu-id="0b7c0-229">Stellen Sie erneut sicher, dass der UI-Thread niemals g \_ CS erhält.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-229">Again, make sure that the UI thread never acquires g\_cs.</span></span>

```
bool foo::bar (char* buffer)  
{  
      EnterCriticalSection(&g_cs);  
      // Get 'new data' icon  
      this.m_Icon = LoadIcon(hInst, MAKEINTRESOURCE(5));  
      // Let UI thread know to update icon SendMessage(hWnd,WM_COMMAND,IDM_ICON,NULL);  
      this.m_Params = GetParams(buffer);  
      LeaveCriticalSection(&g_cs);
      return true;  
}  
```

<span data-ttu-id="0b7c0-230">Wenn Sie diesen Code betrachten, ist es offensichtlich, dass wir g \_ cs in der Sperr Hierarchie implizit die Sperre der obersten Ebene erstellt haben, auch wenn wir nur den Zugriff auf die Klassenmember-Variablen synchronisieren wollten.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-230">Looking at this code it seems clear that we implicitly made g\_cs the top-level lock in our lock hierarchy, even if we only wanted to synchronize access to the class member variables.</span></span>

<span data-ttu-id="0b7c0-231">**Können**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-231">**Do:**</span></span>

-   <span data-ttu-id="0b7c0-232">Entwerfen Sie eine Sperr Hierarchie, und befolgen Sie Sie.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-232">Design a lock hierarchy and obey it.</span></span> <span data-ttu-id="0b7c0-233">Fügen Sie alle erforderlichen Sperren hinzu.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-233">Add all the necessary locks.</span></span> <span data-ttu-id="0b7c0-234">Es gibt viele weitere Synchronisierungs primitive als nur Mutex und criticalabschnitts; Sie müssen alle eingeschlossen werden.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-234">There are many more synchronization primitives than just Mutex and CriticalSections; they all need to be included.</span></span> <span data-ttu-id="0b7c0-235">Einschließen der Loadersperre in ihre Hierarchie, wenn Sie Sperren in DllMain () verwenden</span><span class="sxs-lookup"><span data-stu-id="0b7c0-235">Include the loader lock in your hierarchy if you take any locks in DllMain()</span></span>
-   <span data-ttu-id="0b7c0-236">Stimmen Sie dem Sperrprotokoll mit ihren Abhängigkeiten zu.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-236">Agree on locking protocol with your dependencies.</span></span> <span data-ttu-id="0b7c0-237">Sämtlicher Code, der von der Anwendung aufgerufen wird oder der die Anwendung aufrufen kann, muss dieselbe Sperr Hierarchie verwenden.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-237">Any code your application calls or that might call your application needs to share the same lock hierarchy</span></span>
-   <span data-ttu-id="0b7c0-238">Lock Data Structures not Functions.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-238">Lock data structures not functions.</span></span> <span data-ttu-id="0b7c0-239">Verschieben Sie Sperr Käufe von Funktions Einstiegspunkten, und schützen Sie nur den Datenzugriff mit Sperren.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-239">Move lock acquisitions away from function entry points and guard only data access with locks.</span></span> <span data-ttu-id="0b7c0-240">Wenn weniger Code unter einer Sperre betrieben wird, besteht weniger Wahrscheinlichkeit für Deadlocks.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-240">If less code operates under a lock, there is less of a chance for deadlocks</span></span>
-   <span data-ttu-id="0b7c0-241">Analysieren Sie die Übernahmen und Releases von Sperren im Fehler Behandlungs Code.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-241">Analyze lock acquisitions and releases in your error handling code.</span></span> <span data-ttu-id="0b7c0-242">Häufig die Sperr Hierarchie, wenn Sie bei der Wiederherstellung nach einem Fehlerzustand vergessen wird</span><span class="sxs-lookup"><span data-stu-id="0b7c0-242">Often the lock hierarchy if forgotten when trying to recover from an error condition</span></span>
-   <span data-ttu-id="0b7c0-243">Ersetzen Sie die durch den Verweis Zähler erfallenen sperren, sodass Sie keinen Deadlock haben.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-243">Replace nested locks with reference counters - they cannot deadlock.</span></span> <span data-ttu-id="0b7c0-244">Einzeln gesperrte Elemente in Listen und Tabellen sind gute Kandidaten.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-244">Individually locked elements in lists and tables are good candidates</span></span>
-   <span data-ttu-id="0b7c0-245">Seien Sie vorsichtig, wenn Sie auf ein Thread Handle von einer DLL warten.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-245">Be careful when waiting on a thread handle from a DLL.</span></span> <span data-ttu-id="0b7c0-246">Nehmen Sie immer an, dass der Code unter der Loadersperre aufgerufen werden kann.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-246">Always assume that your code could be called under the loader lock.</span></span> <span data-ttu-id="0b7c0-247">Es ist besser, auf Ihre Ressourcen zu verweisen, und der Arbeits Thread kann eine eigene Bereinigung durchführen (und dann FreeLibraryAndExitThread verwenden, um die Bereinigung zu beenden).</span><span class="sxs-lookup"><span data-stu-id="0b7c0-247">It's better to reference-count your resources and let the worker thread do its own cleanup (and then use FreeLibraryAndExitThread to terminate cleanly)</span></span>
-   <span data-ttu-id="0b7c0-248">Verwenden Sie die Wait Chain Traversal-API, wenn Sie Ihre eigenen Deadlocks diagnostizieren möchten.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-248">Use the Wait Chain Traversal API if you want to diagnose your own deadlocks</span></span>

<span data-ttu-id="0b7c0-249">**Vermeiden Sie Folgendes:**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-249">**Do not:**</span></span>

-   <span data-ttu-id="0b7c0-250">Führen Sie in der DllMain ()-Funktion etwas anderes als die sehr einfache Initialisierung aus.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-250">Do anything other than very simple initialization work in your DllMain() function.</span></span> <span data-ttu-id="0b7c0-251">Weitere Informationen finden Sie unter DllMain-Rückruffunktion.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-251">See DllMain Callback Function for more details.</span></span> <span data-ttu-id="0b7c0-252">Insbesondere nicht "LoadLibraryEx" oder "cokreateinstance" aufrufen</span><span class="sxs-lookup"><span data-stu-id="0b7c0-252">Especially do not call LoadLibraryEx or CoCreateInstance</span></span>
-   <span data-ttu-id="0b7c0-253">Schreiben Sie eigene Sperr primitive.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-253">Write your own locking primitives.</span></span> <span data-ttu-id="0b7c0-254">Mit benutzerdefiniertem Synchronisierungs Code können Sie problemlos einfache Fehler in die Codebasis einbringen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-254">Custom synchronization code can easily introduce subtle bugs into your code base.</span></span> <span data-ttu-id="0b7c0-255">Verwenden Sie stattdessen die umfangreiche Auswahl von Betriebssystem-Synchronisierungs Objekten.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-255">Use the rich selection of operating system synchronization objects instead</span></span>
-   <span data-ttu-id="0b7c0-256">Arbeiten in den Konstruktoren und Debuggern für globale Variablen, Sie werden unter der Loadersperre ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-256">Do any work in the constructors and destructors for global variables, they are executed under the loader lock</span></span>

<span data-ttu-id="0b7c0-257">**Vorsicht bei Ausnahmen**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-257">**Be Careful with Exceptions**</span></span>

<span data-ttu-id="0b7c0-258">Ausnahmen ermöglichen die Trennung des normalen Programmflusses und der Fehlerbehandlung.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-258">Exceptions allow the separation of normal program flow and error handling.</span></span> <span data-ttu-id="0b7c0-259">Aufgrund dieser Trennung ist es möglicherweise schwierig, den genauen Zustand des Programms vor der Ausnahme zu erkennen, und der Ausnahmehandler könnte wichtige Schritte bei der Wiederherstellung eines gültigen Zustands übersehen.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-259">Because of this separation, it can be difficult to know the precise state of the program prior to the exception and the exception handler might miss crucial steps in restoring a valid state.</span></span> <span data-ttu-id="0b7c0-260">Dies gilt insbesondere für Sperr Käufe, die im Handler freigegeben werden müssen, um zukünftige Deadlocks zu verhindern.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-260">This is especially true for lock acquisitions that need to be released in the handler to prevent future deadlocks.</span></span>

<span data-ttu-id="0b7c0-261">Der folgende Beispielcode veranschaulicht dieses Problem.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-261">The sample code below illustrates this issue.</span></span> <span data-ttu-id="0b7c0-262">Der unbegrenzte Zugriff auf die Variable "Buffer" führt gelegentlich zu einer Zugriffsverletzung (AV).</span><span class="sxs-lookup"><span data-stu-id="0b7c0-262">The unbounded access to the "buffer" variable will occasionally result in an access violation (AV).</span></span> <span data-ttu-id="0b7c0-263">Diese AV-Datei wird vom systemeigenen Ausnahmehandler abgefangen, aber es ist nicht einfach zu bestimmen, ob der kritische Abschnitt zum Zeitpunkt der Ausnahme bereits abgerufen wurde (die AV könnte sogar irgendwo im Code von EnterCriticalSection stattgefunden haben).</span><span class="sxs-lookup"><span data-stu-id="0b7c0-263">This AV is caught by the native exception handler, but it has no easy way of determining if the critical section was already acquired at the time of the exception (the AV could even have taken place somewhere in the EnterCriticalSection code).</span></span>

```
 BOOL bar (char* buffer)  
{  
   BOOL rc = FALSE;  
   __try {  
      EnterCriticalSection(&cs);  
      while (*buffer++ != '&') ;  
      rc = GetParams(buffer);  
      LeaveCriticalSection(&cs);  
   } __except (EXCEPTION_EXECUTE_HANDLER)  
   {  
      return FALSE;  
   } 
   return rc;  
}  
```

<span data-ttu-id="0b7c0-264">**Können**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-264">**Do:**</span></span>

-   <span data-ttu-id="0b7c0-265">" \_ \_ Try/" entfernen \_ \_ , wenn dies möglich ist. verwenden Sie "Set-Filter" nicht.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-265">Remove \_\_try/\_\_except whenever possible; do not use SetUnhandledExceptionFilter</span></span>
-   <span data-ttu-id="0b7c0-266">Umschließen Sie Ihre Sperren in benutzerdefinierten automatischen \_ ptr-ähnlichen Vorlagen, wenn Sie C++-Ausnahmen verwenden.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-266">Wrap your locks in custom auto\_ptr-like templates if you use C++ exceptions.</span></span> <span data-ttu-id="0b7c0-267">Die Sperre sollte im Dekonstruktor freigegeben werden.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-267">The lock should be released in the destructor.</span></span> <span data-ttu-id="0b7c0-268">Freigabe der Sperren in der letzten Anweisung für Native Ausnahmen \_ \_</span><span class="sxs-lookup"><span data-stu-id="0b7c0-268">For native exceptions release the locks in your \_\_finally statement</span></span>
-   <span data-ttu-id="0b7c0-269">Seien Sie vorsichtig mit dem Code, der in einem nativen Ausnahmehandler ausgeführt wird. die Ausnahme hat möglicherweise viele Sperren kompromittiert, sodass der Handler keine</span><span class="sxs-lookup"><span data-stu-id="0b7c0-269">Be careful with the code executing in a native exception handler; the exception might have leaked many locks, so your handler should not acquire any</span></span>

<span data-ttu-id="0b7c0-270">**Vermeiden Sie Folgendes:**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-270">**Do not:**</span></span>

-   <span data-ttu-id="0b7c0-271">Behandeln Sie Native Ausnahmen, wenn dies nicht erforderlich oder für die Win32-APIs erforderlich ist.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-271">Handle native exceptions if not necessary or required by the Win32 APIs.</span></span> <span data-ttu-id="0b7c0-272">Wenn Sie Native Ausnahmehandler für die Berichterstellung oder die Datenwiederherstellung nach einem schwerwiegenden Fehler verwenden, sollten Sie stattdessen den standardmäßigen Betriebssystem Mechanismus von Windows-Fehlerberichterstattung verwenden.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-272">If you use native exception handlers for reporting or data recovery after catastrophic failures, consider using the default operating system mechanism of Windows Error Reporting instead</span></span>
-   <span data-ttu-id="0b7c0-273">Verwenden Sie C++-Ausnahmen mit beliebigen Arten von UI-Code (User32). eine Ausnahme, die in einem Rückruf ausgelöst wird, durchläuft die Ebenen des C-Codes, die vom Betriebssystem bereitgestellt werden.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-273">Use C++ exceptions with any kind of UI (user32) code; an exception thrown in a callback will travel through layers of C code provided by the operating system.</span></span> <span data-ttu-id="0b7c0-274">Dieser Code kennt die Semantik "C++ auflösen" nicht.</span><span class="sxs-lookup"><span data-stu-id="0b7c0-274">That code does not know about C++ unroll semantics</span></span>

## <a name="links-to-resources"></a><span data-ttu-id="0b7c0-275">Links zu Ressourcen</span><span class="sxs-lookup"><span data-stu-id="0b7c0-275">Links to Resources</span></span>

-   [<span data-ttu-id="0b7c0-276">Windows-Fehlerberichterstattung</span><span class="sxs-lookup"><span data-stu-id="0b7c0-276">Windows Error Reporting</span></span>](../wer/windows-error-reporting.md)
-   <span data-ttu-id="0b7c0-277">[Asynchroner Entwurf](https://msdn.microsoft.com/library/ms228969(v=VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="0b7c0-277">[Asynchronous Design](https://msdn.microsoft.com/library/ms228969(v=VS.80).aspx)</span></span>
-   [<span data-ttu-id="0b7c0-278">Asynchrone e/a</span><span class="sxs-lookup"><span data-stu-id="0b7c0-278">Asynchronous I/O</span></span>](../fileio/synchronous-and-asynchronous-i-o.md)
-   [<span data-ttu-id="0b7c0-279">**Attachthreadinput-Funktion**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-279">**AttachThreadInput Function**</span></span>](/windows/win32/api/winuser/nf-winuser-attachthreadinput)
-   <span data-ttu-id="0b7c0-280">[**Auto \_ ptr-Klasse**](https://msdn.microsoft.com/library/ew3fk483(v=VS.71).aspx)</span><span class="sxs-lookup"><span data-stu-id="0b7c0-280">[**auto\_ptr Class**](https://msdn.microsoft.com/library/ew3fk483(v=VS.71).aspx)</span></span>
-   [<span data-ttu-id="0b7c0-281">**Disableprocesswindowsghosting-Funktion**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-281">**DisableProcessWindowsGhosting Function**</span></span>](/windows/win32/api/winuser/nf-winuser-disableprocesswindowsghosting)
-   [<span data-ttu-id="0b7c0-282">**DllMain-Rückruffunktion**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-282">**DllMain Callback Function**</span></span>](../dlls/dllmain.md)
-   <span data-ttu-id="0b7c0-283">[Ereignisse](https://msdn.microsoft.com/library/wewwczdw(v=VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="0b7c0-283">[Events](https://msdn.microsoft.com/library/wewwczdw(v=VS.80).aspx)</span></span>
-   [<span data-ttu-id="0b7c0-284">**GetMessage-Funktion**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-284">**GetMessage Function**</span></span>](/windows/win32/api/winuser/nf-winuser-getmessage)
-   [<span data-ttu-id="0b7c0-285">E/a-Abbruch</span><span class="sxs-lookup"><span data-stu-id="0b7c0-285">I/O cancellation</span></span>](../fileio/canceling-pending-i-o-operations.md)
-   [<span data-ttu-id="0b7c0-286">**Ishungappwindow-Funktion**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-286">**IsHungAppWindow Function**</span></span>](/windows/win32/api/winuser/nf-winuser-ishungappwindow)
-   [<span data-ttu-id="0b7c0-287">Nachrichten Warteschlange</span><span class="sxs-lookup"><span data-stu-id="0b7c0-287">Message Queue</span></span>](../winmsg/using-messages-and-message-queues.md)
-   [<span data-ttu-id="0b7c0-288">**MsgWaitForMultipleObjects-Funktion**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-288">**MsgWaitForMultipleObjects Function**</span></span>](/windows/win32/api/winuser/nf-winuser-msgwaitformultipleobjects)
-   [<span data-ttu-id="0b7c0-289">Neue Thread Pool-API</span><span class="sxs-lookup"><span data-stu-id="0b7c0-289">New Thread Pool API</span></span>](../procthread/thread-pool-api.md)
-   [<span data-ttu-id="0b7c0-290">**PostMessage-Funktion**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-290">**PostMessage Function**</span></span>](/windows/win32/api/winuser/nf-winuser-postmessagea)
-   [<span data-ttu-id="0b7c0-291">Neustart und Wiederherstellung</span><span class="sxs-lookup"><span data-stu-id="0b7c0-291">Restart and Recovery</span></span>](../recovery/registering-for-application-restart.md)
-   [<span data-ttu-id="0b7c0-292">**Sendmessagecallback-Funktion**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-292">**SendMessageCallback Function**</span></span>](/windows/win32/api/winuser/nf-winuser-sendmessagecallbacka)
-   [<span data-ttu-id="0b7c0-293">**Sendnotisymess Age-Funktion**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-293">**SendNotifyMessage Function**</span></span>](/windows/win32/api/winuser/nf-winuser-sendnotifymessagea)
-   [<span data-ttu-id="0b7c0-294">Synchronisierungs Objekte</span><span class="sxs-lookup"><span data-stu-id="0b7c0-294">Synchronization Objects</span></span>](../sync/about-synchronization.md)
-   [<span data-ttu-id="0b7c0-295">**TerminateThread-Funktion**</span><span class="sxs-lookup"><span data-stu-id="0b7c0-295">**TerminateThread Function**</span></span>](/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminatethread)
-   [<span data-ttu-id="0b7c0-296">Windows-Fehlerberichterstattung</span><span class="sxs-lookup"><span data-stu-id="0b7c0-296">Windows Error Reporting</span></span>](../wer/windows-error-reporting.md)
-   [<span data-ttu-id="0b7c0-297">Winqual</span><span class="sxs-lookup"><span data-stu-id="0b7c0-297">Winqual</span></span>](/windows-hardware/drivers/dashboard/winqual-submission-tool--winqualexe-)

 

 
