---
description: Mit Version 2,0 haben Leistungsindikatoren die Architektur geändert, um den Prozess für die Bereitstellung von Leistungsindikator Daten für Consumer zu vereinfachen.
ms.assetid: 37f75b15-3f52-4259-a6d9-5a1a14f88379
title: Bereitstellen von Counter-Daten mit Version 2,0
ms.topic: article
ms.date: 08/17/2020
ms.openlocfilehash: 67976c8a0b6c77582ed8c50c2e5cf753c77fcf6b
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/07/2021
ms.locfileid: "106349218"
---
# <a name="providing-counter-data-using-version-20"></a><span data-ttu-id="24108-103">Bereitstellen von Counter-Daten mit Version 2,0</span><span class="sxs-lookup"><span data-stu-id="24108-103">Providing Counter Data Using Version 2.0</span></span>

<span data-ttu-id="24108-104">Die Anbieter von modernen Leistungsdaten verwenden ein Manifest zum Definieren der Leistungsdaten und zum Verwalten von Daten im Kontext des Anbieters.</span><span class="sxs-lookup"><span data-stu-id="24108-104">Modern performance data providers use a manifest to define the counter data and use performance counter provider APIs to manage data within the context of the provider.</span></span> <span data-ttu-id="24108-105">Anbieter, die mit einem Manifest und Leistungs Anbieter-APIs implementiert werden, werden häufig als **v2-Anbieter** bezeichnet.</span><span class="sxs-lookup"><span data-stu-id="24108-105">Providers implemented using a manifest and performance counter provider APIs are often called **V2 providers**.</span></span> <span data-ttu-id="24108-106">Windows unterstützt Benutzermodus-v2-Anbieter unter Windows Vista oder höher und Kernel Modus-v2-Anbieter unter Windows 7 oder höher.</span><span class="sxs-lookup"><span data-stu-id="24108-106">Windows supports user-mode V2 providers on Windows Vista or later and kernel-mode V2 providers on Windows 7 or later.</span></span>

<span data-ttu-id="24108-107">Auf dieser Seite werden Benutzermodus v2-Anbieter beschrieben.</span><span class="sxs-lookup"><span data-stu-id="24108-107">This page describes user-mode V2 providers.</span></span> <span data-ttu-id="24108-108">Weitere Informationen zu Kernel Modus-v2-Anbietern finden Sie unter [Kernel Mode Performance Monitoring](/windows-hardware/drivers/devtest/kernel-mode-performance-monitoring).</span><span class="sxs-lookup"><span data-stu-id="24108-108">For information about kernel-mode V2 providers, see [Kernel Mode Performance Monitoring](/windows-hardware/drivers/devtest/kernel-mode-performance-monitoring).</span></span>

<span data-ttu-id="24108-109">Zur Laufzeit funktionieren v2-Anbieter wie folgt:</span><span class="sxs-lookup"><span data-stu-id="24108-109">At runtime, V2 providers work as follows:</span></span>

- <span data-ttu-id="24108-110">Der Anbieter Prozess registriert sich selbst beim Windows-Leistungsindikator System, indem perfstartprovider und perfsetcountersetinfo aufgerufen werden.</span><span class="sxs-lookup"><span data-stu-id="24108-110">The provider process registers itself with the Windows Performance Counter system by calling PerfStartProvider and PerfSetCounterSetInfo.</span></span> <span data-ttu-id="24108-111">Der Anbieter stellt optional eine Rückruffunktion bereit, die über Consumeranforderungen benachrichtigt wird.</span><span class="sxs-lookup"><span data-stu-id="24108-111">The provider optionally provides a callback function that will be notified about consumer requests.</span></span>
- <span data-ttu-id="24108-112">Der Anbieter Prozess fügt mithilfe von perfkreateinstance und perfdelta eteinstance Instanzen nach Bedarf hinzu oder entfernt Sie.</span><span class="sxs-lookup"><span data-stu-id="24108-112">The provider process adds or removes instances as appropriate using PerfCreateInstance and PerfDeleteInstance.</span></span> <span data-ttu-id="24108-113">Der Anbieter aktualisiert Leistungswerte bei der Änderung mithilfe von perfset \* \* _-APIs.</span><span class="sxs-lookup"><span data-stu-id="24108-113">The provider updates counter values when they change using PerfSet\*\*_ APIs.</span></span>
- <span data-ttu-id="24108-114">Ein Consumer sendet eine Anforderung an Daten aus einem CounterSet.</span><span class="sxs-lookup"><span data-stu-id="24108-114">A consumer makes a request for data from a counterset.</span></span> <span data-ttu-id="24108-115">Das System überprüft, ob der Aufrufer über Berechtigungen zum Sammeln der Daten verfügt.</span><span class="sxs-lookup"><span data-stu-id="24108-115">The system verifies that the caller has permissions to collect the data.</span></span> <span data-ttu-id="24108-116">Das System verwendet dann einen Arbeits Thread, der im Anbieter Prozess ausgeführt wird, um die Anforderung zu verarbeiten, wobei die Rückruffunktion des Anbieters bei Bedarf aufgerufen wird.</span><span class="sxs-lookup"><span data-stu-id="24108-116">The system then uses a worker thread running in the provider process to handle the request, invoking the provider's callback function if appropriate.</span></span> <span data-ttu-id="24108-117">Der Arbeits Thread kopiert die gesammelten Daten in einen vom System verwalteten Puffer, und das System gibt die Daten dann an den Consumer zurück.</span><span class="sxs-lookup"><span data-stu-id="24108-117">The worker thread copies the collected data into a system-managed buffer, and the system then returns the data to the consumer.</span></span>

## <a name="steps-to-creating-a-provider"></a><span data-ttu-id="24108-118">Schritte zum Erstellen eines Anbieters</span><span class="sxs-lookup"><span data-stu-id="24108-118">Steps to creating a provider</span></span>

1. <span data-ttu-id="24108-119">Schreiben Sie ein Manifest, das die vom Anbieter bereitgestellten gegen Daten definiert.</span><span class="sxs-lookup"><span data-stu-id="24108-119">Write a manifest that defines the counter data that your provider will provide.</span></span> <span data-ttu-id="24108-120">Ausführliche Informationen zum Schreiben des Manifests finden Sie unter [Leistungsindikator Schema](performance-counters-schema.md).</span><span class="sxs-lookup"><span data-stu-id="24108-120">For details on writing the manifest, see [Performance Counters Schema](performance-counters-schema.md).</span></span>
2. <span data-ttu-id="24108-121">Verwenden Sie [ctrpp](ctrpp.md) , um den Vorlagen Code zu generieren, den Sie in Ihren Anbieter einschließen.</span><span class="sxs-lookup"><span data-stu-id="24108-121">Use [CTRPP](ctrpp.md) to generate the template code that you include in your provider.</span></span> <span data-ttu-id="24108-122">Der Vorlagen Code umfasst die Strukturen, die die Indikatorensätze definieren, die Funktionen [_ *counterinitialize* \*](counterinitialize.md) und [**countercleanup**](countercleanup.md) sowie die Ressourcen Zeichenfolgen.</span><span class="sxs-lookup"><span data-stu-id="24108-122">The template code includes the structures that define the counter sets, the [_ *CounterInitialize*\*](counterinitialize.md) and [**CounterCleanup**](countercleanup.md) functions, and the resource strings.</span></span>

   <span data-ttu-id="24108-123">Der Anbieter muss die Funktionen [**counterinitialize**](counterinitialize.md) und [**countercleanup**](countercleanup.md) aufzurufen.</span><span class="sxs-lookup"><span data-stu-id="24108-123">Your provider must call the [**CounterInitialize**](counterinitialize.md) and [**CounterCleanup**](countercleanup.md) functions.</span></span> <span data-ttu-id="24108-124">Die **counterinitialize** -Funktion Ruft die [**perfstartprovider**](/windows/desktop/api/Perflib/nf-perflib-perfstartprovider) -Funktion auf, um den Anbieter zu registrieren, und ruft auch die Funktion [**perfsetcountersetinfo**](/windows/desktop/api/Perflib/nf-perflib-perfsetcountersetinfo) auf, um den Indikatorsatz zu initialisieren.</span><span class="sxs-lookup"><span data-stu-id="24108-124">The **CounterInitialize** calls the [**PerfStartProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstartprovider) function to register the provider and also calls the [**PerfSetCounterSetInfo**](/windows/desktop/api/Perflib/nf-perflib-perfsetcountersetinfo) function to initialize the counter set.</span></span> <span data-ttu-id="24108-125">Das **countercleanup** Ruft die [**perfstopprovider**](/windows/desktop/api/Perflib/nf-perflib-perfstopprovider) -Funktion auf, um die Registrierung des Anbieters zu entfernen.</span><span class="sxs-lookup"><span data-stu-id="24108-125">The **CounterCleanup** calls the [**PerfStopProvider**](/windows/desktop/api/Perflib/nf-perflib-perfstopprovider) function to remove the provider's registration.</span></span>

3. <span data-ttu-id="24108-126">Schließen Sie den Vorlagen Code aus dem vorherigen Schritt in Ihr Projekt ein, und vervollständigen Sie den Anbieter.</span><span class="sxs-lookup"><span data-stu-id="24108-126">Include the template code from the previous step in your project and complete your provider.</span></span>

   <span data-ttu-id="24108-127">Zum Vervollständigen des Anbieters müssen Sie die [**perfkreateinstance**](/windows/desktop/api/Perflib/nf-perflib-perfcreateinstance) -Funktion für jede Instanz des von Ihnen bereitgestellten Leistungs Zählers aufrufen.</span><span class="sxs-lookup"><span data-stu-id="24108-127">To complete the provider, you need to call the [**PerfCreateInstance**](/windows/desktop/api/Perflib/nf-perflib-perfcreateinstance) function for each instance of the counter set that you provide.</span></span>

   <span data-ttu-id="24108-128">Um die Werte für die Zählers festzulegen, müssen Sie eine der folgenden Funktionen aufzurufen:</span><span class="sxs-lookup"><span data-stu-id="24108-128">To set the counter values, call one of the following functions:</span></span>

   - [<span data-ttu-id="24108-129">**Perfsetulongcountervalue**</span><span class="sxs-lookup"><span data-stu-id="24108-129">**PerfSetULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetulongcountervalue)
   - [<span data-ttu-id="24108-130">**Perfsetulonglongcountervalue**</span><span class="sxs-lookup"><span data-stu-id="24108-130">**PerfSetULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetulonglongcountervalue)
   - [<span data-ttu-id="24108-131">**Perfsetcounterref-Wert**</span><span class="sxs-lookup"><span data-stu-id="24108-131">**PerfSetCounterRefValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue)

   <span data-ttu-id="24108-132">Der Vorteil der Verwendung von [**perfsetcounterrefvalue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue) besteht darin, dass Sie keinen Funktions aufrufmachen müssen, um den Zählerwert festzulegen oder zu aktualisieren. Sie aktualisieren einfach die lokale Indikator Variable (die Variable, auf die die Verweis Punkte verweisen) und die Leistungsindikatoren verwenden den Zeiger, um auf den Indikator Wert zuzugreifen.</span><span class="sxs-lookup"><span data-stu-id="24108-132">The benefit of using [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue) is that you do not have to make a function call to set or update the counter value, you simply update your local counter variable (the variable to which the reference points) and Performance Counters uses the pointer to access the counter value.</span></span>

   <span data-ttu-id="24108-133">Wenn Sie [**perfsetcounterrefvalue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue)nicht verwenden, können Sie die folgenden Funktionen verwenden, um den Indikator Wert zu erhöhen oder zu verringern:</span><span class="sxs-lookup"><span data-stu-id="24108-133">If you do not use [**PerfSetCounterRefValue**](/windows/desktop/api/Perflib/nf-perflib-perfsetcounterrefvalue), you can use the following functions to increment or decrement the counter value:</span></span>

   - [<span data-ttu-id="24108-134">**Perfdecrementulongcountervalue**</span><span class="sxs-lookup"><span data-stu-id="24108-134">**PerfDecrementULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfdecrementulongcountervalue)
   - [<span data-ttu-id="24108-135">**Perfdecrementulonglongcountervalue**</span><span class="sxs-lookup"><span data-stu-id="24108-135">**PerfDecrementULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfdecrementulonglongcountervalue)
   - [<span data-ttu-id="24108-136">**Perfinkrementulongcountervalue**</span><span class="sxs-lookup"><span data-stu-id="24108-136">**PerfIncrementULongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfincrementulongcountervalue)
   - [<span data-ttu-id="24108-137">**Perfinkrementulonglongcountervalue**</span><span class="sxs-lookup"><span data-stu-id="24108-137">**PerfIncrementULongLongCounterValue**</span></span>](/windows/desktop/api/Perflib/nf-perflib-perfincrementulonglongcountervalue)

   <span data-ttu-id="24108-138">Bevor der Anbieter beendet wird, muss er den [**perfdelta eteinstance**](/windows/desktop/api/Perflib/nf-perflib-perfdeleteinstance) für jede erstellte Instanz von Counter-Set-Instanz abrufen.</span><span class="sxs-lookup"><span data-stu-id="24108-138">Before the provider exits, it must call the [**PerfDeleteInstance**](/windows/desktop/api/Perflib/nf-perflib-perfdeleteinstance) for each counter set instance that it created.</span></span>

   <span data-ttu-id="24108-139">Wenn Sie das **Rückruf** Attribut im [**Provider**](/windows/desktop/PerfCtrs/performance-counters-provider--counters--element) -Element im Manifest angegeben oder das **-notificationcallback-** Argument beim Aufrufen von [ctrpp](ctrpp.md)verwendet haben, müssen Sie die [*controlcallback*](/windows/desktop/api/Perflib/nc-perflib-perflibrequest) -Rückruffunktion implementieren.</span><span class="sxs-lookup"><span data-stu-id="24108-139">If you specified the **callback** attribute in the [**provider**](/windows/desktop/PerfCtrs/performance-counters-provider--counters--element) element in your manifest or used the **-NotificationCallback** argument when calling [CTRPP](ctrpp.md), you must implement the [*ControlCallback*](/windows/desktop/api/Perflib/nc-perflib-perflibrequest) callback function.</span></span> <span data-ttu-id="24108-140">Sie übergeben die Rückruffunktion an [**counterinitialize**](counterinitialize.md).</span><span class="sxs-lookup"><span data-stu-id="24108-140">You pass the callback function to [**CounterInitialize**](counterinitialize.md).</span></span>

   <span data-ttu-id="24108-141">Wenn Sie " **-memoryroutinen** " beim Aufrufen [von ctrpp](ctrpp.md)verwendet haben, müssen Sie die Rückruf Funktionen " [*zugscatememory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_alloc) " und " [*Freispeicher*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_free) " implementieren.</span><span class="sxs-lookup"><span data-stu-id="24108-141">If you used the **-MemoryRoutines** when calling [CTRPP](ctrpp.md), you must implement the [*AllocateMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_alloc) and [*FreeMemory*](/windows/desktop/api/Perflib/nc-perflib-perf_mem_free) callback functions.</span></span> <span data-ttu-id="24108-142">Sie übergeben die Rückruf Funktionen an [**counterinitialize**](counterinitialize.md).</span><span class="sxs-lookup"><span data-stu-id="24108-142">You pass the callback functions to [**CounterInitialize**](counterinitialize.md).</span></span>

4. <span data-ttu-id="24108-143">Verwenden Sie bei der Installation des Anbieters das lodctr-Tool, um den Namen der Binärdatei mit den lokalisierten Ressourcen Zeichenfolgen und Ressourcen-IDs in die Registrierung zu schreiben.</span><span class="sxs-lookup"><span data-stu-id="24108-143">When installing your provider, use the LodCtr tool to write the name of the binary file that contains the localized resource strings and resource IDs to the registry.</span></span> <span data-ttu-id="24108-144">Ausführliche Informationen zur Verwendung von lodctr finden Sie unter [Leistungsindikator Schema](performance-counters-schema.md).</span><span class="sxs-lookup"><span data-stu-id="24108-144">For details on using LodCtr, see [Performance Counters Schema](performance-counters-schema.md).</span></span>

5. <span data-ttu-id="24108-145">Wenn Sie den Anbieter deinstallieren, verwenden Sie das unlodctr-Tool, um die Informationen des Anbieters aus der Registrierung zu entfernen.</span><span class="sxs-lookup"><span data-stu-id="24108-145">When uninstalling your provider, use the UnlodCtr tool to remove your provider's information from the registry.</span></span>
