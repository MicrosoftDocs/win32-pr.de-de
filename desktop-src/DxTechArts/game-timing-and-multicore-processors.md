---
title: Zeitliche Steuerung von Spielen und Multi-Core-Prozessoren
description: In diesem Artikel wird eine präzisere und zuverlässigere Lösung vorgeschlagen, um CPU-Zeitvorgaben mit hoher Auflösung mithilfe der Windows-APIs QueryPerformanceCounter und QueryPerformanceFrequency zu erhalten.
ms.assetid: 1512324d-dffa-3681-be3f-f63a3b8f11db
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 9c5c511f558b59e94945e63c44db225f34ac2583
ms.sourcegitcommit: 592c9bbd22ba69802dc353bcb5eb30699f9e9403
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 08/20/2020
ms.locfileid: "106341947"
---
# <a name="game-timing-and-multicore-processors"></a><span data-ttu-id="fe200-103">Zeitliche Steuerung von Spielen und Multi-Core-Prozessoren</span><span class="sxs-lookup"><span data-stu-id="fe200-103">Game Timing and Multicore Processors</span></span>

<span data-ttu-id="fe200-104">Da Energie Verwaltungs Technologien heutzutage in den heutigen Computern üblich werden, funktioniert eine häufig verwendete Methode zum Abrufen von CPU-Zeitvorgaben mit hoher Auflösung, die RDTSC-Anweisung, möglicherweise nicht mehr wie erwartet.</span><span class="sxs-lookup"><span data-stu-id="fe200-104">With power management technologies becoming more commonplace in today's computers, a commonly-used method to obtain high-resolution CPU timings, the RDTSC instruction, may no longer work as expected.</span></span> <span data-ttu-id="fe200-105">In diesem Artikel wird eine präzisere und zuverlässigere Lösung vorgeschlagen, um CPU-Zeitvorgaben mit hoher Auflösung mithilfe der Windows-APIs [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) und [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency)zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="fe200-105">This article suggests a more accurate, reliable solution to obtain high-resolution CPU timings by using the Windows APIs [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span></span>

-   [<span data-ttu-id="fe200-106">Hintergrund</span><span class="sxs-lookup"><span data-stu-id="fe200-106">Background</span></span>](#background)
-   [<span data-ttu-id="fe200-107">Empfehlungen</span><span class="sxs-lookup"><span data-stu-id="fe200-107">Recommendations</span></span>](#recommendations)
-   [<span data-ttu-id="fe200-108">Anwendungskompatibilität</span><span class="sxs-lookup"><span data-stu-id="fe200-108">Application Compatibility</span></span>](#application-compatibility)

## <a name="background"></a><span data-ttu-id="fe200-109">Hintergrund</span><span class="sxs-lookup"><span data-stu-id="fe200-109">Background</span></span>

<span data-ttu-id="fe200-110">Seit der Einführung des x86-P5-Anweisungs Satzes haben viele Spieleentwickler den Lesezeit Stempel-Leistungs Besatz verwendet, die RDTSC-Anweisung, um eine zeitgesteuerte Zeitüberschreitung zu bieten.</span><span class="sxs-lookup"><span data-stu-id="fe200-110">Since the introduction of the x86 P5 instruction set, many game developers have made use of read time stamp counter, the RDTSC instruction, to perform high-resolution timing.</span></span> <span data-ttu-id="fe200-111">Die Windows-Multimediatimer sind für die Audio-und Videoverarbeitung präzise genug, aber mit Frame Zeiten von einem Dutzend Millisekunden oder weniger verfügen Sie nicht über genügend Auflösung, um Delta Zeit Informationen bereitzustellen.</span><span class="sxs-lookup"><span data-stu-id="fe200-111">The Windows multimedia timers are precise enough for sound and video processing, but with frame times of a dozen milliseconds or less, they don't have enough resolution to provide delta-time information.</span></span> <span data-ttu-id="fe200-112">Viele Spiele verwenden beim Start weiterhin einen Multimediatimer, um die Häufigkeit der CPU festzulegen, und Sie verwenden diesen Frequency-Wert, um Ergebnisse aus RDTSC zu skalieren, um eine genaue Zeit zu erzielen.</span><span class="sxs-lookup"><span data-stu-id="fe200-112">Many games still use a multimedia timer at start-up to establish the frequency of the CPU, and they use that frequency value to scale results from RDTSC to get accurate time.</span></span> <span data-ttu-id="fe200-113">Aufgrund der Einschränkungen von RDTSC stellt die Windows-API die korrektere Methode zum Zugreifen auf diese Funktionalität durch die Routinen von [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) und [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency)bereit.</span><span class="sxs-lookup"><span data-stu-id="fe200-113">Due to the limitations of RDTSC, the Windows API exposes the more correct way to access this functionality through the routines of [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span></span>

<span data-ttu-id="fe200-114">Diese Verwendung von RDTSC für die zeitliche Steuerung hat folgende grundlegende Probleme:</span><span class="sxs-lookup"><span data-stu-id="fe200-114">This use of RDTSC for timing suffers from these fundamental issues:</span></span>

-   <span data-ttu-id="fe200-115">Diskontinuierliche Werte.</span><span class="sxs-lookup"><span data-stu-id="fe200-115">Discontinuous values.</span></span> <span data-ttu-id="fe200-116">Wenn Sie RDTSC direkt verwenden, wird davon ausgegangen, dass der Thread immer auf demselben Prozessor ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="fe200-116">Using RDTSC directly assumes that the thread is always running on the same processor.</span></span> <span data-ttu-id="fe200-117">Multiprozessor-und Dual-Core-Systeme garantieren nicht die Synchronisierung Ihrer Zyklen von Zyklen zwischen Kernen.</span><span class="sxs-lookup"><span data-stu-id="fe200-117">Multiprocessor and dual-core systems do not guarantee synchronization of their cycle counters between cores.</span></span> <span data-ttu-id="fe200-118">Dies wird verstärkt, wenn Sie mit modernen Energie Verwaltungs Technologien kombiniert werden, die verschiedene Kerne zu unterschiedlichen Zeiten im Leerlauf und wiederherstellen, was dazu führt, dass die Kerne in der Regel nicht synchronisiert werden.</span><span class="sxs-lookup"><span data-stu-id="fe200-118">This is exacerbated when combined with modern power management technologies that idle and restore various cores at different times, which results in the cores typically being out of synchronization.</span></span> <span data-ttu-id="fe200-119">Bei einer Anwendung führt dies in der Regel zu einem Absturz oder zu potenziellen abstürzen, da der Thread zwischen den Prozessoren springt und Zeit Steuerungs Werte abruft, die zu großen Delta-, negativen Delta-oder Zeitüberschreitungen führen.</span><span class="sxs-lookup"><span data-stu-id="fe200-119">For an application, this generally results in glitches or in potential crashes as the thread jumps between the processors and gets timing values that result in large deltas, negative deltas, or halted timing.</span></span>
-   <span data-ttu-id="fe200-120">Verfügbarkeit dedizierter Hardware.</span><span class="sxs-lookup"><span data-stu-id="fe200-120">Availability of dedicated hardware.</span></span> <span data-ttu-id="fe200-121">RDTSC sperrt die Zeit Steuerungsinformationen, die von der Anwendung angefordert werden, an den Zyklen des Prozessor-Durchlaufs.</span><span class="sxs-lookup"><span data-stu-id="fe200-121">RDTSC locks the timing information that the application requests to the processor's cycle counter.</span></span> <span data-ttu-id="fe200-122">Schon seit vielen Jahren war dies die beste Möglichkeit, Zeit Steuerungsinformationen mit hoher Genauigkeit zu erhalten, aber neuere Hauptplatinen enthalten jetzt dedizierte Zeit Steuerungsgeräte, die Informationen zur zeitlichen Steuerung ohne die Nachteile von RDTSC bereitstellen.</span><span class="sxs-lookup"><span data-stu-id="fe200-122">For many years this was the best way to get high-precision timing information, but newer motherboards are now including dedicated timing devices which provide high-resolution timing information without the drawbacks of RDTSC.</span></span>
-   <span data-ttu-id="fe200-123">Varianz der CPU-Häufigkeit.</span><span class="sxs-lookup"><span data-stu-id="fe200-123">Variability of the CPU's frequency.</span></span> <span data-ttu-id="fe200-124">Die Annahme ist häufig, dass die Häufigkeit der CPU für die Lebensdauer des Programms fest liegt.</span><span class="sxs-lookup"><span data-stu-id="fe200-124">The assumption is often made that the frequency of the CPU is fixed for the life of the program.</span></span> <span data-ttu-id="fe200-125">Bei modernen Energie Verwaltungs Technologien ist dies jedoch eine falsche Annahme.</span><span class="sxs-lookup"><span data-stu-id="fe200-125">However, with modern power management technologies, this is an incorrect assumption.</span></span> <span data-ttu-id="fe200-126">Obwohl Sie anfänglich auf Laptop Computer und andere mobile Geräte beschränkt ist, wird die Häufigkeit der CPU-Auslastung in vielen High-End-Desktop-PCs verwendet. die Deaktivierung der Funktion zur Aufrechterhaltung einer konsistenten Häufigkeit ist für Benutzer in der Regel nicht akzeptabel.</span><span class="sxs-lookup"><span data-stu-id="fe200-126">While initially limited to laptop computers and other mobile devices, technology that changes the frequency of the CPU is in use in many high-end desktop PCs; disabling its function to maintain a consistent frequency is generally not acceptable to users.</span></span>

## <a name="recommendations"></a><span data-ttu-id="fe200-127">Empfehlungen</span><span class="sxs-lookup"><span data-stu-id="fe200-127">Recommendations</span></span>

<span data-ttu-id="fe200-128">Spiele benötigen genaue Zeit Steuerungsinformationen. Sie müssen aber auch Zeit Steuerungs Code implementieren, um die Probleme zu vermeiden, die mit der Verwendung von RDTSC einhergehen.</span><span class="sxs-lookup"><span data-stu-id="fe200-128">Games need accurate timing information, but you also need to implement timing code in a way that avoids the problems associated with using RDTSC.</span></span> <span data-ttu-id="fe200-129">Führen Sie die folgenden Schritte aus, wenn Sie eine Zeitüberschreitung mit hoher Auflösung implementieren:</span><span class="sxs-lookup"><span data-stu-id="fe200-129">When you implement high-resolution timing, take the following steps:</span></span>

1.  <span data-ttu-id="fe200-130">Verwenden Sie [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) und [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) anstelle von RDTSC.</span><span class="sxs-lookup"><span data-stu-id="fe200-130">Use [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) instead of RDTSC.</span></span> <span data-ttu-id="fe200-131">Diese APIs verwenden möglicherweise RDTSC, verwenden jedoch stattdessen eine Zeit Steuerungsgeräte auf der Hauptplatine oder einige andere Systemdienste, die hochwertige Zeit Steuerungsinformationen mit hoher Auflösung bereitstellen.</span><span class="sxs-lookup"><span data-stu-id="fe200-131">These APIs may make use of RDTSC, but might instead make use of a timing devices on the motherboard or some other system services that provide high-quality high-resolution timing information.</span></span> <span data-ttu-id="fe200-132">RDTSC ist zwar viel schneller als **QueryPerformanceCounter**, da es sich hierbei um einen API-Aufruf handelt, handelt es sich hierbei um eine API, die mehrere hundert Mal pro Frame aufgerufen werden kann, ohne dass eine spürbare Auswirkung besteht.</span><span class="sxs-lookup"><span data-stu-id="fe200-132">While RDTSC is much faster than **QueryPerformanceCounter**, since the latter is an API call, it is an API that can be called several hundred times per frame without any noticeable impact.</span></span> <span data-ttu-id="fe200-133">(Dennoch sollten Entwickler versuchen, den Spiel **QueryPerformanceCounter** so wenig wie möglich aufzurufen, um Leistungseinbußen zu vermeiden.)</span><span class="sxs-lookup"><span data-stu-id="fe200-133">(Nevertheless, developers should attempt to have their games call **QueryPerformanceCounter** as little as possible to avoid any performance penalty.)</span></span>
2.  <span data-ttu-id="fe200-134">Beim Berechnen von Delta Werten sollten die Werte geklammert werden, um sicherzustellen, dass Fehler in den Zeit Steuerungs Werten keine Abstürze oder instabilen zeitbezogenen Berechnungen verursachen.</span><span class="sxs-lookup"><span data-stu-id="fe200-134">When computing deltas, the values should be clamped to ensure that any bugs in the timing values do not cause crashes or unstable time-related computations.</span></span> <span data-ttu-id="fe200-135">Der Klammer Bereich muss zwischen 0 (um negative Delta Werte zu vermeiden) auf einen angemessenen Wert basieren, der auf dem niedrigsten erwarteten Framerate basiert.</span><span class="sxs-lookup"><span data-stu-id="fe200-135">The clamp range should be from 0 (to prevent negative delta values) to some reasonable value based on your lowest expected framerate.</span></span> <span data-ttu-id="fe200-136">Das anspannen ist wahrscheinlich für das Debuggen Ihrer Anwendung nützlich, aber achten Sie darauf, wenn Sie eine Leistungsanalyse durchführen oder das Spiel in einem nicht optimierten Modus ausführen.</span><span class="sxs-lookup"><span data-stu-id="fe200-136">Clamping is likely to be useful in any debugging of your application, but be sure to keep it in mind if doing performance analysis or running the game in some unoptimized mode.</span></span>
3.  <span data-ttu-id="fe200-137">Berechnen Sie alle zeitliche Steuerung in einem einzelnen Thread.</span><span class="sxs-lookup"><span data-stu-id="fe200-137">Compute all timing on a single thread.</span></span> <span data-ttu-id="fe200-138">Berechnung der zeitlichen Steuerung in mehreren Threads – z. b. bei jedem Thread, der einem bestimmten Prozessor zugeordnet ist – verringert die Leistung von mehr Kernsystemen erheblich.</span><span class="sxs-lookup"><span data-stu-id="fe200-138">Computation of timing on multiple threads — for example, with each thread associated with a specific processor — greatly reduces performance of multi-core systems.</span></span>
4.  <span data-ttu-id="fe200-139">Legen Sie den einzelnen Thread mithilfe der Windows-API [**SetThreadAffinityMask**](/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask)auf einem einzelnen Prozessor fest.</span><span class="sxs-lookup"><span data-stu-id="fe200-139">Set that single thread to remain on a single processor by using the Windows API [**SetThreadAffinityMask**](/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask).</span></span> <span data-ttu-id="fe200-140">In der Regel ist dies der Hauptspiel Thread.</span><span class="sxs-lookup"><span data-stu-id="fe200-140">Typically, this is the main game thread.</span></span> <span data-ttu-id="fe200-141">Obwohl [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) und [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) in der Regel für mehrere Prozessoren angepasst werden, können Fehler im BIOS oder in den Treibern dazu führen, dass diese Routinen andere Werte zurückgeben, wenn der Thread von einem Prozessor zu einem anderen verschoben wird.</span><span class="sxs-lookup"><span data-stu-id="fe200-141">While [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) typically adjust for multiple processors, bugs in the BIOS or drivers may result in these routines returning different values as the thread moves from one processor to another.</span></span> <span data-ttu-id="fe200-142">Daher ist es am besten, den Thread auf einem einzelnen Prozessor beizubehalten.</span><span class="sxs-lookup"><span data-stu-id="fe200-142">So, it's best to keep the thread on a single processor.</span></span>

    <span data-ttu-id="fe200-143">Alle anderen Threads sollten ausgeführt werden, ohne eigene Zeit Geber Daten zu sammeln.</span><span class="sxs-lookup"><span data-stu-id="fe200-143">All other threads should operate without gathering their own timer data.</span></span> <span data-ttu-id="fe200-144">Es wird nicht empfohlen, einen Arbeits Thread zum Berechnen der zeitlichen Steuerung zu verwenden, da dies zu einem Synchronisierungs Engpass wird.</span><span class="sxs-lookup"><span data-stu-id="fe200-144">We do not recommend using a worker thread to compute timing, as this will become a synchronization bottleneck.</span></span> <span data-ttu-id="fe200-145">Stattdessen sollten Arbeitsthreads Zeitstempel aus dem Haupt Thread lesen, und da die Arbeitsthreads nur Zeitstempel lesen, ist es nicht erforderlich, kritische Abschnitte zu verwenden.</span><span class="sxs-lookup"><span data-stu-id="fe200-145">Instead, worker threads should read timestamps from the main thread, and because the worker threads only read timestamps, there is no need to use critical sections.</span></span>

5.  <span data-ttu-id="fe200-146">Der Aufruf von [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) erfolgt nur einmal, da sich die Häufigkeit nicht ändert, während das System ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="fe200-146">Call [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) only once, because the frequency will not change while the system is running.</span></span>

## <a name="application-compatibility"></a><span data-ttu-id="fe200-147">Anwendungskompatibilität</span><span class="sxs-lookup"><span data-stu-id="fe200-147">Application Compatibility</span></span>

<span data-ttu-id="fe200-148">Viele Entwickler haben über viele Jahre Annahmen über das Verhalten von RDTSC festgestellt. es ist daher sehr wahrscheinlich, dass einige vorhandene Anwendungen Probleme verursachen, wenn Sie auf einem System mit mehreren Prozessoren oder Kernen ausgeführt werden, die auf die zeitliche Implementierung zurückzuführen sind.</span><span class="sxs-lookup"><span data-stu-id="fe200-148">Many developers have made assumptions about the behavior of RDTSC over many years, so it is quite likely that some existing applications will exhibit problems when run on a system with multiple processors or cores due to the timing implementation.</span></span> <span data-ttu-id="fe200-149">Diese Probleme werden in der Regel als ein-oder langsamer Bewegungswechsel verwendet.</span><span class="sxs-lookup"><span data-stu-id="fe200-149">These problems will usually manifest as glitching or slow-motion movement.</span></span> <span data-ttu-id="fe200-150">Es gibt keine einfache Lösung für Anwendungen, die die Energie Verwaltung nicht kennen, aber es gibt ein vorhandenes Shim, mit dem eine Anwendung immer auf einem einzelnen Prozessor in einem Multiprozessorsystem ausgeführt werden kann.</span><span class="sxs-lookup"><span data-stu-id="fe200-150">There is no easy remedy for applications that are not aware of power management, but there is an existing shim for forcing an application to always run on a single processor in a multiprocessor system.</span></span>

<span data-ttu-id="fe200-151">Um dieses Shim zu erstellen, laden Sie das Microsoft Application Compatibility Toolkit von der [Windows-Anwendungs Kompatibilität](/archive/blogs/yongrhee/download-application-compatibility-toolkit-act-for-windows-10)herunter.</span><span class="sxs-lookup"><span data-stu-id="fe200-151">To create this shim, download the Microsoft Application Compatibility Toolkit from [Windows Application Compatibility](/archive/blogs/yongrhee/download-application-compatibility-toolkit-act-for-windows-10).</span></span>

<span data-ttu-id="fe200-152">Erstellen Sie mit dem Kompatibilitäts Administrator, der Teil des Toolkits ist, eine Datenbank Ihrer Anwendung und zugehörige Korrekturen.</span><span class="sxs-lookup"><span data-stu-id="fe200-152">Using the Compatibility Administrator, part of the toolkit, create a database of your application and associated fixes.</span></span> <span data-ttu-id="fe200-153">Erstellen Sie einen neuen Kompatibilitätsmodus für diese Datenbank, und wählen Sie die Kompatibilitäts Korrektur **singleprocaffität** aus, um zu erzwingen, dass alle Threads der Anwendung auf einem einzelnen Prozessor/Kern ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="fe200-153">Create a new compatibility mode for this database and select the compatibility fix **SingleProcAffinity** to force all of the threads of the application to run on a single processor/core.</span></span> <span data-ttu-id="fe200-154">Mithilfe des Befehlszeilen Tools Fixpack.exe (auch Teil des-Toolkits) können Sie diese Datenbank in ein installier bares Paket konvertieren, um die Installation, das Testen und die Verteilung zu überprüfen.</span><span class="sxs-lookup"><span data-stu-id="fe200-154">By using the command-line tool Fixpack.exe (also part of the toolkit), you can convert this database into an installable package for installation, testing, and distribution.</span></span>

<span data-ttu-id="fe200-155">Anweisungen zur Verwendung des Kompatibilitäts Administrators finden Sie in der Dokumentation des Toolkits.</span><span class="sxs-lookup"><span data-stu-id="fe200-155">For instruction on using Compatibility Administrator, see the toolkit's documentation.</span></span> <span data-ttu-id="fe200-156">Syntax und Beispiele für die Verwendung von Fixpack.exe finden Sie in der Befehlszeilen Hilfe.</span><span class="sxs-lookup"><span data-stu-id="fe200-156">For syntax for and examples of using Fixpack.exe, see its command-line help.</span></span>

<span data-ttu-id="fe200-157">Kundenorientierte Informationen finden Sie in den folgenden Knowledge Base-Artikeln von Microsoft-Hilfe und-Support:</span><span class="sxs-lookup"><span data-stu-id="fe200-157">For customer-oriented information, see the following knowledge base articles from Microsoft Help and Support:</span></span>

-   <span data-ttu-id="fe200-158">[Programme, die die QueryPerformanceCounter-Funktion in Windows Server 2003 und Windows XP](https://support.microsoft.com/kb/895980) (Artikel 895980) unter Umständen schlecht ausführen</span><span class="sxs-lookup"><span data-stu-id="fe200-158">[Programs that user the QueryPerformanceCounter function may perform poorly in Windows Server 2003 and in Windows XP](https://support.microsoft.com/kb/895980) (article 895980)</span></span>
-   <span data-ttu-id="fe200-159">[Die Spielleistung kann auf einem Windows XP-basierten Computer, der einen Dual-Core-Prozessor verwendet, gering sein](https://support.microsoft.com/kb/909944) (Artikel 909944).</span><span class="sxs-lookup"><span data-stu-id="fe200-159">[Game performance may be poor on a Windows XP-based computer that is using a dual-core processor](https://support.microsoft.com/kb/909944) (article 909944)</span></span>

 

 