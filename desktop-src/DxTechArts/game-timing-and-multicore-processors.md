---
title: Zeitliche Steuerung von Spielen und Multi-Core-Prozessoren
description: In diesem Artikel wird eine genauere, zuverlässigere Lösung vorgeschlagen, um mithilfe der Windows-APIs QueryPerformanceCounter und QueryPerformanceFrequency cpu-Zeitsteuerungen mit hoher Auflösung zu erhalten.
ms.assetid: 1512324d-dffa-3681-be3f-f63a3b8f11db
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: f7a6d9d65ccb79c7b496b4d02b1bed132bdc2d3f
ms.sourcegitcommit: 998a611c97d5e20ac0c45e3bda768ae67d8c2cca
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 05/11/2021
ms.locfileid: "109725009"
---
# <a name="game-timing-and-multicore-processors"></a><span data-ttu-id="94220-103">Zeitliche Steuerung von Spielen und Multi-Core-Prozessoren</span><span class="sxs-lookup"><span data-stu-id="94220-103">Game Timing and Multicore Processors</span></span>

<span data-ttu-id="94220-104">Da Energieverwaltungstechnologien auf den heutigen Computern immer häufiger verwendet werden, funktioniert die RDTSC-Anweisung, eine häufig verwendete Methode zum Abrufen von hochauflösenden CPU-Zeitsteuerungen, möglicherweise nicht mehr wie erwartet.</span><span class="sxs-lookup"><span data-stu-id="94220-104">With power management technologies becoming more commonplace in today's computers, a commonly-used method to obtain high-resolution CPU timings, the RDTSC instruction, may no longer work as expected.</span></span> <span data-ttu-id="94220-105">In diesem Artikel wird eine genauere, zuverlässigere Lösung vorgeschlagen, um mithilfe der Windows-APIs [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) und [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency)hohe CPU-Zeitsteuerungen zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="94220-105">This article suggests a more accurate, reliable solution to obtain high-resolution CPU timings by using the Windows APIs [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span></span>

-   [<span data-ttu-id="94220-106">Hintergrund</span><span class="sxs-lookup"><span data-stu-id="94220-106">Background</span></span>](#background)
-   [<span data-ttu-id="94220-107">Empfehlungen</span><span class="sxs-lookup"><span data-stu-id="94220-107">Recommendations</span></span>](#recommendations)
-   [<span data-ttu-id="94220-108">Anwendungskompatibilität</span><span class="sxs-lookup"><span data-stu-id="94220-108">Application Compatibility</span></span>](#application-compatibility)

## <a name="background"></a><span data-ttu-id="94220-109">Hintergrund</span><span class="sxs-lookup"><span data-stu-id="94220-109">Background</span></span>

<span data-ttu-id="94220-110">Seit der Einführung des x86 P5-Anweisungssets haben viele Spieleentwickler den Zeitstempelzähler für Lesezeit, die RDTSC-Anweisung, verwendet, um eine zeitbasierte Zeitsteuerung mit hoher Auflösung durchzuführen.</span><span class="sxs-lookup"><span data-stu-id="94220-110">Since the introduction of the x86 P5 instruction set, many game developers have made use of read time stamp counter, the RDTSC instruction, to perform high-resolution timing.</span></span> <span data-ttu-id="94220-111">Die Windows-Multimedia-Timer sind präzise genug für die Audio- und Videoverarbeitung, aber mit Framezeiten von einem Dutzend Millisekunden oder weniger haben sie nicht genügend Auflösung, um Deltazeitinformationen zu liefern.</span><span class="sxs-lookup"><span data-stu-id="94220-111">The Windows multimedia timers are precise enough for sound and video processing, but with frame times of a dozen milliseconds or less, they don't have enough resolution to provide delta-time information.</span></span> <span data-ttu-id="94220-112">Viele Spiele verwenden immer noch einen Multimedia-Timer beim Start, um die Häufigkeit der CPU zu festlegen, und sie verwenden diesen Frequency-Wert, um Ergebnisse von RDTSC zu skalieren, um eine genaue Zeit zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="94220-112">Many games still use a multimedia timer at start-up to establish the frequency of the CPU, and they use that frequency value to scale results from RDTSC to get accurate time.</span></span> <span data-ttu-id="94220-113">Aufgrund der Einschränkungen von RDTSC bietet die Windows-API die korrektere Möglichkeit, über die Routinen von [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) und [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency)auf diese Funktionalität zuzugreifen.</span><span class="sxs-lookup"><span data-stu-id="94220-113">Due to the limitations of RDTSC, the Windows API exposes the more correct way to access this functionality through the routines of [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency).</span></span>

<span data-ttu-id="94220-114">Diese Verwendung von RDTSC für die zeitlichen Steuerungen ist von den folgenden grundlegenden Problemen betroffen:</span><span class="sxs-lookup"><span data-stu-id="94220-114">This use of RDTSC for timing suffers from these fundamental issues:</span></span>

-   <span data-ttu-id="94220-115">Diskontinuitätswerte.</span><span class="sxs-lookup"><span data-stu-id="94220-115">Discontinuous values.</span></span> <span data-ttu-id="94220-116">Bei der direkten Verwendung von RDTSC wird davon ausgegangen, dass der Thread immer auf demselben Prozessor ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="94220-116">Using RDTSC directly assumes that the thread is always running on the same processor.</span></span> <span data-ttu-id="94220-117">Systeme mit mehreren Prozessoren und dualen Kernen garantieren nicht die Synchronisierung ihrer Zykluszähler zwischen Kernen.</span><span class="sxs-lookup"><span data-stu-id="94220-117">Multiprocessor and dual-core systems do not guarantee synchronization of their cycle counters between cores.</span></span> <span data-ttu-id="94220-118">Dies wird in Kombination mit modernen Energieverwaltungstechnologien verstärkt, die verschiedene Kerne zu unterschiedlichen Zeiten leeren und wiederherstellen, was dazu führt, dass die Kerne in der Regel nicht synchronisiert werden.</span><span class="sxs-lookup"><span data-stu-id="94220-118">This is exacerbated when combined with modern power management technologies that idle and restore various cores at different times, which results in the cores typically being out of synchronization.</span></span> <span data-ttu-id="94220-119">Für eine Anwendung führt dies im Allgemeinen zu Störungen oder potenziellen Abstürzen, wenn der Thread zwischen den Prozessoren springt und Zeitsteuerungswerte erhält, die zu großen Deltas, negativen Deltas oder angehaltener Zeitsteuerung führen.</span><span class="sxs-lookup"><span data-stu-id="94220-119">For an application, this generally results in glitches or in potential crashes as the thread jumps between the processors and gets timing values that result in large deltas, negative deltas, or halted timing.</span></span>
-   <span data-ttu-id="94220-120">Verfügbarkeit dedizierter Hardware.</span><span class="sxs-lookup"><span data-stu-id="94220-120">Availability of dedicated hardware.</span></span> <span data-ttu-id="94220-121">RDTSC sperrt die Zeitsteuerungsinformationen, die die Anwendung an den Zykluszähler des Prozessors anfordert.</span><span class="sxs-lookup"><span data-stu-id="94220-121">RDTSC locks the timing information that the application requests to the processor's cycle counter.</span></span> <span data-ttu-id="94220-122">Viele Jahre lang war dies die beste Möglichkeit, präzise Zeitsteuerungsinformationen zu erhalten, aber neuere Hauptplatinen enthalten jetzt dedizierte Zeitsteuerungsgeräte, die hochauflösende Zeitsteuerungsinformationen ohne die Nachteile von RDTSC bereitstellen.</span><span class="sxs-lookup"><span data-stu-id="94220-122">For many years this was the best way to get high-precision timing information, but newer motherboards are now including dedicated timing devices which provide high-resolution timing information without the drawbacks of RDTSC.</span></span>
-   <span data-ttu-id="94220-123">Variabilität der CPU-Häufigkeit.</span><span class="sxs-lookup"><span data-stu-id="94220-123">Variability of the CPU's frequency.</span></span> <span data-ttu-id="94220-124">Häufig wird davon ausgegangen, dass die Cpu-Häufigkeit für die Lebensdauer des Programms festgelegt ist.</span><span class="sxs-lookup"><span data-stu-id="94220-124">The assumption is often made that the frequency of the CPU is fixed for the life of the program.</span></span> <span data-ttu-id="94220-125">Bei modernen Energieverwaltungstechnologien ist dies jedoch eine falsche Annahme.</span><span class="sxs-lookup"><span data-stu-id="94220-125">However, with modern power management technologies, this is an incorrect assumption.</span></span> <span data-ttu-id="94220-126">Obwohl sie anfänglich auf Laptopcomputer und andere mobile Geräte beschränkt war, wird technologie, die die CPU-Häufigkeit ändert, auf vielen High-End-Desktop-PCs verwendet. Das Deaktivieren seiner Funktion, um eine konsistente Häufigkeit aufrechtzuerhalten, ist für Benutzer im Allgemeinen nicht akzeptabel.</span><span class="sxs-lookup"><span data-stu-id="94220-126">While initially limited to laptop computers and other mobile devices, technology that changes the frequency of the CPU is in use in many high-end desktop PCs; disabling its function to maintain a consistent frequency is generally not acceptable to users.</span></span>

## <a name="recommendations"></a><span data-ttu-id="94220-127">Empfehlungen</span><span class="sxs-lookup"><span data-stu-id="94220-127">Recommendations</span></span>

<span data-ttu-id="94220-128">Spiele benötigen genaue Zeitsteuerungsinformationen, aber Sie müssen auch Zeitsteuerungscode so implementieren, dass die Probleme im Zusammenhang mit der Verwendung von RDTSC vermieden werden.</span><span class="sxs-lookup"><span data-stu-id="94220-128">Games need accurate timing information, but you also need to implement timing code in a way that avoids the problems associated with using RDTSC.</span></span> <span data-ttu-id="94220-129">Führen Sie beim Implementieren von Zeitsteuerung mit hoher Auflösung die folgenden Schritte aus:</span><span class="sxs-lookup"><span data-stu-id="94220-129">When you implement high-resolution timing, take the following steps:</span></span>

1.  <span data-ttu-id="94220-130">Verwenden Sie [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) und [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) anstelle von RDTSC.</span><span class="sxs-lookup"><span data-stu-id="94220-130">Use [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) instead of RDTSC.</span></span> <span data-ttu-id="94220-131">Diese APIs verwenden möglicherweise RDTSC, verwenden jedoch stattdessen Zeitsteuerungsgeräte auf der Hauptplatine oder andere Systemdienste, die qualitativ hochwertige, hochauflösende Zeitsteuerungsinformationen bereitstellen.</span><span class="sxs-lookup"><span data-stu-id="94220-131">These APIs may make use of RDTSC, but might instead make use of a timing devices on the motherboard or some other system services that provide high-quality high-resolution timing information.</span></span> <span data-ttu-id="94220-132">RDTSC ist zwar viel schneller als **QueryPerformanceCounter,** da es sich bei letzterem um einen API-Aufruf handelt, aber es handelt sich um eine API, die mehrere Hundert Mal pro Frame ohne spürbare Auswirkungen aufgerufen werden kann.</span><span class="sxs-lookup"><span data-stu-id="94220-132">While RDTSC is much faster than **QueryPerformanceCounter**, since the latter is an API call, it is an API that can be called several hundred times per frame without any noticeable impact.</span></span> <span data-ttu-id="94220-133">(Trotzdem sollten Entwickler versuchen, ihre Spiele so wenig wie möglich **QueryPerformanceCounter** aufrufen zu lassen, um Leistungseinbußen zu vermeiden.)</span><span class="sxs-lookup"><span data-stu-id="94220-133">(Nevertheless, developers should attempt to have their games call **QueryPerformanceCounter** as little as possible to avoid any performance penalty.)</span></span>
2.  <span data-ttu-id="94220-134">Beim Berechnen von Deltas sollten die Werte zusammengeklammert werden, um sicherzustellen, dass Fehler in den Zeitsteuerungswerten keine Abstürze oder instabile zeitbezogene Berechnungen verursachen.</span><span class="sxs-lookup"><span data-stu-id="94220-134">When computing deltas, the values should be clamped to ensure that any bugs in the timing values do not cause crashes or unstable time-related computations.</span></span> <span data-ttu-id="94220-135">Der Klammerbereich sollte von 0 (um negative Deltawerte zu verhindern) bis zu einem angemessenen Wert basierend auf der niedrigsten erwarteten Framerate liegen.</span><span class="sxs-lookup"><span data-stu-id="94220-135">The clamp range should be from 0 (to prevent negative delta values) to some reasonable value based on your lowest expected framerate.</span></span> <span data-ttu-id="94220-136">Das Anschließen ist wahrscheinlich bei jedem Debuggen Ihrer Anwendung nützlich, aber denken Sie daran, wenn Sie eine Leistungsanalyse durchführen oder das Spiel in einem nicht optimierten Modus ausführen.</span><span class="sxs-lookup"><span data-stu-id="94220-136">Clamping is likely to be useful in any debugging of your application, but be sure to keep it in mind if doing performance analysis or running the game in some unoptimized mode.</span></span>
3.  <span data-ttu-id="94220-137">Berechnen sie alle Zeitsteuerungen für einen einzelnen Thread.</span><span class="sxs-lookup"><span data-stu-id="94220-137">Compute all timing on a single thread.</span></span> <span data-ttu-id="94220-138">Die Berechnung der Zeitsteuerung für mehrere Threads , z. B. mit jedem Thread, der einem bestimmten Prozessor zugeordnet ist, verringert die Leistung von Systemen mit mehreren Kernen deutlich.</span><span class="sxs-lookup"><span data-stu-id="94220-138">Computation of timing on multiple threads — for example, with each thread associated with a specific processor — greatly reduces performance of multi-core systems.</span></span>
4.  <span data-ttu-id="94220-139">Legen Sie mithilfe der Windows-API [**SetThreadAffinityMask**](/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask)fest, dass dieser einzelne Thread auf einem einzelnen Prozessor verbleibt.</span><span class="sxs-lookup"><span data-stu-id="94220-139">Set that single thread to remain on a single processor by using the Windows API [**SetThreadAffinityMask**](/windows/win32/api/winbase/nf-winbase-setthreadaffinitymask).</span></span> <span data-ttu-id="94220-140">In der Regel ist dies der Hauptspielthread.</span><span class="sxs-lookup"><span data-stu-id="94220-140">Typically, this is the main game thread.</span></span> <span data-ttu-id="94220-141">Während [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) und [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) in der Regel für mehrere Prozessoren angepasst werden, können Fehler im BIOS oder treiber dazu führen, dass diese Routinen unterschiedliche Werte zurückgeben, wenn der Thread von einem Prozessor zu einem anderen wechselt.</span><span class="sxs-lookup"><span data-stu-id="94220-141">While [**QueryPerformanceCounter**](/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter) and [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) typically adjust for multiple processors, bugs in the BIOS or drivers may result in these routines returning different values as the thread moves from one processor to another.</span></span> <span data-ttu-id="94220-142">Daher ist es am besten, den Thread auf einem einzelnen Prozessor zu halten.</span><span class="sxs-lookup"><span data-stu-id="94220-142">So, it's best to keep the thread on a single processor.</span></span>

    <span data-ttu-id="94220-143">Alle anderen Threads sollten ausgeführt werden, ohne ihre eigenen Timerdaten zu sammeln.</span><span class="sxs-lookup"><span data-stu-id="94220-143">All other threads should operate without gathering their own timer data.</span></span> <span data-ttu-id="94220-144">Es wird nicht empfohlen, einen Arbeitsthread zum Berechnen der Zeitsteuerung zu verwenden, da dies zu einem Synchronisierungsengpass wird.</span><span class="sxs-lookup"><span data-stu-id="94220-144">We do not recommend using a worker thread to compute timing, as this will become a synchronization bottleneck.</span></span> <span data-ttu-id="94220-145">Stattdessen sollten Arbeitsthreads Zeitstempel aus dem Hauptthread lesen, und da die Arbeitsthreads nur Zeitstempel lesen, müssen keine kritischen Abschnitte verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="94220-145">Instead, worker threads should read timestamps from the main thread, and because the worker threads only read timestamps, there is no need to use critical sections.</span></span>

5.  <span data-ttu-id="94220-146">Rufen [**Sie QueryPerformanceFrequency nur**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) einmal auf, da sich die Häufigkeit nicht ändert, während das System ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="94220-146">Call [**QueryPerformanceFrequency**](/windows/win32/api/profileapi/nf-profileapi-queryperformancefrequency) only once, because the frequency will not change while the system is running.</span></span>

## <a name="application-compatibility"></a><span data-ttu-id="94220-147">Anwendungskompatibilität</span><span class="sxs-lookup"><span data-stu-id="94220-147">Application Compatibility</span></span>

<span data-ttu-id="94220-148">Viele Entwickler haben über viele Jahre Annahmen über das Verhalten von RDTSC getroffen, sodass es sehr wahrscheinlich ist, dass einige vorhandene Anwendungen probleme auftreten, wenn sie auf einem System mit mehreren Prozessoren oder Kernen aufgrund der zeitlichen Implementierung ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="94220-148">Many developers have made assumptions about the behavior of RDTSC over many years, so it is quite likely that some existing applications will exhibit problems when run on a system with multiple processors or cores due to the timing implementation.</span></span> <span data-ttu-id="94220-149">Diese Probleme manifestieren sich in der Regel als Bewegungsproblemen oder Langsamkeitsbewegungen.</span><span class="sxs-lookup"><span data-stu-id="94220-149">These problems will usually manifest as glitching or slow-motion movement.</span></span> <span data-ttu-id="94220-150">Es gibt keine einfache Lösung für Anwendungen, die die Energieverwaltung nicht kennen, aber es gibt einen vorhandenen Shim, um zu erzwingen, dass eine Anwendung immer auf einem einzelnen Prozessor in einem Multiprozessorsystem ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="94220-150">There is no easy remedy for applications that are not aware of power management, but there is an existing shim for forcing an application to always run on a single processor in a multiprocessor system.</span></span>

<span data-ttu-id="94220-151">Um diesen Shim zu erstellen, laden Sie das Microsoft Application Compatibility Toolkit von [Windows-Anwendungskompatibilität](/archive/blogs/yongrhee/download-application-compatibility-toolkit-act-for-windows-10)herunter.</span><span class="sxs-lookup"><span data-stu-id="94220-151">To create this shim, download the Microsoft Application Compatibility Toolkit from [Windows Application Compatibility](/archive/blogs/yongrhee/download-application-compatibility-toolkit-act-for-windows-10).</span></span>

<span data-ttu-id="94220-152">Erstellen Sie mithilfe des Kompatibilitätsadministrators, der Teil des Toolkits ist, eine Datenbank Ihrer Anwendung und die zugehörigen Fehlerbehebungen.</span><span class="sxs-lookup"><span data-stu-id="94220-152">Using the Compatibility Administrator, part of the toolkit, create a database of your application and associated fixes.</span></span> <span data-ttu-id="94220-153">Erstellen Sie einen neuen Kompatibilitätsmodus für diese Datenbank, und wählen Sie den Kompatibilitätsfix **SingleProcAffinity** aus, um die Ausführung aller Threads der Anwendung auf einem einzelnen Prozessor/Kern zu erzwingen.</span><span class="sxs-lookup"><span data-stu-id="94220-153">Create a new compatibility mode for this database and select the compatibility fix **SingleProcAffinity** to force all of the threads of the application to run on a single processor/core.</span></span> <span data-ttu-id="94220-154">Mithilfe des Befehlszeilentools Fixpack.exe (auch Teil des Toolkits) können Sie diese Datenbank in ein installierbares Paket für Installation, Tests und Verteilung konvertieren.</span><span class="sxs-lookup"><span data-stu-id="94220-154">By using the command-line tool Fixpack.exe (also part of the toolkit), you can convert this database into an installable package for installation, testing, and distribution.</span></span>

<span data-ttu-id="94220-155">Anweisungen zur Verwendung des Kompatibilitätsadministrators finden Sie in der Dokumentation des Toolkits.</span><span class="sxs-lookup"><span data-stu-id="94220-155">For instruction on using Compatibility Administrator, see the toolkit's documentation.</span></span> <span data-ttu-id="94220-156">Syntax für und Beispiele für die Verwendung von Fixpack.exe finden Sie in der Befehlszeilenhilfe.</span><span class="sxs-lookup"><span data-stu-id="94220-156">For syntax for and examples of using Fixpack.exe, see its command-line help.</span></span>

<span data-ttu-id="94220-157">Kundenorientierte Informationen finden Sie in den folgenden Knowledge Base-Artikeln von Microsoft Help and Support:</span><span class="sxs-lookup"><span data-stu-id="94220-157">For customer-oriented information, see the following knowledge base articles from Microsoft Help and Support:</span></span>

-   <span data-ttu-id="94220-158">[Programme, die die QueryPerformanceCounter-Funktion verwenden, können in Windows Server 2003 und Windows XP](https://support.microsoft.com/kb/895980) eine schlechte Leistung erzielen (Artikel 895980)</span><span class="sxs-lookup"><span data-stu-id="94220-158">[Programs that use the QueryPerformanceCounter function may perform poorly in Windows Server 2003 and in Windows XP](https://support.microsoft.com/kb/895980) (article 895980)</span></span>
-   <span data-ttu-id="94220-159">[Die Spielleistung auf einem Windows XP-basierten Computer, der einen Dual-Core-Prozessor verwendet, ist möglicherweise schlecht](https://support.microsoft.com/kb/909944) (Artikel 909944)</span><span class="sxs-lookup"><span data-stu-id="94220-159">[Game performance may be poor on a Windows XP-based computer that is using a dual-core processor](https://support.microsoft.com/kb/909944) (article 909944)</span></span>

 

 
