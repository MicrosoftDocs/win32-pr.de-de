---
description: Nach jeder Art von Fehler, die die normale Transaktionsverarbeitung stören, müssen KTM und jeder Ressourcen-Manager Wiederherstellungs Vorgänge durchführen. Die Wiederherstellung ist der Prozess, mit dem Transaktions Teilnehmer in einer konsistenten Ansicht jedes Transaktions Zustands eintreffen.
ms.assetid: 5bc9a155-6ba4-41f8-8e12-e87f48d83940
title: Wiederherstellungs Verarbeitung
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 5a8e74d4f8bff3e56af03b017522212e7a02e232
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/07/2021
ms.locfileid: "106373004"
---
# <a name="recovery-processing"></a><span data-ttu-id="180a5-104">Wiederherstellungs Verarbeitung</span><span class="sxs-lookup"><span data-stu-id="180a5-104">Recovery Processing</span></span>

<span data-ttu-id="180a5-105">Nach jeder Art von Fehler, die die normale Transaktionsverarbeitung stören, müssen KTM und jeder Ressourcen-Manager *Wiederherstellungs* Vorgänge durchführen.</span><span class="sxs-lookup"><span data-stu-id="180a5-105">After any type of failure that disrupts normal transaction processing, KTM and each resource manager must perform *recovery* operations.</span></span> <span data-ttu-id="180a5-106">Die Wiederherstellung ist der Prozess, mit dem Transaktions Teilnehmer in einer konsistenten Ansicht des Zustands der einzelnen Transaktionen eintreffen.</span><span class="sxs-lookup"><span data-stu-id="180a5-106">Recovery is the process by which transaction participants arrive at a consistent view of each transaction's state.</span></span>

<span data-ttu-id="180a5-107">Ressourcen-Manager sind möglicherweise *unsicher über das* Ergebnis einer Transaktion. Dies bedeutet, dass Sie zum Zeitpunkt des Fehlers eine \_ Benachrichtigung zur Vorbereitung der Transaktion erhalten haben, dass Sie auf permanenten \_ Speicher vorbereitet war, aber nicht empfangen (bzw. empfangen, aber nicht protokolliert).</span><span class="sxs-lookup"><span data-stu-id="180a5-107">Resource managers may be *in-doubt* about a transaction's outcome, meaning that at the time of failure, they had received a TRANSACTION\_NOTIFY\_PREPARE notification, had prepared to durable storage, but had not received (or received but not logged) a final outcome for the transaction.</span></span> <span data-ttu-id="180a5-108">Analog dazu kann KTM eine Transaktion unsicher sein, wenn Sie vorbereitet wurde, aber noch nicht empfangen wurde (oder empfangen, aber nicht protokolliert wurde).</span><span class="sxs-lookup"><span data-stu-id="180a5-108">Similarly, KTM can be in-doubt about a transaction if it had been prepared but had not received (or received but not logged) an outcome.</span></span> <span data-ttu-id="180a5-109">Zur Wiederherstellungszeit müssen alle Ergebnisse, die gesendet, aber nicht bestätigt wurden, erneut gesendet werden.</span><span class="sxs-lookup"><span data-stu-id="180a5-109">At recovery time, all outcomes that have been sent but not acknowledged must be re-sent.</span></span> <span data-ttu-id="180a5-110">Wenn z. b. ein Ressourcen-Manager eine \_ Benachrichtigung über den \_ Commit des Transaktions Benachrichtigungs Diensts empfangen hat und die [**commitcomplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete) -Funktion aufgerufen hat, erhält der RM möglicherweise immer noch eine doppelte \_ \_ Benachrichtigung zum Benachrichtigen von Transaktionen,</span><span class="sxs-lookup"><span data-stu-id="180a5-110">For example, if a resource manager received a TRANSACTION\_NOTIFY\_COMMIT notification and called the [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete) function, the RM may still receive a duplicate TRANSACTION\_NOTIFY\_COMMIT notification at recovery time.</span></span>

<span data-ttu-id="180a5-111">Damit eine Transaktion nach einem Ressourcen-Manager oder Systemausfall ordnungsgemäß wieder hergestellt werden kann, muss jeder Ressourcen-Manager bei jedem Start Folgendes ausführen:</span><span class="sxs-lookup"><span data-stu-id="180a5-111">For a transaction to properly recover after a resource manager or system failure, each resource manager must do the following each time it is started:</span></span>

1.  <span data-ttu-id="180a5-112">Verwenden Sie die [**openresourcemanager**](/windows/desktop/api/Ktmw32/nf-ktmw32-openresourcemanager) -Funktion, um das zugehörige Resource Manager-Handle mithilfe seines eindeutigen, permanenten namens erneut zu öffnen.</span><span class="sxs-lookup"><span data-stu-id="180a5-112">Call the [**OpenResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-openresourcemanager) function to re-open its resource manager handle using its unique, persistent name.</span></span> <span data-ttu-id="180a5-113">Dadurch wird KTM informiert, dass der Ressourcen-Manager erneut ausgeführt wird und für die Wiederherstellung verfügbar ist.</span><span class="sxs-lookup"><span data-stu-id="180a5-113">This informs KTM that the resource manager is running again and is available to perform recovery.</span></span> <span data-ttu-id="180a5-114">Wenn keine Eintragung für die Wiederherstellung vorhanden ist, kann der **openresourcemanager** -Befehl fehlschlagen.</span><span class="sxs-lookup"><span data-stu-id="180a5-114">If no enlistments exist to be recovered, the call to **OpenResourceManager** can fail.</span></span> <span data-ttu-id="180a5-115">Rufen Sie " [**kreateresourcemanager**](/windows/desktop/api/Ktmw32/nf-ktmw32-createresourcemanager) " auf, um das RM-Objekt erneut zu erstellen.</span><span class="sxs-lookup"><span data-stu-id="180a5-115">Call [**CreateResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-createresourcemanager) to re-create the RM object.</span></span>
2.  <span data-ttu-id="180a5-116">[**ResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverresourcemanager)-Rückruf.</span><span class="sxs-lookup"><span data-stu-id="180a5-116">Call [**RecoverResourceManager**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverresourcemanager).</span></span> <span data-ttu-id="180a5-117">Der Ressourcen-Manager empfängt für jede Eintragung, für die er Wiederherstellungs Vorgänge ausführen muss, ein Benachrichtigungs Ereignis für die Benachrichtigung zur [**\_ \_ wieder**](notification-mask.md) Herstellung der Transaktion, gefolgt von der \_ \_ letzten Wiederherstellung der Transaktion Benachrichtigen \_ .</span><span class="sxs-lookup"><span data-stu-id="180a5-117">The resource manager will receive a [**TRANSACTION\_NOTIFY\_RECOVER**](notification-mask.md) notification event for each enlistment for which it needs to perform recovery operations, followed by a TRANSACTION\_NOTIFY\_LAST\_RECOVER.</span></span> <span data-ttu-id="180a5-118">Das Benachrichtigungs Ereignis schließt eine Globally Unique Identifier für die Transaktion und die Eintragung ein.</span><span class="sxs-lookup"><span data-stu-id="180a5-118">The notification event includes a globally unique identifier for both the transaction and the enlistment.</span></span>
3.  <span data-ttu-id="180a5-119">Verwenden Sie die [**openenlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment) -Funktion, um jedes Registrierungs handle erneut zu öffnen, für das der Ressourcen-Manager eine \_ Benachrichtigung zur Wiederherstellung per Transaktions Benachrichtigung erhalten hat \_ .</span><span class="sxs-lookup"><span data-stu-id="180a5-119">Call the [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment) function to re-open each enlistment handle for which the resource manager received a TRANSACTION\_NOTIFY\_RECOVER notification.</span></span>
4.  <span data-ttu-id="180a5-120">Für jede Eintragung, die von [**openeintragung**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment)geöffnet wurde, wird die [**Wiederherstellbarkeits Eintragung**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverenlistment)aufgerufen.</span><span class="sxs-lookup"><span data-stu-id="180a5-120">For each enlistment opened by [**OpenEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-openenlistment), call [**RecoverEnlistment**](/windows/desktop/api/Ktmw32/nf-ktmw32-recoverenlistment).</span></span> <span data-ttu-id="180a5-121">Dies bewirkt \_ \_ , dass der Commit für die Transaktion benachrichtigen oder die \_ \_ Benachrichtigung über die Benachrichtigung über die Benachrichtigung übermittelt wird.</span><span class="sxs-lookup"><span data-stu-id="180a5-121">This causes the TRANSACTION\_NOTIFY\_COMMIT or TRANSACTION\_NOTIFY\_INDOUBT notification to be redelivered.</span></span>
5.  <span data-ttu-id="180a5-122">Wenn für den RM ein \_ Commit für die Transaktions Benachrichtigung empfangen \_ wurde, kann der RM die Transaktion durch Aufrufen von [**commitcomplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete)vervollständigen.</span><span class="sxs-lookup"><span data-stu-id="180a5-122">If the RM received TRANSACTION\_NOTIFY\_COMMIT, the RM can complete the transaction by calling [**CommitComplete**](/windows/desktop/api/Ktmw32/nf-ktmw32-commitcomplete).</span></span>

    <span data-ttu-id="180a5-123">Wenn die RM-Transaktion die Transaktion nicht \_ \_ sicher benachrichtigt, sollte der RM auf den Eingang der Ergebnis Benachrichtigung warten.</span><span class="sxs-lookup"><span data-stu-id="180a5-123">If the RM received TRANSACTION\_NOTIFY\_INDOUBT, the RM should wait for the outcome notification to arrive.</span></span>

6.  <span data-ttu-id="180a5-124">Für Transaktionen, für die der RM keine Benachrichtigung zur Wiederherstellung per Transaktions Benachrichtigung erhält \_ \_ , aber zuvor eine \_ Transaktion \_ Benachrichtigungs Vorbereitung für empfangen hat, sollte der RM die Transaktion so verarbeiten, als ob ein Rollback ausgeführt würde.</span><span class="sxs-lookup"><span data-stu-id="180a5-124">For any transactions that the RM does not receive a TRANSACTION\_NOTIFY\_RECOVER notification, but previously received a TRANSACTION\_NOTIFY\_PREPARE notification for, the RM should process the transaction as if it were rolled back.</span></span>

> [!Note]
>
> <span data-ttu-id="180a5-125">Ressourcen-Manager können während der Durchführung der Wiederherstellung neue Transaktionen eintragen oder erstellen.</span><span class="sxs-lookup"><span data-stu-id="180a5-125">Resource managers are allowed to enlist in or create new transactions while in the process of performing recovery.</span></span>

 

<span data-ttu-id="180a5-126">KTM verwendet ein *mutmaßliches Abbruch* Transaktionsmodell.</span><span class="sxs-lookup"><span data-stu-id="180a5-126">KTM uses a *presumed abort* transaction model.</span></span> <span data-ttu-id="180a5-127">Dieses Verhalten wird im folgenden Szenario veranschaulicht.</span><span class="sxs-lookup"><span data-stu-id="180a5-127">The following scenario illustrates this behavior.</span></span> <span data-ttu-id="180a5-128">Nehmen Sie an, dass KTM und ein Ressourcen-Manager auf demselben Computer vorhanden sind.</span><span class="sxs-lookup"><span data-stu-id="180a5-128">Assume that KTM and an resource manager exist on the same computer.</span></span> <span data-ttu-id="180a5-129">Angenommen, KTM gibt eine Vorbereitungs Benachrichtigung für eine Transaktion aus, aber das System stürzt ab, bevor KTM die Vorbereitungs Benachrichtigung protokolliert.</span><span class="sxs-lookup"><span data-stu-id="180a5-129">Suppose KTM issues a prepare notification for a transaction, but the system crashes before KTM logs the prepare notification.</span></span> <span data-ttu-id="180a5-130">Angenommen, der Ressourcen-Manager empfängt und protokolliert die Vorbereitungs Benachrichtigung, kurz bevor das System abstürzt.</span><span class="sxs-lookup"><span data-stu-id="180a5-130">Further suppose that the resource manager receives and logs the prepare notification just before the system crashes.</span></span> <span data-ttu-id="180a5-131">Nachdem das System wieder hergestellt wurde, kennt KTM die Transaktion nicht, da die Vorbereitungsphase nie protokolliert wurde.</span><span class="sxs-lookup"><span data-stu-id="180a5-131">After the system is restored, KTM has no knowledge of the transaction, because it never logged the prepare phase.</span></span> <span data-ttu-id="180a5-132">Der Ressourcen-Manager hat Kenntnis der Transaktion, weil er die Vorbereitungs Benachrichtigung empfangen, verarbeitet und protokolliert hat.</span><span class="sxs-lookup"><span data-stu-id="180a5-132">The resource manager has knowledge of the transaction, because it received, processed, and logged the prepare notification.</span></span> <span data-ttu-id="180a5-133">Wenn KTM seine Wiederherstellungs Benachrichtigungen ausgibt, enthält der Ressourcen-Manager keine Wiederherstellungs Benachrichtigung für die betreffende Transaktion.</span><span class="sxs-lookup"><span data-stu-id="180a5-133">When KTM issues its recovery notifications, the resource manager does not include a recovery notification for the transaction in question.</span></span> <span data-ttu-id="180a5-134">Mit dem mutmaßlichen Abbruch Modell behandelt der Ressourcen-Manager in diesem Fall die vorbereitete Transaktion als abgebrochen, wenn Sie keine Benachrichtigungen empfängt, um die Wiederherstellung für diese Transaktion auszuführen.</span><span class="sxs-lookup"><span data-stu-id="180a5-134">With the presumed abort model, the resource manager in this case will treat the prepared transaction as aborted when it does not receive notifications to perform recovery on that transaction.</span></span>

 

 



